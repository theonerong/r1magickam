(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const br="CameraPresetsDB",vr=1,se="presets";class Br{constructor(){this.db=null}async init(){return new Promise((t,n)=>{const o=indexedDB.open(br,vr);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(se)||i.createObjectStore(se,{keyPath:"id"}).createIndex("type","type",{unique:!1})}})}async saveModification(t,n){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`modified_${t}`,type:"modification",name:t,data:n,timestamp:Date.now()})}async saveNewPreset(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`new_${t.name}`,type:"new",name:t.name,data:t,timestamp:Date.now()})}async saveDeletion(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`deleted_${t}`,type:"deletion",name:t,timestamp:Date.now()})}async getAllModifications(){return new Promise((t,n)=>{const i=this.db.transaction([se],"readonly").objectStore(se).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async clearFactoryPresetModifications(){return new Promise((t,n)=>{const o=this.db.transaction([se],"readwrite"),s=o.objectStore(se),i=s.getAll();i.onsuccess=()=>{const r=i.result,l=[];for(const d of r)if(d.type==="modification"||d.type==="deletion"){const u=s.delete(d.id);l.push(new Promise((g,E)=>{u.onsuccess=()=>g(),u.onerror=()=>E(u.error)}))}Promise.all(l).then(()=>t()).catch(n)},i.onerror=()=>n(i.error),o.onerror=()=>n(o.error)})}async removeModification(t){const o=this.db.transaction([se],"readwrite").objectStore(se);await o.delete(`modified_${t}`),await o.delete(`deleted_${t}`)}}const De=new Br,Sr="ImportedPresetsDB",xr=1,et="imported_presets";class wr{constructor(){this.db=null,this.importedPresets=[],this.isImportModalOpen=!1,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates=new Map}async init(){return new Promise((t,n)=>{const o=indexedDB.open(Sr,xr);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(et)||i.createObjectStore(et,{keyPath:"id",autoIncrement:!0})}})}async loadImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([et],"readonly").objectStore(et).getAll();i.onsuccess=()=>{this.importedPresets=i.result.map(r=>r.preset),t(this.importedPresets)},i.onerror=()=>{console.error("Error loading imported presets:",i.error),t([])}})}async saveImportedPresets(t){return this.db||await this.init(),new Promise(async(n,o)=>{const i=this.db.transaction([et],"readwrite").objectStore(et),r=i.clear();r.onsuccess=()=>{const l=t.map(d=>new Promise((u,g)=>{const E=i.add({preset:d});E.onsuccess=()=>u(),E.onerror=()=>g(E.error)}));Promise.all(l).then(()=>{this.importedPresets=t,n()}).catch(o)},r.onerror=()=>o(r.error)})}async loadPresetsFromFile(){try{const t=await fetch("./presets.json");if(!t.ok)throw new Error("Failed to load presets.json");return(await t.json()).filter(s=>s.name&&s.message&&Array.isArray(s.category)).sort((s,i)=>s.name.localeCompare(i.name))}catch(t){throw console.error("Error loading presets.json:",t),new Error("Could not load presets.json file")}}getFilteredPresets(t){if(!this.importFilterText.trim())return t;const n=this.importFilterText.toLowerCase();return t.filter(o=>o.name.toLowerCase().includes(n))}async showPresetSelectionUI(t){return new Promise(n=>{this.isImportModalOpen=!0,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates.clear(),t.forEach(S=>{const C=this.importedPresets.some(N=>N.name===S.name);this.checkboxStates.set(S.name,C)});const o=document.createElement("div");o.className="styles-menu",o.style.display="flex",o.style.zIndex="10000",o.id="import-preset-modal";const s=document.createElement("div");s.className="styles-menu-content";const i=document.createElement("div");i.className="styles-menu-header",i.style.marginBottom="0",i.innerHTML=`
        <h2 style="font-size: 14px;">Import (<span id="import-preset-count">${t.length}</span>)</h2>
        <div class="menu-nav-buttons">
          <button id="import-jump-to-top" class="menu-jump-button" title="Jump to top">‚Üë</button>
          <button id="import-jump-to-bottom" class="menu-jump-button" title="Jump to bottom">‚Üì</button>
          <button id="close-import-modal" class="close-button">√ó</button>
        </div>
      `;const r=document.createElement("div");r.className="styles-menu-scroll-container",r.id="import-scroll-container",r.style.paddingTop="0",r.style.paddingBottom="22px";const l=document.createElement("div");l.className="menu-section",l.style.cssText="position: sticky; top: 0; background: #1a1a1a; z-index: 10; padding: 5px 0; margin: 0; border-bottom: 1px solid #333;",l.innerHTML=`
        <input type="text" id="import-preset-filter" class="style-filter" placeholder="Filter..." style="width: 100%; margin: 0; height: 24px; font-size: 12px;">
      `;const d=document.createElement("div");d.className="menu-section",d.id="import-presets-section",d.style.margin="0";const u=document.createElement("div");u.className="menu-list",u.id="import-presets-list";const g=()=>{const S=this.getFilteredPresets(t),C=document.getElementById("import-preset-count");C&&(C.textContent=S.length),u.innerHTML="",S.forEach((N,pe)=>{const J=document.createElement("button");J.className="menu-item",J.dataset.presetIndex=pe,J.dataset.presetName=N.name,J.style.cssText="display: flex; align-items: center; padding: 6px 15px; min-height: 30px; width: 100%; justify-content: flex-start; margin-bottom: 2px;";const _=document.createElement("input");_.type="checkbox",_.id=`import-preset-${pe}`,_.checked=this.checkboxStates.get(N.name)||!1,_.style.cssText=`
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #4CAF50;
            flex-shrink: 0;
          `,_.onclick=te=>{te.stopPropagation(),this.checkboxStates.set(N.name,_.checked)};const Y=document.createElement("span");Y.className="menu-item-name",Y.textContent=N.name,Y.style.cssText="flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; color: #000; font-size: 12px;",J.appendChild(_),J.appendChild(Y),J.onclick=te=>{te.target!==_&&(_.checked=!_.checked,this.checkboxStates.set(N.name,_.checked))},u.appendChild(J)}),E()},E=()=>{const S=u.querySelectorAll(".menu-item");if(S.forEach(C=>C.classList.remove("menu-selected")),this.currentImportScrollIndex>=0&&this.currentImportScrollIndex<S.length){const C=S[this.currentImportScrollIndex];C.classList.add("menu-selected"),C.scrollIntoView({behavior:"smooth",block:"nearest"})}};d.appendChild(u);const B=document.createElement("div");B.style.cssText=`
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1a1a1a;
  z-index: 20;
  padding: 2px;
  border-top: 1px solid #333;
  display: flex;
  gap: 3px;
`,B.innerHTML=`
  <button id="select-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úì All
  </button>
  <button id="deselect-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úó None
  </button>
  <button id="confirm-import-presets" style="flex: 1; padding: 0; background: #4CAF50; color: white; border: none; border-radius: 2px; font-size: 10px; font-weight: bold; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Import
  </button>
  <button id="cancel-import-presets" style="flex: 1; padding: 0; background: #666; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Cancel
  </button>
`,r.appendChild(l),r.appendChild(d),s.appendChild(i),s.appendChild(r),o.appendChild(s),o.appendChild(B),document.body.appendChild(o),g(),document.getElementById("import-preset-filter").addEventListener("input",S=>{this.importFilterText=S.target.value,this.currentImportScrollIndex=0,g()}),document.getElementById("select-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!0)}),g()},document.getElementById("deselect-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!1)}),g()};const F=()=>{this.isImportModalOpen=!1,document.body.removeChild(o)};document.getElementById("close-import-modal").onclick=()=>{F(),n(null)},document.getElementById("cancel-import-presets").onclick=()=>{F(),n(null)},document.getElementById("confirm-import-presets").onclick=()=>{const S=t.filter(C=>this.checkboxStates.get(C.name)===!0);F(),n(S)},document.getElementById("import-jump-to-top").onclick=()=>{r.scrollTop=0,this.currentImportScrollIndex=0,E()},document.getElementById("import-jump-to-bottom").onclick=()=>{r.scrollTop=r.scrollHeight;const S=u.querySelectorAll(".menu-item");this.currentImportScrollIndex=S.length-1,E()},this.scrollImportUp=()=>{u.querySelectorAll(".menu-item").length!==0&&(this.currentImportScrollIndex=Math.max(0,this.currentImportScrollIndex-1),E())},this.scrollImportDown=()=>{const S=u.querySelectorAll(".menu-item");S.length!==0&&(this.currentImportScrollIndex=Math.min(S.length-1,this.currentImportScrollIndex+1),E())},r.style.overflowY="auto"})}async import(){try{const t=await this.loadPresetsFromFile();if(t.length===0)return{success:!1,message:"No presets found in presets.json"};const n=await this.showPresetSelectionUI(t);if(n===null)return{success:!1,message:"cancelled"};if(n.length===0)return{success:!1,message:"No presets selected"};const o=new Set(this.importedPresets.map(r=>r.name)),s=n.filter(r=>!o.has(r.name)),i=[...this.importedPresets,...s];return await this.saveImportedPresets(i),{success:!0,message:`Imported ${n.length}. Total: ${i.length}`,count:n.length,total:i.length}}catch(t){return{success:!1,message:t.message}}}async deletePreset(t){const n=this.importedPresets.findIndex(o=>o.name===t);return n>=0?(this.importedPresets.splice(n,1),await this.saveImportedPresets(this.importedPresets),!0):!1}async clearImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([et],"readwrite").objectStore(et).clear();i.onsuccess=()=>{this.importedPresets=[],t()},i.onerror=()=>n(i.error)})}getImportedPresets(){return this.importedPresets}}const we=new wr;let Zn=[],h,I,H,v,En,A=null,V=null;const Zt=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"SXGA+ (1400x1050)",width:1400,height:1050},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080},{name:"HD (3264x2448)",width:3264,height:2448}];let Je=0;const xi="r1_camera_resolution",Io=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080}];let Tt=0;const wi="r1_import_resolution";let re=0,R=[],eo=!1,K=1,Ht=!1,ai=0,ci=1,ye=!1,$=5,en=500,to=!1;const Ct={1:{delay:800,label:"Slow"},2:{delay:500,label:"Medium"},3:{delay:300,label:"Fast"}},Ti="r1_camera_burst_settings",Ci="r1_camera_timer_settings",Li="r1_camera_last_preset";let fe=!1,Ye=null,Oe=10,ht=!1,Mi=[3,5,10],me=1;const Pi={1:{seconds:1,label:"1s"},2:{seconds:3,label:"3s"},3:{seconds:5,label:"5s"},4:{seconds:10,label:"10s"},5:{seconds:30,label:"30s"},6:{seconds:60,label:"1m"},7:{seconds:300,label:"5m"},8:{seconds:600,label:"10m"},9:{seconds:1800,label:"30m"},10:{seconds:3600,label:"1h"}};let be="",Qe=!1;const ki="r1_camera_master_prompt",Ai="r1_camera_master_prompt_enabled",Di="r1_camera_aspect_ratio";let le="none";const Tr="r1_camera_selection_history";let co={},Me=!1,ce=!1,fn=null,Ve=null,Lt=30,bo=.1,ft=!0,Mt=2,un=!1,Pt=3;const Ri="r1_camera_motion_settings";let $t=null;const Jt={1:{seconds:3,label:"3s"},2:{seconds:10,label:"10s"},3:{seconds:30,label:"30s"},4:{seconds:60,label:"1m"},5:{seconds:300,label:"5m"},6:{seconds:600,label:"10m"},7:{seconds:900,label:"15m"},8:{seconds:1800,label:"30m"}};let ie=!1;const Oi="r1_camera_no_magic_mode";let bt,no,Ft=null,oe=0,U=!1,it=!1,Ne=!1,W=0,ve=0,Be=0,ee=!1,tn=!1,Ln=!1,Mn=!1,Pn=!1,kn=!1,Et=!1,Dt=!1,Pe=-1,Se=0;const Cr="R1CameraGallery",Lr=1,st="images";let Ee=null,P=[];const Ni="r1_gallery_sort_order";let X=-1,he=1,mn=!1,di=0,ui=1,ge=1;const pn=16;let Ut=null,Vt=null,Yt="newest",ot=!1,O=new Set,It=!1,Re=[],In=null,tt="",bn="",uo=0,ut="",je="",mt="",hn=null,vt=null,mo=!1;const Mr=500,mi={transform:"Take a picture and transform the image into [DESCRIBE TRANSFORMATION]. [ADD SPECIFIC DETAILS ABOUT STYLE, APPEARANCE, COLORS, ETC.]",transform_subject:"Take a picture and transform the subject into [WHAT THE SUBJECT BECOMES]. Preserve the subject's recognizable facial structure and identity. [ADD DETAILS ABOUT NEW APPEARANCE, ENVIRONMENT, LIGHTING].",convert:"Take a picture and convert the scene into [DESCRIBE NEW FORMAT/MEDIUM]. [ADD DETAILS ABOUT MATERIALS, TEXTURES, SCALE].",style:"Take a picture in the style of [ARTISTIC STYLE/ARTIST]. [ADD DETAILS ABOUT TECHNIQUE, COLORS, COMPOSITION].",place:"Take a picture and place the subject in [DESCRIBE SCENE/LOCATION]. [ADD DETAILS ABOUT LIGHTING, ATMOSPHERE, INTEGRATION].",recreate:"Take a picture and recreate [FAMOUS WORK/SCENE]. Replace [DESCRIBE WHAT TO REPLACE]. Preserve the iconic [DESCRIBE KEY ELEMENTS TO KEEP].",render:"Take a picture and render it as [FORMAT/MEDIUM]. [ADD DETAILS ABOUT APPEARANCE, TEXTURE, TECHNICAL SPECIFICS].",make:"Take a picture and make the subject into [CHARACTER/CREATURE]. [ADD DETAILS ABOUT APPEARANCE, TRAITS, SETTING]. Make it photorealistic.",analyze:"Analyze the image and [DESCRIBE WHAT TO ANALYZE/EXTRACT]. [ADD DETAILS ABOUT OUTPUT FORMAT] and email it to me.",random:`Take a picture and [DESCRIBE BASE TRANSFORMATION].

[CATEGORY NAME] SELECTION (CRITICAL):
‚Ä¢ SELECT EXACTLY ONE option using the PRE-CALCULATED values
‚Ä¢ These values are MANDATORY - you MUST use them for selection
‚Ä¢ Do NOT choose based on popularity, visual interest, or defaults

For 2 options (50/50 split):
‚Ä¢ If LAST DIGIT is EVEN (0,2,4,6,8): SELECT [OPTION 1]
‚Ä¢ If LAST DIGIT is ODD (1,3,5,7,9): SELECT [OPTION 2]

For 3-10 options:
‚Ä¢ Use LAST DIGIT to select:
  - 0: [OPTION 1]
  - 1: [OPTION 2]
  - 2: [OPTION 3]
  - 3: [OPTION 4]
  - (continue pattern)

For 11-20 options:
‚Ä¢ Use LAST TWO DIGITS modulo [number of options]:
  - 0: [OPTION 1]
  - 1: [OPTION 2]
  - (continue pattern)

For 21+ options:
‚Ä¢ Use LAST TWO DIGITS modulo [number of options] to distribute evenly
‚Ä¢ Map each result to corresponding option in list

[ADD DETAILS ABOUT HOW THE SELECTED OPTION SHOULD AFFECT THE IMAGE].`,custom:""};let m=[],Bt=[],kt=!1,b=0,Ge=-1,Ie=navigator.onLine,L=[],gt=!1,nt=null,vn=0;const qi=500,_i="r1_camera_queue";let dt,St,ke;const go="r1_camera_styles";let ze=[];const Hi="r1_camera_favorites",Fi="r1_camera_visible_presets";let x=[],Xe=!1,ae=0,Qt="",nn=!0;function Z(e){Ft&&(clearTimeout(Ft),Ft=null),bt||(bt=document.getElementById("style-reveal"),no=document.getElementById("style-reveal-text")),!(!bt||!no)&&(no.textContent=e,bt.style.display="block",Ft=setTimeout(()=>{bt&&(bt.style.display="none"),Ft=null},1200))}function An(){return new Promise((e,t)=>{const n=indexedDB.open(Cr,Lr);n.onerror=()=>{console.error("Failed to open IndexedDB:",n.error),t(n.error)},n.onsuccess=()=>{Ee=n.result,console.log("IndexedDB opened successfully"),e(Ee)},n.onupgradeneeded=o=>{Ee=o.target.result,Ee.objectStoreNames.contains(st)||(Ee.createObjectStore(st,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Object store created"))}})}async function Pr(){try{const e=localStorage.getItem("r1_gallery_index");if(!e){console.log("No old gallery data to migrate");return}const t=JSON.parse(e);let n=0;for(const o of t){const s="r1_gallery_"+o,i=localStorage.getItem(s);if(i){const r=JSON.parse(i);for(const l of r)await Rn(l),n++;localStorage.removeItem(s)}}localStorage.removeItem("r1_gallery_index"),console.log(`Migration complete: ${n} images migrated to IndexedDB`),await Dn()}catch(e){console.error("Migration failed:",e)}}async function Dn(){try{Ee||await An(),P=[];const n=Ee.transaction([st],"readonly").objectStore(st).getAll();return new Promise((o,s)=>{n.onsuccess=()=>{P=n.result||[];const i=localStorage.getItem(Ni);i&&(Yt=i),P.sort((r,l)=>l.timestamp-r.timestamp),console.log(`Gallery loaded: ${P.length} images`),o()},n.onerror=()=>{console.error("Failed to load gallery:",n.error),P=[],s(n.error)}})}catch(e){console.error("Error loading gallery:",e),P=[]}}async function Rn(e){try{Ee||await An();const o=Ee.transaction([st],"readwrite").objectStore(st).add(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image saved to IndexedDB"),s()},o.onerror=()=>{console.error("Failed to save image:",o.error),i(o.error)}})}catch(t){console.error("Error saving image:",t)}}async function $i(e){try{Ee||await An();const o=Ee.transaction([st],"readwrite").objectStore(st).delete(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image deleted from IndexedDB"),s()},o.onerror=()=>{console.error("Failed to delete image:",o.error),i(o.error)}})}catch(t){console.error("Error deleting image:",t)}}async function Ui(e){const t={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:e,timestamp:Date.now()};P.unshift(t),await Rn(t),console.log(`Image added. Total: ${P.length}`)}function kr(e){return!Ut&&!Vt?e:e.filter(t=>{const n=new Date(t.timestamp);n.setHours(0,0,0,0);const o=n.getTime();let s=!0,i=!0;if(Ut){const r=new Date(Ut).getTime();s=o>=r}if(Vt){const r=new Date(Vt).getTime();i=o<=r}return s&&i})}function Ar(e){const t=[...e];return Yt==="newest"?t.sort((n,o)=>o.timestamp-n.timestamp):t.sort((n,o)=>n.timestamp-o.timestamp),t}function vo(){let e=kr(P);return Ar(e)}async function ue(){rt(),ir(),H&&H.style.display==="block"&&Fn(),await Dn();const e=document.getElementById("gallery-modal"),t=document.getElementById("gallery-grid"),n=document.getElementById("gallery-pagination"),o=document.getElementById("page-info"),s=document.getElementById("prev-page"),i=document.getElementById("next-page"),r=document.getElementById("gallery-count");r&&(r.textContent=P.length);const l=document.getElementById("gallery-sort-order");l&&(l.value=Yt);const d=vo();if(d.length===0)t.innerHTML='<div class="gallery-empty">No photos match the selected filter.</div>',n.style.display="none";else{const u=Math.ceil(d.length/pn);ge=Math.min(ge,u);const g=(ge-1)*pn,E=Math.min(g+pn,d.length),B=d.slice(g,E),k=document.createDocumentFragment();B.forEach(F=>{const S=document.createElement("div");if(S.className="gallery-item",ot&&O.has(F.id)&&S.classList.add("selected"),ot){const N=document.createElement("input");N.type="checkbox",N.className="gallery-item-checkbox",N.checked=O.has(F.id),N.addEventListener("click",pe=>{pe.stopPropagation(),pi(F.id)}),S.appendChild(N)}const C=document.createElement("img");C.src=F.imageBase64,C.alt="Gallery image",C.loading="lazy",S.appendChild(C),S.onclick=()=>{if(ot)pi(F.id),ue();else{const N=P.findIndex(pe=>pe.id===F.id);Nr(N)}},k.appendChild(S)}),t.innerHTML="",t.appendChild(k),u>1?(n.style.display="flex",o.textContent=`Page ${ge} of ${u}`,s.disabled=ge===1,i.disabled=ge===u):n.style.display="none"}e.style.display="flex"}async function Dr(){if(document.getElementById("gallery-modal").style.display="none",ge=1,await rr(),fe||ye||ce||Me||It){let e="";fe?e="‚è±Ô∏è Timer Mode":ye?e="üì∏ Burst Mode":ce?e="üëÅÔ∏è Motion Detection":Me&&(e="üé≤ Random Mode"),Z(e)}else m&&m[b]&&Z(m[b].name)}function Rr(){const e=vo(),t=Math.ceil(e.length/pn);ge<t&&(ge++,ue())}function Or(){ge>1&&(ge--,ue())}function oo(){ge=1,ue()}function gi(e,t){const n=e==="start"?"gallery-start-date-btn":"gallery-end-date-btn",o=document.getElementById(n);if(!o)return;const s=o.querySelector(".date-button-text");if(s)if(t){const r=new Date(t+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.textContent=r,o.classList.add("has-date")}else s.textContent=e==="start"?"Start":"End",o.classList.remove("has-date")}function Nr(e){if(e<0||e>=P.length)return;X=e;const t=P[e],n=document.getElementById("image-viewer"),o=document.getElementById("viewer-image"),s=document.getElementById("viewer-prompt");o.src=t.imageBase64,o.style.transform="scale(1) translate(0, 0)",he=1,s.value="",n.style.display="flex",document.getElementById("gallery-modal").style.display="none"}function qr(){document.getElementById("image-viewer").style.display="none",X=-1,he=1;const e=document.getElementById("gallery-modal");e.style.display="flex",ue()}async function _r(){if(!(X<0||X>=P.length)&&confirm("Delete this image from gallery?")){const e=P[X];await $i(e.id),P.splice(X,1),document.getElementById("image-viewer").style.display="none",X=-1,he=1,ue()}}function Hr(){const e=document.getElementById("preset-selector");It=!1,Re=[];const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none");const n=e.querySelector(".preset-selector-header h3");n&&(n.innerHTML='Select Preset (<span id="preset-count">0</span>)'),on();const o=document.getElementById("preset-count");o&&(o.textContent=m.length),e.style.display="flex",Ne=!0,W=0,pt(),setTimeout(()=>{const s=document.getElementById("preset-list");s&&uo>0&&(s.scrollTop=uo)},50)}function Bn(){const e=document.getElementById("preset-list");e&&(uo=e.scrollTop),document.getElementById("preset-selector").style.display="none",bn="",mt="",document.getElementById("preset-filter").value="",Ne=!1,W=0;const t=document.getElementById("preset-selector-category-hint");t&&(t.style.display="none"),It=!1}function Fr(){if(!Ne)return;const e=document.getElementById("preset-list");!e||e.querySelectorAll(".preset-item").length===0||(W=Math.max(0,W-1),pt())}function $r(){if(!Ne)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");t.length!==0&&(W=Math.min(t.length-1,W+1),pt())}function pt(){const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("preset-selected")}),W>=0&&W<t.length)){const n=t[W];n.classList.add("preset-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.querySelector(".preset-name").textContent,s=m.find(r=>r.name===o),i=document.getElementById("preset-selector-category-hint");i&&s&&s.category?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const d=document.createElement("span");if(d.textContent=r,d.style.cursor="pointer",d.style.padding="0 2px",mt===r&&(d.style.textDecoration="underline",d.style.fontWeight="bold"),d.onclick=u=>{u.stopPropagation(),mt===r?mt="":mt=r,W=0,on()},i.appendChild(d),l<s.category.length-1){const u=document.createElement("span");u.textContent=", ",i.appendChild(u)}})):i&&(i.style.display="none")}}function Ur(){if(!ee)return;const e=document.getElementById("settings-submenu");!e||e.querySelectorAll(".menu-section-button").length===0||(ve=Math.max(0,ve-1),Bo())}function Vr(){if(!ee)return;const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");t.length!==0&&(ve=Math.min(t.length-1,ve+1),Bo())}function Bo(){const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),ve>=0&&ve<t.length)){const n=t[ve];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function jr(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Be=(Be-1+t.length)%t.length,So(t))}function Gr(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Be=(Be+1)%t.length,So(t))}function So(e){if(e.forEach(t=>t.classList.remove("menu-selected")),Be>=0&&Be<e.length){const t=e[Be];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}}function zr(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Jr(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Yr(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Qr(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Xr(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Wr(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Kr(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Zr(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Vi(){if(!Dt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ji(){if(!Dt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function el(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function tl(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function nl(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ol(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function yi(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.max(0,t.scrollTop-100):n&&(n.scrollTop=Math.max(0,n.scrollTop-200))}function fi(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+100):n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+200))}function sl(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function il(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function rl(){if(!Ne)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length===0||W>=t.length)return;const n=t[W];n&&n.click()}function on(){const e=document.getElementById("preset-list");e.innerHTML="";const n=vl().filter(l=>{if(bn){const d=bn.toLowerCase(),u=l.category&&l.category.some(E=>E.toLowerCase().includes(d));if(!(l.name.toLowerCase().includes(d)||l.message.toLowerCase().includes(d)||u))return!1}return mt?l.category&&l.category.includes(mt):!0}).sort((l,d)=>l.name.localeCompare(d.name)),o=n.filter(l=>At(l.name)),s=n.filter(l=>!At(l.name)),i=[...o,...s];if(i.length===0){e.innerHTML='<div class="preset-empty">No presets found</div>';return}i.forEach(l=>{const d=document.createElement("div");d.className="preset-item";const u=document.createElement("div");u.className="preset-name",u.textContent=l.name;const g=document.createElement("div");g.className="preset-description preset-description-hidden",g.textContent=l.message,d.appendChild(u),d.appendChild(g),d.onclick=()=>{g.classList.contains("preset-description-hidden")?g.classList.remove("preset-description-hidden"):ll(l)},e.appendChild(d)});const r=document.getElementById("preset-count");r&&(r.textContent=i.length)}async function ll(e){if(It){const n=Re.findIndex(o=>o.name===e.name);n>-1?Re.splice(n,1):Re.push(e),Gi();return}if(window.batchProcessingActive){window.batchProcessingActive=!1;const n=window.batchImagesToProcess;window.batchImagesToProcess=null,Bn();const s=document.getElementById("preset-selector").querySelector(".preset-selector-header h3");s.textContent="Select Preset",await ml(e,n);return}const t=document.getElementById("viewer-prompt");t.value=e.message,Bn()}function al(){if(X<0||X>=P.length){alert("No image selected");return}let t=document.getElementById("viewer-prompt").value.trim(),n="Custom Prompt";if(!t){const s=wo(),i=m[s];t=i.message,n=i.name,alert(`Using random preset: ${n}`)}const o=P[X];typeof PluginMessageHandler<"u"?(PluginMessageHandler.postMessage(JSON.stringify({message:Un(t,n),pluginId:"com.r1.pixelart",imageBase64:o.imageBase64})),alert("Magic transform submitted! You can submit again with a different prompt.")):alert("Magic transform sent: "+t.substring(0,50)+"...")}function Sn(){ot=!ot;const e=document.getElementById("batch-mode-toggle"),t=document.getElementById("batch-controls"),n=document.getElementById("batch-action-bar");ot?(e.textContent="Done",e.classList.add("active"),t.style.display="flex",n.style.display="flex",O.clear(),On(),ue()):(e.textContent="Select",e.classList.remove("active"),t.style.display="none",n.style.display="none",O.clear(),ue())}function On(){const e=document.getElementById("batch-selected-count"),t=document.getElementById("batch-apply-preset"),n=document.getElementById("batch-delete");e.textContent=`${O.size} selected`,t.disabled=O.size===0,n&&(n.disabled=O.size===0)}function cl(){const e=vo();O.clear(),e.forEach(t=>O.add(t.id)),On(),ue()}function dl(){O.clear(),On(),ue()}function pi(e){O.has(e)?O.delete(e):O.add(e),On()}async function ul(){if(O.size===0)return;const e=document.getElementById("preset-selector"),t=e.querySelector(".preset-selector-header h3");t.textContent=`Select Preset (${O.size} images)`;const n=Array.from(O);window.batchProcessingActive=!0,window.batchImagesToProcess=n,on(),e.style.display="flex",Ne=!0,W=0,pt()}async function ml(e,t){const n=t||Array.from(O),o=n.length,s=document.createElement("div");s.className="batch-progress-overlay",s.innerHTML=`
    <div class="batch-progress-text">Processing <span id="batch-current">0</span> / ${o}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(s);let i=0;for(const r of n){const l=P.find(d=>d.id===r);if(l)try{const d=Un(e.message,e.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:d,pluginId:"com.r1.pixelart",imageBase64:l.imageBase64})),i++,document.getElementById("batch-current").textContent=i,document.getElementById("batch-progress-fill").style.width=`${i/o*100}%`,await new Promise(u=>setTimeout(u,3e3))}catch(d){console.error(`Failed to process image ${r}:`,d)}}document.body.removeChild(s),ot=!1,O.clear(),Sn(),alert(`Batch processing complete! ${i} of ${o} images submitted.`)}async function gl(){if(O.size===0)return;const e=O.size;if(!confirm(`Are you sure you want to delete ${e} selected image${e>1?"s":""}? This cannot be undone.`))return;const n=Array.from(O),o=document.createElement("div");o.className="batch-progress-overlay",o.innerHTML=`
    <div class="batch-progress-text">Deleting <span id="batch-current">0</span> / ${e}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(o);let s=0;for(const i of n)try{await $i(i),s++,document.getElementById("batch-current").textContent=s,document.getElementById("batch-progress-fill").style.width=`${s/e*100}%`}catch(r){console.error(`Failed to delete image ${i}:`,r)}document.body.removeChild(o),ot=!1,O.clear(),await Dn(),Sn(),alert(`${s} of ${e} image${s>1?"s":""} deleted successfully.`)}function yl(e){In=e,Re=[],It=!0;const t=document.getElementById("preset-selector"),n=t.querySelector(".preset-selector-header h3");n.innerHTML='Select Presets <span id="multi-preset-count" style="font-size: 12px; color: #666;">(0 selected)</span>';let o=document.getElementById("multi-preset-controls");if(!o){o=document.createElement("div"),o.id="multi-preset-controls",o.style.cssText="padding: 0 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; gap: 8px; justify-content: space-between; align-items: stretch;",o.innerHTML=`
      <button id="multi-preset-apply" class="batch-control-button" style="background: #4CAF50; color: white;">Apply Selected</button>
      <button id="multi-preset-cancel" class="batch-control-button">Cancel</button>
    `;const s=document.getElementById("preset-filter"),i=document.getElementById("preset-list");s.parentNode.insertBefore(o,s),s.parentNode.insertBefore(s,i)}o.style.display="flex",on(),Gi(),t.style.display="flex",Ne=!0,W=0,pt(),document.getElementById("multi-preset-apply").onclick=fl,document.getElementById("multi-preset-cancel").onclick=zi}function Gi(){document.getElementById("preset-list").querySelectorAll(".preset-item").forEach(o=>{const s=o.querySelector(".preset-name").textContent;Re.some(r=>r.name===s)?(o.style.background="#e8f5e9",o.style.border="2px solid #4CAF50"):(o.style.background="",o.style.border="")});const n=document.getElementById("multi-preset-count");n&&(n.textContent=`(${Re.length} selected)`)}function zi(){It=!1,In=null,Re=[];const e=document.getElementById("multi-preset-controls");e&&(e.style.display="none");const t=document.querySelector(".preset-selector-header h3");t.textContent="Select Preset",Bn()}async function fl(){if(Re.length===0){alert("Please select at least one preset");return}if(!In){alert("No image selected");return}const e=P.find(s=>s.id===In);if(!e){alert("Image not found");return}const t=[...Re];zi();const n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`
    <div class="batch-progress-text">Applying preset <span id="batch-current">0</span> / ${t.length}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(n);let o=0;for(const s of t)try{const i=Un(s.message,s.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:i,pluginId:"com.r1.pixelart",imageBase64:e.imageBase64})),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=`${o/t.length*100}%`,await new Promise(r=>setTimeout(r,3e3))}catch(i){console.error(`Failed to apply preset ${s.name}:`,i)}document.body.removeChild(n),alert(`${o} preset${o>1?"s":""} applied successfully!`)}function pl(){const e=document.getElementById("viewer-image"),t=document.querySelector(".image-viewer-container");let n=0,o=0,s=0,i=0,r=!1;t.addEventListener("touchstart",l=>{l.touches.length===2?(l.preventDefault(),mn=!0,di=hi(l.touches[0],l.touches[1]),ui=he):l.touches.length===1&&he>1&&(r=!0,s=l.touches[0].clientX-n,i=l.touches[0].clientY-o)},{passive:!1}),t.addEventListener("touchmove",l=>{if(mn&&l.touches.length===2){l.preventDefault();const u=hi(l.touches[0],l.touches[1])/di;he=Math.max(1,Math.min(ui*u,5)),e.style.transform=`scale(${he}) translate(${n}px, ${o}px)`}else r&&l.touches.length===1&&he>1&&(l.preventDefault(),n=l.touches[0].clientX-s,o=l.touches[0].clientY-i,e.style.transform=`scale(${he}) translate(${n}px, ${o}px)`)},{passive:!1}),t.addEventListener("touchend",l=>{l.touches.length<2&&(mn=!1),l.touches.length===0&&(r=!1,he===1&&(n=0,o=0,e.style.transform="scale(1) translate(0, 0)"))}),t.addEventListener("touchcancel",()=>{mn=!1,r=!1})}function hi(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function Rt(){if(!U)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),oe=Math.max(0,Math.min(oe,t.length-1));const n=t[oe];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=parseInt(n.dataset.index),s=m[o],i=document.getElementById("menu-category-hint");i&&s&&s.category?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const d=document.createElement("span");if(d.textContent=r,d.style.cursor="pointer",d.style.padding="0 2px",je===r&&(d.style.textDecoration="underline",d.style.fontWeight="bold"),d.onclick=u=>{u.stopPropagation(),je===r?je="":je=r,oe=0,Ae()},i.appendChild(d),l<s.category.length-1){const u=document.createElement("span");u.textContent=", ",i.appendChild(u)}})):i&&(i.style.display="none")}}function hl(){if(!U||!it)return;const e=document.getElementById("menu-styles-list");!e||e.querySelectorAll(".style-item").length===0||(oe=Math.max(0,oe-1),Rt())}function El(){if(!U||!it)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(oe=Math.min(t.length-1,oe+1),Rt())}function Il(){if(!U||!it)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||oe>=t.length)return;const n=t[oe];if(n&&n.querySelector(".style-name")){const i=sn()[oe];if(i){const r=m.findIndex(l=>l===i);r!==-1&&(b=r,de(),Po())}}}async function bl(){await De.init(),await we.init();const t=(await we.loadImportedPresets()).length>0,o=(await De.getAllModifications()).length>0;t||o?m=await xo():(m=[],setTimeout(()=>{confirm("Welcome! You should import presets to get started. Would you like to import now?")&&(document.getElementById("menu-button").click(),setTimeout(()=>{document.getElementById("settings-menu-button").click(),setTimeout(()=>{document.getElementById("import-presets-button").click()},100)},100))},500));const s=localStorage.getItem(go);if(s)try{const d=JSON.parse(s).filter(u=>u.internal===!1);for(const u of d)await De.saveNewPreset(u),m.find(g=>g.name===u.name)||m.push(u);localStorage.removeItem(go)}catch(l){console.error("Error loading styles:",l)}const i=localStorage.getItem(Hi);if(i)try{ze=JSON.parse(i),Array.isArray(ze)||(ze=[])}catch(l){console.error("Error parsing favorite styles:",l),ze=[]}wl(),Sl();const r=localStorage.getItem(Fi);if(r)try{x=JSON.parse(r),Array.isArray(x)||(x=[])}catch{console.error("Error parsing visible presets:",error),x=[]}x.length===0&&m.length>0&&(x=m.map(l=>l.name),xe()),wt()}async function xo(){const e=await De.getAllModifications(),t=new Set,n=new Map,o=[];for(const l of e)l.type==="deletion"?t.add(l.name):l.type==="modification"?n.set(l.name,l.data):l.type==="new"&&o.push(l.data);const s=await we.loadImportedPresets();kt=s.length>0;let i;if(kt)i=s;else{if(Bt.length===0){const l=await fetch("./presets.json");l.ok?(Zn=await l.json(),Bt=[...Zn]):(Zn=[],Bt=[])}i=Bt}return[...i.filter(l=>!t.has(l.name)).map(l=>n.has(l.name)?{...l,...n.get(l.name)}:{...l}),...o]}function xe(){try{localStorage.setItem(Fi,JSON.stringify(x))}catch(e){console.error("Error saving visible presets:",e)}}function vl(){return m.filter(e=>x.includes(e.name))}function Bl(e){try{localStorage.setItem(xi,e.toString())}catch(t){console.error("Error saving resolution:",t)}}function Sl(){try{const e=localStorage.getItem(xi);if(e!==null){const t=parseInt(e,10);t>=0&&t<Zt.length&&(Je=t)}}catch(e){console.error("Error loading resolution:",e)}}function Xt(){const t=m.filter(s=>x.includes(s.name)).slice().sort((s,i)=>s.name.localeCompare(i.name)),n=t.filter(s=>At(s.name)),o=t.filter(s=>!At(s.name));return{favorites:n,regular:o}}function sn(){const{favorites:e,regular:t}=Xt(),n=e.filter(s=>x.includes(s.name)),o=t.filter(s=>x.includes(s.name));return[...n,...o]}function Ji(){const e=sn(),t=m[b];return e.findIndex(n=>n===t)}function Yi(e){const n=sn()[e];return m.findIndex(o=>o===n)}function Nn(){try{const e=m.filter(t=>t.internal===!1);localStorage.setItem(go,JSON.stringify(e))}catch(e){console.error("Error saving styles:",e)}}function xl(e){const t=ze.indexOf(e);t>-1?ze.splice(t,1):ze.push(e),localStorage.setItem(Hi,JSON.stringify(ze));const n=document.querySelector(".styles-menu-scroll-container"),o=n?n.scrollTop:0;Ae(),n&&(n.scrollTop=o)}function wl(){const e=localStorage.getItem(Li);if(e!==null)try{const t=parseInt(e,10);t>=0&&t<m.length&&(b=t)}catch(t){console.error("Error loading last used style:",t)}}function At(e){return ze.includes(e)}function wo(){const e=m.filter(o=>!o.internal&&At(o.name));if(e.length>0){const o=e[Math.floor(Math.random()*e.length)];return m.findIndex(s=>s===o)}const t=m.filter(o=>!o.internal);if(t.length===0)return 0;const n=t[Math.floor(Math.random()*t.length)];return m.findIndex(o=>o===n)}function Qi(){ce=!ce;const e=document.getElementById("motion-toggle");if(ce)e.classList.add("active"),e.title="Motion Detection: ON",v.textContent=`Motion Detection mode ON ‚Ä¢ ${m[b].name}`,Z("üëÅÔ∏è Motion Detection");else{e.classList.remove("active"),e.title="Motion Detection: OFF",Lo(),$t&&(clearInterval($t),$t=null);const t=document.getElementById("timer-countdown");t&&(t.style.display="none",t.classList.remove("countdown-fade-in","countdown-fade-out"));const n=document.getElementById("camera-button");n&&R.length>1&&(n.style.display="flex"),m&&m[b]&&(v.textContent=`Style: ${m[b].name}`,Z(m[b].name))}}function Tl(){for(let e in Jt)if(Jt[e].seconds===Pt)return parseInt(e);return 1}function Cl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("motion-submenu").style.display="flex",kn=!0,ee=!1}function Ll(){document.getElementById("motion-submenu").style.display="none",kn=!1,qe()}function Ml(){document.getElementById("settings-submenu").style.display="none",document.getElementById("visible-presets-submenu").style.display="flex",U=!1,Xe=!0,nn=!0,ee=!1,ae=0,Qt="",document.getElementById("visible-presets-filter").value="",xt(),wt()}function Pl(){document.getElementById("visible-presets-submenu").style.display="none",Xe=!1,nn=!1,ae=0,Qt="",ut="";const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none"),qe()}function Xi(){document.getElementById("settings-submenu").style.display="none",document.getElementById("preset-builder-submenu").style.display="flex",U=!1,ee=!1,Dt=!0,qn()}function To(){document.getElementById("preset-builder-submenu").style.display="none",Dt=!1,Pe=-1;const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none"),qe()}function qn(){Pe=-1,document.getElementById("preset-builder-name").value="",document.getElementById("preset-builder-category").value="",document.getElementById("preset-builder-template").value="",document.getElementById("preset-builder-prompt").value="";const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none");const t=document.getElementById("preset-builder-clear");t&&(t.style.display="flex"),document.querySelectorAll(".chip-section-content").forEach(n=>{n.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(n=>{n.classList.remove("expanded")})}function kl(e){const t=m[e];Xi(),Pe=e,setTimeout(()=>{const n=document.getElementById("preset-builder-name"),o=document.getElementById("preset-builder-category"),s=document.getElementById("preset-builder-prompt"),i=document.getElementById("preset-builder-template"),r=document.getElementById("preset-builder-delete"),l=document.getElementById("preset-builder-clear");n&&(n.value=t.name),o&&(o.value=t.category?t.category.join(", "):""),s&&(s.value=t.message),i&&(i.value=""),r&&(r.style.display="flex"),l&&(l.style.display="none")},100)}function Al(){const e=document.getElementById("preset-builder-template"),t=document.getElementById("preset-builder-prompt"),n=e.value;n&&mi[n]!==void 0&&(t.value=mi[n])}function Dl(){const e=new Set;return m.forEach(t=>{t.category&&Array.isArray(t.category)&&t.category.forEach(n=>{e.add(n.toUpperCase())})}),Array.from(e).sort()}function Rl(){const e=document.getElementById("preset-builder-name").value.trim(),t=document.getElementById("preset-builder-category").value.trim(),n=document.getElementById("preset-builder-prompt").value.trim();if(!e){alert("Please enter a preset name");return}if(!n){alert("Please enter a prompt");return}const o=t?t.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):["CUSTOM"];if(Pe>=0){const s=m[Pe].name;if(m[Pe]={name:e.toUpperCase(),category:o,message:n,internal:!1},s!==e.toUpperCase()){const i=x.indexOf(s);i>-1&&(x[i]=e.toUpperCase())}}else{const s=m.findIndex(r=>r.name.toUpperCase()===e.toUpperCase());if(s!==-1){if(!confirm(`A preset named "${e}" already exists. Do you want to overwrite it?`))return;m.splice(s,1)}const i={name:e.toUpperCase(),category:o,message:n,internal:!1};m.push(i),x.includes(i.name)||x.push(i.name)}xe(),Nn(),alert(Pe>=0?`Preset "${e}" updated!`:`Preset "${e}" saved successfully!`),qn(),To(),U&&Ae()}function Ol(){if(Pe<0){alert("No preset selected for deletion");return}const e=m[Pe];if(e.internal!==!1){alert("Cannot delete built-in presets");return}if(!confirm(`Delete preset "${e.name}"? This cannot be undone.`))return;m.splice(Pe,1);const t=x.indexOf(e.name);t>-1&&(x.splice(t,1),xe()),b>=m.length&&(b=m.length-1),Nn(),alert(`Preset "${e.name}" deleted successfully!`),qn(),To(),U&&Ae()}function xt(){const e=document.getElementById("visible-presets-list");e.innerHTML="";const o=m.filter(r=>!r.internal).filter(r=>{if(Qt){const l=Qt.toLowerCase(),d=r.category&&r.category.some(g=>g.toLowerCase().includes(l));if(!(r.name.toLowerCase().includes(l)||d))return!1}return ut?r.category&&r.category.includes(ut):!0}).sort((r,l)=>r.name.localeCompare(l.name)),s=document.createDocumentFragment();o.forEach(r=>{const l=document.createElement("div");l.className="style-item",l.dataset.presetName=r.name;const d=document.createElement("input");d.type="checkbox",d.className="master-prompt-checkbox",d.checked=x.includes(r.name),d.style.marginRight="3vw";const u=document.createElement("span");u.className="style-name",u.textContent=r.name,l.appendChild(d),l.appendChild(u),d.onclick=g=>{g.stopPropagation(),Ei(r.name,d.checked)},l.onclick=()=>{d.checked=!d.checked,Ei(r.name,d.checked)},s.appendChild(l)}),e.appendChild(s);const i=document.getElementById("visible-presets-count");if(i){const r=o.filter(l=>x.includes(l.name)).length;i.textContent=r}setTimeout(()=>{Wt()},50)}function Ei(e,t){const n=x.indexOf(e);t&&n===-1?x.push(e):!t&&n>-1&&x.splice(n,1),xe(),wt(),xt();const o=document.getElementById("styles-count");if(o){const{favorites:s,regular:i}=Xt(),r=s.length+i.length;o.textContent=r}U&&Ae()}function wt(){const e=document.getElementById("current-visible-presets-display");if(e){const t=m.filter(o=>!o.internal).length,n=x.length;e.textContent=n===t?"All Visible":`${n} of ${t}`}}function Nl(){if(!Xe||!nn)return;const e=document.getElementById("visible-presets-list");!e||e.querySelectorAll(".style-item").length===0||(ae=Math.max(0,ae-1),Wt())}function ql(){if(!Xe||!nn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(ae=Math.min(t.length-1,ae+1),Wt())}function Wt(){if(!Xe)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),ae=Math.max(0,Math.min(ae,t.length-1));const n=t[ae];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.dataset.presetName,s=m.find(r=>r.name===o),i=document.getElementById("visible-presets-category-hint");i&&s&&s.category?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const d=document.createElement("span");if(d.textContent=r,d.style.cursor="pointer",d.style.padding="0 2px",ut===r&&(d.style.textDecoration="underline",d.style.fontWeight="bold"),d.onclick=u=>{u.stopPropagation(),ut===r?ut="":ut=r,ae=0,xt()},i.appendChild(d),l<s.category.length-1){const u=document.createElement("span");u.textContent=", ",i.appendChild(u)}})):i&&(i.style.display="none")}}function _l(){if(!Xe||!nn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||ae>=t.length)return;const n=t[ae];n&&n.click()}function Wi(){const e=["Very Low","Low","Medium","High","Very High"],t=document.getElementById("current-motion-display");if(t){const n=Math.floor((50-Lt)/10)+1,o=Math.max(1,Math.min(5,n));t.textContent=`Sensitivity: ${e[o-1]}`}}function gn(){const e={motionThreshold:Lt,motionPixelThreshold:bo,motionContinuousEnabled:ft,motionCooldown:Mt,motionStartDelay:Pt};try{localStorage.setItem(Ri,JSON.stringify(e))}catch(t){console.error("Failed to save motion settings:",t)}}function Hl(){try{const e=localStorage.getItem(Ri);if(e){const t=JSON.parse(e);Lt=t.motionThreshold||30,bo=t.motionPixelThreshold||.1,ft=t.motionContinuousEnabled!==void 0?t.motionContinuousEnabled:!0,Mt=t.motionCooldown||2,Pt=t.motionStartDelay||3}{const t=document.getElementById("motion-sensitivity-slider");if(t){const r=Math.floor((50-Lt)/10)+1;t.value=Math.max(1,Math.min(5,r))}const n=document.getElementById("motion-continuous-enabled");n&&(n.checked=ft);const o=document.getElementById("motion-cooldown-slider");o&&(o.value=Mt);const s=document.getElementById("motion-start-delay-slider"),i=document.getElementById("motion-start-delay-value");if(s&&i){const r=Tl();s.value=r,i.textContent=Jt[r].label}Wi()}}catch(e){console.error("Failed to load motion settings:",e)}}function Fl(){ie=!ie;const e=document.getElementById("no-magic-status");e&&(e.textContent=ie?"Enabled":"Disabled",e.style.color=ie?"#4CAF50":"",e.style.fontWeight=ie?"600":"");try{localStorage.setItem(Oi,JSON.stringify(ie))}catch(t){console.error("Failed to save No Magic mode:",t)}ie?showStatus("No Magic Mode ON - Camera only",2e3):showStatus("No Magic Mode OFF - AI prompts enabled",2e3)}function $l(){try{const e=localStorage.getItem(Oi);if(e!==null){ie=JSON.parse(e);const t=document.getElementById("no-magic-status");t&&(t.textContent=ie?"Enabled":"Disabled",t.style.color=ie?"#4CAF50":"",t.style.fontWeight=ie?"600":"")}}catch(e){console.error("Failed to load No Magic mode:",e)}}function Ul(){const e=localStorage.getItem(wi);e!==null&&(Tt=parseInt(e,10)),Ki()}function Vl(){localStorage.setItem(wi,Tt.toString()),Ki()}function Ki(){const e=document.getElementById("current-import-resolution-display");if(e){const t=Io[Tt];e.textContent=t.name.split(" ")[0]}}function jl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("tutorial-submenu").style.display="flex",U=!1,Et=!0,Se=0,ee=!1,Zi()}function Gl(){document.getElementById("tutorial-submenu").style.display="none",Et=!1,qe()}function zl(e){const t=document.getElementById("tutorial-glossary"),n=document.getElementById("tutorial-content-area"),o=document.getElementById("section-"+e),s=document.getElementById("back-to-glossary");t&&n&&o&&(t.style.display="none",n.style.display="flex",s&&(s.style.display="block"),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"start"})},100))}function Zi(){const e=document.getElementById("tutorial-glossary"),t=document.getElementById("tutorial-content-area"),n=document.getElementById("back-to-glossary");e&&t&&(t.style.display="none",e.style.display="block",n&&(n.style.display="none"),Se=0,setTimeout(()=>{Co()},50))}function Jl(){if(!Et)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Se=(Se-1+o.length)%o.length,Co();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.max(0,n.scrollTop-80))}function Yl(){if(!Et)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Se=(Se+1)%o.length,Co();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+80))}function Co(){const e=document.getElementById("tutorial-glossary");if(!e)return;const t=e.querySelectorAll(".glossary-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),Se>=0&&Se<t.length)){const n=t[Se];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Ql(){document.getElementById("settings-submenu").style.display="none";const e=document.getElementById("import-resolution-submenu"),t=document.getElementById("import-resolution-list");t.innerHTML="",Io.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Tt&&s.classList.add("selected"),s.textContent=n.name,s.onclick=()=>{Tt=o,Vl(),er()},t.appendChild(s)}),e.style.display="flex"}function er(){document.getElementById("import-resolution-submenu").style.display="none",document.getElementById("settings-submenu").style.display="flex"}function yo(){!h||!I||(Ve=null,un=!1,fn=setInterval(()=>{if(!ce||un||!ft&&H.style.display==="block")return;Xl()&&(console.log("Motion detected! Capturing..."),ho(),un=!0,setTimeout(()=>{if(un=!1,Ve=null,H.style.display==="block"&&(H.style.display="none",h.style.display="block"),!ft){Lo(),ce=!1;const t=document.getElementById("motion-toggle");t.classList.remove("active"),t.title="Motion Detection: OFF",showStatus("Motion capture complete - Press eye button to reactivate",3e3),m&&m[b]&&Z(m[b].name)}},Mt*1e3))},500))}function Lo(){fn&&(clearInterval(fn),fn=null),Ve=null}function Xl(){if(!h||!I)return!1;const e=I.getContext("2d"),t=320,n=240;I.width=t,I.height=n,e.drawImage(h,0,0,t,n);const o=e.getImageData(0,0,t,n);if(!Ve)return Ve=o,!1;let s=0;const i=t*n;for(let l=0;l<o.data.length;l+=4){const d=Math.abs(o.data[l]-Ve.data[l]),u=Math.abs(o.data[l+1]-Ve.data[l+1]),g=Math.abs(o.data[l+2]-Ve.data[l+2]);(d+u+g)/3>Lt&&s++}return Ve=o,s/i>bo}function tr(){Me=!Me;const e=document.getElementById("random-toggle");Me?(e.classList.add("random-active"),v.textContent=`Random mode ON ‚Ä¢ ${m[b].name}`,Z("üé≤ Random Mode")):(e.classList.remove("random-active"),de(),m&&m[b]&&Z(m[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"random_mode_toggled",enabled:Me,timestamp:Date.now()}))}function Wl(){try{const e=localStorage.getItem(_i);e&&(L=JSON.parse(e))}catch(e){console.error("Error loading queue:",e),L=[]}}function rn(){try{localStorage.setItem(_i,JSON.stringify(L))}catch(e){console.error("Error saving queue:",e)}}function so(){dt&&(Ie?(dt.className="connection-status online",dt.querySelector("#connection-text").textContent="Online"):(dt.className="connection-status offline",dt.querySelector("#connection-text").textContent="Offline"),dt.style.display="block"),Ot()}function Ot(){if(St){const e=L.length;St.querySelector("#queue-count").textContent=e,St.style.display=e>0?"block":"none"}if(ke){const e=L.length;ke.querySelector("#sync-count").textContent=e,ke.style.display=e>0&&Ie?"block":"none"}}function Kl(){window.addEventListener("online",()=>{Ie=!0,so(),console.log("Connection restored"),L.length>0&&!gt&&setTimeout(()=>{v.textContent=`Connection restored! Syncing ${L.length} photos...`,Kt()},1e3)}),window.addEventListener("offline",()=>{Ie=!1,so(),console.log("Connection lost"),gt&&(v.textContent="Connection lost during sync")}),so()}async function Zl(){try{return R=(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"),console.log("Available cameras:",R.length),R}catch(e){return console.error("Error enumerating cameras:",e),[]}}function _n(){const e=Zt[Je];if(R.length===0)return{video:{facingMode:"environment",width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};const n={video:{deviceId:{exact:R[re].deviceId},width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};return yt()&&(n.video.advanced=[{zoom:1}]),n}async function ea(e){if(!(e===Je||!A)){Je=e,Bl(e);try{v.textContent="Changing resolution...",A&&A.getTracks().forEach(n=>n.stop());const t=_n();A=await navigator.mediaDevices.getUserMedia(t),h.srcObject=A,V=A.getVideoTracks()[0],await new Promise(n=>{h.onloadedmetadata=async()=>{try{await h.play(),Hn(),await Nt(K),setTimeout(n,100)}catch(o){console.error("Video play error:",o),n()}}}),de(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"resolution_changed",resolution:Zt[Je].name,timestamp:Date.now()}))}catch(t){console.error("Resolution change error:",t),v.textContent="Resolution change failed"}}}function fo(){if(R.length===0)return"Default Camera";const e=R[re];let t=e.label;return!t||t===""?e.deviceId?t=`Camera ${re+1}`:t="Unknown Camera":(t=t.replace(/\([^)]*\)/g,"").trim(),t.toLowerCase().includes("front")?t="Front Camera":t.toLowerCase().includes("back")||t.toLowerCase().includes("rear")?t="Back Camera":t.length>20&&(t=t.substring(0,17)+"...")),t}function yt(){if(R.length===0)return!1;const e=R[re];if(!e)return!1;const t=e.label.toLowerCase();return e.facingMode==="user"?!0:e.facingMode==="environment"?!1:t.includes("front")||t.includes("user")||t.includes("selfie")||t.includes("face")?!0:t.includes("back")||t.includes("rear")||t.includes("environment")?!1:R.length===2?re===1:re>0}function Hn(){try{yt()?(h.style.transform="translateZ(0)",h.style.webkitTransform="translateZ(0)"):(h.style.transform="scaleX(-1) translateZ(0)",h.style.webkitTransform="scaleX(-1) translateZ(0)")}catch(e){console.warn("Mirror transform skipped:",e)}}function ta(){if(!V)return!1;const e=V.getCapabilities();return e&&"zoom"in e}function nr(){if(!V)return{min:1,max:5,step:.1};const e=V.getCapabilities();return e&&e.zoom?{min:Math.min(e.zoom.min||1,1),max:Math.max(e.zoom.max||5,5),step:e.zoom.step||.1}:{min:1,max:5,step:.1}}async function Nt(e){if(V)try{if(ta()){const t=nr(),n=Math.max(t.min,Math.min(e,t.max)),o={advanced:[{zoom:n}]},s=V.getCapabilities();s&&s.focusMode&&s.focusMode.includes("continuous")&&(o.advanced[0].focusMode="continuous"),await V.applyConstraints(o),K=n,yt()?(h.style.transform="translateZ(0)",h.style.webkitTransform="translateZ(0)"):(h.style.transform="scaleX(-1) translateZ(0)",h.style.webkitTransform="scaleX(-1) translateZ(0)")}else{const t=Math.max(1,Math.min(e,5));K=t,yt()?(h.style.transform=`scale(${t})`,h.style.webkitTransform=`scale(${t})`):(h.style.transform=`scaleX(-1) scale(${t})`,h.style.webkitTransform=`scaleX(-1) scale(${t})`)}}catch{const n=Math.max(1,Math.min(e,5));K=n,yt()?(h.style.transform=`scale(${n})`,h.style.webkitTransform=`scale(${n})`):(h.style.transform=`scaleX(-1) scale(${n})`,h.style.webkitTransform=`scaleX(-1) scale(${n})`)}}async function na(){if(V)try{const e=V.getCapabilities();e&&e.focusMode&&(e.focusMode.includes("single-shot")?(await V.applyConstraints({advanced:[{focusMode:"single-shot",zoom:K}]}),console.log("Triggered single-shot focus"),setTimeout(async()=>{try{await V.applyConstraints({advanced:[{focusMode:"continuous",zoom:K}]})}catch(t){console.log("Could not return to continuous focus:",t)}},500)):e.focusMode.includes("manual")&&(await V.applyConstraints({advanced:[{focusMode:"manual",zoom:K}]}),console.log("Triggered manual focus")))}catch(e){console.log("Focus adjustment not supported or failed:",e)}}async function oa(){if(eo||R.length<=1){console.log("Cannot switch camera: loading or not enough cameras");return}eo=!0;try{v.textContent="Switching camera...",A&&A.getTracks().forEach(t=>t.stop()),re=(re+1)%R.length,console.log(`Switching to camera ${re+1} of ${R.length}`);const e=_n();A=await navigator.mediaDevices.getUserMedia(e),h.srcObject=A,V=A.getVideoTracks()[0],await new Promise(t=>{h.onloadedmetadata=async()=>{try{await h.play(),Hn(),await Nt(K),setTimeout(t,100)}catch(n){console.error("Video play error:",n),t()}}}),de(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"camera_switched",cameraIndex:re,cameraLabel:fo(),timestamp:Date.now()}))}catch(e){console.error("Camera switch error:",e),v.textContent="Camera switch failed",re=(re-1+R.length)%R.length}finally{eo=!1}}function sa(){try{const e=localStorage.getItem(Ti);if(e){const t=JSON.parse(e);$=t.count||5;const n=t.speed||2;en=Ct[n].delay}}catch(e){console.error("Error loading burst settings:",e)}}function Ii(e,t){try{localStorage.setItem(Ti,JSON.stringify({count:e,speed:t}))}catch(n){console.error("Error saving burst settings:",n)}}function or(){ye=!ye;const e=document.getElementById("burst-toggle");ye?(e.classList.add("burst-active"),v.textContent=`Burst mode ON (${$} photos) ‚Ä¢ ${m[b].name}`,Z("üì∏ Burst Mode")):(e.classList.remove("burst-active"),de(),m&&m[b]&&Z(m[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_mode_toggled",enabled:ye,count:$,timestamp:Date.now()}))}function sr(){fe=!fe;const e=document.getElementById("timer-toggle");fe?(e.classList.add("timer-active"),v.textContent=`Timer mode ON (${Oe}s delay) ‚Ä¢ ${m[b].name}`,Z("‚è±Ô∏è Timer Mode")):(e.classList.remove("timer-active"),Ye&&(clearInterval(Ye),Ye=null,document.getElementById("timer-countdown").style.display="none"),de(),m&&m[b]&&Z(m[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"timer_mode_toggled",enabled:fe,delay:Oe,timestamp:Date.now()}))}function po(e){let t=Oe;const n=document.getElementById("timer-countdown"),o=document.getElementById("timer-countdown-text");o.textContent=t,n.style.display="flex",n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),v.textContent=`Timer: ${t}s...`,Ye=setInterval(()=>{t--,t>0?(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{o.textContent=t,n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),v.textContent=`Timer: ${t}s...`},500)):(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{n.style.display="none",n.classList.remove("countdown-fade-out"),clearInterval(Ye),Ye=null,e(),ht&&fe&&(setTimeout(()=>{if(H.style.display==="block"){H.style.display="none",h.style.display="block";const s=document.getElementById("camera-button");s&&R.length>1&&(s.style.display="flex")}},500),setTimeout(()=>{fe&&po(e)},me*1e3))},500))},1e3)}function ir(){Ye&&(clearInterval(Ye),Ye=null,document.getElementById("timer-countdown").style.display="none",de())}function ia(){try{const e=localStorage.getItem(Ci);if(e){const t=JSON.parse(e);Oe=t.delay||10,ht=t.repeat||!1,me=t.repeatInterval||1}}catch(e){console.error("Error loading timer settings:",e)}}function io(){try{localStorage.setItem(Ci,JSON.stringify({delay:Oe,repeat:ht,repeatInterval:me}))}catch(e){console.error("Error saving timer settings:",e)}}function jt(){const e=document.getElementById("current-timer-display");if(e){const t=ht?`Repeat (${Pi[ra()].label})`:"No Repeat";e.textContent=`${Oe}s, ${t}`}}function ra(){for(const[e,t]of Object.entries(Pi))if(t.seconds===me)return parseInt(e);return 1}async function bi(){if(!(!A||to||H.style.display==="block")){to=!0,v.textContent=`Burst mode: Taking ${$} photos...`;for(let e=0;e<$;e++)v.textContent=`Burst ${e+1}/${$}...`,la(e+1),e<$-1&&await new Promise(t=>setTimeout(t,en));to=!1,v.textContent=`Burst complete! ${$} photos saved.`,Ie&&!gt?setTimeout(()=>{Kt()},500):Ie||(v.textContent=`Burst complete! ${$} photos queued (offline).`),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_complete",count:$,timestamp:Date.now()})),setTimeout(()=>{ye?v.textContent=`Burst mode ON (${$} photos) ‚Ä¢ ${m[b].name}`:de()},2e3)}}function la(e){if(!A)return;Me&&(b=wo()),(I.width!==h.videoWidth||I.height!==h.videoHeight)&&(I.width=h.videoWidth,I.height=h.videoHeight);const t=I.getContext("2d",{willReadFrequently:!1,alpha:!1});t.clearRect(0,0,I.width,I.height);const n=I.width/K,o=I.height/K,s=(I.width-n)/2,i=(I.height-o)/2;if(yt())t.drawImage(h,s,i,n,o,0,0,I.width,I.height);else{t.save(),t.scale(-1,1),t.drawImage(h,s,i,n,o,-I.width,0,I.width,I.height),t.restore();const g=document.createElement("canvas");g.width=I.width,g.height=I.height;const E=g.getContext("2d");E.scale(-1,1),E.drawImage(I,-I.width,0),t.clearRect(0,0,I.width,I.height),t.drawImage(g,0,0)}const r=Je>=2?.7:.8,l=I.toDataURL("image/jpeg",r),d=m[b];Ui(l);const u={id:Date.now().toString()+"-"+e,imageBase64:l,preset:d,timestamp:Date.now()};L.push(u),rn(),Ot()}async function aa(){try{h=document.getElementById("video"),I=document.getElementById("canvas"),H=document.getElementById("captured-image"),v=document.getElementById("status"),En=document.getElementById("reset-button");const e=document.getElementById("start-screen");if(e){const r=e.querySelector(".start-text");r&&(r.textContent="Requesting camera access...");const l=document.getElementById("start-button");l&&(l.disabled=!0)}if(await Zl(),R.length>1){const r=R.findIndex(l=>{const d=l.label.toLowerCase();return d.includes("back")||d.includes("rear")||d.includes("environment")});re=r!==-1?r:R.length-1}else re=0;const t=_n();A=await navigator.mediaDevices.getUserMedia(t),h.srcObject=A,V=A.getVideoTracks()[0],console.log("Camera initialized:",fo()),Wl(),Kl(),await new Promise(r=>{h.onloadedmetadata=async()=>{try{await h.play(),Hn(),Nt(1),setTimeout(r,100)}catch(l){console.error("Video play error:",l),r()}}}),document.getElementById("start-screen").remove(),document.getElementById("camera-container").style.display="flex",v.style.display="block";const n=document.getElementById("camera-button");R.length>1&&(n.style.display="flex");const o=document.getElementById("menu-button");o&&(o.style.display="flex");const s=document.getElementById("mode-carousel");s&&(s.style.display="block");const i=document.getElementById("gallery-button");i&&(i.style.display="flex"),de(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_ready",availableCameras:R.length,currentCamera:fo(),timestamp:Date.now()}))}catch(e){console.error("Camera access error:",e),v.textContent="Camera access denied";const t=document.getElementById("start-button");t&&(t.disabled=!1);const n=document.getElementById("start-screen");n&&(n.style.display="block"),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_error",error:e.message,timestamp:Date.now()}))}}function rt(){A&&h&&(A.getTracks().forEach(e=>{e.stop()}),h.style.display="none",h.srcObject=null)}async function rr(){if(h)try{const e=_n();A=await navigator.mediaDevices.getUserMedia(e),h.srcObject=A,V=A.getVideoTracks()[0],await new Promise(t=>{h.onloadedmetadata=async()=>{try{await h.play(),Hn(),await Nt(K),setTimeout(t,100)}catch(n){console.error("Video resume error:",n),t()}}}),h.style.display="block"}catch(e){console.error("Failed to resume camera:",e),v.textContent="Camera resume failed"}}function ho(){if(!A)return;Me&&(b=wo(),Z(m[b].name)),(I.width!==h.videoWidth||I.height!==h.videoHeight)&&(I.width=h.videoWidth,I.height=h.videoHeight);const e=I.getContext("2d",{willReadFrequently:!1,alpha:!1,desynchronized:!0});e.clearRect(0,0,I.width,I.height);const t=I.width/K,n=I.height/K,o=(I.width-t)/2,s=(I.height-n)/2;if(yt())e.drawImage(h,o,s,t,n,0,0,I.width,I.height);else{e.save(),e.scale(-1,1),e.drawImage(h,o,s,t,n,-I.width,0,I.width,I.height),e.restore();const E=document.createElement("canvas");E.width=I.width,E.height=I.height;const B=E.getContext("2d");B.scale(-1,1),B.drawImage(I,-I.width,0),e.clearRect(0,0,I.width,I.height),e.drawImage(E,0,0)}const i=Je>=2?.7:.8,r=I.toDataURL("image/jpeg",i);H.src=r,H.style.display="block",H.style.transform="none",h.style.display="none",Cn(),ce||fe&&ht?En.style.display="none":En.style.display="block";const l=document.getElementById("camera-button");l&&(l.style.display="none");const d=document.getElementById("resolution-button");d&&(d.style.display="none"),Ui(r);const u=m[b],g={id:Date.now().toString(),imageBase64:r,preset:u,timestamp:Date.now()};if(L.push(g),rn(),Ot(),Ie){const E=ie?"Photo saved!":"Photo saved! Uploading...";v.textContent=E,gt||Kt()}else v.textContent=`Photo queued for sync (${L.length} in queue)`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"photo_captured",queued:!0,queueLength:L.length,timestamp:Date.now()}))}async function Kt(){if(L.length===0||gt)return;if(!Ie){v.textContent="Cannot sync - offline";return}gt=!0,ke.disabled=!0,ke.classList.add("syncing"),console.log(`Syncing ${L.length} queued photos...`);const e=L.length;let t=0;for(;L.length>0&&Ie;){const n=L[0];try{if(v.textContent=`Syncing ${t+1}/${e}...`,typeof PluginMessageHandler<"u"&&!ie&&PluginMessageHandler.postMessage(JSON.stringify({message:Un(n.preset.message,n.preset.name),pluginId:"com.r1.pixelart",imageBase64:n.imageBase64})),await new Promise(o=>setTimeout(o,3e3)),Ie)L.shift(),t++,rn(),Ot();else{console.log("Lost connection during sync");break}await new Promise(o=>setTimeout(o,3e3))}catch(o){console.error("Sync error:",o),v.textContent="Sync error - will retry later";break}}if(gt=!1,ke.disabled=!1,ke.classList.remove("syncing"),L.length===0){const n=ie?`All ${t} photos saved!`:`All ${t} photos synced successfully!`;v.textContent=n,setTimeout(()=>{de()},2e3)}else Ie?v.textContent=`Synced ${t}. ${L.length} remaining.`:v.textContent=`Connection lost. ${L.length} photos queued.`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"sync_complete",synced:t,remaining:L.length,timestamp:Date.now()}))}function Mo(){const e=document.getElementById("queue-manager"),t=document.getElementById("queue-list");t.innerHTML="",L.length===0?t.innerHTML=`
      <div class="queue-empty">
        <h4>No Photos in Queue</h4>
        <p>Take photos while offline and they'll appear here for syncing.</p>
      </div>
    `:L.forEach((n,o)=>{const s=document.createElement("div");s.className="queue-item",s.innerHTML=`
        <div class="queue-item-header">
          <span class="queue-item-style">${n.preset.name}</span>
          <span class="queue-item-time">${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <img src="${n.imageBase64}" class="queue-item-preview" alt="Queued photo">
        <div class="queue-item-actions">
          <button onclick="removeFromQueue(${o})" class="delete-button">Remove</button>
          <button onclick="previewQueueItem(${o})" class="secondary">Preview</button>
        </div>
      `,t.appendChild(s)}),e.style.display="flex"}function ca(){document.getElementById("queue-manager").style.display="none"}function da(e){confirm("Remove this photo from the sync queue?")&&(L.splice(e,1),rn(),Ot(),Mo())}function ua(e){const t=L[e];alert(`Style: ${t.preset.name}
Prompt: ${t.preset.message}
Saved: ${new Date(t.timestamp).toLocaleString()}`)}function lr(){confirm("Clear all photos from the queue? This cannot be undone.")&&(L=[],rn(),Ot(),Mo())}window.addEventListener("sideClick",()=>{if(console.log("Side button pressed"),ee){const o=document.getElementById("settings-submenu").querySelectorAll(".menu-section-button");o.length>0&&ve<o.length&&o[ve].click();return}if(Xe){_l();return}if(Et){const n=document.getElementById("tutorial-glossary");if(n&&n.style.display!=="none"){const o=n.querySelectorAll(".glossary-item");o.length>0&&Se<o.length&&o[Se].click()}return}if(tn){const o=document.getElementById("resolution-submenu").querySelectorAll(".resolution-item");o.length>0&&Be<o.length&&o[Be].click();return}if(Ne){rl();return}if(U&&it){Il();return}const e=document.getElementById("start-screen"),t=document.getElementById("start-button");if(e&&e.style.display!=="none")console.log("Simulating tap on start button"),setTimeout(()=>{t.click()},100);else if(H&&H.style.display==="block")Fn();else{if(ce){if(Pt>0){let n=Pt;const o=document.getElementById("timer-countdown"),s=document.getElementById("timer-countdown-text");s.textContent=n,o.style.display="flex",o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),v.textContent=`Motion Detection starting in ${n}s...`,$t=setInterval(()=>{n--,n>0?(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{s.textContent=n,o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),v.textContent=`Motion Detection starting in ${n}s...`},500)):(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{o.style.display="none",o.classList.remove("countdown-fade-out"),clearInterval($t),ce&&h&&h.readyState>=2&&(yo(),showStatus("Motion Detection active - Move in front of camera",3e3))},500))},1e3)}else yo(),showStatus("Motion Detection ON - Move in front of camera",3e3);return}fe?po(ye?()=>bi():()=>ho()):ye?bi():ho()}});window.addEventListener("scrollUp",()=>{var t,n,o,s;if(console.log("Scroll wheel: up"),document.getElementById("style-editor").style.display==="flex"){yi();return}if(Ne){Fr();return}if(we.isImportModalOpen){we.scrollImportUp();return}if(Et){Jl();return}if(Dt){Vi();return}if(Xe){Nl();return}if(U&&it){hl();return}if(kn){Kr();return}if(Pn){Xr();return}if(Mn){Yr();return}if(Ln){zr();return}if(tn){jr();return}if(ee){Ur();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){el();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){nl();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){yi();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){sl();return}if(!A||H.style.display==="block")return;const e=Date.now();e-vn<qi||(vn=e,nt&&clearTimeout(nt),nt=setTimeout(()=>{let i=Ji();const r=sn();i=(i-1+r.length)%r.length,b=Yi(i);const l=m[b];l&&Z(l.name),de(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:m[b].name,timestamp:Date.now()})),nt=null},50))});window.addEventListener("scrollDown",()=>{var t,n,o,s;if(console.log("Scroll wheel: down"),document.getElementById("style-editor").style.display==="flex"){fi();return}if(Ne){$r();return}if(we.isImportModalOpen){we.scrollImportDown();return}if(Et){Yl();return}if(Dt){ji();return}if(Xe){ql();return}if(U&&it){El();return}if(kn){Zr();return}if(Pn){Wr();return}if(Mn){Qr();return}if(Ln){Jr();return}if(tn){Gr();return}if(ee){Vr();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){tl();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){ol();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){fi();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){il();return}if(!A||H.style.display==="block")return;const e=Date.now();e-vn<qi||(vn=e,nt&&clearTimeout(nt),nt=setTimeout(()=>{let i=Ji();const r=sn();i=(i+1)%r.length,b=Yi(i);const l=m[b];l&&Z(l.name),de(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:m[b].name,timestamp:Date.now()})),nt=null},50))});function de(){b=Math.max(0,Math.min(b,m.length-1));const e=m[b];if(V)try{const t={};V.applyConstraints(t)}catch(t){console.error("Error applying preset constraints:",t)}v&&(v.textContent=`Style: ${e.name}`),localStorage.setItem(Li,b.toString()),U&&Rt()}window.onPluginMessage=function(e){console.log("Received plugin message:",e),e&&e.status==="processing"?v.textContent="AI is processing your image...":e&&e.status==="complete"?v.textContent="AI transformation complete!":e&&e.error&&(v.textContent="Error: "+e.error)};typeof PluginMessageHandler<"u"?(console.log("Flutter channel is available"),PluginMessageHandler.postMessage(JSON.stringify({message:"AI Camera Styles initialized",pluginId:"com.r1.pixelart"}))):console.log("Running in development mode - Flutter channel not available");function Fn(){H.style.display="none",ce&&ft||(Lo(),ce&&yo()),H.style.transform="none",h.style.display="block",En.style.display="none";const e=document.getElementById("camera-button");e&&R.length>1&&(e.style.display="flex");const t=document.getElementById("resolution-button");t&&(t.style.display="flex"),setTimeout(()=>{Nt(K)},50),de(),dr()}function vi(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function ma(){const e=document.getElementById("video");e.addEventListener("touchstart",n=>{n.touches.length===2&&(n.preventDefault(),Ht=!0,ai=vi(n.touches[0],n.touches[1]),ci=K)},{passive:!1});let t=null;e.addEventListener("touchmove",n=>{if(Ht&&n.touches.length===2){n.preventDefault();const s=vi(n.touches[0],n.touches[1])/ai,i=ci*s,r=nr(),l=Math.max(r.min,Math.min(i,r.max));t||(Nt(l),t=setTimeout(()=>{t=null},50))}},{passive:!1}),e.addEventListener("touchend",n=>{n.touches.length<2&&(Ht&&na(),Ht=!1,console.log("Pinch ended, current zoom:",K))}),e.addEventListener("touchcancel",()=>{Ht=!1})}function $n(){const e=document.getElementById("unified-menu");H&&H.style.display==="block"&&Fn(),Ae();const t=document.getElementById("styles-count");if(t){const{favorites:n,regular:o}=Xt(),s=n.length+o.length;t.textContent=s}ar(),xn(),wn(),jt(),U=!0,it=!0,rt(),ir(),e.style.display="flex"}async function Po(){U=!1,it=!1,oe=0,tt="",je="",document.getElementById("style-filter").value="";const e=document.getElementById("menu-category-hint");if(e&&(e.style.display="none"),document.getElementById("unified-menu").style.display="none",await rr(),fe||ye||ce||Me){let t="";fe?t="‚è±Ô∏è Timer Mode":ye?t="üì∏ Burst Mode":ce?t="üëÅÔ∏è Motion Detection":Me&&(t="üé≤ Random Mode"),Z(t)}else m&&m[b]&&Z(m[b].name)}function qe(){const e=document.getElementById("settings-submenu"),t=document.getElementById("unified-menu");ar(),xn(),jt(),wn(),t.style.display="none",rt(),e.style.display="flex",U=!1,ee=!0,ve=0,setTimeout(()=>{Bo()},50)}function ga(){document.getElementById("settings-submenu").style.display="none",ee=!1,ve=0,$n()}function ya(){const e=document.getElementById("timer-settings-submenu"),t=document.getElementById("settings-submenu"),n=document.getElementById("timer-delay-slider"),o=document.getElementById("timer-delay-value"),s=document.getElementById("timer-repeat-enabled");if(n&&o){const l=Mi.indexOf(Oe);n.value=l!==-1?l+1:3,o.textContent=Oe}s&&(s.checked=ht);const i=document.getElementById("timer-repeat-interval-input"),r=document.getElementById("timer-repeat-interval-unit");i&&r&&(me>=3600&&me%3600===0?(i.value=me/3600,r.value="3600"):me>=60&&me%60===0?(i.value=me/60,r.value="60"):(i.value=me,r.value="1")),t.style.display="none",rt(),e.style.display="flex",Mn=!0,ee=!1}function fa(){document.getElementById("timer-settings-submenu").style.display="none",Mn=!1,qe()}function pa(){const e=document.querySelector(".styles-menu-scroll-container");e&&(e.scrollTo({top:0,behavior:"smooth"}),oe=0,Rt())}function ha(){const e=document.querySelector(".styles-menu-scroll-container");if(e){e.scrollTo({top:e.scrollHeight,behavior:"smooth"});const t=document.getElementById("menu-styles-list");if(t){const n=t.querySelectorAll(".style-item");n.length>0&&(oe=n.length-1,Rt())}}}function ar(){const e=document.getElementById("current-resolution-display");if(e){const t=Zt[Je];e.textContent=`${t.width}x${t.height}`}}function xn(){const e=document.getElementById("current-burst-display");if(e){let t="Medium";for(const[n,o]of Object.entries(Ct))if(o.delay===en){t=o.label;break}e.textContent=`${$} photos, ${t}`}}function Ea(){document.getElementById("settings-submenu").style.display="none",rt();const e=document.getElementById("resolution-submenu"),t=document.getElementById("resolution-list");t.innerHTML="",Zt.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Je&&s.classList.add("active");const i=document.createElement("span");i.className="resolution-name",i.textContent=n.name,s.appendChild(i),s.onclick=()=>{ea(o),cr()},t.appendChild(s)}),e.style.display="flex",tn=!0,ee=!1,Be=0,setTimeout(()=>{const n=e.querySelectorAll(".resolution-item");So(n)},100)}async function cr(){document.getElementById("resolution-submenu").style.display="none",tn=!1,Be=0,qe()}function Ia(){document.getElementById("settings-submenu").style.display="none",rt();const e=document.getElementById("burst-submenu"),t=document.getElementById("burst-count-slider"),n=document.getElementById("burst-speed-slider"),o=document.getElementById("burst-count-value"),s=document.getElementById("burst-speed-value");if(t&&o&&(t.value=$,o.textContent=$),n&&s){let i=2;for(const[r,l]of Object.entries(Ct))if(l.delay===en){i=parseInt(r);break}n.value=i,s.textContent=Ct[i].label}e.style.display="flex",Ln=!0,ee=!1}async function ba(){document.getElementById("burst-submenu").style.display="none",Ln=!1,qe()}function va(){document.getElementById("settings-submenu").style.display="none",rt();const e=document.getElementById("master-prompt-submenu"),t=document.getElementById("master-prompt-enabled"),n=document.getElementById("master-prompt-text"),o=document.getElementById("master-prompt-char-count");t&&(t.checked=Qe),n&&(n.value=be,n.disabled=!Qe,o&&(o.textContent=be.length)),e.style.display="flex",Pn=!0,ee=!1}async function Ba(){document.getElementById("master-prompt-submenu").style.display="none",Pn=!1,qe()}function Sa(){document.getElementById("settings-submenu").style.display="none",rt();const e=document.getElementById("aspect-ratio-submenu");e.style.display="flex",ee=!1}async function xa(){document.getElementById("aspect-ratio-submenu").style.display="none",qe()}function Bi(){const e=document.getElementById("current-aspect-ratio-display");e&&(e.textContent=le==="none"?"None":le)}function wn(){const e=document.getElementById("current-master-prompt-display");if(e)if(Qe&&be.trim()){const t=be.substring(0,20);e.textContent=`Enabled: ${t}${be.length>20?"...":""}`}else Qe?e.textContent="Enabled (empty)":e.textContent="Disabled"}function yn(){try{localStorage.setItem(ki,be),localStorage.setItem(Ai,Qe.toString()),localStorage.setItem(Di,le)}catch(e){console.error("Failed to save master prompt:",e)}}function wa(){try{const e=localStorage.getItem(ki),t=localStorage.getItem(Ai);e!==null&&(be=e),t!==null&&(Qe=t==="true");const n=localStorage.getItem(Di);if(n){le=n;const o=document.getElementById("aspect-ratio-1-1"),s=document.getElementById("aspect-ratio-16-9");o&&(o.checked=le==="1:1"),s&&(s.checked=le==="16:9");const i=document.getElementById("current-aspect-ratio-display");i&&(i.textContent=le==="none"?"None":le)}}catch(e){console.error("Failed to load master prompt:",e)}}function Ta(){try{const e=localStorage.getItem(Tr);e&&(co=JSON.parse(e))}catch(e){console.error("Failed to load selection history:",e),co={}}}function Ca(e){return e?co[e]||[]:[]}function Un(e,t=""){let n=e;if(Qe&&be.trim()&&(n=`${e} ${be}`),/RANDOM|SELECT|SELECTION|CHOOSE|modulo|LAST DIGIT|LAST TWO DIGITS|LAST THREE DIGITS/i.test(e)){const s=Ca(t),i=Date.now(),r=i%10,l=i%100,d=i%1e3;n+=`

GLOBAL RANDOMIZATION DIRECTIVE (CRITICAL - ABSOLUTE PRIORITY):
- Any section labeled RANDOM, SELECT, or CHOOSE must use the PRE-CALCULATED values below
- These values are MANDATORY - you MUST use them for selection
- Do NOT choose based on popularity, visual interest, or defaults
- Do NOT deviate from the calculated selection

RANDOM SEED: ${i}
LAST DIGIT: ${r}
LAST TWO DIGITS: ${l}
LAST THREE DIGITS: ${d}

SELECTION ENFORCEMENT:
- When the preset says "use LAST DIGIT" ‚Üí use the value ${r} above
- When the preset says "use LAST TWO DIGITS" ‚Üí use the value ${l} above
- When the preset says "use LAST THREE DIGITS" ‚Üí use the value ${d} above
- Match the number to the corresponding option in the list
- This is MANDATORY and overrides all other selection preferences`,s.length>0&&(n+=`

SELECTION HISTORY (CRITICAL):
- The following options were recently used for this preset
- AVOID selecting these options - choose something different
- Recently used: ${s.join(", ")}`)}return le==="1:1"?n+=" Use a square aspect ratio.":le==="16:9"&&(n+=" Use a square aspect ratio, but pad the image with black bars at top and bottom to simulate a 16:9 aspect ratio."),console.log("FINAL PROMPT:",n),n}function Ae(e=!1){const t=document.getElementById("menu-styles-list");t.innerHTML="",t.replaceWith(t.cloneNode(!1));const n=document.getElementById("menu-styles-list"),o=document.createDocumentFragment(),{favorites:s,regular:i}=Xt(),r=s.filter(u=>{if(tt){const g=tt.toLowerCase(),E=u.category&&u.category.some(k=>k.toLowerCase().includes(g));if(!(u.name.toLowerCase().includes(g)||u.message.toLowerCase().includes(g)||E))return!1}return je?u.category&&u.category.includes(je):!0}),l=i.filter(u=>{if(tt){const g=tt.toLowerCase(),E=u.category&&u.category.some(k=>k.toLowerCase().includes(g));if(!(u.name.toLowerCase().includes(g)||u.message.toLowerCase().includes(g)||E))return!1}return je?u.category&&u.category.includes(je):!0});if(r.length>0){const u=document.createElement("h3");u.className="menu-section-header",u.textContent="‚òÖ Favorites",o.appendChild(u),r.forEach(g=>{const E=Si(g);o.appendChild(E)})}if(l.length>0){const u=document.createElement("h3");u.className="menu-section-header",u.textContent=tt?"Search Results":"All Styles",o.appendChild(u),l.forEach(g=>{const E=Si(g);o.appendChild(E)})}if(l.length===0&&r.length===0&&tt){const u=document.createElement("div");u.className="menu-empty",u.textContent="No styles found",o.appendChild(u)}n.appendChild(o),n.addEventListener("click",La);const d=document.getElementById("styles-count");if(d){const{favorites:u,regular:g}=Xt(),E=u.length+g.length;d.textContent=E}e||(oe=0,Rt())}function Si(e){const t=m.findIndex(l=>l===e),n=document.createElement("div");n.className="style-item",n.dataset.index=t,t===b&&n.classList.add("active");const o=document.createElement("button");o.className="style-favorite",o.textContent=At(e.name)?"‚≠ê":"‚òÜ",o.dataset.action="favorite",o.dataset.styleName=e.name;const s=document.createElement("span");s.className="style-name",s.textContent=e.name;const i=document.createElement("button");i.className="style-edit";const r=e.internal===!1;return i.textContent=r?"Builder":"Edit",i.dataset.action=r?"builder":"edit",i.dataset.index=t,n.appendChild(o),n.appendChild(s),n.appendChild(i),n}function La(e){const t=e.target;if(t.dataset.action==="favorite"){e.stopPropagation();const o=t.dataset.styleName;xl(o);return}if(t.dataset.action==="edit"){e.stopPropagation();const o=parseInt(t.dataset.index);Pa(o);return}if(t.dataset.action==="builder"){e.stopPropagation();const o=parseInt(t.dataset.index);kl(o);return}const n=t.closest(".style-item");if(n){const o=parseInt(n.dataset.index);isNaN(o)||(b=o,de(),Po())}}function Ma(e="Add New Style"){const t=document.getElementById("style-editor");document.getElementById("editor-title").textContent=e,t.style.display="flex",setTimeout(()=>{const n=document.querySelector(".style-editor-body");n&&n.focus()},100)}let Tn=!1;function ko(){if(!Tn){Tn=!0;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="0.5vh",e.style.paddingBottom="0.5vw")}}function Ao(){setTimeout(()=>{const e=document.querySelectorAll(".style-input, .style-textarea");if(!Array.from(e).some(n=>n===document.activeElement)&&Tn){Tn=!1;const n=document.querySelector(".style-editor-body");n&&(n.style.gap="1vh",n.style.paddingBottom="1vw")}},100)}const ro=document.getElementById("style-name"),lo=document.getElementById("style-category"),ao=document.getElementById("style-message");ro&&(ro.addEventListener("focus",ko),ro.addEventListener("blur",Ao));lo&&(lo.addEventListener("focus",ko),lo.addEventListener("blur",Ao));ao&&(ao.addEventListener("focus",ko),ao.addEventListener("blur",Ao));function Do(){document.getElementById("style-editor").style.display="none",document.getElementById("style-name").value="",document.getElementById("style-message").value="";const e=document.getElementById("style-category");e&&(e.value=""),document.getElementById("delete-style").style.display="none",Ge=-1}function Pa(e){Ge=e;const t=m[e];document.getElementById("style-name").value=t.name,document.getElementById("style-message").value=t.message;const n=document.getElementById("style-category");n&&(n.value=t.category?t.category.join(", "):""),document.getElementById("delete-style").style.display="block",Ma("Edit Style")}async function ka(){const e=document.getElementById("style-name").value.trim(),t=document.getElementById("style-message").value.trim(),n=document.getElementById("style-category").value.trim(),o=n?n.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):[];if(!e||!t){alert("Please fill in both name and AI prompt");return}if(Ge>=0){const s=m[Ge].name;m[Ge]={name:e,category:o,message:t};const i=Bt.some(l=>l.name===s),r=kt&&we.getImportedPresets().some(l=>l.name===s);if(i||r?await De.saveModification(s,{name:e,message:t,category:o}):await De.saveNewPreset({name:e,category:o,message:t}),s!==e){const l=x.indexOf(s);l>-1&&(x[l]=e,xe())}}else{const s={name:e,category:o,message:t};await De.saveNewPreset(s),m.push(s),x.push(e),xe()}Nn(),alert(Ge>=0?`Preset "${e}" updated!`:`Preset "${e}" saved!`),Do(),$n()}async function Aa(){if(Ge>=0&&m.length>1&&confirm("Delete this style?")){const e=m[Ge].name,t=Bt.some(s=>s.name===e);kt&&we.getImportedPresets().some(s=>s.name===e)?await we.deletePreset(e):t?await De.saveDeletion(e):await De.removeModification(e),m.splice(Ge,1);const o=x.indexOf(e);o>-1&&(x.splice(o,1),xe()),b>=m.length&&(b=m.length-1),Nn(),Do(),$n(),alert(`Preset "${e}" deleted successfully!`)}}function Da(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain(),s=e.createBiquadFilter();n.type="square",n.frequency.setValueAtTime(2400,t),n.frequency.exponentialRampToValueAtTime(1800,t+.012),s.type="highpass",s.frequency.setValueAtTime(1500,t),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.015),n.connect(s),s.connect(o),o.connect(e.destination),n.start(t),n.stop(t+.015);const i=e.createOscillator(),r=e.createGain(),l=e.createBiquadFilter();i.type="square",i.frequency.setValueAtTime(1200,t+.015),i.frequency.exponentialRampToValueAtTime(200,t+.023),l.type="bandpass",l.frequency.setValueAtTime(1500,t+.015),l.Q.setValueAtTime(2,t+.015),r.gain.setValueAtTime(.4,t+.015),r.gain.exponentialRampToValueAtTime(.001,t+.03),i.connect(l),l.connect(r),r.connect(e.destination),i.start(t+.015),i.stop(t+.03);const d=e.createOscillator(),u=e.createGain();d.type="triangle",d.frequency.setValueAtTime(400,t+.023),d.frequency.setValueAtTime(450,t+.027),d.frequency.setValueAtTime(380,t+.031),d.frequency.setValueAtTime(420,t+.035),u.gain.setValueAtTime(0,t+.023),u.gain.linearRampToValueAtTime(.15,t+.025),u.gain.exponentialRampToValueAtTime(.001,t+.04),d.connect(u),u.connect(e.destination),d.start(t+.023),d.stop(t+.04);const g=e.createOscillator(),E=e.createGain(),B=e.createBiquadFilter();g.type="square",g.frequency.setValueAtTime(800,t+.05),g.frequency.exponentialRampToValueAtTime(150,t+.06),B.type="bandpass",B.frequency.setValueAtTime(1e3,t+.05),B.Q.setValueAtTime(2,t+.05),E.gain.setValueAtTime(.5,t+.05),E.gain.exponentialRampToValueAtTime(.001,t+.07),g.connect(B),B.connect(E),E.connect(e.destination),g.start(t+.05),g.stop(t+.07);const k=e.createOscillator(),F=e.createGain(),S=e.createBiquadFilter();k.type="sine",k.frequency.setValueAtTime(180,t+.05),k.frequency.exponentialRampToValueAtTime(120,t+.095),S.type="lowpass",S.frequency.setValueAtTime(300,t+.05),F.gain.setValueAtTime(0,t+.05),F.gain.linearRampToValueAtTime(.2,t+.055),F.gain.exponentialRampToValueAtTime(.001,t+.105),k.connect(S),S.connect(F),F.connect(e.destination),k.start(t+.05),k.stop(t+.105);const C=e.sampleRate*.08,N=e.createBuffer(1,C,e.sampleRate),pe=N.getChannelData(0);for(let at=0;at<C;at++){const ln=Math.sin(at/200)*.5+.5;pe[at]=(Math.random()*2-1)*ln}const J=e.createBufferSource();J.buffer=N;const _=e.createBiquadFilter();_.type="bandpass",_.frequency.setValueAtTime(3e3,t+.07),_.Q.setValueAtTime(1,t+.07);const Y=e.createGain();Y.gain.setValueAtTime(0,t+.07),Y.gain.linearRampToValueAtTime(.12,t+.075),Y.gain.linearRampToValueAtTime(.12,t+.125),Y.gain.exponentialRampToValueAtTime(.001,t+.15),J.connect(_),_.connect(Y),Y.connect(e.destination),J.start(t+.07),J.stop(t+.15);const te=e.createOscillator(),lt=e.createGain();te.type="square",te.frequency.setValueAtTime(600,t+.145),te.frequency.exponentialRampToValueAtTime(100,t+.155),lt.gain.setValueAtTime(.25,t+.145),lt.gain.exponentialRampToValueAtTime(.001,t+.165),te.connect(lt),lt.connect(e.destination),te.start(t+.145),te.stop(t+.165)}catch(e){console.log("Audio generation failed:",e)}}window.addEventListener("load",()=>{var Ks,Zs,ei,ti,ni,oi,si,ii,ri,li;bl(),wa(),Ta(),ma();const e=document.getElementById("start-button");e&&e.addEventListener("click",()=>{Da();const a=document.querySelector(".camera-body");a&&(a.style.transition="all 0.1s",a.style.boxShadow="0 0 50px rgba(255, 255, 255, 1)",setTimeout(()=>{a.style.boxShadow=""},100));const c=document.querySelector(".lens-inner");c&&(c.style.transition="all 0.05s",c.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout(()=>{c.style.transform="translate(-50%, -50%) scale(1)"},50)),setTimeout(()=>{aa()},300)});const t=document.getElementById("burst-toggle");t&&t.addEventListener("click",or);const n=document.getElementById("timer-toggle");n&&n.addEventListener("click",sr);const o=document.getElementById("random-toggle");o&&o.addEventListener("click",tr);const s=document.getElementById("motion-toggle");s&&s.addEventListener("click",Qi);const i=document.getElementById("menu-button");i&&i.addEventListener("click",$n);const r=document.getElementById("close-menu");r&&r.addEventListener("click",Po);const l=document.getElementById("jump-to-top");l&&l.addEventListener("click",pa);const d=document.getElementById("jump-to-bottom");d&&d.addEventListener("click",ha);const u=document.getElementById("settings-menu-button");u&&u.addEventListener("click",qe);const g=document.getElementById("settings-back");g&&g.addEventListener("click",ga);const E=document.getElementById("resolution-settings-button");E&&E.addEventListener("click",Ea);const B=document.getElementById("resolution-back");B&&B.addEventListener("click",cr);const k=document.getElementById("burst-settings-button");k&&k.addEventListener("click",Ia);const F=document.getElementById("burst-back");F&&F.addEventListener("click",ba);const S=document.getElementById("timer-settings-button");S&&S.addEventListener("click",ya);const C=document.getElementById("timer-settings-back");C&&C.addEventListener("click",fa);const N=document.getElementById("master-prompt-settings-button");N&&N.addEventListener("click",va);const pe=document.getElementById("master-prompt-back");pe&&pe.addEventListener("click",Ba);const J=document.getElementById("aspect-ratio-settings-button");J&&J.addEventListener("click",Sa);const _=document.getElementById("aspect-ratio-back");_&&_.addEventListener("click",xa);const Y=document.getElementById("aspect-ratio-1-1"),te=document.getElementById("aspect-ratio-16-9");Y&&Y.addEventListener("change",a=>{a.target.checked?(le="1:1",te&&(te.checked=!1)):le="none",yn(),Bi()}),te&&te.addEventListener("change",a=>{a.target.checked?(le="16:9",Y&&(Y.checked=!1)):le="none",yn(),Bi()});const lt=document.getElementById("motion-settings-button");lt&&lt.addEventListener("click",Cl);const at=document.getElementById("motion-back");at&&at.addEventListener("click",Ll);const ln=document.getElementById("visible-presets-settings-button");ln&&ln.addEventListener("click",Ml);const Ro=document.getElementById("visible-presets-back");Ro&&Ro.addEventListener("click",Pl);const Oo=document.getElementById("preset-builder-button");Oo&&Oo.addEventListener("click",Xi);const No=document.getElementById("preset-builder-back");No&&No.addEventListener("click",To);const qo=document.getElementById("preset-builder-jump-up");qo&&qo.addEventListener("click",Vi);const _o=document.getElementById("preset-builder-jump-down");_o&&_o.addEventListener("click",ji);const Ho=document.getElementById("preset-builder-template");Ho&&Ho.addEventListener("change",Al);const Fo=document.getElementById("preset-builder-name");Fo&&Fo.addEventListener("keypress",a=>{var c;a.key==="Enter"&&(a.preventDefault(),(c=document.getElementById("preset-builder-category"))==null||c.focus())});const Te=document.getElementById("preset-builder-category"),_e=document.getElementById("category-autocomplete");if(Te&&_e){const a=()=>{const y=Te.value,p=y.lastIndexOf(","),f=(p>=0?y.substring(p+1):y).trim().toUpperCase(),M=Dl(),w=f?M.filter(T=>T.includes(f)):M;w.length>0?(_e.innerHTML=w.map(T=>`<div class="category-autocomplete-item" data-category="${T}">${T}</div>`).join(""),_e.style.display="block"):_e.style.display="none"},c=y=>{const p=Te.value,f=p.lastIndexOf(",");f>=0?Te.value=p.substring(0,f+1)+" "+y+", ":Te.value=y+", ",_e.style.display="none",Te.focus()};Te.addEventListener("input",a),Te.addEventListener("focus",a),_e.addEventListener("click",y=>{if(y.target.classList.contains("category-autocomplete-item")){const p=y.target.getAttribute("data-category");c(p)}}),document.addEventListener("click",y=>{!Te.contains(y.target)&&!_e.contains(y.target)&&(_e.style.display="none")}),Te.addEventListener("keypress",y=>{var p;y.key==="Enter"&&(y.preventDefault(),_e.style.display="none",(p=document.getElementById("preset-builder-template"))==null||p.focus())})}const $o=document.getElementById("preset-builder-save");$o&&$o.addEventListener("click",Rl);const Uo=document.getElementById("preset-builder-clear");Uo&&Uo.addEventListener("click",qn);const Vo=document.getElementById("preset-builder-delete");Vo&&Vo.addEventListener("click",Ol),document.querySelectorAll(".chip-section-header").forEach(a=>{a.addEventListener("click",()=>{const c=a.getAttribute("data-section"),y=document.getElementById("section-"+c),p=y.style.display==="block";document.querySelectorAll(".chip-section-content").forEach(f=>{f.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(f=>{f.classList.remove("expanded")}),p||(y.style.display="block",a.classList.add("expanded"))})}),document.querySelectorAll(".preset-chip").forEach(a=>{a.addEventListener("click",c=>{const y=c.target.getAttribute("data-text"),p=document.getElementById("preset-builder-prompt"),f=p.value;f.trim()?p.value=f+" "+y:p.value=y,p.scrollTop=p.scrollHeight})});const jo=document.getElementById("preset-builder-quality");jo&&jo.addEventListener("change",a=>{const c=a.target.value;if(c){const y=document.getElementById("preset-builder-prompt"),p=y.value;p.trim()?y.value=p+" "+c:y.value=c,a.target.value="",y.scrollTop=y.scrollHeight}});const Go=document.getElementById("visible-presets-filter");Go&&Go.addEventListener("input",a=>{Qt=a.target.value,xt()});const zo=document.getElementById("visible-presets-select-all");zo&&zo.addEventListener("click",()=>{x=m.filter(c=>!c.internal).map(c=>c.name),xe(),xt(),wt(),U&&Ae()});const Jo=document.getElementById("visible-presets-deselect-all");Jo&&Jo.addEventListener("click",()=>{x=[],xe(),xt(),wt(),U&&Ae()});const Yo=document.getElementById("visible-presets-jump-up");Yo&&Yo.addEventListener("click",()=>{ae=0,Wt()});const Qo=document.getElementById("visible-presets-jump-down");Qo&&Qo.addEventListener("click",()=>{const a=document.getElementById("visible-presets-list");if(a){const c=a.querySelectorAll(".style-item");c.length>0&&(ae=c.length-1,Wt())}});let D=null,He=null,q=null,qt=[],We=0,Fe=0,$e=0,Ke=!1;function ur(){const a=P[X];if(!a)return;document.getElementById("image-viewer").style.display="none",document.getElementById("image-editor-modal").style.display="flex",D=document.getElementById("editor-canvas"),He=D.getContext("2d",{willReadFrequently:!0});const c=new Image;c.onload=()=>{q=c,qt=[],We=0,Fe=0,$e=0,document.getElementById("brightness-slider").value=0,document.getElementById("contrast-slider").value=0,document.getElementById("brightness-value").textContent="0",document.getElementById("contrast-value").textContent="0",Ze(),Vn()},c.src=a.imageBase64}function Ze(){!q||!D||(D.width=q.width,D.height=q.height,He.clearRect(0,0,D.width,D.height),He.drawImage(q,0,0),(Fe!==0||$e!==0)&&mr())}function mr(){const a=He.getImageData(0,0,D.width,D.height),c=a.data,y=Fe,p=($e+100)/100;for(let f=0;f<c.length;f+=4)c[f]=((c[f]/255-.5)*p+.5)*255,c[f+1]=((c[f+1]/255-.5)*p+.5)*255,c[f+2]=((c[f+2]/255-.5)*p+.5)*255,c[f]+=y,c[f+1]+=y,c[f+2]+=y,c[f]=Math.max(0,Math.min(255,c[f])),c[f+1]=Math.max(0,Math.min(255,c[f+1])),c[f+2]=Math.max(0,Math.min(255,c[f+2]));He.putImageData(a,0,0)}function gr(){an(),We=(We+90)%360;const a=document.createElement("canvas"),c=a.getContext("2d");We===90||We===270?(a.width=q.height,a.height=q.width):(a.width=q.width,a.height=q.height),c.translate(a.width/2,a.height/2),c.rotate(We*Math.PI/180),c.drawImage(q,-q.width/2,-q.height/2);const y=new Image;y.onload=()=>{q=y,Ze()},y.src=a.toDataURL("image/jpeg",.95)}function yr(){an();const a=He.getImageData(0,0,D.width,D.height),c=a.data,y=D.width,p=D.height,f=new Uint8ClampedArray(c),M=[0,-1,0,-1,5,-1,0,-1,0];for(let T=1;T<p-1;T++)for(let j=1;j<y-1;j++)for(let G=0;G<3;G++){let ne=0;for(let Q=-1;Q<=1;Q++)for(let Ue=-1;Ue<=1;Ue++){const Le=((T+Q)*y+(j+Ue))*4+G,ct=(Q+1)*3+(Ue+1);ne+=c[Le]*M[ct]}f[(T*y+j)*4+G]=Math.max(0,Math.min(255,ne))}for(let T=0;T<c.length;T+=4)c[T]=f[T],c[T+1]=f[T+1],c[T+2]=f[T+2];He.putImageData(a,0,0);const w=new Image;w.onload=()=>{q=w,Ze()},w.src=D.toDataURL("image/jpeg",.95)}function fr(){an();const a=He.getImageData(0,0,D.width,D.height),c=a.data,y=1.15,p=1.2,f=5;for(let w=0;w<c.length;w+=4){let T=c[w],j=c[w+1],G=c[w+2];T=((T/255-.5)*y+.5)*255,j=((j/255-.5)*y+.5)*255,G=((G/255-.5)*y+.5)*255;const ne=.2989*T+.587*j+.114*G;T=ne+p*(T-ne),j=ne+p*(j-ne),G=ne+p*(G-ne),T+=f,j+=f,G+=f,c[w]=Math.max(0,Math.min(255,T)),c[w+1]=Math.max(0,Math.min(255,j)),c[w+2]=Math.max(0,Math.min(255,G))}He.putImageData(a,0,0);const M=new Image;M.onload=()=>{q=M,Ze()},M.src=D.toDataURL("image/jpeg",.95)}function pr(){Ke=!Ke;const a=document.getElementById("crop-overlay"),c=document.getElementById("crop-button");if(Ke){a.style.display="block",c.classList.add("active");const p=document.querySelector(".editor-image-container").getBoundingClientRect(),f=D.getBoundingClientRect(),M=document.querySelector(".crop-top-left"),w=document.querySelector(".crop-bottom-right");M.style.left=f.left-p.left+f.width*.1+"px",M.style.top=f.top-p.top+f.height*.1+"px",w.style.right=p.right-f.right+f.width*.1+"px",w.style.bottom=p.bottom-f.bottom+f.height*.1+"px"}else a.style.display="none",c.classList.remove("active")}function hr(){if(!Ke)return;an(),document.querySelector(".editor-image-container").getBoundingClientRect();const c=D.getBoundingClientRect(),y=document.querySelector(".crop-top-left"),p=document.querySelector(".crop-bottom-right"),f=y.getBoundingClientRect(),M=p.getBoundingClientRect(),w=f.left-c.left,T=f.top-c.top,j=M.right-c.left,G=M.bottom-c.top,ne=j-w,Q=G-T;if(ne<=0||Q<=0){alert("Invalid crop area");return}const Ue=q.width/c.width,Le=q.height/c.height,ct=w*Ue,_t=T*Le,Xn=ne*Ue,Wn=Q*Le,dn=document.createElement("canvas");dn.width=Xn,dn.height=Wn,dn.getContext("2d").drawImage(q,ct,_t,Xn,Wn,0,0,Xn,Wn);const Kn=new Image;Kn.onload=()=>{q=Kn,Ke=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active"),Ze()},Kn.src=dn.toDataURL("image/jpeg",.95)}function an(){const a={image:q,rotation:We,brightness:Fe,contrast:$e};qt.push(a),Vn()}function Er(){if(qt.length===0)return;const a=qt.pop();q=a.image,We=a.rotation,Fe=a.brightness,$e=a.contrast,document.getElementById("brightness-slider").value=Fe,document.getElementById("contrast-slider").value=$e,document.getElementById("brightness-value").textContent=Fe,document.getElementById("contrast-value").textContent=$e,Ze(),Vn()}function Vn(){const a=document.getElementById("undo-edit-button");a.disabled=qt.length===0}async function Ir(){const a=document.createElement("canvas");a.width=D.width,a.height=D.height,a.getContext("2d").drawImage(D,0,0);const y=a.toDataURL("image/jpeg",.9),p={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:y,timestamp:Date.now()};P.unshift(p),await Rn(p),X=0;const f=document.getElementById("viewer-image");f.src=y,f.style.transform="scale(1) translate(0, 0)",he=1,Xo(),await ue(),zt("Edited image saved!","success",3e3)}function Xo(){document.getElementById("image-editor-modal").style.display="none",document.getElementById("image-viewer").style.display="flex",Ke=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active")}(Ks=document.getElementById("edit-viewer-image"))==null||Ks.addEventListener("click",ur),(Zs=document.getElementById("close-image-editor"))==null||Zs.addEventListener("click",Xo),(ei=document.getElementById("rotate-button"))==null||ei.addEventListener("click",gr),(ti=document.getElementById("sharpen-button"))==null||ti.addEventListener("click",yr),(ni=document.getElementById("autocorrect-button"))==null||ni.addEventListener("click",fr),(oi=document.getElementById("undo-edit-button"))==null||oi.addEventListener("click",Er),(si=document.getElementById("save-edit-button"))==null||si.addEventListener("click",Ir),(ii=document.getElementById("crop-button"))==null||ii.addEventListener("click",()=>{Ke?hr():pr()}),(ri=document.getElementById("brightness-slider"))==null||ri.addEventListener("input",a=>{Fe=parseInt(a.target.value),document.getElementById("brightness-value").textContent=Fe,Ze()}),(li=document.getElementById("contrast-slider"))==null||li.addEventListener("input",a=>{$e=parseInt(a.target.value),document.getElementById("contrast-value").textContent=$e,Ze()});let Ce=null;document.querySelectorAll(".crop-corner").forEach(a=>{a.addEventListener("touchstart",c=>{c.preventDefault(),Ce=a})}),document.addEventListener("touchmove",a=>{if(!Ce||!Ke)return;a.preventDefault();const c=a.touches[0],p=document.querySelector(".editor-image-container").getBoundingClientRect(),f=D.getBoundingClientRect();let M=c.clientX-p.left,w=c.clientY-p.top;const T=f.left-p.left,j=f.top-p.top,G=f.right-p.left,ne=f.bottom-p.top,Q=Ce.offsetWidth;if(Ce.classList.contains("crop-top-left")){M=Math.max(T,Math.min(M,G-Q)),w=Math.max(j,Math.min(w,ne-Q));const Le=document.querySelector(".crop-bottom-right").getBoundingClientRect(),ct=Le.right-p.left-Q*2,_t=Le.bottom-p.top-Q*2;M=Math.min(M,ct),w=Math.min(w,_t),Ce.style.left=M+"px",Ce.style.top=w+"px"}else if(Ce.classList.contains("crop-bottom-right")){M=Math.max(T+Q,Math.min(M,G)),w=Math.max(j+Q,Math.min(w,ne));const Le=document.querySelector(".crop-top-left").getBoundingClientRect(),ct=Le.right-p.left+Q,_t=Le.bottom-p.top+Q;M=Math.max(M,ct),w=Math.max(w,_t),Ce.style.right=p.width-M+"px",Ce.style.bottom=p.height-w+"px"}}),document.addEventListener("touchend",()=>{Ce=null});const Wo=document.getElementById("motion-sensitivity-slider"),Ko=document.getElementById("motion-sensitivity-value");if(Wo&&Ko){const a=["Very Low","Low","Medium","High","Very High"];Wo.addEventListener("input",c=>{const y=parseInt(c.target.value);Ko.textContent=a[y-1],Lt=50-y*10,gn(),Wi()})}const Zo=document.getElementById("motion-continuous-enabled");Zo&&Zo.addEventListener("change",a=>{ft=a.target.checked,gn()});const es=document.getElementById("motion-cooldown-slider"),ts=document.getElementById("motion-cooldown-value");es&&ts&&es.addEventListener("input",a=>{Mt=parseInt(a.target.value),ts.textContent=`${Mt}s`,gn()});const ns=document.getElementById("motion-start-delay-slider"),os=document.getElementById("motion-start-delay-value");ns&&os&&ns.addEventListener("input",a=>{const c=parseInt(a.target.value);Pt=Jt[c].seconds,os.textContent=Jt[c].label,gn()});const ss=document.getElementById("no-magic-toggle-button");ss&&ss.addEventListener("click",Fl);const is=document.getElementById("tutorial-button");is&&is.addEventListener("click",jl);const rs=document.getElementById("tutorial-back");rs&&rs.addEventListener("click",Gl);const ls=document.getElementById("import-presets-button");ls&&ls.addEventListener("click",async()=>{try{const a=await we.import();if(a.success){m=await xo(),x=m.map(y=>y.name),xe(),Ae(),wt();const c=document.getElementById("styles-count");if(c){const y=m.filter(p=>x.includes(p.name)).length;c.textContent=y}alert(a.message)}else a.message!=="cancelled"&&a.message!=="No presets selected"&&alert("Import failed: "+a.message)}catch(a){alert("Import error: "+a.message)}}),document.querySelectorAll(".glossary-item").forEach(a=>{a.addEventListener("click",()=>{const c=a.getAttribute("data-section");zl(c)})});const as=document.getElementById("back-to-glossary");as&&as.addEventListener("click",Zi);const cs=document.getElementById("master-prompt-enabled");cs&&cs.addEventListener("change",a=>{Qe=a.target.checked;const c=document.getElementById("master-prompt-text");c&&(c.disabled=!Qe),yn(),wn()});const ds=document.getElementById("master-prompt-text");ds&&ds.addEventListener("input",a=>{be=a.target.value;const c=document.getElementById("master-prompt-char-count");c&&(c.textContent=be.length),yn(),wn()});const us=document.getElementById("style-filter");let jn=null;us&&us.addEventListener("input",a=>{tt=a.target.value,jn&&clearTimeout(jn),jn=setTimeout(()=>{Ae()},150)});const ms=document.getElementById("burst-count-slider"),Gn=document.getElementById("burst-speed-slider");ms&&ms.addEventListener("input",a=>{$=parseInt(a.target.value),document.getElementById("burst-count-value").textContent=$;const c=parseInt(Gn.value);Ii($,c),xn(),ye&&(v.textContent=`Burst mode ON (${$} photos) ‚Ä¢ ${m[b].name}`)}),Gn&&Gn.addEventListener("input",a=>{const c=parseInt(a.target.value);en=Ct[c].delay,document.getElementById("burst-speed-value").textContent=Ct[c].label,Ii($,c),xn()});const gs=document.getElementById("timer-delay-slider"),ys=document.getElementById("timer-delay-value");gs&&ys&&gs.addEventListener("input",a=>{const c=parseInt(a.target.value)-1;Oe=Mi[c],ys.textContent=Oe,io(),jt()});const fs=document.getElementById("timer-repeat-enabled");fs&&fs.addEventListener("change",a=>{ht=a.target.checked,io(),jt()});const zn=document.getElementById("timer-repeat-interval-input"),Jn=document.getElementById("timer-repeat-interval-unit");if(zn&&Jn){const a=()=>{const c=parseInt(zn.value)||1,y=parseInt(Jn.value);me=c*y,io(),jt()};zn.addEventListener("input",a),Jn.addEventListener("change",a)}sa(),ia(),Hl(),$l(),Ul();const ps=document.getElementById("reset-button");ps&&ps.addEventListener("click",Fn);const hs=document.getElementById("camera-button");hs&&hs.addEventListener("click",oa);const Es=document.getElementById("close-editor");Es&&Es.addEventListener("click",Do);const Is=document.getElementById("import-resolution-settings-button");Is&&Is.addEventListener("click",Ql);const bs=document.getElementById("import-resolution-back");bs&&bs.addEventListener("click",er);const vs=document.getElementById("save-style");vs&&vs.addEventListener("click",ka);const Bs=document.getElementById("delete-style");Bs&&Bs.addEventListener("click",Aa),dt=document.getElementById("connection-status"),St=document.getElementById("queue-status"),ke=document.getElementById("sync-button"),ke&&ke.addEventListener("click",Kt),St&&St.addEventListener("click",Mo);const Ss=document.getElementById("close-queue-manager");Ss&&Ss.addEventListener("click",ca);const xs=document.getElementById("sync-all");xs&&xs.addEventListener("click",Kt);const ws=document.getElementById("clear-queue");ws&&ws.addEventListener("click",lr);const Ts=document.getElementById("gallery-button");Ts&&Ts.addEventListener("click",ue);const Cs=document.getElementById("close-gallery");Cs&&Cs.addEventListener("click",Dr);const Ls=document.getElementById("gallery-import-button");Ls&&Ls.addEventListener("click",()=>{qa()});const Ms=document.getElementById("close-qr-scanner");Ms&&Ms.addEventListener("click",()=>{Gt()});const Ps=document.getElementById("close-viewer");Ps&&Ps.addEventListener("click",qr);const ks=document.getElementById("delete-viewer-image");ks&&ks.addEventListener("click",_r);const As=document.getElementById("upload-viewer-image");As&&As.addEventListener("click",Ra);const Ds=document.getElementById("qr-scan-button");Ds&&Ds.addEventListener("click",()=>{const a=document.getElementById("qr-scan-button"),c=document.getElementById("qr-scanner-video");a&&(a.disabled=!0),c&&c.paused&&c.play(),z("Scanning...",""),dr()});const Rs=document.getElementById("close-qr-modal");Rs&&Rs.addEventListener("click",Na);const Os=document.getElementById("gallery-start-date-btn"),Yn=document.getElementById("gallery-start-date");Os&&Yn&&(Os.addEventListener("click",()=>{Yn.showPicker()}),Yn.addEventListener("change",a=>{Ut=a.target.value||null,gi("start",Ut),oo()}));const Ns=document.getElementById("gallery-end-date-btn"),Qn=document.getElementById("gallery-end-date");Ns&&Qn&&(Ns.addEventListener("click",()=>{Qn.showPicker()}),Qn.addEventListener("change",a=>{Vt=a.target.value||null,gi("end",Vt),oo()}));const qs=document.getElementById("gallery-sort-order");qs&&qs.addEventListener("change",a=>{Yt=a.target.value;try{localStorage.setItem(Ni,Yt)}catch(c){console.error("Failed to save sort order:",c)}oo()});const _s=document.getElementById("prev-page");_s&&_s.addEventListener("click",Or);const Hs=document.getElementById("next-page");Hs&&Hs.addEventListener("click",Rr);const Fs=document.getElementById("load-preset-button");Fs&&Fs.addEventListener("click",Hr);const $s=document.getElementById("multi-preset-button");$s&&$s.addEventListener("click",()=>{if(X>=0){const a=P[X].id;yl(a)}});const Us=document.getElementById("close-preset-selector");Us&&Us.addEventListener("click",Bn);const cn=document.getElementById("preset-filter");cn&&(cn.addEventListener("input",a=>{bn=a.target.value,on()}),cn.addEventListener("focus",()=>{const a=document.getElementById("preset-selector-category-hint");a&&(a.style.display="none");const c=document.getElementById("multi-preset-controls");c&&(c.style.display="none")}),cn.addEventListener("blur",()=>{if(It){const a=document.getElementById("multi-preset-controls");a&&(a.style.display="flex")}}));const Vs=document.getElementById("preset-selector-jump-up");Vs&&Vs.addEventListener("click",()=>{W=0,pt()});const js=document.getElementById("preset-selector-jump-down");js&&js.addEventListener("click",()=>{const a=document.getElementById("preset-list");if(a){const c=a.querySelectorAll(".preset-item");c.length>0&&(W=c.length-1,pt())}});const Gs=document.getElementById("magic-button");Gs&&Gs.addEventListener("click",al);const zs=document.getElementById("batch-mode-toggle");zs&&zs.addEventListener("click",Sn);const Js=document.getElementById("batch-select-all");Js&&Js.addEventListener("click",cl);const Ys=document.getElementById("batch-deselect-all");Ys&&Ys.addEventListener("click",dl);const Qs=document.getElementById("batch-cancel");Qs&&Qs.addEventListener("click",Sn);const Xs=document.getElementById("batch-apply-preset");Xs&&Xs.addEventListener("click",ul);const Ws=document.getElementById("batch-delete");Ws&&Ws.addEventListener("click",gl),An().then(async()=>{localStorage.getItem("r1_gallery_index")?(console.log("Migrating old gallery data..."),await Pr()):await Dn()}).catch(a=>{console.error("Failed to initialize database:",a)}),pl()});window.removeFromQueue=da;window.previewQueueItem=ua;window.clearQueue=lr;async function Ra(){if(X<0)return;const e=document.getElementById("status"),t=document.getElementById("upload-viewer-image");try{t.disabled=!0,t.textContent="‚è≥",e&&(e.style.display="block",e.textContent="Uploading image...");const o=P[X].imageBase64.split(",")[1],s=atob(o),i=new Array(s.length);for(let B=0;B<s.length;B++)i[B]=s.charCodeAt(B);const r=new Uint8Array(i),l=new Blob([r],{type:"image/png"}),d=new FormData;d.append("file",l,`magic-kamera-${Date.now()}.png`);const u=await fetch("https://store2.gofile.io/uploadFile?token=",{method:"POST",body:d});if(!u.ok)throw new Error("Upload failed - status: "+u.status);const g=await u.json();if(g.status!=="ok"||!g.data.downloadPage)throw new Error("Upload failed: "+JSON.stringify(g));const E=g.data.downloadPage;e&&(e.textContent="Upload successful!",setTimeout(()=>{e.style.display="none"},2e3)),Oa(E.trim())}catch{e&&(e.textContent="Upload failed. Please try again.",setTimeout(()=>{e.style.display="none"},3e3))}finally{t.disabled=!1,t.textContent="üì§"}}function Oa(e){const t=document.getElementById("qr-modal"),n=document.getElementById("qr-code-container"),o=document.getElementById("qr-url-text");!t||!n||!o||(n.innerHTML="",new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),o.textContent=e,t.style.display="flex")}function Na(){const e=document.getElementById("qr-modal");e&&(e.style.display="none")}function qa(){const e=document.getElementById("qr-scanner-modal"),t=document.getElementById("qr-scanner-video");if(!e||!t)return;e.style.display="flex",_a(),z("Ready to scan","");const n=document.getElementById("qr-scan-button");n&&(n.disabled=!1)}function Gt(){const e=document.getElementById("qr-scanner-modal");e&&(e.style.display="none"),Cn(),Ha(),z("Point camera at QR code...","")}async function _a(){const e=document.getElementById("qr-scanner-video");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=t,e.onloadedmetadata=()=>{e.pause(),z("Ready to scan","")}}catch(t){console.error("Error starting QR scanner camera:",t),z("Camera access denied","error")}}function Ha(){const e=document.getElementById("qr-scanner-video");e&&e.srcObject&&(e.srcObject.getTracks().forEach(n=>n.stop()),e.srcObject=null)}function z(e,t=""){const n=document.getElementById("qr-scanner-status");n&&(n.textContent=e,n.className="qr-scanner-status",t&&n.classList.add(t))}function zt(e,t="info",n=3e3){const o=document.getElementById("gallery-status-message");o&&(o.textContent=e,o.className="gallery-status-message",t==="error"?o.classList.add("error"):t==="success"&&o.classList.add("success"),o.style.display="block",setTimeout(()=>{o.style.display="none"},n))}function dr(){mo||(mo=!0,hn=setInterval(Fa,Mr))}function Cn(){mo=!1,hn&&(clearInterval(hn),hn=null)}function Fa(){const e=document.getElementById("qr-scanner-video");if(!e||e.readyState!==e.HAVE_ENOUGH_DATA)return;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height),s=jsQR(o.data,o.width,o.height);s&&s.data?$a(s.data)?vt!==s.data&&(vt=s.data,z("QR Code detected! Importing...","success"),Cn(),setTimeout(()=>{Va()},500)):(Cn(),Gt(),zt("Invalid QR code - must be a valid URL","error",4e3)):z("Scanning...","")}function $a(e){try{const t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}async function Ua(e,t=640,n=480,o=.85){return new Promise((s,i)=>{const r=new Image,l=URL.createObjectURL(e);r.onload=()=>{URL.revokeObjectURL(l);let d=r.width,u=r.height;if(d>t||u>n){const B=d/u;d>u?(d=t,u=d/B):(u=n,d=u*B)}const g=document.createElement("canvas");g.width=d,g.height=u,g.getContext("2d").drawImage(r,0,0,d,u),g.toBlob(B=>{B?s(B):i(new Error("Failed to compress image"))},"image/jpeg",o)},r.onerror=()=>{URL.revokeObjectURL(l),i(new Error("Failed to load image for resizing"))},r.src=l})}async function Va(){if(!vt){Gt(),zt("No QR code detected","error",3e3);return}try{z("Downloading image...","");const e=vt.trim(),t=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/raw?url=",""];let n=null,o=null;for(let g=0;g<t.length;g++)try{const E=t[g]?t[g]+encodeURIComponent(e):e;z(`Trying method ${g+1}/${t.length}...`,"");const B=new AbortController,k=setTimeout(()=>B.abort(),8e3);if(n=await fetch(E,{signal:B.signal}),clearTimeout(k),n.ok){z("Download successful!","success");break}}catch(E){o=E;continue}if(!n||!n.ok)throw new Error("All download methods failed");z("Reading image data...","");let s=await n.blob();const i=Math.round(s.size/1024);if(z("Original size: "+i+"KB",""),s.type&&!s.type.startsWith("image/"))throw new Error("Not an image: "+s.type);z("Optimizing image...","");const r=Io[Tt];s=await Ua(s,r.width,r.height,.85);const l=Math.round(s.size/1024);z("Compressed: "+i+"KB ‚Üí "+l+"KB",""),z("Converting to base64...","");const d=await new Promise((g,E)=>{const B=setTimeout(()=>{E(new Error("Base64 conversion timeout"))},1e4),k=new FileReader;k.onloadend=()=>{clearTimeout(B),g(k.result)},k.onerror=()=>{clearTimeout(B),E(new Error("FileReader error"))},k.readAsDataURL(s)});z("Saving to gallery...","");const u={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:d,timestamp:Date.now()};P.unshift(u),await Rn(u),z("‚úÖ Import successful!","success"),vt=null,Gt(),await ue(),zt("Image imported successfully!","success",3e3)}catch(e){vt=null,Gt(),zt("Import failed: "+e.message,"error",4e3)}}document.getElementById("factory-reset-button").addEventListener("click",async()=>{confirm(kt?"This will reset to your imported preset list. Your custom presets will be kept. Continue?":"This will restore all factory presets to their original state. Your custom presets will be kept. Continue?")&&(await De.clearFactoryPresetModifications(),m=await xo(),x=m.map(n=>n.name),xe(),renderMenuStyles(),alert(kt?"Presets reset to imported list!":"Factory presets restored successfully!"))});document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".mode-carousel-track");e&&e.querySelectorAll(".mode-button").forEach(n=>{const o=n.getAttribute("data-mode");o==="random"?n.addEventListener("click",tr):o==="motion"?n.addEventListener("click",Qi):o==="burst"?n.addEventListener("click",or):o==="timer"&&n.addEventListener("click",sr)})});console.log("AI Camera Styles app initialized!");let Eo=0;document.addEventListener("touchstart",e=>{Eo=e.touches[0].clientX},{passive:!0});document.addEventListener("touchend",e=>{const t=e.changedTouches[0].clientX,n=Eo-t,o=document.querySelector(".mode-carousel");if(!o)return;const s=30,i=window.innerWidth*.5;Eo>i&&n>s&&o.classList.add("show"),n<-s&&o.classList.remove("show")},{passive:!0});
