(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const xi="CameraPresetsDB",Ti=1,re="presets";class Ci{constructor(){this.db=null}async init(){return new Promise((t,n)=>{const o=indexedDB.open(xi,Ti);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains(re)||r.createObjectStore(re,{keyPath:"id"}).createIndex("type","type",{unique:!1})}})}async saveModification(t,n){await this.db.transaction([re],"readwrite").objectStore(re).put({id:`modified_${t}`,type:"modification",name:t,data:n,timestamp:Date.now()})}async saveNewPreset(t){await this.db.transaction([re],"readwrite").objectStore(re).put({id:`new_${t.name}`,type:"new",name:t.name,data:t,timestamp:Date.now()})}async saveDeletion(t){await this.db.transaction([re],"readwrite").objectStore(re).put({id:`deleted_${t}`,type:"deletion",name:t,timestamp:Date.now()})}async getAllModifications(){return new Promise((t,n)=>{const r=this.db.transaction([re],"readonly").objectStore(re).getAll();r.onsuccess=()=>t(r.result),r.onerror=()=>n(r.error)})}async clearFactoryPresetModifications(){return new Promise((t,n)=>{const o=this.db.transaction([re],"readwrite"),s=o.objectStore(re),r=s.getAll();r.onsuccess=()=>{const l=r.result,i=[];for(const c of l)if(c.type==="modification"||c.type==="deletion"){const d=s.delete(c.id);i.push(new Promise((m,f)=>{d.onsuccess=()=>m(),d.onerror=()=>f(d.error)}))}Promise.all(i).then(()=>t()).catch(n)},r.onerror=()=>n(r.error),o.onerror=()=>n(o.error)})}async removeModification(t){const o=this.db.transaction([re],"readwrite").objectStore(re);await o.delete(`modified_${t}`),await o.delete(`deleted_${t}`)}}const Re=new Ci,Li="ImportedPresetsDB",Mi=1,et="imported_presets";class Pi{constructor(){this.db=null,this.importedPresets=[],this.isImportModalOpen=!1,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates=new Map}async init(){return new Promise((t,n)=>{const o=indexedDB.open(Li,Mi);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains(et)||r.createObjectStore(et,{keyPath:"id",autoIncrement:!0})}})}async loadImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const r=this.db.transaction([et],"readonly").objectStore(et).getAll();r.onsuccess=()=>{this.importedPresets=r.result.map(l=>l.preset),t(this.importedPresets)},r.onerror=()=>{console.error("Error loading imported presets:",r.error),t([])}})}async saveImportedPresets(t){return this.db||await this.init(),new Promise(async(n,o)=>{const r=this.db.transaction([et],"readwrite").objectStore(et),l=r.clear();l.onsuccess=()=>{const i=t.map(c=>new Promise((d,m)=>{const f=r.add({preset:c});f.onsuccess=()=>d(),f.onerror=()=>m(f.error)}));Promise.all(i).then(()=>{this.importedPresets=t,n()}).catch(o)},l.onerror=()=>o(l.error)})}async loadPresetsFromFile(){try{const t=await fetch("./presets.json");if(!t.ok)throw new Error("Failed to load presets.json");return(await t.json()).filter(s=>s.name&&s.message&&Array.isArray(s.category)).sort((s,r)=>s.name.localeCompare(r.name))}catch(t){throw console.error("Error loading presets.json:",t),new Error("Could not load presets.json file")}}getFilteredPresets(t){if(!this.importFilterText.trim())return t;const n=this.importFilterText.toLowerCase();return t.filter(o=>o.name.toLowerCase().includes(n))}async showPresetSelectionUI(t){return new Promise(n=>{this.isImportModalOpen=!0,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates.clear(),t.forEach(B=>{const M=this.importedPresets.some(F=>F.name===B.name);this.checkboxStates.set(B.name,M)});const o=document.createElement("div");o.className="styles-menu",o.style.display="flex",o.style.zIndex="10000",o.id="import-preset-modal";const s=document.createElement("div");s.className="styles-menu-content";const r=document.createElement("div");r.className="styles-menu-header",r.style.marginBottom="0",r.innerHTML=`
        <h2 style="font-size: 14px;">Import (<span id="import-preset-count">${t.length}</span>)</h2>
        <div class="menu-nav-buttons">
          <button id="import-jump-to-top" class="menu-jump-button" title="Jump to top">‚Üë</button>
          <button id="import-jump-to-bottom" class="menu-jump-button" title="Jump to bottom">‚Üì</button>
          <button id="close-import-modal" class="close-button">√ó</button>
        </div>
      `;const l=document.createElement("div");l.className="styles-menu-scroll-container",l.id="import-scroll-container",l.style.paddingTop="0",l.style.paddingBottom="22px";const i=document.createElement("div");i.className="menu-section",i.style.cssText="position: sticky; top: 0; background: #1a1a1a; z-index: 10; padding: 5px 0; margin: 0; border-bottom: 1px solid #333;",i.innerHTML=`
        <input type="text" id="import-preset-filter" class="style-filter" placeholder="Filter..." style="width: 100%; margin: 0; height: 24px; font-size: 12px;">
      `;const c=document.createElement("div");c.className="menu-section",c.id="import-presets-section",c.style.margin="0";const d=document.createElement("div");d.className="menu-list",d.id="import-presets-list";const m=()=>{const B=this.getFilteredPresets(t),M=document.getElementById("import-preset-count");M&&(M.textContent=B.length),d.innerHTML="",B.forEach((F,Ie)=>{const Y=document.createElement("button");Y.className="menu-item",Y.dataset.presetIndex=Ie,Y.dataset.presetName=F.name,Y.style.cssText="display: flex; align-items: center; padding: 6px 15px; min-height: 30px; width: 100%; justify-content: flex-start; margin-bottom: 2px;";const $=document.createElement("input");$.type="checkbox",$.id=`import-preset-${Ie}`,$.checked=this.checkboxStates.get(F.name)||!1,$.style.cssText=`
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #4CAF50;
            flex-shrink: 0;
          `,$.onclick=ne=>{ne.stopPropagation(),this.checkboxStates.set(F.name,$.checked)};const X=document.createElement("span");X.className="menu-item-name",X.textContent=F.name,X.style.cssText="flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; color: #000; font-size: 12px;",Y.appendChild($),Y.appendChild(X),Y.onclick=ne=>{ne.target!==$&&($.checked=!$.checked,this.checkboxStates.set(F.name,$.checked))},d.appendChild(Y)}),f()},f=()=>{const B=d.querySelectorAll(".menu-item");if(B.forEach(M=>M.classList.remove("menu-selected")),this.currentImportScrollIndex>=0&&this.currentImportScrollIndex<B.length){const M=B[this.currentImportScrollIndex];M.classList.add("menu-selected"),M.scrollIntoView({behavior:"smooth",block:"nearest"})}};c.appendChild(d);const v=document.createElement("div");v.style.cssText=`
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1a1a1a;
  z-index: 20;
  padding: 2px;
  border-top: 1px solid #333;
  display: flex;
  gap: 3px;
`,v.innerHTML=`
  <button id="select-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úì All
  </button>
  <button id="deselect-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úó None
  </button>
  <button id="confirm-import-presets" style="flex: 1; padding: 0; background: #4CAF50; color: white; border: none; border-radius: 2px; font-size: 10px; font-weight: bold; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Import
  </button>
  <button id="cancel-import-presets" style="flex: 1; padding: 0; background: #666; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Cancel
  </button>
`,l.appendChild(i),l.appendChild(c),s.appendChild(r),s.appendChild(l),o.appendChild(s),o.appendChild(v),document.body.appendChild(o),m(),document.getElementById("import-preset-filter").addEventListener("input",B=>{this.importFilterText=B.target.value,this.currentImportScrollIndex=0,m()}),document.getElementById("select-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(M=>{this.checkboxStates.set(M.name,!0)}),m()},document.getElementById("deselect-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(M=>{this.checkboxStates.set(M.name,!1)}),m()};const L=()=>{this.isImportModalOpen=!1,document.body.removeChild(o)};document.getElementById("close-import-modal").onclick=()=>{L(),n(null)},document.getElementById("cancel-import-presets").onclick=()=>{L(),n(null)},document.getElementById("confirm-import-presets").onclick=()=>{const B=t.filter(M=>this.checkboxStates.get(M.name)===!0);L(),n(B)},document.getElementById("import-jump-to-top").onclick=()=>{l.scrollTop=0,this.currentImportScrollIndex=0,f()},document.getElementById("import-jump-to-bottom").onclick=()=>{l.scrollTop=l.scrollHeight;const B=d.querySelectorAll(".menu-item");this.currentImportScrollIndex=B.length-1,f()},this.scrollImportUp=()=>{d.querySelectorAll(".menu-item").length!==0&&(this.currentImportScrollIndex=Math.max(0,this.currentImportScrollIndex-1),f())},this.scrollImportDown=()=>{const B=d.querySelectorAll(".menu-item");B.length!==0&&(this.currentImportScrollIndex=Math.min(B.length-1,this.currentImportScrollIndex+1),f())},l.style.overflowY="auto"})}async import(){try{const t=await this.loadPresetsFromFile();if(t.length===0)return{success:!1,message:"No presets found in presets.json"};const n=await this.showPresetSelectionUI(t);if(n===null)return{success:!1,message:"cancelled"};if(n.length===0)return{success:!1,message:"No presets selected"};const o=new Map(this.importedPresets.map(c=>[c.name,c]));let s=0,r=0;n.forEach(c=>{o.has(c.name)?(o.set(c.name,c),s++):(o.set(c.name,c),r++)});const l=Array.from(o.values());await this.saveImportedPresets(l);let i="";return s>0&&r>0?i=`Updated ${s}, imported ${r} new. Total: ${l.length}`:s>0?i=`Updated ${s} preset(s). Total: ${l.length}`:i=`Imported ${r} new preset(s). Total: ${l.length}`,{success:!0,message:i,updated:s,new:r,total:l.length}}catch(t){return{success:!1,message:t.message}}}async deletePreset(t){const n=this.importedPresets.findIndex(o=>o.name===t);return n>=0?(this.importedPresets.splice(n,1),await this.saveImportedPresets(this.importedPresets),!0):!1}async clearImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const r=this.db.transaction([et],"readwrite").objectStore(et).clear();r.onsuccess=()=>{this.importedPresets=[],t()},r.onerror=()=>n(r.error)})}getImportedPresets(){return this.importedPresets}}const de=new Pi;let to=[],E,I,U,S,In,O=null,z=null;const tn=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"SXGA+ (1400x1050)",width:1400,height:1050},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080},{name:"HD (3264x2448)",width:3264,height:2448}];let Je=0;const Lr="r1_camera_resolution",bo=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080}];let Ct=0;const Mr="r1_import_resolution";let le=0,q=[],no=!1,ee=1,$t=!1,dr=0,ur=1,pe=!1,j=5,nn=500,oo=!1;const Lt={1:{delay:800,label:"Slow"},2:{delay:500,label:"Medium"},3:{delay:300,label:"Fast"}},Pr="r1_camera_burst_settings",kr="r1_camera_timer_settings",Ar="r1_camera_last_preset";let he=!1,Qe=null,Ne=10,It=!1,Dr=[3,5,10],ge=1;const Rr={1:{seconds:1,label:"1s"},2:{seconds:3,label:"3s"},3:{seconds:5,label:"5s"},4:{seconds:10,label:"10s"},5:{seconds:30,label:"30s"},6:{seconds:60,label:"1m"},7:{seconds:300,label:"5m"},8:{seconds:600,label:"10m"},9:{seconds:1800,label:"30m"},10:{seconds:3600,label:"1h"}};let we="",Ye=!1;const Or="r1_camera_master_prompt",Nr="r1_camera_master_prompt_enabled",qr="r1_camera_aspect_ratio";let ae="none";const vo="r1_camera_selection_history";let nt={};const mr=5;let ke=!1,ue=!1,pn=null,je=null,Mt=30,Bo=.1,ht=!0,Pt=2,mn=!1,kt=3;const _r="r1_camera_motion_settings";let Vt=null;const Yt={1:{seconds:3,label:"3s"},2:{seconds:10,label:"10s"},3:{seconds:30,label:"30s"},4:{seconds:60,label:"1m"},5:{seconds:300,label:"5m"},6:{seconds:600,label:"10m"},7:{seconds:900,label:"15m"},8:{seconds:1800,label:"30m"}};let ie=!1;const Fr="r1_camera_no_magic_mode";let Bt,so,Ut=null,oe=0,G=!1,it=!1,qe=!1,K=0,xe=0,Te=0,te=!1,on=!1,Pn=!1,kn=!1,An=!1,Dn=!1,bt=!1,Rt=!1,Ae=-1,Ce=0;const ki="R1CameraGallery",Ai=1,rt="images";let ve=null,R=[];const Hr="r1_gallery_sort_order";let Z=-1,be=1,gn=!1,gr=0,fr=1,fe=1;const hn=16;let jt=null,Gt=null,Xt="newest",st=!1,_=new Set,vt=!1,Oe=[],bn=null,tt="",vn="",mo=0,mt="",Ge="",gt="",En=null,St=null,go=!1;const Di=500,yr={transform:"Take a picture and transform the image into [DESCRIBE TRANSFORMATION]. [ADD SPECIFIC DETAILS ABOUT STYLE, APPEARANCE, COLORS, ETC.]",transform_subject:"Take a picture and transform the subject into [WHAT THE SUBJECT BECOMES]. Preserve the subject's recognizable facial structure and identity. [ADD DETAILS ABOUT NEW APPEARANCE, ENVIRONMENT, LIGHTING].",convert:"Take a picture and convert the scene into [DESCRIBE NEW FORMAT/MEDIUM]. [ADD DETAILS ABOUT MATERIALS, TEXTURES, SCALE].",style:"Take a picture in the style of [ARTISTIC STYLE/ARTIST]. [ADD DETAILS ABOUT TECHNIQUE, COLORS, COMPOSITION].",place:"Take a picture and place the subject in [DESCRIBE SCENE/LOCATION]. [ADD DETAILS ABOUT LIGHTING, ATMOSPHERE, INTEGRATION].",recreate:"Take a picture and recreate [FAMOUS WORK/SCENE]. Replace [DESCRIBE WHAT TO REPLACE]. Preserve the iconic [DESCRIBE KEY ELEMENTS TO KEEP].",render:"Take a picture and render it as [FORMAT/MEDIUM]. [ADD DETAILS ABOUT APPEARANCE, TEXTURE, TECHNICAL SPECIFICS].",make:"Take a picture and make the subject into [CHARACTER/CREATURE]. [ADD DETAILS ABOUT APPEARANCE, TRAITS, SETTING]. Make it photorealistic.",analyze:"Analyze the image and [DESCRIBE WHAT TO ANALYZE/EXTRACT]. [ADD DETAILS ABOUT OUTPUT FORMAT] and email it to me.",random:`Take a picture and [DESCRIBE BASE TRANSFORMATION].

[CATEGORY NAME] SELECTION (CRITICAL):
‚Ä¢ SELECT EXACTLY ONE option using the PRE-CALCULATED values
‚Ä¢ These values are MANDATORY - you MUST use them for selection
‚Ä¢ Do NOT choose based on popularity, visual interest, or defaults

For 2 options (50/50 split):
‚Ä¢ If LAST DIGIT is EVEN (0,2,4,6,8): SELECT [OPTION 1]
‚Ä¢ If LAST DIGIT is ODD (1,3,5,7,9): SELECT [OPTION 2]

For 3-10 options:
‚Ä¢ Use LAST DIGIT to select:
  - 0: [OPTION 1]
  - 1: [OPTION 2]
  - 2: [OPTION 3]
  - 3: [OPTION 4]
  - (continue pattern)

For 11-20 options:
‚Ä¢ Use LAST TWO DIGITS modulo [number of options]:
  - 0: [OPTION 1]
  - 1: [OPTION 2]
  - (continue pattern)

For 21+ options:
‚Ä¢ Use LAST TWO DIGITS modulo [number of options] to distribute evenly
‚Ä¢ Map each result to corresponding option in list

[ADD DETAILS ABOUT HOW THE SELECTED OPTION SHOULD AFFECT THE IMAGE].`,custom:""};let g=[],wt=[],At=!1,b=0,ye=-1,Se=navigator.onLine,A=[],yt=!1,ot=null,Bn=0;const $r=500,Ur="r1_camera_queue";let ut,xt,De;const fo="r1_camera_styles";let ze=[];const Vr="r1_camera_favorites",jr="r1_camera_visible_presets";let x=[],Xe=!1,ce=0,Wt="",sn=!0;function Q(e){Ut&&(clearTimeout(Ut),Ut=null),Bt||(Bt=document.getElementById("style-reveal"),so=document.getElementById("style-reveal-text")),!(!Bt||!so)&&(so.textContent=e,Bt.style.display="block",Ut=setTimeout(()=>{Bt&&(Bt.style.display="none"),Ut=null},1200))}function Rn(){return new Promise((e,t)=>{const n=indexedDB.open(ki,Ai);n.onerror=()=>{console.error("Failed to open IndexedDB:",n.error),t(n.error)},n.onsuccess=()=>{ve=n.result,console.log("IndexedDB opened successfully"),e(ve)},n.onupgradeneeded=o=>{ve=o.target.result,ve.objectStoreNames.contains(rt)||(ve.createObjectStore(rt,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Object store created"))}})}async function Ri(){try{const e=localStorage.getItem("r1_gallery_index");if(!e){console.log("No old gallery data to migrate");return}const t=JSON.parse(e);let n=0;for(const o of t){const s="r1_gallery_"+o,r=localStorage.getItem(s);if(r){const l=JSON.parse(r);for(const i of l)await Nn(i),n++;localStorage.removeItem(s)}}localStorage.removeItem("r1_gallery_index"),console.log(`Migration complete: ${n} images migrated to IndexedDB`),await On()}catch(e){console.error("Migration failed:",e)}}async function On(){try{ve||await Rn(),R=[];const n=ve.transaction([rt],"readonly").objectStore(rt).getAll();return new Promise((o,s)=>{n.onsuccess=()=>{R=n.result||[];const r=localStorage.getItem(Hr);r&&(Xt=r),R.sort((l,i)=>i.timestamp-l.timestamp),console.log(`Gallery loaded: ${R.length} images`),o()},n.onerror=()=>{console.error("Failed to load gallery:",n.error),R=[],s(n.error)}})}catch(e){console.error("Error loading gallery:",e),R=[]}}async function Nn(e){try{ve||await Rn();const o=ve.transaction([rt],"readwrite").objectStore(rt).add(e);return new Promise((s,r)=>{o.onsuccess=()=>{console.log("Image saved to IndexedDB"),s()},o.onerror=()=>{console.error("Failed to save image:",o.error),r(o.error)}})}catch(t){console.error("Error saving image:",t)}}async function Gr(e){try{ve||await Rn();const o=ve.transaction([rt],"readwrite").objectStore(rt).delete(e);return new Promise((s,r)=>{o.onsuccess=()=>{console.log("Image deleted from IndexedDB"),s()},o.onerror=()=>{console.error("Failed to delete image:",o.error),r(o.error)}})}catch(t){console.error("Error deleting image:",t)}}async function zr(e){const t={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:e,timestamp:Date.now()};R.unshift(t),await Nn(t),console.log(`Image added. Total: ${R.length}`)}function Oi(e){return!jt&&!Gt?e:e.filter(t=>{const n=new Date(t.timestamp);n.setHours(0,0,0,0);const o=n.getTime();let s=!0,r=!0;if(jt){const l=new Date(jt).getTime();s=o>=l}if(Gt){const l=new Date(Gt).getTime();r=o<=l}return s&&r})}function Ni(e){const t=[...e];return Xt==="newest"?t.sort((n,o)=>o.timestamp-n.timestamp):t.sort((n,o)=>n.timestamp-o.timestamp),t}function So(){let e=Oi(R);return Ni(e)}async function me(){lt(),ci(),U&&U.style.display==="block"&&Un(),await On();const e=document.getElementById("gallery-modal"),t=document.getElementById("gallery-grid"),n=document.getElementById("gallery-pagination"),o=document.getElementById("page-info"),s=document.getElementById("prev-page"),r=document.getElementById("next-page"),l=document.getElementById("gallery-count");l&&(l.textContent=R.length);const i=document.getElementById("gallery-sort-order");i&&(i.value=Xt);const c=So();if(c.length===0)t.innerHTML='<div class="gallery-empty">No photos match the selected filter.</div>',n.style.display="none";else{const d=Math.ceil(c.length/hn);fe=Math.min(fe,d);const m=(fe-1)*hn,f=Math.min(m+hn,c.length),v=c.slice(m,f),C=document.createDocumentFragment();v.forEach(L=>{const B=document.createElement("div");if(B.className="gallery-item",st&&_.has(L.id)&&B.classList.add("selected"),st){const F=document.createElement("input");F.type="checkbox",F.className="gallery-item-checkbox",F.checked=_.has(L.id),F.addEventListener("click",Ie=>{Ie.stopPropagation(),Ir(L.id)}),B.appendChild(F)}const M=document.createElement("img");M.src=L.imageBase64,M.alt="Gallery image",M.loading="lazy",B.appendChild(M),B.onclick=()=>{if(st)Ir(L.id),me();else{const F=R.findIndex(Ie=>Ie.id===L.id);Hi(F)}},C.appendChild(B)}),t.innerHTML="",t.appendChild(C),d>1?(n.style.display="flex",o.textContent=`Page ${fe} of ${d}`,s.disabled=fe===1,r.disabled=fe===d):n.style.display="none"}e.style.display="flex"}async function qi(){if(document.getElementById("gallery-modal").style.display="none",fe=1,await di(),he||pe||ue||ke||vt){let e="";he?e="‚è±Ô∏è Timer Mode":pe?e="üì∏ Burst Mode":ue?e="üëÅÔ∏è Motion Detection":ke&&(e="üé≤ Random Mode"),Q(e)}else g&&g[b]&&Q(g[b].name)}function _i(){const e=So(),t=Math.ceil(e.length/hn);fe<t&&(fe++,me())}function Fi(){fe>1&&(fe--,me())}function ro(){fe=1,me()}function pr(e,t){const n=e==="start"?"gallery-start-date-btn":"gallery-end-date-btn",o=document.getElementById(n);if(!o)return;const s=o.querySelector(".date-button-text");if(s)if(t){const l=new Date(t+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.textContent=l,o.classList.add("has-date")}else s.textContent=e==="start"?"Start":"End",o.classList.remove("has-date")}function Hi(e){if(e<0||e>=R.length)return;Z=e;const t=R[e],n=document.getElementById("image-viewer"),o=document.getElementById("viewer-image"),s=document.getElementById("viewer-prompt");o.src=t.imageBase64,o.style.transform="scale(1) translate(0, 0)",be=1,s.value="",n.style.display="flex",document.getElementById("gallery-modal").style.display="none"}function $i(){document.getElementById("image-viewer").style.display="none",Z=-1,be=1;const e=document.getElementById("gallery-modal");e.style.display="flex",me()}async function Ui(){if(!(Z<0||Z>=R.length)&&confirm("Delete this image from gallery?")){const e=R[Z];await Gr(e.id),R.splice(Z,1),document.getElementById("image-viewer").style.display="none",Z=-1,be=1,me()}}function Vi(){const e=document.getElementById("preset-selector");vt=!1,Oe=[];const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none");const n=e.querySelector(".preset-selector-header h3");n&&(n.innerHTML='Select Preset (<span id="preset-count">0</span>)'),rn();const o=document.getElementById("preset-count");o&&(o.textContent=g.length),e.style.display="flex",qe=!0,K=0,Et(),setTimeout(()=>{const s=document.getElementById("preset-list");s&&mo>0&&(s.scrollTop=mo)},50)}function Sn(){const e=document.getElementById("preset-list");e&&(mo=e.scrollTop),document.getElementById("preset-selector").style.display="none",vn="",gt="",document.getElementById("preset-filter").value="",qe=!1,K=0;const t=document.getElementById("preset-selector-category-hint");t&&(t.style.display="none"),vt=!1}function ji(){if(!qe)return;const e=document.getElementById("preset-list");!e||e.querySelectorAll(".preset-item").length===0||(K=Math.max(0,K-1),Et())}function Gi(){if(!qe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");t.length!==0&&(K=Math.min(t.length-1,K+1),Et())}function Et(){const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("preset-selected")}),K>=0&&K<t.length)){const n=t[K];n.classList.add("preset-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.querySelector(".preset-name").textContent,s=g.find(l=>l.name===o),r=document.getElementById("preset-selector-category-hint");r&&s&&s.category?(r.innerHTML="",r.style.display="block",s.category.forEach((l,i)=>{const c=document.createElement("span");if(c.textContent=l,c.style.cursor="pointer",c.style.padding="0 2px",gt===l&&(c.style.textDecoration="underline",c.style.fontWeight="bold"),c.onclick=d=>{d.stopPropagation(),gt===l?gt="":gt=l,K=0,rn()},r.appendChild(c),i<s.category.length-1){const d=document.createElement("span");d.textContent=", ",r.appendChild(d)}})):r&&(r.style.display="none")}}function zi(){if(!te)return;const e=document.getElementById("settings-submenu");!e||e.querySelectorAll(".menu-section-button").length===0||(xe=Math.max(0,xe-1),wo())}function Ji(){if(!te)return;const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");t.length!==0&&(xe=Math.min(t.length-1,xe+1),wo())}function wo(){const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),xe>=0&&xe<t.length)){const n=t[xe];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Qi(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Te=(Te-1+t.length)%t.length,xo(t))}function Yi(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Te=(Te+1)%t.length,xo(t))}function xo(e){if(e.forEach(t=>t.classList.remove("menu-selected")),Te>=0&&Te<e.length){const t=e[Te];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Xi(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Wi(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Zi(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Ki(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function el(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function tl(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function nl(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ol(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Jr(){if(!Rt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Qr(){if(!Rt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function sl(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function rl(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function il(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ll(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function hr(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.max(0,t.scrollTop-100):n&&(n.scrollTop=Math.max(0,n.scrollTop-200))}function Er(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+100):n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+200))}function al(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function cl(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function dl(){if(!qe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length===0||K>=t.length)return;const n=t[K];n&&n.click()}function rn(){const e=document.getElementById("preset-list");e.innerHTML="";const n=Tl().filter(i=>{if(vn){const c=vn.toLowerCase(),d=i.category&&i.category.some(f=>f.toLowerCase().includes(c));if(!(i.name.toLowerCase().includes(c)||i.message.toLowerCase().includes(c)||d))return!1}return gt?i.category&&i.category.includes(gt):!0}).sort((i,c)=>i.name.localeCompare(c.name)),o=n.filter(i=>Dt(i.name)),s=n.filter(i=>!Dt(i.name)),r=[...o,...s];if(r.length===0){e.innerHTML='<div class="preset-empty">No presets found</div>';return}r.forEach(i=>{const c=document.createElement("div");c.className="preset-item";const d=document.createElement("div");d.className="preset-name",d.textContent=i.name;const m=document.createElement("div");m.className="preset-description preset-description-hidden",m.textContent=i.message,c.appendChild(d),c.appendChild(m),c.onclick=()=>{m.classList.contains("preset-description-hidden")?m.classList.remove("preset-description-hidden"):ul(i)},e.appendChild(c)});const l=document.getElementById("preset-count");l&&(l.textContent=r.length)}async function ul(e){if(vt){const n=Oe.findIndex(o=>o.name===e.name);n>-1?Oe.splice(n,1):Oe.push(e),Yr();return}if(window.batchProcessingActive){window.batchProcessingActive=!1;const n=window.batchImagesToProcess;window.batchImagesToProcess=null,Sn();const s=document.getElementById("preset-selector").querySelector(".preset-selector-header h3");s.textContent="Select Preset",await pl(e,n);return}const t=document.getElementById("viewer-prompt");t.value=e.message,Sn()}function ml(){if(Z<0||Z>=R.length){alert("No image selected");return}let t=document.getElementById("viewer-prompt").value.trim(),n="Custom Prompt";if(!t){const s=To(),r=g[s];t=r.message,n=r.name,alert(`Using random preset: ${n}`)}const o=R[Z];typeof PluginMessageHandler<"u"?(PluginMessageHandler.postMessage(JSON.stringify({message:jn(t,n),pluginId:"com.r1.pixelart",imageBase64:o.imageBase64})),alert("Magic transform submitted! You can submit again with a different prompt.")):alert("Magic transform sent: "+t.substring(0,50)+"...")}function wn(){st=!st;const e=document.getElementById("batch-mode-toggle"),t=document.getElementById("batch-controls"),n=document.getElementById("batch-action-bar");st?(e.textContent="Done",e.classList.add("active"),t.style.display="flex",n.style.display="flex",_.clear(),qn(),me()):(e.textContent="Select",e.classList.remove("active"),t.style.display="none",n.style.display="none",_.clear(),me())}function qn(){const e=document.getElementById("batch-selected-count"),t=document.getElementById("batch-apply-preset"),n=document.getElementById("batch-delete");e.textContent=`${_.size} selected`,t.disabled=_.size===0,n&&(n.disabled=_.size===0)}function gl(){const e=So();_.clear(),e.forEach(t=>_.add(t.id)),qn(),me()}function fl(){_.clear(),qn(),me()}function Ir(e){_.has(e)?_.delete(e):_.add(e),qn()}async function yl(){if(_.size===0)return;const e=document.getElementById("preset-selector"),t=e.querySelector(".preset-selector-header h3");t.textContent=`Select Preset (${_.size} images)`;const n=Array.from(_);window.batchProcessingActive=!0,window.batchImagesToProcess=n,rn(),e.style.display="flex",qe=!0,K=0,Et()}async function pl(e,t){const n=t||Array.from(_),o=n.length,s=document.createElement("div");s.className="batch-progress-overlay",s.innerHTML=`
    <div class="batch-progress-text">Processing <span id="batch-current">0</span> / ${o}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(s);let r=0;for(const l of n){const i=R.find(c=>c.id===l);if(i)try{const c=jn(e.message,e.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:c,pluginId:"com.r1.pixelart",imageBase64:i.imageBase64})),r++,document.getElementById("batch-current").textContent=r,document.getElementById("batch-progress-fill").style.width=`${r/o*100}%`,await new Promise(d=>setTimeout(d,3e3))}catch(c){console.error(`Failed to process image ${l}:`,c)}}document.body.removeChild(s),st=!1,_.clear(),wn(),alert(`Batch processing complete! ${r} of ${o} images submitted.`)}async function hl(){if(_.size===0)return;const e=_.size;if(!confirm(`Are you sure you want to delete ${e} selected image${e>1?"s":""}? This cannot be undone.`))return;const n=Array.from(_),o=document.createElement("div");o.className="batch-progress-overlay",o.innerHTML=`
    <div class="batch-progress-text">Deleting <span id="batch-current">0</span> / ${e}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(o);let s=0;for(const r of n)try{await Gr(r),s++,document.getElementById("batch-current").textContent=s,document.getElementById("batch-progress-fill").style.width=`${s/e*100}%`}catch(l){console.error(`Failed to delete image ${r}:`,l)}document.body.removeChild(o),st=!1,_.clear(),await On(),wn(),alert(`${s} of ${e} image${s>1?"s":""} deleted successfully.`)}function El(e){bn=e,Oe=[],vt=!0;const t=document.getElementById("preset-selector"),n=t.querySelector(".preset-selector-header h3");n.innerHTML='Select Presets <span id="multi-preset-count" style="font-size: 12px; color: #666;">(0 selected)</span>';let o=document.getElementById("multi-preset-controls");if(!o){o=document.createElement("div"),o.id="multi-preset-controls",o.style.cssText="padding: 0 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; gap: 8px; justify-content: space-between; align-items: stretch;",o.innerHTML=`
      <button id="multi-preset-apply" class="batch-control-button" style="background: #4CAF50; color: white;">Apply Selected</button>
      <button id="multi-preset-cancel" class="batch-control-button">Cancel</button>
    `;const s=document.getElementById("preset-filter"),r=document.getElementById("preset-list");s.parentNode.insertBefore(o,s),s.parentNode.insertBefore(s,r)}o.style.display="flex",rn(),Yr(),t.style.display="flex",qe=!0,K=0,Et(),document.getElementById("multi-preset-apply").onclick=Il,document.getElementById("multi-preset-cancel").onclick=Xr}function Yr(){document.getElementById("preset-list").querySelectorAll(".preset-item").forEach(o=>{const s=o.querySelector(".preset-name").textContent;Oe.some(l=>l.name===s)?(o.style.background="#e8f5e9",o.style.border="2px solid #4CAF50"):(o.style.background="",o.style.border="")});const n=document.getElementById("multi-preset-count");n&&(n.textContent=`(${Oe.length} selected)`)}function Xr(){vt=!1,bn=null,Oe=[];const e=document.getElementById("multi-preset-controls");e&&(e.style.display="none");const t=document.querySelector(".preset-selector-header h3");t.textContent="Select Preset",Sn()}async function Il(){if(Oe.length===0){alert("Please select at least one preset");return}if(!bn){alert("No image selected");return}const e=R.find(s=>s.id===bn);if(!e){alert("Image not found");return}const t=[...Oe];Xr();const n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`
    <div class="batch-progress-text">Applying preset <span id="batch-current">0</span> / ${t.length}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(n);let o=0;for(const s of t)try{const r=jn(s.message,s.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:r,pluginId:"com.r1.pixelart",imageBase64:e.imageBase64})),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=`${o/t.length*100}%`,await new Promise(l=>setTimeout(l,3e3))}catch(r){console.error(`Failed to apply preset ${s.name}:`,r)}document.body.removeChild(n),alert(`${o} preset${o>1?"s":""} applied successfully!`)}function bl(){const e=document.getElementById("viewer-image"),t=document.querySelector(".image-viewer-container");let n=0,o=0,s=0,r=0,l=!1;t.addEventListener("touchstart",i=>{i.touches.length===2?(i.preventDefault(),gn=!0,gr=br(i.touches[0],i.touches[1]),fr=be):i.touches.length===1&&be>1&&(l=!0,s=i.touches[0].clientX-n,r=i.touches[0].clientY-o)},{passive:!1}),t.addEventListener("touchmove",i=>{if(gn&&i.touches.length===2){i.preventDefault();const d=br(i.touches[0],i.touches[1])/gr;be=Math.max(1,Math.min(fr*d,5)),e.style.transform=`scale(${be}) translate(${n}px, ${o}px)`}else l&&i.touches.length===1&&be>1&&(i.preventDefault(),n=i.touches[0].clientX-s,o=i.touches[0].clientY-r,e.style.transform=`scale(${be}) translate(${n}px, ${o}px)`)},{passive:!1}),t.addEventListener("touchend",i=>{i.touches.length<2&&(gn=!1),i.touches.length===0&&(l=!1,be===1&&(n=0,o=0,e.style.transform="scale(1) translate(0, 0)"))}),t.addEventListener("touchcancel",()=>{gn=!1,l=!1})}function br(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function Ot(){if(!G)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),oe=Math.max(0,Math.min(oe,t.length-1));const n=t[oe];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=parseInt(n.dataset.index),s=g[o],r=document.getElementById("menu-category-hint");r&&s&&s.category?(r.innerHTML="",r.style.display="block",s.category.forEach((l,i)=>{const c=document.createElement("span");if(c.textContent=l,c.style.cursor="pointer",c.style.padding="0 2px",Ge===l&&(c.style.textDecoration="underline",c.style.fontWeight="bold"),c.onclick=d=>{d.stopPropagation(),Ge===l?Ge="":Ge=l,oe=0,Be()},r.appendChild(c),i<s.category.length-1){const d=document.createElement("span");d.textContent=", ",r.appendChild(d)}})):r&&(r.style.display="none")}}function vl(){if(!G||!it)return;const e=document.getElementById("menu-styles-list");!e||e.querySelectorAll(".style-item").length===0||(oe=Math.max(0,oe-1),Ot())}function Bl(){if(!G||!it)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(oe=Math.min(t.length-1,oe+1),Ot())}function Sl(){if(!G||!it)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||oe>=t.length)return;const n=t[oe];if(n&&n.querySelector(".style-name")){const r=Nt()[oe];if(r){const l=g.findIndex(i=>i===r);l!==-1&&(b=l,se(),ko())}}}async function wl(){await Re.init(),await de.init();const t=(await de.loadImportedPresets()).length>0,o=(await Re.getAllModifications()).length>0;t||o?g=await xn():(g=[],setTimeout(()=>{confirm("Welcome! You should import presets to get started. Would you like to import now?")&&(document.getElementById("menu-button").click(),setTimeout(()=>{document.getElementById("settings-menu-button").click(),setTimeout(()=>{document.getElementById("import-presets-button").click()},100)},100))},500));const s=localStorage.getItem(fo);if(s)try{const c=JSON.parse(s).filter(d=>d.internal===!1);for(const d of c)await Re.saveNewPreset(d),g.find(m=>m.name===d.name)||g.push(d);localStorage.removeItem(fo)}catch(i){console.error("Error loading styles:",i)}const r=localStorage.getItem(Vr);if(r)try{ze=JSON.parse(r),Array.isArray(ze)||(ze=[])}catch(i){console.error("Error parsing favorite styles:",i),ze=[]}Pl(),Ll();const l=localStorage.getItem(jr);if(l)try{x=JSON.parse(l),Array.isArray(x)||(x=[])}catch{console.error("Error parsing visible presets:",error),x=[]}x.length===0&&g.length>0&&(x=g.map(i=>i.name),Ee()),ft(),setTimeout(()=>{xl()},1e3)}async function xl(){try{const e=await fetch("./presets.json");if(!e.ok)return;const t=await e.json(),n=de.getImportedPresets();if(n.length===0)return;let o=!1;const s=new Set(n.map(r=>r.name));for(const r of t){const l=n.find(i=>i.name===r.name);if(!l||l.message!==r.message){o=!0;break}}if(o){const r=document.getElementById("updates-status");r&&(r.textContent="üî¥ Updates available",r.style.color="#FF5722",r.style.fontWeight="bold")}}catch(e){console.log("Could not check for updates:",e)}}async function xn(){const e=await Re.getAllModifications(),t=new Set,n=new Map,o=[];for(const i of e)i.type==="deletion"?t.add(i.name):i.type==="modification"?n.set(i.name,i.data):i.type==="new"&&o.push(i.data);const s=await de.loadImportedPresets();At=s.length>0;let r;if(At)r=s;else{if(wt.length===0){const i=await fetch("./presets.json");i.ok?(to=await i.json(),wt=[...to]):(to=[],wt=[])}r=wt}return[...r.filter(i=>!t.has(i.name)).map(i=>n.has(i.name)?{...i,...n.get(i.name)}:{...i}),...o]}function Ee(){try{localStorage.setItem(jr,JSON.stringify(x))}catch(e){console.error("Error saving visible presets:",e)}}function Tl(){return g.filter(e=>x.includes(e.name))}function Cl(e){try{localStorage.setItem(Lr,e.toString())}catch(t){console.error("Error saving resolution:",t)}}function Ll(){try{const e=localStorage.getItem(Lr);if(e!==null){const t=parseInt(e,10);t>=0&&t<tn.length&&(Je=t)}}catch(e){console.error("Error loading resolution:",e)}}function Zt(){const t=g.filter(s=>x.includes(s.name)).slice().sort((s,r)=>s.name.localeCompare(r.name)),n=t.filter(s=>Dt(s.name)),o=t.filter(s=>!Dt(s.name));return{favorites:n,regular:o}}function Nt(){const{favorites:e,regular:t}=Zt(),n=e.filter(s=>x.includes(s.name)),o=t.filter(s=>x.includes(s.name));return[...n,...o]}function Wr(){const e=Nt(),t=g[b];return e.findIndex(n=>n===t)}function Zr(e){const n=Nt()[e];return g.findIndex(o=>o===n)}function _n(){try{const e=g.filter(t=>t.internal===!1);localStorage.setItem(fo,JSON.stringify(e))}catch(e){console.error("Error saving styles:",e)}}function Ml(e){const t=ze.indexOf(e);t>-1?ze.splice(t,1):ze.push(e),localStorage.setItem(Vr,JSON.stringify(ze));const n=document.querySelector(".styles-menu-scroll-container"),o=n?n.scrollTop:0;Be(),n&&(n.scrollTop=o)}function Pl(){const e=localStorage.getItem(Ar);if(e!==null)try{const t=parseInt(e,10);t>=0&&t<g.length&&(b=t)}catch(t){console.error("Error loading last used style:",t)}}function Dt(e){return ze.includes(e)}function To(){const e=Nt();if(e.length===0)return 0;const t=e.filter(o=>Dt(o.name));if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];return g.findIndex(s=>s===o)}const n=e[Math.floor(Math.random()*e.length)];return g.findIndex(o=>o===n)}function Kr(){ue=!ue;const e=document.getElementById("motion-toggle");if(ue)e.classList.add("active"),e.title="Motion Detection: ON",S.textContent=`Motion Detection mode ON ‚Ä¢ ${g[b].name}`,Q("üëÅÔ∏è Motion Detection");else{e.classList.remove("active"),e.title="Motion Detection: OFF",Mo(),Vt&&(clearInterval(Vt),Vt=null);const t=document.getElementById("timer-countdown");t&&(t.style.display="none",t.classList.remove("countdown-fade-in","countdown-fade-out"));const n=document.getElementById("camera-button");n&&q.length>1&&(n.style.display="flex"),g&&g[b]&&(S.textContent=`Style: ${g[b].name}`,Q(g[b].name))}}function kl(){for(let e in Yt)if(Yt[e].seconds===kt)return parseInt(e);return 1}function Al(){document.getElementById("settings-submenu").style.display="none",document.getElementById("motion-submenu").style.display="flex",Dn=!0,te=!1}function Dl(){document.getElementById("motion-submenu").style.display="none",Dn=!1,_e()}function Rl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("visible-presets-submenu").style.display="flex",G=!1,Xe=!0,sn=!0,te=!1,ce=0,Wt="",document.getElementById("visible-presets-filter").value="",Tt(),ft()}function Ol(){document.getElementById("visible-presets-submenu").style.display="none",Xe=!1,sn=!1,ce=0,Wt="",mt="";const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none"),_e()}function ei(){document.getElementById("settings-submenu").style.display="none",document.getElementById("preset-builder-submenu").style.display="flex",G=!1,te=!1,Rt=!0,Fn()}function Co(){document.getElementById("preset-builder-submenu").style.display="none",Rt=!1,Ae=-1;const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none"),_e()}function Fn(){Ae=-1,document.getElementById("preset-builder-name").value="",document.getElementById("preset-builder-category").value="",document.getElementById("preset-builder-template").value="",document.getElementById("preset-builder-prompt").value="";const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none");const t=document.getElementById("preset-builder-clear");t&&(t.style.display="flex"),document.querySelectorAll(".chip-section-content").forEach(n=>{n.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(n=>{n.classList.remove("expanded")})}function Nl(e){const t=g[e];ei(),Ae=e,setTimeout(()=>{const n=document.getElementById("preset-builder-name"),o=document.getElementById("preset-builder-category"),s=document.getElementById("preset-builder-prompt"),r=document.getElementById("preset-builder-template"),l=document.getElementById("preset-builder-delete"),i=document.getElementById("preset-builder-clear");n&&(n.value=t.name),o&&(o.value=t.category?t.category.join(", "):""),s&&(s.value=t.message),r&&(r.value=""),l&&(l.style.display="flex"),i&&(i.style.display="none")},100)}function ql(){const e=document.getElementById("preset-builder-template"),t=document.getElementById("preset-builder-prompt"),n=e.value;n&&yr[n]!==void 0&&(t.value=yr[n])}function _l(){const e=new Set;return g.forEach(t=>{t.category&&Array.isArray(t.category)&&t.category.forEach(n=>{e.add(n.toUpperCase())})}),Array.from(e).sort()}function Fl(){const e=document.getElementById("preset-builder-name").value.trim(),t=document.getElementById("preset-builder-category").value.trim(),n=document.getElementById("preset-builder-prompt").value.trim();if(!e){alert("Please enter a preset name");return}if(!n){alert("Please enter a prompt");return}const o=t?t.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):["CUSTOM"];if(Ae>=0){const s=g[Ae].name;if(g[Ae]={name:e.toUpperCase(),category:o,message:n,internal:!1},s!==e.toUpperCase()){const r=x.indexOf(s);r>-1&&(x[r]=e.toUpperCase())}}else{const s=g.findIndex(l=>l.name.toUpperCase()===e.toUpperCase());if(s!==-1){if(!confirm(`A preset named "${e}" already exists. Do you want to overwrite it?`))return;g.splice(s,1)}const r={name:e.toUpperCase(),category:o,message:n,internal:!1};g.push(r),x.includes(r.name)||x.push(r.name)}Ee(),_n(),alert(Ae>=0?`Preset "${e}" updated!`:`Preset "${e}" saved successfully!`),Fn(),Co(),G&&Be()}function Hl(){if(Ae<0){alert("No preset selected for deletion");return}const e=g[Ae];if(e.internal!==!1){alert("Cannot delete built-in presets");return}if(!confirm(`Delete preset "${e.name}"? This cannot be undone.`))return;g.splice(Ae,1);const t=x.indexOf(e.name);t>-1&&(x.splice(t,1),Ee()),b>=g.length&&(b=g.length-1),_n(),alert(`Preset "${e.name}" deleted successfully!`),Fn(),Co(),G&&Be()}function Tt(){const e=document.getElementById("visible-presets-list"),t=document.querySelector("#visible-presets-submenu .submenu-list");t&&t.scrollTop,e.innerHTML="";const s=g.filter(i=>!i.internal).filter(i=>{if(Wt){const c=Wt.toLowerCase(),d=i.category&&i.category.some(f=>f.toLowerCase().includes(c));if(!(i.name.toLowerCase().includes(c)||d))return!1}return mt?i.category&&i.category.includes(mt):!0}).sort((i,c)=>i.name.localeCompare(c.name)),r=document.createDocumentFragment();s.forEach(i=>{const c=document.createElement("div");c.className="style-item",c.dataset.presetName=i.name;const d=document.createElement("input");d.type="checkbox",d.className="master-prompt-checkbox",d.checked=x.includes(i.name),d.style.marginRight="3vw";const m=document.createElement("span");m.className="style-name",m.textContent=i.name,c.appendChild(d),c.appendChild(m),d.onclick=f=>{f.stopPropagation(),vr(i.name,d.checked)},c.onclick=()=>{d.checked=!d.checked,vr(i.name,d.checked)},r.appendChild(c)}),e.appendChild(r);const l=document.getElementById("visible-presets-count");if(l){const i=s.filter(c=>x.includes(c.name)).length;l.textContent=i}setTimeout(()=>{Kt()},50)}function vr(e,t){const n=x.indexOf(e);t&&n===-1?x.push(e):!t&&n>-1&&x.splice(n,1),Ee(),ft();const o=document.querySelector("#visible-presets-submenu .submenu-list"),s=o?o.scrollTop:0;Tt(),o&&requestAnimationFrame(()=>{o.scrollTop=s});const r=document.getElementById("styles-count");if(r){const{favorites:l,regular:i}=Zt(),c=l.length+i.length;r.textContent=c}G&&Be()}function ft(){const e=document.getElementById("current-visible-presets-display");if(e){const t=g.filter(o=>!o.internal).length,n=x.length;e.textContent=n===t?"All Visible":`${n} of ${t}`}}function $l(){if(!Xe||!sn)return;const e=document.getElementById("visible-presets-list");!e||e.querySelectorAll(".style-item").length===0||(ce=Math.max(0,ce-1),Kt())}function Ul(){if(!Xe||!sn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(ce=Math.min(t.length-1,ce+1),Kt())}function Kt(){if(!Xe)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),ce=Math.max(0,Math.min(ce,t.length-1));const n=t[ce];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.dataset.presetName,s=g.find(l=>l.name===o),r=document.getElementById("visible-presets-category-hint");r&&s&&s.category?(r.innerHTML="",r.style.display="block",s.category.forEach((l,i)=>{const c=document.createElement("span");if(c.textContent=l,c.style.cursor="pointer",c.style.padding="0 2px",mt===l&&(c.style.textDecoration="underline",c.style.fontWeight="bold"),c.onclick=d=>{d.stopPropagation(),mt===l?mt="":mt=l,ce=0,Tt()},r.appendChild(c),i<s.category.length-1){const d=document.createElement("span");d.textContent=", ",r.appendChild(d)}})):r&&(r.style.display="none")}}function Vl(){if(!Xe||!sn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||ce>=t.length)return;const n=t[ce];n&&n.click()}function ti(){const e=["Very Low","Low","Medium","High","Very High"],t=document.getElementById("current-motion-display");if(t){const n=Math.floor((50-Mt)/10)+1,o=Math.max(1,Math.min(5,n));t.textContent=`Sensitivity: ${e[o-1]}`}}function fn(){const e={motionThreshold:Mt,motionPixelThreshold:Bo,motionContinuousEnabled:ht,motionCooldown:Pt,motionStartDelay:kt};try{localStorage.setItem(_r,JSON.stringify(e))}catch(t){console.error("Failed to save motion settings:",t)}}function jl(){try{const e=localStorage.getItem(_r);if(e){const t=JSON.parse(e);Mt=t.motionThreshold||30,Bo=t.motionPixelThreshold||.1,ht=t.motionContinuousEnabled!==void 0?t.motionContinuousEnabled:!0,Pt=t.motionCooldown||2,kt=t.motionStartDelay||3}{const t=document.getElementById("motion-sensitivity-slider");if(t){const l=Math.floor((50-Mt)/10)+1;t.value=Math.max(1,Math.min(5,l))}const n=document.getElementById("motion-continuous-enabled");n&&(n.checked=ht);const o=document.getElementById("motion-cooldown-slider");o&&(o.value=Pt);const s=document.getElementById("motion-start-delay-slider"),r=document.getElementById("motion-start-delay-value");if(s&&r){const l=kl();s.value=l,r.textContent=Yt[l].label}ti()}}catch(e){console.error("Failed to load motion settings:",e)}}function Gl(){ie=!ie;const e=document.getElementById("no-magic-status");e&&(e.textContent=ie?"Enabled":"Disabled",e.style.color=ie?"#4CAF50":"",e.style.fontWeight=ie?"600":"");try{localStorage.setItem(Fr,JSON.stringify(ie))}catch(t){console.error("Failed to save No Magic mode:",t)}ie?showStatus("No Magic Mode ON - Camera only",2e3):showStatus("No Magic Mode OFF - AI prompts enabled",2e3)}function zl(){try{const e=localStorage.getItem(Fr);if(e!==null){ie=JSON.parse(e);const t=document.getElementById("no-magic-status");t&&(t.textContent=ie?"Enabled":"Disabled",t.style.color=ie?"#4CAF50":"",t.style.fontWeight=ie?"600":"")}}catch(e){console.error("Failed to load No Magic mode:",e)}}function Jl(){const e=localStorage.getItem(Mr);e!==null&&(Ct=parseInt(e,10)),ni()}function Ql(){localStorage.setItem(Mr,Ct.toString()),ni()}function ni(){const e=document.getElementById("current-import-resolution-display");if(e){const t=bo[Ct];e.textContent=t.name.split(" ")[0]}}function Yl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("tutorial-submenu").style.display="flex",G=!1,bt=!0,Ce=0,te=!1,oi()}function Xl(){document.getElementById("tutorial-submenu").style.display="none",bt=!1,_e()}function Wl(e){const t=document.getElementById("tutorial-glossary"),n=document.getElementById("tutorial-content-area"),o=document.getElementById("section-"+e),s=document.getElementById("back-to-glossary");t&&n&&o&&(t.style.display="none",n.style.display="flex",s&&(s.style.display="block"),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"start"})},100))}function oi(){const e=document.getElementById("tutorial-glossary"),t=document.getElementById("tutorial-content-area"),n=document.getElementById("back-to-glossary");e&&t&&(t.style.display="none",e.style.display="block",n&&(n.style.display="none"),Ce=0,setTimeout(()=>{Lo()},50))}function Zl(){if(!bt)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Ce=(Ce-1+o.length)%o.length,Lo();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.max(0,n.scrollTop-80))}function Kl(){if(!bt)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Ce=(Ce+1)%o.length,Lo();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+80))}function Lo(){const e=document.getElementById("tutorial-glossary");if(!e)return;const t=e.querySelectorAll(".glossary-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),Ce>=0&&Ce<t.length)){const n=t[Ce];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function ea(){document.getElementById("settings-submenu").style.display="none";const e=document.getElementById("import-resolution-submenu"),t=document.getElementById("import-resolution-list");t.innerHTML="",bo.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Ct&&s.classList.add("selected"),s.textContent=n.name,s.onclick=()=>{Ct=o,Ql(),si()},t.appendChild(s)}),e.style.display="flex"}function si(){document.getElementById("import-resolution-submenu").style.display="none",document.getElementById("settings-submenu").style.display="flex"}function yo(){!E||!I||(je=null,mn=!1,pn=setInterval(()=>{if(!ue||mn||!ht&&U.style.display==="block")return;ta()&&(console.log("Motion detected! Capturing..."),Eo(),mn=!0,setTimeout(()=>{if(mn=!1,je=null,U.style.display==="block"&&(U.style.display="none",E.style.display="block"),!ht){Mo(),ue=!1;const t=document.getElementById("motion-toggle");t.classList.remove("active"),t.title="Motion Detection: OFF",showStatus("Motion capture complete - Press eye button to reactivate",3e3),g&&g[b]&&Q(g[b].name)}},Pt*1e3))},500))}function Mo(){pn&&(clearInterval(pn),pn=null),je=null}function ta(){if(!E||!I)return!1;const e=I.getContext("2d"),t=320,n=240;I.width=t,I.height=n,e.drawImage(E,0,0,t,n);const o=e.getImageData(0,0,t,n);if(!je)return je=o,!1;let s=0;const r=t*n;for(let i=0;i<o.data.length;i+=4){const c=Math.abs(o.data[i]-je.data[i]),d=Math.abs(o.data[i+1]-je.data[i+1]),m=Math.abs(o.data[i+2]-je.data[i+2]);(c+d+m)/3>Mt&&s++}return je=o,s/r>Bo}function ri(){ke=!ke;const e=document.getElementById("random-toggle");ke?(e.classList.add("random-active"),S.textContent=`Random mode ON ‚Ä¢ ${g[b].name}`,Q("üé≤ Random Mode")):(e.classList.remove("random-active"),se(),g&&g[b]&&Q(g[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"random_mode_toggled",enabled:ke,timestamp:Date.now()}))}function na(){try{const e=localStorage.getItem(Ur);e&&(A=JSON.parse(e))}catch(e){console.error("Error loading queue:",e),A=[]}}function ln(){try{localStorage.setItem(Ur,JSON.stringify(A))}catch(e){console.error("Error saving queue:",e)}}function io(){ut&&(Se?(ut.className="connection-status online",ut.querySelector("#connection-text").textContent="Online"):(ut.className="connection-status offline",ut.querySelector("#connection-text").textContent="Offline"),ut.style.display="block"),qt()}function qt(){if(xt){const e=A.length;xt.querySelector("#queue-count").textContent=e,xt.style.display=e>0?"block":"none"}if(De){const e=A.length;De.querySelector("#sync-count").textContent=e,De.style.display=e>0&&Se?"block":"none"}}function oa(){window.addEventListener("online",()=>{Se=!0,io(),console.log("Connection restored"),A.length>0&&!yt&&setTimeout(()=>{S.textContent=`Connection restored! Syncing ${A.length} photos...`,en()},1e3)}),window.addEventListener("offline",()=>{Se=!1,io(),console.log("Connection lost"),yt&&(S.textContent="Connection lost during sync")}),io()}async function sa(){try{return q=(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"),console.log("Available cameras:",q.length),q}catch(e){return console.error("Error enumerating cameras:",e),[]}}function Hn(){const e=tn[Je];if(q.length===0)return{video:{facingMode:"environment",width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};const n={video:{deviceId:{exact:q[le].deviceId},width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};return pt()&&(n.video.advanced=[{zoom:1}]),n}async function ra(e){if(!(e===Je||!O)){Je=e,Cl(e);try{S.textContent="Changing resolution...",O&&O.getTracks().forEach(n=>n.stop());const t=Hn();O=await navigator.mediaDevices.getUserMedia(t),E.srcObject=O,z=O.getVideoTracks()[0],await new Promise(n=>{E.onloadedmetadata=async()=>{try{await E.play(),$n(),await _t(ee),setTimeout(n,100)}catch(o){console.error("Video play error:",o),n()}}}),se(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"resolution_changed",resolution:tn[Je].name,timestamp:Date.now()}))}catch(t){console.error("Resolution change error:",t),S.textContent="Resolution change failed"}}}function po(){if(q.length===0)return"Default Camera";const e=q[le];let t=e.label;return!t||t===""?e.deviceId?t=`Camera ${le+1}`:t="Unknown Camera":(t=t.replace(/\([^)]*\)/g,"").trim(),t.toLowerCase().includes("front")?t="Front Camera":t.toLowerCase().includes("back")||t.toLowerCase().includes("rear")?t="Back Camera":t.length>20&&(t=t.substring(0,17)+"...")),t}function pt(){if(q.length===0)return!1;const e=q[le];if(!e)return!1;const t=e.label.toLowerCase();return e.facingMode==="user"?!0:e.facingMode==="environment"?!1:t.includes("front")||t.includes("user")||t.includes("selfie")||t.includes("face")?!0:t.includes("back")||t.includes("rear")||t.includes("environment")?!1:q.length===2?le===1:le>0}function $n(){try{pt()?(E.style.transform="translateZ(0)",E.style.webkitTransform="translateZ(0)"):(E.style.transform="scaleX(-1) translateZ(0)",E.style.webkitTransform="scaleX(-1) translateZ(0)")}catch(e){console.warn("Mirror transform skipped:",e)}}function ia(){if(!z)return!1;const e=z.getCapabilities();return e&&"zoom"in e}function ii(){if(!z)return{min:1,max:5,step:.1};const e=z.getCapabilities();return e&&e.zoom?{min:Math.min(e.zoom.min||1,1),max:Math.max(e.zoom.max||5,5),step:e.zoom.step||.1}:{min:1,max:5,step:.1}}async function _t(e){if(z)try{if(ia()){const t=ii(),n=Math.max(t.min,Math.min(e,t.max)),o={advanced:[{zoom:n}]},s=z.getCapabilities();s&&s.focusMode&&s.focusMode.includes("continuous")&&(o.advanced[0].focusMode="continuous"),await z.applyConstraints(o),ee=n,pt()?(E.style.transform="translateZ(0)",E.style.webkitTransform="translateZ(0)"):(E.style.transform="scaleX(-1) translateZ(0)",E.style.webkitTransform="scaleX(-1) translateZ(0)")}else{const t=Math.max(1,Math.min(e,5));ee=t,pt()?(E.style.transform=`scale(${t})`,E.style.webkitTransform=`scale(${t})`):(E.style.transform=`scaleX(-1) scale(${t})`,E.style.webkitTransform=`scaleX(-1) scale(${t})`)}}catch{const n=Math.max(1,Math.min(e,5));ee=n,pt()?(E.style.transform=`scale(${n})`,E.style.webkitTransform=`scale(${n})`):(E.style.transform=`scaleX(-1) scale(${n})`,E.style.webkitTransform=`scaleX(-1) scale(${n})`)}}async function la(){if(z)try{const e=z.getCapabilities();e&&e.focusMode&&(e.focusMode.includes("single-shot")?(await z.applyConstraints({advanced:[{focusMode:"single-shot",zoom:ee}]}),console.log("Triggered single-shot focus"),setTimeout(async()=>{try{await z.applyConstraints({advanced:[{focusMode:"continuous",zoom:ee}]})}catch(t){console.log("Could not return to continuous focus:",t)}},500)):e.focusMode.includes("manual")&&(await z.applyConstraints({advanced:[{focusMode:"manual",zoom:ee}]}),console.log("Triggered manual focus")))}catch(e){console.log("Focus adjustment not supported or failed:",e)}}async function aa(){if(no||q.length<=1){console.log("Cannot switch camera: loading or not enough cameras");return}no=!0;try{S.textContent="Switching camera...",O&&O.getTracks().forEach(t=>t.stop()),le=(le+1)%q.length,console.log(`Switching to camera ${le+1} of ${q.length}`);const e=Hn();O=await navigator.mediaDevices.getUserMedia(e),E.srcObject=O,z=O.getVideoTracks()[0],await new Promise(t=>{E.onloadedmetadata=async()=>{try{await E.play(),$n(),await _t(ee),setTimeout(t,100)}catch(n){console.error("Video play error:",n),t()}}}),se(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"camera_switched",cameraIndex:le,cameraLabel:po(),timestamp:Date.now()}))}catch(e){console.error("Camera switch error:",e),S.textContent="Camera switch failed",le=(le-1+q.length)%q.length}finally{no=!1}}function ca(){try{const e=localStorage.getItem(Pr);if(e){const t=JSON.parse(e);j=t.count||5;const n=t.speed||2;nn=Lt[n].delay}}catch(e){console.error("Error loading burst settings:",e)}}function Br(e,t){try{localStorage.setItem(Pr,JSON.stringify({count:e,speed:t}))}catch(n){console.error("Error saving burst settings:",n)}}function li(){pe=!pe;const e=document.getElementById("burst-toggle");pe?(e.classList.add("burst-active"),S.textContent=`Burst mode ON (${j} photos) ‚Ä¢ ${g[b].name}`,Q("üì∏ Burst Mode")):(e.classList.remove("burst-active"),se(),g&&g[b]&&Q(g[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_mode_toggled",enabled:pe,count:j,timestamp:Date.now()}))}function ai(){he=!he;const e=document.getElementById("timer-toggle");he?(e.classList.add("timer-active"),S.textContent=`Timer mode ON (${Ne}s delay) ‚Ä¢ ${g[b].name}`,Q("‚è±Ô∏è Timer Mode")):(e.classList.remove("timer-active"),Qe&&(clearInterval(Qe),Qe=null,document.getElementById("timer-countdown").style.display="none"),se(),g&&g[b]&&Q(g[b].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"timer_mode_toggled",enabled:he,delay:Ne,timestamp:Date.now()}))}function ho(e){let t=Ne;const n=document.getElementById("timer-countdown"),o=document.getElementById("timer-countdown-text");o.textContent=t,n.style.display="flex",n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),S.textContent=`Timer: ${t}s...`,Qe=setInterval(()=>{t--,t>0?(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{o.textContent=t,n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),S.textContent=`Timer: ${t}s...`},500)):(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{n.style.display="none",n.classList.remove("countdown-fade-out"),clearInterval(Qe),Qe=null,e(),It&&he&&(setTimeout(()=>{if(U.style.display==="block"){U.style.display="none",E.style.display="block";const s=document.getElementById("camera-button");s&&q.length>1&&(s.style.display="flex")}},500),setTimeout(()=>{he&&ho(e)},ge*1e3))},500))},1e3)}function ci(){Qe&&(clearInterval(Qe),Qe=null,document.getElementById("timer-countdown").style.display="none",se())}function da(){try{const e=localStorage.getItem(kr);if(e){const t=JSON.parse(e);Ne=t.delay||10,It=t.repeat||!1,ge=t.repeatInterval||1}}catch(e){console.error("Error loading timer settings:",e)}}function lo(){try{localStorage.setItem(kr,JSON.stringify({delay:Ne,repeat:It,repeatInterval:ge}))}catch(e){console.error("Error saving timer settings:",e)}}function zt(){const e=document.getElementById("current-timer-display");if(e){const t=It?`Repeat (${Rr[ua()].label})`:"No Repeat";e.textContent=`${Ne}s, ${t}`}}function ua(){for(const[e,t]of Object.entries(Rr))if(t.seconds===ge)return parseInt(e);return 1}async function Sr(){if(!(!O||oo||U.style.display==="block")){oo=!0,S.textContent=`Burst mode: Taking ${j} photos...`;for(let e=0;e<j;e++)S.textContent=`Burst ${e+1}/${j}...`,ma(e+1),e<j-1&&await new Promise(t=>setTimeout(t,nn));oo=!1,S.textContent=`Burst complete! ${j} photos saved.`,Se&&!yt?setTimeout(()=>{en()},500):Se||(S.textContent=`Burst complete! ${j} photos queued (offline).`),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_complete",count:j,timestamp:Date.now()})),setTimeout(()=>{pe?S.textContent=`Burst mode ON (${j} photos) ‚Ä¢ ${g[b].name}`:se()},2e3)}}function ma(e){if(!O)return;ke&&(b=To()),(I.width!==E.videoWidth||I.height!==E.videoHeight)&&(I.width=E.videoWidth,I.height=E.videoHeight);const t=I.getContext("2d",{willReadFrequently:!1,alpha:!1});t.clearRect(0,0,I.width,I.height);const n=I.width/ee,o=I.height/ee,s=(I.width-n)/2,r=(I.height-o)/2;if(pt())t.drawImage(E,s,r,n,o,0,0,I.width,I.height);else{t.save(),t.scale(-1,1),t.drawImage(E,s,r,n,o,-I.width,0,I.width,I.height),t.restore();const m=document.createElement("canvas");m.width=I.width,m.height=I.height;const f=m.getContext("2d");f.scale(-1,1),f.drawImage(I,-I.width,0),t.clearRect(0,0,I.width,I.height),t.drawImage(m,0,0)}const l=Je>=2?.7:.8,i=I.toDataURL("image/jpeg",l),c=g[b];zr(i);const d={id:Date.now().toString()+"-"+e,imageBase64:i,preset:c,timestamp:Date.now()};A.push(d),ln(),qt()}async function ga(){try{E=document.getElementById("video"),I=document.getElementById("canvas"),U=document.getElementById("captured-image"),S=document.getElementById("status"),In=document.getElementById("reset-button");const e=document.getElementById("start-screen");if(e){const l=e.querySelector(".start-text");l&&(l.textContent="Requesting camera access...");const i=document.getElementById("start-button");i&&(i.disabled=!0)}if(await sa(),q.length>1){const l=q.findIndex(i=>{const c=i.label.toLowerCase();return c.includes("back")||c.includes("rear")||c.includes("environment")});le=l!==-1?l:q.length-1}else le=0;const t=Hn();O=await navigator.mediaDevices.getUserMedia(t),E.srcObject=O,z=O.getVideoTracks()[0],console.log("Camera initialized:",po()),na(),oa(),await new Promise(l=>{E.onloadedmetadata=async()=>{try{await E.play(),$n(),_t(1),setTimeout(l,100)}catch(i){console.error("Video play error:",i),l()}}}),document.getElementById("start-screen").remove(),document.getElementById("camera-container").style.display="flex",S.style.display="block";const n=document.getElementById("camera-button");q.length>1&&(n.style.display="flex");const o=document.getElementById("menu-button");o&&(o.style.display="flex");const s=document.getElementById("mode-carousel");s&&(s.style.display="block");const r=document.getElementById("gallery-button");r&&(r.style.display="flex"),se(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_ready",availableCameras:q.length,currentCamera:po(),timestamp:Date.now()}))}catch(e){console.error("Camera access error:",e),S.textContent="Camera access denied";const t=document.getElementById("start-button");t&&(t.disabled=!1);const n=document.getElementById("start-screen");n&&(n.style.display="block"),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_error",error:e.message,timestamp:Date.now()}))}}function lt(){O&&E&&(O.getTracks().forEach(e=>{e.stop()}),E.style.display="none",E.srcObject=null)}async function di(){if(E)try{const e=Hn();O=await navigator.mediaDevices.getUserMedia(e),E.srcObject=O,z=O.getVideoTracks()[0],await new Promise(t=>{E.onloadedmetadata=async()=>{try{await E.play(),$n(),await _t(ee),setTimeout(t,100)}catch(n){console.error("Video resume error:",n),t()}}}),E.style.display="block"}catch(e){console.error("Failed to resume camera:",e),S.textContent="Camera resume failed"}}function Eo(){if(!O)return;ke&&(b=To(),Q(g[b].name)),(I.width!==E.videoWidth||I.height!==E.videoHeight)&&(I.width=E.videoWidth,I.height=E.videoHeight);const e=I.getContext("2d",{willReadFrequently:!1,alpha:!1,desynchronized:!0});e.clearRect(0,0,I.width,I.height);const t=I.width/ee,n=I.height/ee,o=(I.width-t)/2,s=(I.height-n)/2;if(pt())e.drawImage(E,o,s,t,n,0,0,I.width,I.height);else{e.save(),e.scale(-1,1),e.drawImage(E,o,s,t,n,-I.width,0,I.width,I.height),e.restore();const f=document.createElement("canvas");f.width=I.width,f.height=I.height;const v=f.getContext("2d");v.scale(-1,1),v.drawImage(I,-I.width,0),e.clearRect(0,0,I.width,I.height),e.drawImage(f,0,0)}const r=Je>=2?.7:.8,l=I.toDataURL("image/jpeg",r);U.src=l,U.style.display="block",U.style.transform="none",E.style.display="none",Mn(),ue||he&&It?In.style.display="none":In.style.display="block";const i=document.getElementById("camera-button");i&&(i.style.display="none");const c=document.getElementById("resolution-button");c&&(c.style.display="none"),zr(l);const d=g[b],m={id:Date.now().toString(),imageBase64:l,preset:d,timestamp:Date.now()};if(A.push(m),ln(),qt(),Se){const f=ie?"Photo saved!":"Photo saved! Uploading...";S.textContent=f,yt||en()}else S.textContent=`Photo queued for sync (${A.length} in queue)`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"photo_captured",queued:!0,queueLength:A.length,timestamp:Date.now()}))}async function en(){if(A.length===0||yt)return;if(!Se){S.textContent="Cannot sync - offline";return}yt=!0,De.disabled=!0,De.classList.add("syncing"),console.log(`Syncing ${A.length} queued photos...`);const e=A.length;let t=0;for(;A.length>0&&Se;){const n=A[0];try{if(S.textContent=`Syncing ${t+1}/${e}...`,typeof PluginMessageHandler<"u"&&!ie&&PluginMessageHandler.postMessage(JSON.stringify({message:jn(n.preset.message,n.preset.name),pluginId:"com.r1.pixelart",imageBase64:n.imageBase64})),await new Promise(o=>setTimeout(o,3e3)),Se)A.shift(),t++,ln(),qt();else{console.log("Lost connection during sync");break}await new Promise(o=>setTimeout(o,3e3))}catch(o){console.error("Sync error:",o),S.textContent="Sync error - will retry later";break}}if(yt=!1,De.disabled=!1,De.classList.remove("syncing"),A.length===0){const n=ie?`All ${t} photos saved!`:`All ${t} photos synced successfully!`;S.textContent=n,setTimeout(()=>{se()},2e3)}else Se?S.textContent=`Synced ${t}. ${A.length} remaining.`:S.textContent=`Connection lost. ${A.length} photos queued.`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"sync_complete",synced:t,remaining:A.length,timestamp:Date.now()}))}function Po(){const e=document.getElementById("queue-manager"),t=document.getElementById("queue-list");t.innerHTML="",A.length===0?t.innerHTML=`
      <div class="queue-empty">
        <h4>No Photos in Queue</h4>
        <p>Take photos while offline and they'll appear here for syncing.</p>
      </div>
    `:A.forEach((n,o)=>{const s=document.createElement("div");s.className="queue-item",s.innerHTML=`
        <div class="queue-item-header">
          <span class="queue-item-style">${n.preset.name}</span>
          <span class="queue-item-time">${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <img src="${n.imageBase64}" class="queue-item-preview" alt="Queued photo">
        <div class="queue-item-actions">
          <button onclick="removeFromQueue(${o})" class="delete-button">Remove</button>
          <button onclick="previewQueueItem(${o})" class="secondary">Preview</button>
        </div>
      `,t.appendChild(s)}),e.style.display="flex"}function fa(){document.getElementById("queue-manager").style.display="none"}function ya(e){confirm("Remove this photo from the sync queue?")&&(A.splice(e,1),ln(),qt(),Po())}function pa(e){const t=A[e];alert(`Style: ${t.preset.name}
Prompt: ${t.preset.message}
Saved: ${new Date(t.timestamp).toLocaleString()}`)}function ui(){confirm("Clear all photos from the queue? This cannot be undone.")&&(A=[],ln(),qt(),Po())}window.addEventListener("sideClick",()=>{if(console.log("Side button pressed"),te){const o=document.getElementById("settings-submenu").querySelectorAll(".menu-section-button");o.length>0&&xe<o.length&&o[xe].click();return}if(Xe){Vl();return}if(bt){const n=document.getElementById("tutorial-glossary");if(n&&n.style.display!=="none"){const o=n.querySelectorAll(".glossary-item");o.length>0&&Ce<o.length&&o[Ce].click()}return}if(on){const o=document.getElementById("resolution-submenu").querySelectorAll(".resolution-item");o.length>0&&Te<o.length&&o[Te].click();return}if(qe){dl();return}if(G&&it){Sl();return}const e=document.getElementById("start-screen"),t=document.getElementById("start-button");if(e&&e.style.display!=="none")console.log("Simulating tap on start button"),setTimeout(()=>{t.click()},100);else if(U&&U.style.display==="block")Un();else{if(ue){if(kt>0){let n=kt;const o=document.getElementById("timer-countdown"),s=document.getElementById("timer-countdown-text");s.textContent=n,o.style.display="flex",o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),S.textContent=`Motion Detection starting in ${n}s...`,Vt=setInterval(()=>{n--,n>0?(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{s.textContent=n,o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),S.textContent=`Motion Detection starting in ${n}s...`},500)):(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{o.style.display="none",o.classList.remove("countdown-fade-out"),clearInterval(Vt),ue&&E&&E.readyState>=2&&(yo(),showStatus("Motion Detection active - Move in front of camera",3e3))},500))},1e3)}else yo(),showStatus("Motion Detection ON - Move in front of camera",3e3);return}he?ho(pe?()=>Sr():()=>Eo()):pe?Sr():Eo()}});window.addEventListener("scrollUp",()=>{var t,n,o,s;if(console.log("Scroll wheel: up"),document.getElementById("style-editor").style.display==="flex"){hr();return}if(qe){ji();return}if(de.isImportModalOpen){de.scrollImportUp();return}if(bt){Zl();return}if(Rt){Jr();return}if(Xe){$l();return}if(G&&it){vl();return}if(Dn){nl();return}if(An){el();return}if(kn){Zi();return}if(Pn){Xi();return}if(on){Qi();return}if(te){zi();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){sl();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){il();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){hr();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){al();return}if(!O||U.style.display==="block")return;const e=Date.now();e-Bn<$r||(Bn=e,ot&&clearTimeout(ot),ot=setTimeout(()=>{let r=Wr();const l=Nt();r=(r-1+l.length)%l.length,b=Zr(r);const i=g[b];i&&Q(i.name),se(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:g[b].name,timestamp:Date.now()})),ot=null},50))});window.addEventListener("scrollDown",()=>{var t,n,o,s;if(console.log("Scroll wheel: down"),document.getElementById("style-editor").style.display==="flex"){Er();return}if(qe){Gi();return}if(de.isImportModalOpen){de.scrollImportDown();return}if(bt){Kl();return}if(Rt){Qr();return}if(Xe){Ul();return}if(G&&it){Bl();return}if(Dn){ol();return}if(An){tl();return}if(kn){Ki();return}if(Pn){Wi();return}if(on){Yi();return}if(te){Ji();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){rl();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){ll();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){Er();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){cl();return}if(!O||U.style.display==="block")return;const e=Date.now();e-Bn<$r||(Bn=e,ot&&clearTimeout(ot),ot=setTimeout(()=>{let r=Wr();const l=Nt();r=(r+1)%l.length,b=Zr(r);const i=g[b];i&&Q(i.name),se(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:g[b].name,timestamp:Date.now()})),ot=null},50))});function se(){b=Math.max(0,Math.min(b,g.length-1));const e=g[b];if(z)try{const t={};z.applyConstraints(t)}catch(t){console.error("Error applying preset constraints:",t)}S&&(S.textContent=`Style: ${e.name}`),Q(e.name),localStorage.setItem(Ar,b.toString()),G&&Ot()}window.onPluginMessage=function(e){console.log("Received plugin message:",e),e&&e.status==="processing"?S.textContent="AI is processing your image...":e&&e.status==="complete"?S.textContent="AI transformation complete!":e&&e.error&&(S.textContent="Error: "+e.error)};typeof PluginMessageHandler<"u"?(console.log("Flutter channel is available"),PluginMessageHandler.postMessage(JSON.stringify({message:"AI Camera Styles initialized",pluginId:"com.r1.pixelart"}))):console.log("Running in development mode - Flutter channel not available");function Un(){U.style.display="none",ue&&ht||(Mo(),ue&&yo()),U.style.transform="none",E.style.display="block",In.style.display="none";const e=document.getElementById("camera-button");e&&q.length>1&&(e.style.display="flex");const t=document.getElementById("resolution-button");t&&(t.style.display="flex"),setTimeout(()=>{_t(ee)},50),se(),yi()}function wr(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function ha(){const e=document.getElementById("video");e.addEventListener("touchstart",n=>{n.touches.length===2&&(n.preventDefault(),$t=!0,dr=wr(n.touches[0],n.touches[1]),ur=ee)},{passive:!1});let t=null;e.addEventListener("touchmove",n=>{if($t&&n.touches.length===2){n.preventDefault();const s=wr(n.touches[0],n.touches[1])/dr,r=ur*s,l=ii(),i=Math.max(l.min,Math.min(r,l.max));t||(_t(i),t=setTimeout(()=>{t=null},50))}},{passive:!1}),e.addEventListener("touchend",n=>{n.touches.length<2&&($t&&la(),$t=!1,console.log("Pinch ended, current zoom:",ee))}),e.addEventListener("touchcancel",()=>{$t=!1})}function Vn(){const e=document.getElementById("unified-menu");U&&U.style.display==="block"&&Un(),Be();const t=document.getElementById("styles-count");if(t){const{favorites:n,regular:o}=Zt(),s=n.length+o.length;t.textContent=s}mi(),Tn(),Cn(),zt(),G=!0,it=!0,lt(),ci(),e.style.display="flex"}async function ko(){G=!1,it=!1,oe=0,tt="",Ge="",document.getElementById("style-filter").value="";const e=document.getElementById("menu-category-hint");if(e&&(e.style.display="none"),document.getElementById("unified-menu").style.display="none",await di(),he||pe||ue||ke){let t="";he?t="‚è±Ô∏è Timer Mode":pe?t="üì∏ Burst Mode":ue?t="üëÅÔ∏è Motion Detection":ke&&(t="üé≤ Random Mode"),Q(t)}else g&&g[b]&&Q(g[b].name)}function _e(){const e=document.getElementById("settings-submenu"),t=document.getElementById("unified-menu");mi(),Tn(),zt(),Cn(),t.style.display="none",lt(),e.style.display="flex",G=!1,te=!0,xe=0,setTimeout(()=>{wo()},50)}function Ea(){document.getElementById("settings-submenu").style.display="none",te=!1,xe=0,Vn()}function Ia(){const e=document.getElementById("timer-settings-submenu"),t=document.getElementById("settings-submenu"),n=document.getElementById("timer-delay-slider"),o=document.getElementById("timer-delay-value"),s=document.getElementById("timer-repeat-enabled");if(n&&o){const i=Dr.indexOf(Ne);n.value=i!==-1?i+1:3,o.textContent=Ne}s&&(s.checked=It);const r=document.getElementById("timer-repeat-interval-input"),l=document.getElementById("timer-repeat-interval-unit");r&&l&&(ge>=3600&&ge%3600===0?(r.value=ge/3600,l.value="3600"):ge>=60&&ge%60===0?(r.value=ge/60,l.value="60"):(r.value=ge,l.value="1")),t.style.display="none",lt(),e.style.display="flex",kn=!0,te=!1}function ba(){document.getElementById("timer-settings-submenu").style.display="none",kn=!1,_e()}function va(){const e=document.querySelector(".styles-menu-scroll-container");e&&(e.scrollTo({top:0,behavior:"smooth"}),oe=0,Ot())}function Ba(){const e=document.querySelector(".styles-menu-scroll-container");if(e){e.scrollTo({top:e.scrollHeight,behavior:"smooth"});const t=document.getElementById("menu-styles-list");if(t){const n=t.querySelectorAll(".style-item");n.length>0&&(oe=n.length-1,Ot())}}}function mi(){const e=document.getElementById("current-resolution-display");if(e){const t=tn[Je];e.textContent=`${t.width}x${t.height}`}}function Tn(){const e=document.getElementById("current-burst-display");if(e){let t="Medium";for(const[n,o]of Object.entries(Lt))if(o.delay===nn){t=o.label;break}e.textContent=`${j} photos, ${t}`}}function Sa(){document.getElementById("settings-submenu").style.display="none",lt();const e=document.getElementById("resolution-submenu"),t=document.getElementById("resolution-list");t.innerHTML="",tn.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Je&&s.classList.add("active");const r=document.createElement("span");r.className="resolution-name",r.textContent=n.name,s.appendChild(r),s.onclick=()=>{ra(o),gi()},t.appendChild(s)}),e.style.display="flex",on=!0,te=!1,Te=0,setTimeout(()=>{const n=e.querySelectorAll(".resolution-item");xo(n)},100)}async function gi(){document.getElementById("resolution-submenu").style.display="none",on=!1,Te=0,_e()}function wa(){document.getElementById("settings-submenu").style.display="none",lt();const e=document.getElementById("burst-submenu"),t=document.getElementById("burst-count-slider"),n=document.getElementById("burst-speed-slider"),o=document.getElementById("burst-count-value"),s=document.getElementById("burst-speed-value");if(t&&o&&(t.value=j,o.textContent=j),n&&s){let r=2;for(const[l,i]of Object.entries(Lt))if(i.delay===nn){r=parseInt(l);break}n.value=r,s.textContent=Lt[r].label}e.style.display="flex",Pn=!0,te=!1}async function xa(){document.getElementById("burst-submenu").style.display="none",Pn=!1,_e()}function Ta(){document.getElementById("settings-submenu").style.display="none",lt();const e=document.getElementById("master-prompt-submenu"),t=document.getElementById("master-prompt-enabled"),n=document.getElementById("master-prompt-text"),o=document.getElementById("master-prompt-char-count");t&&(t.checked=Ye),n&&(n.value=we,n.disabled=!Ye,o&&(o.textContent=we.length)),e.style.display="flex",An=!0,te=!1}async function Ca(){document.getElementById("master-prompt-submenu").style.display="none",An=!1,_e()}function La(){document.getElementById("settings-submenu").style.display="none",lt();const e=document.getElementById("aspect-ratio-submenu");e.style.display="flex",te=!1}async function Ma(){document.getElementById("aspect-ratio-submenu").style.display="none",_e()}function xr(){const e=document.getElementById("current-aspect-ratio-display");e&&(e.textContent=ae==="none"?"None":ae)}function Cn(){const e=document.getElementById("current-master-prompt-display");if(e)if(Ye&&we.trim()){const t=we.substring(0,20);e.textContent=`Enabled: ${t}${we.length>20?"...":""}`}else Ye?e.textContent="Enabled (empty)":e.textContent="Disabled"}function yn(){try{localStorage.setItem(Or,we),localStorage.setItem(Nr,Ye.toString()),localStorage.setItem(qr,ae)}catch(e){console.error("Failed to save master prompt:",e)}}function Pa(){try{const e=localStorage.getItem(Or),t=localStorage.getItem(Nr);e!==null&&(we=e),t!==null&&(Ye=t==="true");const n=localStorage.getItem(qr);if(n){ae=n;const o=document.getElementById("aspect-ratio-1-1"),s=document.getElementById("aspect-ratio-16-9");o&&(o.checked=ae==="1:1"),s&&(s.checked=ae==="16:9");const r=document.getElementById("current-aspect-ratio-display");r&&(r.textContent=ae==="none"?"None":ae)}}catch(e){console.error("Failed to load master prompt:",e)}}function ka(){try{const e=localStorage.getItem(vo);e&&(nt=JSON.parse(e))}catch(e){console.error("Failed to load selection history:",e),nt={}}}function jn(e,t=""){let n=e;if(Ye&&we.trim()&&(n=`${e} ${we}`),/RANDOM|SELECT|SELECTION|CHOOSE|modulo|LAST DIGIT|LAST TWO DIGITS|LAST THREE DIGITS/i.test(e)){const s=Date.now(),r=s%10,l=s%100,i=s%1e3;n=Aa(n,r,l,i,t)}return ae==="1:1"?n+=" Use a square aspect ratio.":ae==="16:9"&&(n+=" Use a square aspect ratio, but pad the image with black bars at top and bottom to simulate a 16:9 aspect ratio."),console.log("FINAL PROMPT:",n),n}function Aa(e,t,n,o,s){console.log("=== PROCESSING RANDOM SELECTIONS ==="),console.log("Last Digit:",t),console.log("Last Two Digits:",n),console.log("Last Three Digits:",o);const r=/‚Ä¢\s*If[^‚Ä¢]*RANDOM SEED ends in an? (EVEN|ODD)[^‚Ä¢]*SELECT ([^\n]+)\n‚Ä¢\s*If[^‚Ä¢]*RANDOM SEED ends in an? (EVEN|ODD)[^‚Ä¢]*SELECT ([^\n]+)/gi;e=e.replace(r,(c,d,m,f,v)=>{const C=t%2===0;let L;return d.toUpperCase()==="EVEN"?L=C?m.trim():v.trim():L=C?v.trim():m.trim(),console.log("EVEN/ODD Selection:",L),fi(s,L),`SELECTED OPTION: ${L}
(Automatically selected using random seed)`});const l=/(?:use|using)\s+(?:the\s+)?LAST\s+(DIGIT|TWO DIGITS|THREE DIGITS)(?:\s+of\s+the\s+RANDOM\s+SEED)?(?:[^\n]*?)\s+modulo\s+(\d+)[^\n]*?:\s*([\s\S]*?)(?=\n[A-Z][A-Z\s]+(?:\([A-Z]+\))?:|\n\n|$)/gi;e=e.replace(l,(c,d,m,f)=>(console.log("Found modulo pattern A for:",d,"modulo",m),Tr(d,m,f,t,n,o,s,c)));const i=/SELECT(?:\s+EXACTLY\s+ONE)?(?:\s+\w+)?\s+using\s+RANDOM\s+SEED\s+modulo\s+(\d+)[^\n]*?:\s*([\s\S]*?)(?=\n[A-Z][A-Z\s]+(?:\([A-Z]+\))?:|\n\n|$)/gi;return e=e.replace(i,(c,d,m)=>(console.log("Found modulo pattern B (RANDOM SEED) modulo",d),Tr("TWO DIGITS",d,m,t,n,o,s,c))),e=e.replace(/‚Ä¢\s*If[^\n]*(?:RANDOM SEED|none is specified|no \w+ is specified)[^\n]*\n/gi,""),e=e.replace(/‚Ä¢\s*Otherwise\s+SELECT[^\n]*\n/gi,""),e=e.replace(/^\s*[A-Z][A-Z\s]+:\s*$/gm,""),e=e.replace(/\n{3,}/g,`

`),console.log("=== FINISHED PROCESSING ==="),e}function Tr(e,t,n,o,s,r,l,i){const c=[],d=/^\s*[-‚Äì]\s*(\d+):\s*(.+?)$/gm;let m;for(;(m=d.exec(n))!==null;){const B=parseInt(m[1]),M=m[2].trim();c.push({number:B,option:M}),console.log(`  Found option ${B}: ${M.substring(0,50)}`)}if(c.length===0)return console.log("  No options found, keeping original"),i;let f;e==="DIGIT"?f=o:e==="TWO DIGITS"?f=s:e==="THREE DIGITS"&&(f=r),console.log("  Selected value before modulo:",f);const v=parseInt(t),C=f%v;console.log("  Selection index after modulo:",C);const L=c.find(B=>B.number===C);return L?(console.log("  SELECTED:",L.option),fi(l,L.option),`SELECTED OPTION: ${L.option}
(Automatically selected using random seed)`):(console.log("  No matching option found!"),i)}function fi(e,t){if(!e||!t)return;const n=Da(e);n.unshift(t),n.length>mr&&n.splice(mr),nt[e]=n,localStorage.setItem(vo,JSON.stringify(nt))}function Da(e){if(!e)return[];if(!nt[e]){const t=localStorage.getItem(vo);if(t)try{nt=JSON.parse(t)}catch{nt={}}}return nt[e]||[]}function Be(e=!1){const t=document.getElementById("menu-styles-list");t.innerHTML="",t.replaceWith(t.cloneNode(!1));const n=document.getElementById("menu-styles-list"),o=document.createDocumentFragment(),{favorites:s,regular:r}=Zt(),l=s.filter(d=>{if(tt){const m=tt.toLowerCase(),f=d.category&&d.category.some(C=>C.toLowerCase().includes(m));if(!(d.name.toLowerCase().includes(m)||d.message.toLowerCase().includes(m)||f))return!1}return Ge?d.category&&d.category.includes(Ge):!0}),i=r.filter(d=>{if(tt){const m=tt.toLowerCase(),f=d.category&&d.category.some(C=>C.toLowerCase().includes(m));if(!(d.name.toLowerCase().includes(m)||d.message.toLowerCase().includes(m)||f))return!1}return Ge?d.category&&d.category.includes(Ge):!0});if(l.length>0){const d=document.createElement("h3");d.className="menu-section-header",d.textContent="‚òÖ Favorites",o.appendChild(d),l.forEach(m=>{const f=Cr(m);o.appendChild(f)})}if(i.length>0){const d=document.createElement("h3");d.className="menu-section-header",d.textContent=tt?"Search Results":"All Styles",o.appendChild(d),i.forEach(m=>{const f=Cr(m);o.appendChild(f)})}if(i.length===0&&l.length===0&&tt){const d=document.createElement("div");d.className="menu-empty",d.textContent="No styles found",o.appendChild(d)}n.appendChild(o),n.addEventListener("click",Ra);const c=document.getElementById("styles-count");if(c){const{favorites:d,regular:m}=Zt(),f=d.length+m.length;c.textContent=f}e||(oe=0,Ot())}function Cr(e){const t=g.findIndex(i=>i===e),n=document.createElement("div");n.className="style-item",n.dataset.index=t,t===b&&n.classList.add("active");const o=document.createElement("button");o.className="style-favorite",o.textContent=Dt(e.name)?"‚≠ê":"‚òÜ",o.dataset.action="favorite",o.dataset.styleName=e.name;const s=document.createElement("span");s.className="style-name",s.textContent=e.name;const r=document.createElement("button");r.className="style-edit";const l=e.internal===!1;return r.textContent=l?"Builder":"Edit",r.dataset.action=l?"builder":"edit",r.dataset.index=t,n.appendChild(o),n.appendChild(s),n.appendChild(r),n}function Ra(e){const t=e.target;if(t.dataset.action==="favorite"){e.stopPropagation();const o=t.dataset.styleName;Ml(o);return}if(t.dataset.action==="edit"){e.stopPropagation();const o=parseInt(t.dataset.index);Na(o);return}if(t.dataset.action==="builder"){e.stopPropagation();const o=parseInt(t.dataset.index);Nl(o);return}const n=t.closest(".style-item");if(n){const o=parseInt(n.dataset.index);isNaN(o)||(b=o,se(),ko())}}function Oa(e="Add New Style"){const t=document.getElementById("style-editor");document.getElementById("editor-title").textContent=e,t.style.display="flex",setTimeout(()=>{const n=document.querySelector(".style-editor-body");n&&n.focus()},100)}let Ln=!1;function Ao(){if(!Ln){Ln=!0;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="0.5vh",e.style.paddingBottom="0.5vw")}}function Do(){setTimeout(()=>{const e=document.querySelectorAll(".style-input, .style-textarea");if(!Array.from(e).some(n=>n===document.activeElement)&&Ln){Ln=!1;const n=document.querySelector(".style-editor-body");n&&(n.style.gap="1vh",n.style.paddingBottom="1vw")}},100)}const ao=document.getElementById("style-name"),co=document.getElementById("style-category"),uo=document.getElementById("style-message");ao&&(ao.addEventListener("focus",Ao),ao.addEventListener("blur",Do));co&&(co.addEventListener("focus",Ao),co.addEventListener("blur",Do));uo&&(uo.addEventListener("focus",Ao),uo.addEventListener("blur",Do));function Ro(){document.getElementById("style-editor").style.display="none",document.getElementById("style-name").value="",document.getElementById("style-message").value="";const e=document.getElementById("style-category");e&&(e.value=""),document.getElementById("delete-style").style.display="none",ye=-1}function Na(e){ye=e;const t=g[e];document.getElementById("style-name").value=t.name,document.getElementById("style-message").value=t.message;const n=document.getElementById("style-category");n&&(n.value=t.category?t.category.join(", "):""),document.getElementById("delete-style").style.display="block",Oa("Edit Style")}async function qa(){const e=document.getElementById("style-name").value.trim(),t=document.getElementById("style-message").value.trim(),n=document.getElementById("style-category").value.trim(),o=n?n.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):[];if(!e||!t){alert("Please fill in both name and AI prompt");return}if(ye>=0){const s=g[ye].name;g[ye]={name:e,category:o,message:t};const r=wt.some(i=>i.name===s),l=At&&de.getImportedPresets().some(i=>i.name===s);if(r||l?await Re.saveModification(s,{name:e,message:t,category:o}):await Re.saveNewPreset({name:e,category:o,message:t}),s!==e){const i=x.indexOf(s);i>-1&&(x[i]=e,Ee())}}else{const s={name:e,category:o,message:t};await Re.saveNewPreset(s),g.push(s),x.push(e),Ee()}_n(),alert(ye>=0?`Preset "${e}" updated!`:`Preset "${e}" saved!`),Ro(),Vn()}async function _a(){if(ye>=0&&g.length>1&&confirm("Delete this style?")){const e=g[ye].name,t=wt.some(l=>l.name===e);At&&de.getImportedPresets().some(l=>l.name===e)?await de.deletePreset(e):t?await Re.saveDeletion(e):await Re.removeModification(e),g.splice(ye,1);const o=x.indexOf(e);o>-1&&(x.splice(o,1),Ee()),ye===b?b=Math.max(0,ye-1):ye<b&&(b=b-1),b=Math.max(0,Math.min(b,g.length-1)),_n(),se(),Ro();const s=document.querySelector(".styles-menu-scroll-container"),r=s?s.scrollTop:0;Vn(),s&&requestAnimationFrame(()=>{s.scrollTop=r}),alert(`Preset "${e}" deleted successfully!`)}}function Fa(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain(),s=e.createBiquadFilter();n.type="square",n.frequency.setValueAtTime(2400,t),n.frequency.exponentialRampToValueAtTime(1800,t+.012),s.type="highpass",s.frequency.setValueAtTime(1500,t),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.015),n.connect(s),s.connect(o),o.connect(e.destination),n.start(t),n.stop(t+.015);const r=e.createOscillator(),l=e.createGain(),i=e.createBiquadFilter();r.type="square",r.frequency.setValueAtTime(1200,t+.015),r.frequency.exponentialRampToValueAtTime(200,t+.023),i.type="bandpass",i.frequency.setValueAtTime(1500,t+.015),i.Q.setValueAtTime(2,t+.015),l.gain.setValueAtTime(.4,t+.015),l.gain.exponentialRampToValueAtTime(.001,t+.03),r.connect(i),i.connect(l),l.connect(e.destination),r.start(t+.015),r.stop(t+.03);const c=e.createOscillator(),d=e.createGain();c.type="triangle",c.frequency.setValueAtTime(400,t+.023),c.frequency.setValueAtTime(450,t+.027),c.frequency.setValueAtTime(380,t+.031),c.frequency.setValueAtTime(420,t+.035),d.gain.setValueAtTime(0,t+.023),d.gain.linearRampToValueAtTime(.15,t+.025),d.gain.exponentialRampToValueAtTime(.001,t+.04),c.connect(d),d.connect(e.destination),c.start(t+.023),c.stop(t+.04);const m=e.createOscillator(),f=e.createGain(),v=e.createBiquadFilter();m.type="square",m.frequency.setValueAtTime(800,t+.05),m.frequency.exponentialRampToValueAtTime(150,t+.06),v.type="bandpass",v.frequency.setValueAtTime(1e3,t+.05),v.Q.setValueAtTime(2,t+.05),f.gain.setValueAtTime(.5,t+.05),f.gain.exponentialRampToValueAtTime(.001,t+.07),m.connect(v),v.connect(f),f.connect(e.destination),m.start(t+.05),m.stop(t+.07);const C=e.createOscillator(),L=e.createGain(),B=e.createBiquadFilter();C.type="sine",C.frequency.setValueAtTime(180,t+.05),C.frequency.exponentialRampToValueAtTime(120,t+.095),B.type="lowpass",B.frequency.setValueAtTime(300,t+.05),L.gain.setValueAtTime(0,t+.05),L.gain.linearRampToValueAtTime(.2,t+.055),L.gain.exponentialRampToValueAtTime(.001,t+.105),C.connect(B),B.connect(L),L.connect(e.destination),C.start(t+.05),C.stop(t+.105);const M=e.sampleRate*.08,F=e.createBuffer(1,M,e.sampleRate),Ie=F.getChannelData(0);for(let ct=0;ct<M;ct++){const an=Math.sin(ct/200)*.5+.5;Ie[ct]=(Math.random()*2-1)*an}const Y=e.createBufferSource();Y.buffer=F;const $=e.createBiquadFilter();$.type="bandpass",$.frequency.setValueAtTime(3e3,t+.07),$.Q.setValueAtTime(1,t+.07);const X=e.createGain();X.gain.setValueAtTime(0,t+.07),X.gain.linearRampToValueAtTime(.12,t+.075),X.gain.linearRampToValueAtTime(.12,t+.125),X.gain.exponentialRampToValueAtTime(.001,t+.15),Y.connect($),$.connect(X),X.connect(e.destination),Y.start(t+.07),Y.stop(t+.15);const ne=e.createOscillator(),at=e.createGain();ne.type="square",ne.frequency.setValueAtTime(600,t+.145),ne.frequency.exponentialRampToValueAtTime(100,t+.155),at.gain.setValueAtTime(.25,t+.145),at.gain.exponentialRampToValueAtTime(.001,t+.165),ne.connect(at),at.connect(e.destination),ne.start(t+.145),ne.stop(t+.165)}catch(e){console.log("Audio generation failed:",e)}}window.addEventListener("load",()=>{var er,tr,nr,or,sr,rr,ir,lr,ar,cr;wl(),Pa(),ka(),ha();const e=document.getElementById("start-button");e&&e.addEventListener("click",()=>{Fa();const a=document.querySelector(".camera-body");a&&(a.style.transition="all 0.1s",a.style.boxShadow="0 0 50px rgba(255, 255, 255, 1)",setTimeout(()=>{a.style.boxShadow=""},100));const u=document.querySelector(".lens-inner");u&&(u.style.transition="all 0.05s",u.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout(()=>{u.style.transform="translate(-50%, -50%) scale(1)"},50)),setTimeout(()=>{ga()},300)});const t=document.getElementById("burst-toggle");t&&t.addEventListener("click",li);const n=document.getElementById("timer-toggle");n&&n.addEventListener("click",ai);const o=document.getElementById("random-toggle");o&&o.addEventListener("click",ri);const s=document.getElementById("motion-toggle");s&&s.addEventListener("click",Kr);const r=document.getElementById("menu-button");r&&r.addEventListener("click",Vn);const l=document.getElementById("close-menu");l&&l.addEventListener("click",ko);const i=document.getElementById("jump-to-top");i&&i.addEventListener("click",va);const c=document.getElementById("jump-to-bottom");c&&c.addEventListener("click",Ba);const d=document.getElementById("settings-menu-button");d&&d.addEventListener("click",_e);const m=document.getElementById("settings-back");m&&m.addEventListener("click",Ea);const f=document.getElementById("resolution-settings-button");f&&f.addEventListener("click",Sa);const v=document.getElementById("resolution-back");v&&v.addEventListener("click",gi);const C=document.getElementById("burst-settings-button");C&&C.addEventListener("click",wa);const L=document.getElementById("burst-back");L&&L.addEventListener("click",xa);const B=document.getElementById("timer-settings-button");B&&B.addEventListener("click",Ia);const M=document.getElementById("timer-settings-back");M&&M.addEventListener("click",ba);const F=document.getElementById("master-prompt-settings-button");F&&F.addEventListener("click",Ta);const Ie=document.getElementById("master-prompt-back");Ie&&Ie.addEventListener("click",Ca);const Y=document.getElementById("aspect-ratio-settings-button");Y&&Y.addEventListener("click",La);const $=document.getElementById("aspect-ratio-back");$&&$.addEventListener("click",Ma);const X=document.getElementById("aspect-ratio-1-1"),ne=document.getElementById("aspect-ratio-16-9");X&&X.addEventListener("change",a=>{a.target.checked?(ae="1:1",ne&&(ne.checked=!1)):ae="none",yn(),xr()}),ne&&ne.addEventListener("change",a=>{a.target.checked?(ae="16:9",X&&(X.checked=!1)):ae="none",yn(),xr()});const at=document.getElementById("motion-settings-button");at&&at.addEventListener("click",Al);const ct=document.getElementById("motion-back");ct&&ct.addEventListener("click",Dl);const an=document.getElementById("visible-presets-settings-button");an&&an.addEventListener("click",Rl);const Oo=document.getElementById("visible-presets-back");Oo&&Oo.addEventListener("click",Ol);const No=document.getElementById("preset-builder-button");No&&No.addEventListener("click",ei);const qo=document.getElementById("preset-builder-back");qo&&qo.addEventListener("click",Co);const _o=document.getElementById("preset-builder-jump-up");_o&&_o.addEventListener("click",Jr);const Fo=document.getElementById("preset-builder-jump-down");Fo&&Fo.addEventListener("click",Qr);const Ho=document.getElementById("preset-builder-template");Ho&&Ho.addEventListener("change",ql);const $o=document.getElementById("preset-builder-name");$o&&$o.addEventListener("keypress",a=>{var u;a.key==="Enter"&&(a.preventDefault(),(u=document.getElementById("preset-builder-category"))==null||u.focus())});const Le=document.getElementById("preset-builder-category"),Fe=document.getElementById("category-autocomplete");if(Le&&Fe){const a=()=>{const p=Le.value,h=p.lastIndexOf(","),y=(h>=0?p.substring(h+1):p).trim().toUpperCase(),P=_l(),w=y?P.filter(T=>T.includes(y)):P;w.length>0?(Fe.innerHTML=w.map(T=>`<div class="category-autocomplete-item" data-category="${T}">${T}</div>`).join(""),Fe.style.display="block"):Fe.style.display="none"},u=p=>{const h=Le.value,y=h.lastIndexOf(",");y>=0?Le.value=h.substring(0,y+1)+" "+p+", ":Le.value=p+", ",Fe.style.display="none",Le.focus()};Le.addEventListener("input",a),Le.addEventListener("focus",a),Fe.addEventListener("click",p=>{if(p.target.classList.contains("category-autocomplete-item")){const h=p.target.getAttribute("data-category");u(h)}}),document.addEventListener("click",p=>{!Le.contains(p.target)&&!Fe.contains(p.target)&&(Fe.style.display="none")}),Le.addEventListener("keypress",p=>{var h;p.key==="Enter"&&(p.preventDefault(),Fe.style.display="none",(h=document.getElementById("preset-builder-template"))==null||h.focus())})}const Uo=document.getElementById("preset-builder-save");Uo&&Uo.addEventListener("click",Fl);const Vo=document.getElementById("preset-builder-clear");Vo&&Vo.addEventListener("click",Fn);const jo=document.getElementById("preset-builder-delete");jo&&jo.addEventListener("click",Hl),document.querySelectorAll(".chip-section-header").forEach(a=>{a.addEventListener("click",()=>{const u=a.getAttribute("data-section"),p=document.getElementById("section-"+u),h=p.style.display==="block";document.querySelectorAll(".chip-section-content").forEach(y=>{y.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(y=>{y.classList.remove("expanded")}),h||(p.style.display="block",a.classList.add("expanded"))})}),document.querySelectorAll(".preset-chip").forEach(a=>{a.addEventListener("click",u=>{const p=u.target.getAttribute("data-text"),h=document.getElementById("preset-builder-prompt"),y=h.value;y.trim()?h.value=y+" "+p:h.value=p,h.scrollTop=h.scrollHeight})});const Go=document.getElementById("preset-builder-quality");Go&&Go.addEventListener("change",a=>{const u=a.target.value;if(u){const p=document.getElementById("preset-builder-prompt"),h=p.value;h.trim()?p.value=h+" "+u:p.value=u,a.target.value="",p.scrollTop=p.scrollHeight}});const zo=document.getElementById("visible-presets-filter");zo&&zo.addEventListener("input",a=>{Wt=a.target.value,Tt()});const Jo=document.getElementById("visible-presets-select-all");Jo&&Jo.addEventListener("click",()=>{x=g.filter(u=>!u.internal).map(u=>u.name),Ee(),Tt(),ft(),G&&Be()});const Qo=document.getElementById("visible-presets-deselect-all");Qo&&Qo.addEventListener("click",()=>{x=[],Ee(),Tt(),ft(),G&&Be()});const Yo=document.getElementById("visible-presets-jump-up");Yo&&Yo.addEventListener("click",()=>{ce=0,Kt()});const Xo=document.getElementById("visible-presets-jump-down");Xo&&Xo.addEventListener("click",()=>{const a=document.getElementById("visible-presets-list");if(a){const u=a.querySelectorAll(".style-item");u.length>0&&(ce=u.length-1,Kt())}});let N=null,He=null,H=null,Ft=[],We=0,$e=0,Ue=0,Ze=!1;function pi(){const a=R[Z];if(!a)return;document.getElementById("image-viewer").style.display="none",document.getElementById("image-editor-modal").style.display="flex",N=document.getElementById("editor-canvas"),He=N.getContext("2d",{willReadFrequently:!0});const u=new Image;u.onload=()=>{H=u,Ft=[],We=0,$e=0,Ue=0,document.getElementById("brightness-slider").value=0,document.getElementById("contrast-slider").value=0,document.getElementById("brightness-value").textContent="0",document.getElementById("contrast-value").textContent="0",Ke(),Gn()},u.src=a.imageBase64}function Ke(){!H||!N||(N.width=H.width,N.height=H.height,He.clearRect(0,0,N.width,N.height),He.drawImage(H,0,0),($e!==0||Ue!==0)&&hi())}function hi(){const a=He.getImageData(0,0,N.width,N.height),u=a.data,p=$e,h=(Ue+100)/100;for(let y=0;y<u.length;y+=4)u[y]=((u[y]/255-.5)*h+.5)*255,u[y+1]=((u[y+1]/255-.5)*h+.5)*255,u[y+2]=((u[y+2]/255-.5)*h+.5)*255,u[y]+=p,u[y+1]+=p,u[y+2]+=p,u[y]=Math.max(0,Math.min(255,u[y])),u[y+1]=Math.max(0,Math.min(255,u[y+1])),u[y+2]=Math.max(0,Math.min(255,u[y+2]));He.putImageData(a,0,0)}function Ei(){cn(),We=(We+90)%360;const a=document.createElement("canvas"),u=a.getContext("2d");We===90||We===270?(a.width=H.height,a.height=H.width):(a.width=H.width,a.height=H.height),u.translate(a.width/2,a.height/2),u.rotate(We*Math.PI/180),u.drawImage(H,-H.width/2,-H.height/2);const p=new Image;p.onload=()=>{H=p,Ke()},p.src=a.toDataURL("image/jpeg",.95)}function Ii(){cn();const a=He.getImageData(0,0,N.width,N.height),u=a.data,p=N.width,h=N.height,y=new Uint8ClampedArray(u),P=[0,-1,0,-1,5,-1,0,-1,0];for(let T=1;T<h-1;T++)for(let k=1;k<p-1;k++)for(let D=0;D<3;D++){let V=0;for(let W=-1;W<=1;W++)for(let Ve=-1;Ve<=1;Ve++){const Pe=((T+W)*p+(k+Ve))*4+D,dt=(W+1)*3+(Ve+1);V+=u[Pe]*P[dt]}y[(T*p+k)*4+D]=Math.max(0,Math.min(255,V))}for(let T=0;T<u.length;T+=4)u[T]=y[T],u[T+1]=y[T+1],u[T+2]=y[T+2];He.putImageData(a,0,0);const w=new Image;w.onload=()=>{H=w,Ke()},w.src=N.toDataURL("image/jpeg",.95)}function bi(){cn();const a=He.getImageData(0,0,N.width,N.height),u=a.data,p=1.15,h=1.2,y=5;for(let w=0;w<u.length;w+=4){let T=u[w],k=u[w+1],D=u[w+2];T=((T/255-.5)*p+.5)*255,k=((k/255-.5)*p+.5)*255,D=((D/255-.5)*p+.5)*255;const V=.2989*T+.587*k+.114*D;T=V+h*(T-V),k=V+h*(k-V),D=V+h*(D-V),T+=y,k+=y,D+=y,u[w]=Math.max(0,Math.min(255,T)),u[w+1]=Math.max(0,Math.min(255,k)),u[w+2]=Math.max(0,Math.min(255,D))}He.putImageData(a,0,0);const P=new Image;P.onload=()=>{H=P,Ke()},P.src=N.toDataURL("image/jpeg",.95)}function vi(){Ze=!Ze;const a=document.getElementById("crop-overlay"),u=document.getElementById("crop-button");if(Ze){a.style.display="block",u.classList.add("active");const h=document.querySelector(".editor-image-container").getBoundingClientRect(),y=N.getBoundingClientRect(),P=document.querySelector(".crop-top-left"),w=document.querySelector(".crop-bottom-right");P.style.left=y.left-h.left+y.width*.1+"px",P.style.top=y.top-h.top+y.height*.1+"px",w.style.right=h.right-y.right+y.width*.1+"px",w.style.bottom=h.bottom-y.bottom+y.height*.1+"px"}else a.style.display="none",u.classList.remove("active")}function Bi(){if(!Ze)return;cn(),document.querySelector(".editor-image-container").getBoundingClientRect();const u=N.getBoundingClientRect(),p=document.querySelector(".crop-top-left"),h=document.querySelector(".crop-bottom-right"),y=p.getBoundingClientRect(),P=h.getBoundingClientRect(),w=y.left-u.left,T=y.top-u.top,k=P.right-u.left,D=P.bottom-u.top,V=k-w,W=D-T;if(V<=0||W<=0){alert("Invalid crop area");return}const Ve=H.width/u.width,Pe=H.height/u.height,dt=w*Ve,Ht=T*Pe,Zn=V*Ve,Kn=W*Pe,un=document.createElement("canvas");un.width=Zn,un.height=Kn,un.getContext("2d").drawImage(H,dt,Ht,Zn,Kn,0,0,Zn,Kn);const eo=new Image;eo.onload=()=>{H=eo,Ze=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active"),Ke()},eo.src=un.toDataURL("image/jpeg",.95)}function cn(){const a={image:H,rotation:We,brightness:$e,contrast:Ue};Ft.push(a),Gn()}function Si(){if(Ft.length===0)return;const a=Ft.pop();H=a.image,We=a.rotation,$e=a.brightness,Ue=a.contrast,document.getElementById("brightness-slider").value=$e,document.getElementById("contrast-slider").value=Ue,document.getElementById("brightness-value").textContent=$e,document.getElementById("contrast-value").textContent=Ue,Ke(),Gn()}function Gn(){const a=document.getElementById("undo-edit-button");a.disabled=Ft.length===0}async function wi(){const a=document.createElement("canvas");a.width=N.width,a.height=N.height,a.getContext("2d").drawImage(N,0,0);const p=a.toDataURL("image/jpeg",.9),h={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:p,timestamp:Date.now()};R.unshift(h),await Nn(h),Z=0;const y=document.getElementById("viewer-image");y.src=p,y.style.transform="scale(1) translate(0, 0)",be=1,Wo(),await me(),Qt("Edited image saved!","success",3e3)}function Wo(){document.getElementById("image-editor-modal").style.display="none",document.getElementById("image-viewer").style.display="flex",Ze=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active")}(er=document.getElementById("edit-viewer-image"))==null||er.addEventListener("click",pi),(tr=document.getElementById("close-image-editor"))==null||tr.addEventListener("click",Wo),(nr=document.getElementById("rotate-button"))==null||nr.addEventListener("click",Ei),(or=document.getElementById("sharpen-button"))==null||or.addEventListener("click",Ii),(sr=document.getElementById("autocorrect-button"))==null||sr.addEventListener("click",bi),(rr=document.getElementById("undo-edit-button"))==null||rr.addEventListener("click",Si),(ir=document.getElementById("save-edit-button"))==null||ir.addEventListener("click",wi),(lr=document.getElementById("crop-button"))==null||lr.addEventListener("click",()=>{Ze?Bi():vi()}),(ar=document.getElementById("brightness-slider"))==null||ar.addEventListener("input",a=>{$e=parseInt(a.target.value),document.getElementById("brightness-value").textContent=$e,Ke()}),(cr=document.getElementById("contrast-slider"))==null||cr.addEventListener("input",a=>{Ue=parseInt(a.target.value),document.getElementById("contrast-value").textContent=Ue,Ke()});let Me=null;document.querySelectorAll(".crop-corner").forEach(a=>{a.addEventListener("touchstart",u=>{u.preventDefault(),Me=a})}),document.addEventListener("touchmove",a=>{if(!Me||!Ze)return;a.preventDefault();const u=a.touches[0],h=document.querySelector(".editor-image-container").getBoundingClientRect(),y=N.getBoundingClientRect();let P=u.clientX-h.left,w=u.clientY-h.top;const T=y.left-h.left,k=y.top-h.top,D=y.right-h.left,V=y.bottom-h.top,W=Me.offsetWidth;if(Me.classList.contains("crop-top-left")){P=Math.max(T,Math.min(P,D-W)),w=Math.max(k,Math.min(w,V-W));const Pe=document.querySelector(".crop-bottom-right").getBoundingClientRect(),dt=Pe.right-h.left-W*2,Ht=Pe.bottom-h.top-W*2;P=Math.min(P,dt),w=Math.min(w,Ht),Me.style.left=P+"px",Me.style.top=w+"px"}else if(Me.classList.contains("crop-bottom-right")){P=Math.max(T+W,Math.min(P,D)),w=Math.max(k+W,Math.min(w,V));const Pe=document.querySelector(".crop-top-left").getBoundingClientRect(),dt=Pe.right-h.left+W,Ht=Pe.bottom-h.top+W;P=Math.max(P,dt),w=Math.max(w,Ht),Me.style.right=h.width-P+"px",Me.style.bottom=h.height-w+"px"}}),document.addEventListener("touchend",()=>{Me=null});const Zo=document.getElementById("motion-sensitivity-slider"),Ko=document.getElementById("motion-sensitivity-value");if(Zo&&Ko){const a=["Very Low","Low","Medium","High","Very High"];Zo.addEventListener("input",u=>{const p=parseInt(u.target.value);Ko.textContent=a[p-1],Mt=50-p*10,fn(),ti()})}const es=document.getElementById("motion-continuous-enabled");es&&es.addEventListener("change",a=>{ht=a.target.checked,fn()});const ts=document.getElementById("motion-cooldown-slider"),ns=document.getElementById("motion-cooldown-value");ts&&ns&&ts.addEventListener("input",a=>{Pt=parseInt(a.target.value),ns.textContent=`${Pt}s`,fn()});const os=document.getElementById("motion-start-delay-slider"),ss=document.getElementById("motion-start-delay-value");os&&ss&&os.addEventListener("input",a=>{const u=parseInt(a.target.value);kt=Yt[u].seconds,ss.textContent=Yt[u].label,fn()});const rs=document.getElementById("no-magic-toggle-button");rs&&rs.addEventListener("click",Gl);const is=document.getElementById("tutorial-button");is&&is.addEventListener("click",Yl);const ls=document.getElementById("tutorial-back");ls&&ls.addEventListener("click",Xl);const as=document.getElementById("import-presets-button");as&&as.addEventListener("click",async()=>{try{const a=await de.import();if(a.success){g=await xn(),x=g.map(p=>p.name),Ee(),Be(),ft();const u=document.getElementById("styles-count");if(u){const p=g.filter(h=>x.includes(h.name)).length;u.textContent=p}alert(a.message)}else a.message!=="cancelled"&&a.message!=="No presets selected"&&alert("Import failed: "+a.message)}catch(a){alert("Import error: "+a.message)}}),document.querySelectorAll(".glossary-item").forEach(a=>{a.addEventListener("click",()=>{const u=a.getAttribute("data-section");Wl(u)})});const cs=document.getElementById("back-to-glossary");cs&&cs.addEventListener("click",oi);const ds=document.getElementById("master-prompt-enabled");ds&&ds.addEventListener("change",a=>{Ye=a.target.checked;const u=document.getElementById("master-prompt-text");u&&(u.disabled=!Ye),yn(),Cn()});const us=document.getElementById("master-prompt-text");us&&us.addEventListener("input",a=>{we=a.target.value;const u=document.getElementById("master-prompt-char-count");u&&(u.textContent=we.length),yn(),Cn()});const ms=document.getElementById("style-filter");let zn=null;ms&&ms.addEventListener("input",a=>{tt=a.target.value,zn&&clearTimeout(zn),zn=setTimeout(()=>{Be()},150)});const gs=document.getElementById("burst-count-slider"),Jn=document.getElementById("burst-speed-slider");gs&&gs.addEventListener("input",a=>{j=parseInt(a.target.value),document.getElementById("burst-count-value").textContent=j;const u=parseInt(Jn.value);Br(j,u),Tn(),pe&&(S.textContent=`Burst mode ON (${j} photos) ‚Ä¢ ${g[b].name}`)}),Jn&&Jn.addEventListener("input",a=>{const u=parseInt(a.target.value);nn=Lt[u].delay,document.getElementById("burst-speed-value").textContent=Lt[u].label,Br(j,u),Tn()});const fs=document.getElementById("timer-delay-slider"),ys=document.getElementById("timer-delay-value");fs&&ys&&fs.addEventListener("input",a=>{const u=parseInt(a.target.value)-1;Ne=Dr[u],ys.textContent=Ne,lo(),zt()});const ps=document.getElementById("timer-repeat-enabled");ps&&ps.addEventListener("change",a=>{It=a.target.checked,lo(),zt()});const Qn=document.getElementById("timer-repeat-interval-input"),Yn=document.getElementById("timer-repeat-interval-unit");if(Qn&&Yn){const a=()=>{const u=parseInt(Qn.value)||1,p=parseInt(Yn.value);ge=u*p,lo(),zt()};Qn.addEventListener("input",a),Yn.addEventListener("change",a)}ca(),da(),jl(),zl(),Jl();const hs=document.getElementById("reset-button");hs&&hs.addEventListener("click",Un);const Es=document.getElementById("camera-button");Es&&Es.addEventListener("click",aa);const Is=document.getElementById("close-editor");Is&&Is.addEventListener("click",Ro);const bs=document.getElementById("import-resolution-settings-button");bs&&bs.addEventListener("click",ea);const vs=document.getElementById("import-resolution-back");vs&&vs.addEventListener("click",si);const Bs=document.getElementById("save-style");Bs&&Bs.addEventListener("click",qa);const Ss=document.getElementById("delete-style");Ss&&Ss.addEventListener("click",_a),ut=document.getElementById("connection-status"),xt=document.getElementById("queue-status"),De=document.getElementById("sync-button"),De&&De.addEventListener("click",en),xt&&xt.addEventListener("click",Po);const ws=document.getElementById("close-queue-manager");ws&&ws.addEventListener("click",fa);const xs=document.getElementById("sync-all");xs&&xs.addEventListener("click",en);const Ts=document.getElementById("clear-queue");Ts&&Ts.addEventListener("click",ui);const Cs=document.getElementById("gallery-button");Cs&&Cs.addEventListener("click",me);const Ls=document.getElementById("close-gallery");Ls&&Ls.addEventListener("click",qi);const Ms=document.getElementById("gallery-import-button");Ms&&Ms.addEventListener("click",()=>{Va()});const Ps=document.getElementById("check-updates-button");Ps&&Ps.addEventListener("click",async()=>{try{const a=await fetch("./presets.json");if(!a.ok){alert("Could not load presets.json");return}const u=await a.json(),p=de.getImportedPresets();if(p.length===0){alert('No presets imported yet. Use "Import Presets" first.');return}let h=0,y=0;const P=new Set(p.map(k=>k.name));if(u.forEach(k=>{if(P.has(k.name)){const D=p.find(V=>V.name===k.name);D&&D.message!==k.message&&h++}else y++}),h===0&&y===0){alert("‚úÖ All presets are up to date!");return}const w=[];if(h>0&&w.push(`${h} updated preset(s)`),y>0&&w.push(`${y} new preset(s)`),confirm(`Found ${w.join(" and ")} available.

Would you like to import all updates now?`)){const k=await de.import();if(k.success){g=await xn(),x=g.map(V=>V.name),Ee(),Be(),ft();const D=document.getElementById("updates-status");D&&(D.textContent="Check for Updates",D.style.color="",D.style.fontWeight=""),alert(k.message)}}}catch(a){alert("Error checking for updates: "+a.message)}});const ks=document.getElementById("close-qr-scanner");ks&&ks.addEventListener("click",()=>{Jt()});const As=document.getElementById("close-viewer");As&&As.addEventListener("click",$i);const Ds=document.getElementById("delete-viewer-image");Ds&&Ds.addEventListener("click",Ui);const Rs=document.getElementById("upload-viewer-image");Rs&&Rs.addEventListener("click",Ha);const Os=document.getElementById("qr-scan-button");Os&&Os.addEventListener("click",()=>{const a=document.getElementById("qr-scan-button"),u=document.getElementById("qr-scanner-video");a&&(a.disabled=!0),u&&u.paused&&u.play(),J("Scanning...",""),yi()});const Ns=document.getElementById("close-qr-modal");Ns&&Ns.addEventListener("click",Ua);const qs=document.getElementById("gallery-start-date-btn"),Xn=document.getElementById("gallery-start-date");qs&&Xn&&(qs.addEventListener("click",()=>{Xn.showPicker()}),Xn.addEventListener("change",a=>{jt=a.target.value||null,pr("start",jt),ro()}));const _s=document.getElementById("gallery-end-date-btn"),Wn=document.getElementById("gallery-end-date");_s&&Wn&&(_s.addEventListener("click",()=>{Wn.showPicker()}),Wn.addEventListener("change",a=>{Gt=a.target.value||null,pr("end",Gt),ro()}));const Fs=document.getElementById("gallery-sort-order");Fs&&Fs.addEventListener("change",a=>{Xt=a.target.value;try{localStorage.setItem(Hr,Xt)}catch(u){console.error("Failed to save sort order:",u)}ro()});const Hs=document.getElementById("prev-page");Hs&&Hs.addEventListener("click",Fi);const $s=document.getElementById("next-page");$s&&$s.addEventListener("click",_i);const Us=document.getElementById("load-preset-button");Us&&Us.addEventListener("click",Vi);const Vs=document.getElementById("multi-preset-button");Vs&&Vs.addEventListener("click",()=>{if(Z>=0){const a=R[Z].id;El(a)}});const js=document.getElementById("close-preset-selector");js&&js.addEventListener("click",Sn);const dn=document.getElementById("preset-filter");dn&&(dn.addEventListener("input",a=>{vn=a.target.value,rn()}),dn.addEventListener("focus",()=>{const a=document.getElementById("preset-selector-category-hint");a&&(a.style.display="none");const u=document.getElementById("multi-preset-controls");u&&(u.style.display="none")}),dn.addEventListener("blur",()=>{if(vt){const a=document.getElementById("multi-preset-controls");a&&(a.style.display="flex")}}));const Gs=document.getElementById("preset-selector-jump-up");Gs&&Gs.addEventListener("click",()=>{K=0,Et()});const zs=document.getElementById("preset-selector-jump-down");zs&&zs.addEventListener("click",()=>{const a=document.getElementById("preset-list");if(a){const u=a.querySelectorAll(".preset-item");u.length>0&&(K=u.length-1,Et())}});const Js=document.getElementById("magic-button");Js&&Js.addEventListener("click",ml);const Qs=document.getElementById("batch-mode-toggle");Qs&&Qs.addEventListener("click",wn);const Ys=document.getElementById("batch-select-all");Ys&&Ys.addEventListener("click",gl);const Xs=document.getElementById("batch-deselect-all");Xs&&Xs.addEventListener("click",fl);const Ws=document.getElementById("batch-cancel");Ws&&Ws.addEventListener("click",wn);const Zs=document.getElementById("batch-apply-preset");Zs&&Zs.addEventListener("click",yl);const Ks=document.getElementById("batch-delete");Ks&&Ks.addEventListener("click",hl),Rn().then(async()=>{localStorage.getItem("r1_gallery_index")?(console.log("Migrating old gallery data..."),await Ri()):await On()}).catch(a=>{console.error("Failed to initialize database:",a)}),bl()});window.removeFromQueue=ya;window.previewQueueItem=pa;window.clearQueue=ui;async function Ha(){if(Z<0)return;const e=document.getElementById("status"),t=document.getElementById("upload-viewer-image");try{t.disabled=!0,t.textContent="‚è≥",e&&(e.style.display="block",e.textContent="Uploading image...");const o=R[Z].imageBase64.split(",")[1],s=atob(o),r=new Array(s.length);for(let v=0;v<s.length;v++)r[v]=s.charCodeAt(v);const l=new Uint8Array(r),i=new Blob([l],{type:"image/png"}),c=new FormData;c.append("file",i,`magic-kamera-${Date.now()}.png`);const d=await fetch("https://store2.gofile.io/uploadFile?token=",{method:"POST",body:c});if(!d.ok)throw new Error("Upload failed - status: "+d.status);const m=await d.json();if(m.status!=="ok"||!m.data.downloadPage)throw new Error("Upload failed: "+JSON.stringify(m));const f=m.data.downloadPage;e&&(e.textContent="Upload successful!",setTimeout(()=>{e.style.display="none"},2e3)),$a(f.trim())}catch{e&&(e.textContent="Upload failed. Please try again.",setTimeout(()=>{e.style.display="none"},3e3))}finally{t.disabled=!1,t.textContent="üì§"}}function $a(e){const t=document.getElementById("qr-modal"),n=document.getElementById("qr-code-container"),o=document.getElementById("qr-url-text");!t||!n||!o||(n.innerHTML="",new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),o.textContent=e,t.style.display="flex")}function Ua(){const e=document.getElementById("qr-modal");e&&(e.style.display="none")}function Va(){const e=document.getElementById("qr-scanner-modal"),t=document.getElementById("qr-scanner-video");if(!e||!t)return;e.style.display="flex",ja(),J("Ready to scan","");const n=document.getElementById("qr-scan-button");n&&(n.disabled=!1)}function Jt(){const e=document.getElementById("qr-scanner-modal");e&&(e.style.display="none"),Mn(),Ga(),J("Point camera at QR code...","")}async function ja(){const e=document.getElementById("qr-scanner-video");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=t,e.onloadedmetadata=()=>{e.pause(),J("Ready to scan","")}}catch(t){console.error("Error starting QR scanner camera:",t),J("Camera access denied","error")}}function Ga(){const e=document.getElementById("qr-scanner-video");e&&e.srcObject&&(e.srcObject.getTracks().forEach(n=>n.stop()),e.srcObject=null)}function J(e,t=""){const n=document.getElementById("qr-scanner-status");n&&(n.textContent=e,n.className="qr-scanner-status",t&&n.classList.add(t))}function Qt(e,t="info",n=3e3){const o=document.getElementById("gallery-status-message");o&&(o.textContent=e,o.className="gallery-status-message",t==="error"?o.classList.add("error"):t==="success"&&o.classList.add("success"),o.style.display="block",setTimeout(()=>{o.style.display="none"},n))}function yi(){go||(go=!0,En=setInterval(za,Di))}function Mn(){go=!1,En&&(clearInterval(En),En=null)}function za(){const e=document.getElementById("qr-scanner-video");if(!e||e.readyState!==e.HAVE_ENOUGH_DATA)return;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height),s=jsQR(o.data,o.width,o.height);s&&s.data?Ja(s.data)?St!==s.data&&(St=s.data,J("QR Code detected! Importing...","success"),Mn(),setTimeout(()=>{Ya()},500)):(Mn(),Jt(),Qt("Invalid QR code - must be a valid URL","error",4e3)):J("Scanning...","")}function Ja(e){try{const t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}async function Qa(e,t=640,n=480,o=.85){return new Promise((s,r)=>{const l=new Image,i=URL.createObjectURL(e);l.onload=()=>{URL.revokeObjectURL(i);let c=l.width,d=l.height;if(c>t||d>n){const v=c/d;c>d?(c=t,d=c/v):(d=n,c=d*v)}const m=document.createElement("canvas");m.width=c,m.height=d,m.getContext("2d").drawImage(l,0,0,c,d),m.toBlob(v=>{v?s(v):r(new Error("Failed to compress image"))},"image/jpeg",o)},l.onerror=()=>{URL.revokeObjectURL(i),r(new Error("Failed to load image for resizing"))},l.src=i})}async function Ya(){if(!St){Jt(),Qt("No QR code detected","error",3e3);return}try{J("Downloading image...","");const e=St.trim(),t=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/raw?url=",""];let n=null,o=null;for(let m=0;m<t.length;m++)try{const f=t[m]?t[m]+encodeURIComponent(e):e;J(`Trying method ${m+1}/${t.length}...`,"");const v=new AbortController,C=setTimeout(()=>v.abort(),8e3);if(n=await fetch(f,{signal:v.signal}),clearTimeout(C),n.ok){J("Download successful!","success");break}}catch(f){o=f;continue}if(!n||!n.ok)throw new Error("All download methods failed");J("Reading image data...","");let s=await n.blob();const r=Math.round(s.size/1024);if(J("Original size: "+r+"KB",""),s.type&&!s.type.startsWith("image/"))throw new Error("Not an image: "+s.type);J("Optimizing image...","");const l=bo[Ct];s=await Qa(s,l.width,l.height,.85);const i=Math.round(s.size/1024);J("Compressed: "+r+"KB ‚Üí "+i+"KB",""),J("Converting to base64...","");const c=await new Promise((m,f)=>{const v=setTimeout(()=>{f(new Error("Base64 conversion timeout"))},1e4),C=new FileReader;C.onloadend=()=>{clearTimeout(v),m(C.result)},C.onerror=()=>{clearTimeout(v),f(new Error("FileReader error"))},C.readAsDataURL(s)});J("Saving to gallery...","");const d={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:c,timestamp:Date.now()};R.unshift(d),await Nn(d),J("‚úÖ Import successful!","success"),St=null,Jt(),await me(),Qt("Image imported successfully!","success",3e3)}catch(e){St=null,Jt(),Qt("Import failed: "+e.message,"error",4e3)}}document.getElementById("factory-reset-button").addEventListener("click",async()=>{confirm(At?"This will reset to your imported preset list. Your custom presets will be kept. Continue?":"This will restore all factory presets to their original state. Your custom presets will be kept. Continue?")&&(await Re.clearFactoryPresetModifications(),g=await xn(),x=g.map(n=>n.name),Ee(),renderMenuStyles(),alert(At?"Presets reset to imported list!":"Factory presets restored successfully!"))});document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".mode-carousel-track");e&&e.querySelectorAll(".mode-button").forEach(n=>{const o=n.getAttribute("data-mode");o==="random"?n.addEventListener("click",ri):o==="motion"?n.addEventListener("click",Kr):o==="burst"?n.addEventListener("click",li):o==="timer"&&n.addEventListener("click",ai)})});console.log("AI Camera Styles app initialized!");let Io=0;document.addEventListener("touchstart",e=>{Io=e.touches[0].clientX},{passive:!0});document.addEventListener("touchend",e=>{const t=e.changedTouches[0].clientX,n=Io-t,o=document.querySelector(".mode-carousel");if(!o)return;const s=30,r=window.innerWidth*.5;Io>r&&n>s&&o.classList.add("show"),n<-s&&o.classList.remove("show")},{passive:!0});
