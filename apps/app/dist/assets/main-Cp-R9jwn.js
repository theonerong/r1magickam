(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const kr="CameraPresetsDB",Nr=1,se="presets";class Rr{constructor(){this.db=null}async init(){return new Promise((t,n)=>{const o=indexedDB.open(kr,Nr);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(se)||i.createObjectStore(se,{keyPath:"id"}).createIndex("type","type",{unique:!1})}})}async saveModification(t,n){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`modified_${t}`,type:"modification",name:t,data:n,timestamp:Date.now()})}async saveNewPreset(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`new_${t.name}`,type:"new",name:t.name,data:t,timestamp:Date.now()})}async saveDeletion(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`deleted_${t}`,type:"deletion",name:t,timestamp:Date.now()})}async getAllModifications(){return new Promise((t,n)=>{const i=this.db.transaction([se],"readonly").objectStore(se).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async clearAll(){return new Promise((t,n)=>{const o=this.db.transaction([se],"readwrite"),i=o.objectStore(se).clear();i.onsuccess=()=>t(),i.onerror=()=>n(i.error),o.onerror=()=>n(o.error)})}async clearFactoryPresetModifications(){return new Promise((t,n)=>{const o=this.db.transaction([se],"readwrite"),s=o.objectStore(se),i=s.getAll();i.onsuccess=()=>{const l=i.result,r=[];for(const a of l)if(a.type==="modification"||a.type==="deletion"){const c=s.delete(a.id);r.push(new Promise((g,f)=>{c.onsuccess=()=>g(),c.onerror=()=>f(c.error)}))}Promise.all(r).then(()=>t()).catch(n)},i.onerror=()=>n(i.error),o.onerror=()=>n(o.error)})}async removeModification(t){const o=this.db.transaction([se],"readwrite").objectStore(se);await o.delete(`modified_${t}`),await o.delete(`deleted_${t}`)}}const Ee=new Rr,qr="ImportedPresetsDB",_r=1,ot="imported_presets";class Hr{constructor(){this.db=null,this.importedPresets=[],this.isImportModalOpen=!1,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates=new Map}async init(){return new Promise((t,n)=>{const o=indexedDB.open(qr,_r);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(ot)||i.createObjectStore(ot,{keyPath:"id",autoIncrement:!0})}})}async loadImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([ot],"readonly").objectStore(ot).getAll();i.onsuccess=()=>{this.importedPresets=i.result.map(l=>l.preset),t(this.importedPresets)},i.onerror=()=>{console.error("Error loading imported presets:",i.error),t([])}})}async saveImportedPresets(t){return this.db||await this.init(),new Promise(async(n,o)=>{const i=this.db.transaction([ot],"readwrite").objectStore(ot),l=i.clear();l.onsuccess=()=>{const r=t.map(a=>new Promise((c,g)=>{const f=i.add({preset:a});f.onsuccess=()=>c(),f.onerror=()=>g(f.error)}));Promise.all(r).then(()=>{this.importedPresets=t,n()}).catch(o)},l.onerror=()=>o(l.error)})}async loadPresetsFromFile(){try{const t=await fetch("./presets.json");if(!t.ok)throw new Error("Failed to load presets.json");return(await t.json()).filter(s=>s.name&&s.message&&Array.isArray(s.category)).sort((s,i)=>s.name.localeCompare(i.name))}catch(t){throw console.error("Error loading presets.json:",t),new Error("Could not load presets.json file")}}getFilteredPresets(t){if(!this.importFilterText.trim())return t;const n=this.importFilterText.toLowerCase();return t.filter(o=>o.name.toLowerCase().includes(n))}async showPresetSelectionUI(t){return new Promise(n=>{this.isImportModalOpen=!0,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates.clear(),t.forEach(T=>{const C=this.importedPresets.some(R=>R.name===T.name);this.checkboxStates.set(T.name,C)});const o=document.createElement("div");o.className="styles-menu",o.style.display="flex",o.style.zIndex="10000",o.id="import-preset-modal";const s=document.createElement("div");s.className="styles-menu-content";const i=document.createElement("div");i.className="styles-menu-header",i.style.marginBottom="0",i.innerHTML=`
        <h2 style="font-size: 14px;">Import (<span id="import-preset-count">${t.length}</span>)</h2>
        <div class="menu-nav-buttons">
          <button id="import-jump-to-top" class="menu-jump-button" title="Jump to top">‚Üë</button>
          <button id="import-jump-to-bottom" class="menu-jump-button" title="Jump to bottom">‚Üì</button>
          <button id="close-import-modal" class="close-button">√ó</button>
        </div>
      `;const l=document.createElement("div");l.className="styles-menu-scroll-container",l.id="import-scroll-container",l.style.paddingTop="0",l.style.paddingBottom="22px";const r=document.createElement("div");r.className="menu-section",r.style.cssText="position: sticky; top: 0; background: #1a1a1a; z-index: 10; padding: 5px 0; margin: 0; border-bottom: 1px solid #333;",r.innerHTML=`
        <input type="text" id="import-preset-filter" class="style-filter" placeholder="Filter..." style="width: 100%; margin: 0; height: 24px; font-size: 12px;">
      `;const a=document.createElement("div");a.className="menu-section",a.id="import-presets-section",a.style.margin="0";const c=document.createElement("div");c.className="menu-list",c.id="import-presets-list";const g=()=>{const T=this.getFilteredPresets(t),C=document.getElementById("import-preset-count");C&&(C.textContent=T.length),c.innerHTML="",T.forEach((R,we)=>{const oe=document.createElement("button");oe.className="menu-item",oe.dataset.presetIndex=we,oe.dataset.presetName=R.name,oe.style.cssText="display: flex; align-items: center; padding: 6px 15px; min-height: 30px; width: 100%; justify-content: flex-start; margin-bottom: 2px;";const j=document.createElement("input");j.type="checkbox",j.id=`import-preset-${we}`,j.checked=this.checkboxStates.get(R.name)||!1,j.style.cssText=`
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #4CAF50;
            flex-shrink: 0;
          `,j.onclick=$=>{$.stopPropagation(),this.checkboxStates.set(R.name,j.checked)};const K=document.createElement("span");K.className="menu-item-name",K.textContent=R.name,K.style.cssText="flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; color: #000; font-size: 12px; display: flex; align-items: center;";const de=this.importedPresets.find($=>$.name===R.name);if(de){if(de.message!==R.message){const $=document.createElement("span");$.className="preset-ticket preset-ticket-updated",$.textContent="UPDATED",K.appendChild($)}}else{const $=document.createElement("span");$.className="preset-ticket preset-ticket-new",$.textContent="NEW",K.appendChild($)}oe.appendChild(j),oe.appendChild(K),oe.onclick=$=>{$.target!==j&&(j.checked=!j.checked,this.checkboxStates.set(R.name,j.checked))},c.appendChild(oe)}),f()},f=()=>{const T=c.querySelectorAll(".menu-item");if(T.forEach(C=>C.classList.remove("menu-selected")),this.currentImportScrollIndex>=0&&this.currentImportScrollIndex<T.length){const C=T[this.currentImportScrollIndex];C.classList.add("menu-selected"),C.scrollIntoView({behavior:"smooth",block:"nearest"})}};a.appendChild(c);const v=document.createElement("div");v.style.cssText=`
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1a1a1a;
  z-index: 20;
  padding: 2px;
  border-top: 1px solid #333;
  display: flex;
  gap: 3px;
`,v.innerHTML=`
  <button id="select-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úì All
  </button>
  <button id="deselect-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úó None
  </button>
  <button id="confirm-import-presets" style="flex: 1; padding: 0; background: #4CAF50; color: white; border: none; border-radius: 2px; font-size: 10px; font-weight: bold; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Import
  </button>
  <button id="cancel-import-presets" style="flex: 1; padding: 0; background: #666; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Cancel
  </button>
`,l.appendChild(r),l.appendChild(a),s.appendChild(i),s.appendChild(l),o.appendChild(s),o.appendChild(v),document.body.appendChild(o),g(),document.getElementById("import-preset-filter").addEventListener("input",T=>{this.importFilterText=T.target.value,this.currentImportScrollIndex=0,g()}),document.getElementById("select-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!0)}),g()},document.getElementById("deselect-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!1)}),g()};const P=()=>{this.isImportModalOpen=!1,document.body.removeChild(o)};document.getElementById("close-import-modal").onclick=()=>{P(),n(null)},document.getElementById("cancel-import-presets").onclick=()=>{P(),n(null)},document.getElementById("confirm-import-presets").onclick=()=>{const T=t.filter(C=>this.checkboxStates.get(C.name)===!0);P(),n(T)},document.getElementById("import-jump-to-top").onclick=()=>{l.scrollTop=0,this.currentImportScrollIndex=0,f()},document.getElementById("import-jump-to-bottom").onclick=()=>{l.scrollTop=l.scrollHeight;const T=c.querySelectorAll(".menu-item");this.currentImportScrollIndex=T.length-1,f()},this.scrollImportUp=()=>{c.querySelectorAll(".menu-item").length!==0&&(this.currentImportScrollIndex=Math.max(0,this.currentImportScrollIndex-1),f())},this.scrollImportDown=()=>{const T=c.querySelectorAll(".menu-item");T.length!==0&&(this.currentImportScrollIndex=Math.min(T.length-1,this.currentImportScrollIndex+1),f())},l.style.overflowY="auto"})}async import(){try{const t=await this.loadPresetsFromFile();if(t.length===0)return{success:!1,message:"No presets found in presets.json"};const n=await this.showPresetSelectionUI(t);if(n===null)return{success:!1,message:"cancelled"};if(n.length===0)return{success:!1,message:"No presets selected"};const o=new Map(this.importedPresets.map(a=>[a.name,a]));let s=0,i=0;n.forEach(a=>{o.has(a.name)?(o.set(a.name,a),s++):(o.set(a.name,a),i++)});const l=Array.from(o.values());await this.saveImportedPresets(l);let r="";return s>0&&i>0?r=`Updated ${s}, imported ${i} new. Total: ${l.length}`:s>0?r=`Updated ${s} preset(s). Total: ${l.length}`:r=`Imported ${i} new preset(s). Total: ${l.length}`,{success:!0,message:r,updated:s,new:i,total:l.length}}catch(t){return{success:!1,message:t.message}}}async deletePreset(t){const n=this.importedPresets.findIndex(o=>o.name===t);return n>=0?(this.importedPresets.splice(n,1),await this.saveImportedPresets(this.importedPresets),!0):!1}async clearImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([ot],"readwrite").objectStore(ot).clear();i.onsuccess=()=>{this.importedPresets=[],t()},i.onerror=()=>n(i.error)})}getImportedPresets(){return this.importedPresets}}const ae=new Hr;let oo=[],I,b,Y,B,Sn,N=null,Z=null;function Ur(e,t="info"){return new Promise(n=>{const o=document.getElementById("custom-alert-modal"),s=document.getElementById("custom-alert-message"),i=document.getElementById("custom-alert-buttons");s.textContent=e,i.innerHTML='<button class="custom-alert-btn custom-alert-btn-primary" id="custom-alert-ok">OK</button>',o.style.display="flex";const l=document.getElementById("custom-alert-ok"),r=()=>{o.style.display="none",l.removeEventListener("click",r),n()};l.addEventListener("click",r)})}function Fr(e,t={}){return new Promise(n=>{const o=document.getElementById("custom-alert-modal"),s=document.getElementById("custom-alert-message"),i=document.getElementById("custom-alert-buttons");s.textContent=e;const l=t.yesText||"Yes",r=t.noText||"No",a=t.danger?"custom-alert-btn-danger":"custom-alert-btn-primary";i.innerHTML=`
      <button class="custom-alert-btn custom-alert-btn-secondary" id="custom-confirm-no">${r}</button>
      <button class="custom-alert-btn ${a}" id="custom-confirm-yes">${l}</button>
    `,o.style.display="flex";const c=document.getElementById("custom-confirm-yes"),g=document.getElementById("custom-confirm-no"),f=()=>{o.style.display="none",c.removeEventListener("click",f),g.removeEventListener("click",v),n(!0)},v=()=>{o.style.display="none",c.removeEventListener("click",f),g.removeEventListener("click",v),n(!1)};c.addEventListener("click",f),g.addEventListener("click",v)})}window.alert=Ur;window.confirm=Fr;const on=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"SXGA+ (1400x1050)",width:1400,height:1050},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080},{name:"HD (3264x2448)",width:3264,height:2448}];let Xe=0;const Ni="r1_camera_resolution",xo=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080}];let Ct=0;const Ri="r1_import_resolution";let me=0,_=[],so=!1,re=1,Ft=!1,hi=0,Ei=1,ve=!1,W=5,sn=500,io=!1;const Pt={1:{delay:800,label:"Slow"},2:{delay:500,label:"Medium"},3:{delay:300,label:"Fast"}},qi="r1_camera_burst_settings",_i="r1_camera_timer_settings",Hi="r1_camera_last_preset";let Be=!1,Ke=null,He=10,It=!1,Ui=[3,5,10],Ie=1;const Fi={1:{seconds:1,label:"1s"},2:{seconds:3,label:"3s"},3:{seconds:5,label:"5s"},4:{seconds:10,label:"10s"},5:{seconds:30,label:"30s"},6:{seconds:60,label:"1m"},7:{seconds:300,label:"5m"},8:{seconds:600,label:"10m"},9:{seconds:1800,label:"30m"},10:{seconds:3600,label:"1h"}};let Le="",Te=!1;const $i="r1_camera_master_prompt",Vi="r1_camera_master_prompt_enabled",Gi="r1_camera_aspect_ratio";let ue="none";const Co="r1_camera_selection_history";let it={};const Ii=5;let Re=!1,fe=!1,bn=null,ze=null,Lt=30,Po=.1,ht=!0,Mt=2,pn=!1,Ot=3;const ji="r1_camera_motion_settings";let Vt=null;const Qt={1:{seconds:3,label:"3s"},2:{seconds:10,label:"10s"},3:{seconds:30,label:"30s"},4:{seconds:60,label:"1m"},5:{seconds:300,label:"5m"},6:{seconds:600,label:"10m"},7:{seconds:900,label:"15m"},8:{seconds:1800,label:"30m"}};let O=!1;const Yi="r1_camera_no_magic_mode";let Wt=!1,Lo=-1,Bt,ro,$t=null,le=0,F=!1,Ue=!1,Fe=!1,ie=0,Me=0,Oe=0,X=!1,rn=!1,kn=!1,Nn=!1,Xt=!1,Rn=!1,bt=!1,kt=!1,pe=-1,Ae=0;const $r="R1CameraGallery",Vr=1,at="images";let Ce=null,k=[];const zi="r1_gallery_sort_order";let te=-1,xe=1,hn=!1,bi=0,vi=1,be=1;const vn=16;let Gt=null,jt=null,Kt="newest",lt=!1,U=new Set,vt=!1,_e=[],Tn=null,st="",wn="",fo=0,ut="",Je="",gt="",yo=!1,po=!1,ho=!1,Bn=null,Tt=null,Eo=!1;const Gr=500,Bi={transform:"Take a picture and transform the image into [DESCRIBE TRANSFORMATION]. [ADD SPECIFIC DETAILS ABOUT STYLE, APPEARANCE, COLORS, ETC.]",transform_subject:"Take a picture and transform the subject into [WHAT THE SUBJECT BECOMES]. Preserve the subject's recognizable facial structure and identity. [ADD DETAILS ABOUT NEW APPEARANCE, ENVIRONMENT, LIGHTING].",convert:"Take a picture and convert the scene into [DESCRIBE NEW FORMAT/MEDIUM]. [ADD DETAILS ABOUT MATERIALS, TEXTURES, SCALE].",style:"Take a picture in the style of [ARTISTIC STYLE/ARTIST]. [ADD DETAILS ABOUT TECHNIQUE, COLORS, COMPOSITION].",place:"Take a picture and place the subject in [DESCRIBE SCENE/LOCATION]. [ADD DETAILS ABOUT LIGHTING, ATMOSPHERE, INTEGRATION].",recreate:"Take a picture and recreate [FAMOUS WORK/SCENE]. Replace [DESCRIBE WHAT TO REPLACE]. Preserve the iconic [DESCRIBE KEY ELEMENTS TO KEEP].",render:"Take a picture and render it as [FORMAT/MEDIUM]. [ADD DETAILS ABOUT APPEARANCE, TEXTURE, TECHNICAL SPECIFICS].",make:"Take a picture and make the subject into [CHARACTER/CREATURE]. [ADD DETAILS ABOUT APPEARANCE, TRAITS, SETTING]. Make it photorealistic.",analyze:"Analyze the image and [DESCRIBE WHAT TO ANALYZE/EXTRACT]. [ADD DETAILS ABOUT OUTPUT FORMAT] and email it to me.",random_even_odd:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If the RANDOM SEED ends in an EVEN number (0,2,4,6,8): SELECT Option A
- If the RANDOM SEED ends in an ODD number (1,3,5,7,9): SELECT Option B

If Option A:
[DESCRIBE WHAT HAPPENS IN OPTION A - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]

If Option B:
[DESCRIBE WHAT HAPPENS IN OPTION B - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO BOTH OPTIONS - LIGHTING, QUALITY, PRESERVATION, ETC.]`,random_last_digit:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST DIGIT modulo [NUMBER 2-10]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  - 5: [OPTION 6 DESCRIPTION]
  - 6: [OPTION 7 DESCRIPTION]
  - 7: [OPTION 8 DESCRIPTION]
  - 8: [OPTION 9 DESCRIPTION]
  - 9: [OPTION 10 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS - STYLE, QUALITY, TECHNICAL DETAILS, ETC.]

IMPORTANT:
- Replace [NUMBER 2-10] with the actual number of options you have (between 2 and 10)
- Remove any unused option lines (e.g., if you only have 5 options, remove lines 5-9)
- Each option should be a distinct visual variation or transformation
- For exactly 10 options, use LAST DIGIT modulo 10 (covers digits 0-9)`,random_last_two:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST TWO DIGITS modulo [NUMBER 11-99]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  - 5: [OPTION 6 DESCRIPTION]
  - 6: [OPTION 7 DESCRIPTION]
  - 7: [OPTION 8 DESCRIPTION]
  - 8: [OPTION 9 DESCRIPTION]
  - 9: [OPTION 10 DESCRIPTION]
  - 10: [OPTION 11 DESCRIPTION]
  - 11: [OPTION 12 DESCRIPTION]
  - 12: [OPTION 13 DESCRIPTION]
  - 13: [OPTION 14 DESCRIPTION]
  - 14: [OPTION 15 DESCRIPTION]
  - 15: [OPTION 16 DESCRIPTION]
  - 16: [OPTION 17 DESCRIPTION]
  - 17: [OPTION 18 DESCRIPTION]
  - 18: [OPTION 19 DESCRIPTION]
  - 19: [OPTION 20 DESCRIPTION]
  - 20: [OPTION 21 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]

IMPORTANT:
- Replace [NUMBER 11-99] with the actual number of options (between 11 and 99)
- Add or remove option lines to match your number of options
- Use LAST TWO DIGITS only when you have MORE than 10 options
- Ensure the colon (:) comes immediately after the modulo number
- Use exactly 2 spaces before each dash (-)
- Keep all options in one continuous list with no blank lines`,random_last_three:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST THREE DIGITS modulo [NUMBER 100+]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  (continue numbering for all your options)
  - 98: [OPTION 99 DESCRIPTION]
  - 99: [OPTION 100 DESCRIPTION]
  - 100: [OPTION 101 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]

IMPORTANT:
- Replace [NUMBER 100+] with the actual number of options (101 or more)
- Add option lines for every option you want to include
- Use LAST THREE DIGITS only when you have 101 or more options
- Ensure the colon (:) comes immediately after the modulo number
- Use exactly 2 spaces before each dash (-)
- Keep all options in one continuous list with no blank lines
- This format is ideal for large preset collections like 120 Star Trek species or 150 character types`,custom:""};let u=[],ft=[],At=!1,E=0,ye=-1,Se=navigator.onLine,D=[],yt=!1,rt=null,xn=0;const Ji=500,Qi="r1_camera_queue";let St,wt,qe;const Io="r1_camera_styles";let Qe=[];const Wi="r1_camera_favorites",Xi="r1_camera_visible_presets";let S=[],Ze=!1,ge=0,Zt="",ln=!0;function ne(e){$t&&(clearTimeout($t),$t=null),Bt||(Bt=document.getElementById("style-reveal"),ro=document.getElementById("style-reveal-text")),!(!Bt||!ro)&&(ro.textContent=O?"‚ö° NO MAGIC MODE":e,Bt.style.display="block",$t=setTimeout(()=>{Bt&&(Bt.style.display="none"),$t=null},1200))}function qn(){return new Promise((e,t)=>{const n=indexedDB.open($r,Vr);n.onerror=()=>{console.error("Failed to open IndexedDB:",n.error),t(n.error)},n.onsuccess=()=>{Ce=n.result,console.log("IndexedDB opened successfully"),e(Ce)},n.onupgradeneeded=o=>{Ce=o.target.result,Ce.objectStoreNames.contains(at)||(Ce.createObjectStore(at,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Object store created"))}})}async function jr(){try{const e=localStorage.getItem("r1_gallery_index");if(!e){console.log("No old gallery data to migrate");return}const t=JSON.parse(e);let n=0;for(const o of t){const s="r1_gallery_"+o,i=localStorage.getItem(s);if(i){const l=JSON.parse(i);for(const r of l)await Hn(r),n++;localStorage.removeItem(s)}}localStorage.removeItem("r1_gallery_index"),console.log(`Migration complete: ${n} images migrated to IndexedDB`),await _n()}catch(e){console.error("Migration failed:",e)}}async function _n(){try{Ce||await qn(),k=[];const n=Ce.transaction([at],"readonly").objectStore(at).getAll();return new Promise((o,s)=>{n.onsuccess=()=>{k=n.result||[];const i=localStorage.getItem(zi);i&&(Kt=i),k.sort((l,r)=>r.timestamp-l.timestamp),console.log(`Gallery loaded: ${k.length} images`),o()},n.onerror=()=>{console.error("Failed to load gallery:",n.error),k=[],s(n.error)}})}catch(e){console.error("Error loading gallery:",e),k=[]}}async function Hn(e){try{Ce||await qn();const o=Ce.transaction([at],"readwrite").objectStore(at).add(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image saved to IndexedDB"),s()},o.onerror=()=>{console.error("Failed to save image:",o.error),i(o.error)}})}catch(t){console.error("Error saving image:",t)}}async function Ki(e){try{Ce||await qn();const o=Ce.transaction([at],"readwrite").objectStore(at).delete(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image deleted from IndexedDB"),s()},o.onerror=()=>{console.error("Failed to delete image:",o.error),i(o.error)}})}catch(t){console.error("Error deleting image:",t)}}async function Zi(e){const t={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:e,timestamp:Date.now()};k.unshift(t),await Hn(t),console.log(`Image added. Total: ${k.length}`)}function Yr(e){return!Gt&&!jt?e:e.filter(t=>{const n=new Date(t.timestamp);n.setHours(0,0,0,0);const o=n.getTime();let s=!0,i=!0;if(Gt){const l=new Date(Gt).getTime();s=o>=l}if(jt){const l=new Date(jt).getTime();i=o<=l}return s&&i})}function zr(e){const t=[...e];return Kt==="newest"?t.sort((n,o)=>o.timestamp-n.timestamp):t.sort((n,o)=>n.timestamp-o.timestamp),t}function Mo(){let e=Yr(k);return zr(e)}async function ce(){ct(),Ir(),Y&&Y.style.display==="block"&&Gn(),await _n();const e=document.getElementById("gallery-modal"),t=document.getElementById("gallery-grid"),n=document.getElementById("gallery-pagination"),o=document.getElementById("page-info"),s=document.getElementById("prev-page"),i=document.getElementById("next-page"),l=document.getElementById("gallery-count");l&&(l.textContent=k.length);const r=document.getElementById("gallery-sort-order");r&&(r.value=Kt);const a=Mo();if(a.length===0)t.innerHTML='<div class="gallery-empty">No photos match the selected filter.</div>',n.style.display="none";else{const c=Math.ceil(a.length/vn);be=Math.min(be,c);const g=(be-1)*vn,f=Math.min(g+vn,a.length),v=a.slice(g,f),w=document.createDocumentFragment();v.forEach(P=>{const T=document.createElement("div");if(T.className="gallery-item",lt&&U.has(P.id)&&T.classList.add("selected"),lt){const R=document.createElement("input");R.type="checkbox",R.className="gallery-item-checkbox",R.checked=U.has(P.id),R.addEventListener("click",we=>{we.stopPropagation(),xi(P.id)}),T.appendChild(R)}const C=document.createElement("img");C.src=P.imageBase64,C.alt="Gallery image",C.loading="lazy",T.appendChild(C),T.onclick=()=>{if(lt)xi(P.id),ce();else{const R=k.findIndex(we=>we.id===P.id);Oo(R)}},w.appendChild(T)}),t.innerHTML="",t.appendChild(w),c>1?(n.style.display="flex",o.textContent=`Page ${be} of ${c}`,s.disabled=be===1,i.disabled=be===c):n.style.display="none"}e.style.display="flex"}async function Jr(){if(document.getElementById("gallery-modal").style.display="none",be=1,await br(),B&&(B.style.display="block"),O)B&&(B.textContent="‚ö° NO MAGIC MODE"),ne("‚ö° NO MAGIC MODE");else if(Be||ve||fe||Re||vt){let e="";Be?e="‚è±Ô∏è Timer Mode":ve?e="üì∏ Burst Mode":fe?e="üëÅÔ∏è Motion Detection":Re&&(e="üé≤ Random Mode"),B&&(B.textContent=`${e} ‚Ä¢ ${u[E]?u[E].name:""}`),ne(e)}else z()}function Qr(){const e=Mo(),t=Math.ceil(e.length/vn);be<t&&(be++,ce())}function Wr(){be>1&&(be--,ce())}function lo(){be=1,ce()}function Si(e,t){const n=e==="start"?"gallery-start-date-btn":"gallery-end-date-btn",o=document.getElementById(n);if(!o)return;const s=o.querySelector(".date-button-text");if(s)if(t){const l=new Date(t+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.textContent=l,o.classList.add("has-date")}else s.textContent=e==="start"?"Start":"End",o.classList.remove("has-date")}function Oo(e){if(e<0||e>=k.length)return;te=e;const t=k[e],n=document.getElementById("image-viewer"),o=document.getElementById("viewer-image"),s=document.getElementById("viewer-prompt");o.src=t.imageBase64,o.style.transform="scale(1) translate(0, 0)",xe=1,s.value="";const i=document.getElementById("mp-viewer-button");i&&(Te?i.classList.add("enabled"):i.classList.remove("enabled")),n.style.display="flex",document.getElementById("gallery-modal").style.display="none"}function Xr(){document.getElementById("image-viewer").style.display="none",te=-1,xe=1;const e=document.getElementById("gallery-modal");e.style.display="flex",ce()}async function Kr(){if(!(te<0||te>=k.length)&&await confirm("Delete this image from gallery?")){const e=k[te];await Ki(e.id),k.splice(te,1),document.getElementById("image-viewer").style.display="none",te=-1,xe=1,ce()}}function Zr(){const e=document.getElementById("preset-selector");vt=!1,_e=[];const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none");const n=e.querySelector(".preset-selector-header h3");n&&(n.innerHTML='Select Preset (<span id="preset-count">0</span>)'),an();const o=document.getElementById("preset-count");o&&(o.textContent=u.length),e.style.display="flex",Fe=!0,ie=0,Et(),setTimeout(()=>{const s=document.getElementById("preset-list");s&&fo>0&&(s.scrollTop=fo)},50)}function Cn(){const e=document.getElementById("preset-list");e&&(fo=e.scrollTop),document.getElementById("preset-selector").style.display="none",wn="",gt="",document.getElementById("preset-filter").value="",Fe=!1,ie=0;const t=document.getElementById("preset-selector-category-hint");t&&(t.style.display="none"),vt=!1}function el(){if(!Fe)return;const e=document.getElementById("preset-list");!e||e.querySelectorAll(".preset-item").length===0||(ie=Math.max(0,ie-1),Et())}function tl(){if(!Fe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");t.length!==0&&(ie=Math.min(t.length-1,ie+1),Et())}function Et(){const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("preset-selected")}),ie>=0&&ie<t.length)){const n=t[ie];n.classList.add("preset-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.querySelector(".preset-name").textContent,s=u.find(l=>l.name===o),i=document.getElementById("preset-selector-category-hint");i&&s&&s.category&&!ho?(i.innerHTML="",i.style.display="block",s.category.forEach((l,r)=>{const a=document.createElement("span");if(a.textContent=l,a.style.cursor="pointer",a.style.padding="0 2px",gt===l&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),gt===l?gt="":gt=l,ie=0,an()},i.appendChild(a),r<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function nl(){if(!X)return;const e=document.getElementById("settings-submenu");!e||e.querySelectorAll(".menu-section-button").length===0||(Me=Math.max(0,Me-1),Ao())}function ol(){if(!X)return;const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");t.length!==0&&(Me=Math.min(t.length-1,Me+1),Ao())}function Ao(){const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),Me>=0&&Me<t.length)){const n=t[Me];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function sl(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Oe=(Oe-1+t.length)%t.length,Do(t))}function il(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Oe=(Oe+1)%t.length,Do(t))}function Do(e){if(e.forEach(t=>t.classList.remove("menu-selected")),Oe>=0&&Oe<e.length){const t=e[Oe];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}}function rl(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ll(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function al(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function cl(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function dl(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function ml(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function ul(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function gl(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function er(){if(!kt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function tr(){if(!kt)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function fl(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function yl(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function pl(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function hl(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Ti(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.max(0,t.scrollTop-100):n&&(n.scrollTop=Math.max(0,n.scrollTop-200))}function wi(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+100):n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+200))}function El(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Il(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function bl(){if(!Fe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length===0||ie>=t.length)return;const n=t[ie];n&&n.click()}function an(){const e=document.getElementById("preset-list");e.innerHTML="";const n=Rl().filter(r=>{if(wn){const a=wn.toLowerCase(),c=r.category&&r.category.some(f=>f.toLowerCase().includes(a));if(!(r.name.toLowerCase().includes(a)||r.message.toLowerCase().includes(a)||c))return!1}return gt?r.category&&r.category.includes(gt):!0}).sort((r,a)=>r.name.localeCompare(a.name)),o=n.filter(r=>Dt(r.name)),s=n.filter(r=>!Dt(r.name)),i=[...o,...s];if(i.length===0){e.innerHTML='<div class="preset-empty">No presets found</div>';return}i.forEach(r=>{const a=document.createElement("div");a.className="preset-item";const c=document.createElement("div");c.className="preset-name",c.textContent=r.name;const g=document.createElement("div");g.className="preset-description preset-description-hidden",g.textContent=r.message,a.appendChild(c),a.appendChild(g),a.onclick=()=>{g.classList.contains("preset-description-hidden")?g.classList.remove("preset-description-hidden"):vl(r)},e.appendChild(a)});const l=document.getElementById("preset-count");l&&(l.textContent=i.length)}async function vl(e){if(vt){const n=_e.findIndex(o=>o.name===e.name);n>-1?_e.splice(n,1):_e.push(e),nr();return}if(window.batchProcessingActive){window.batchProcessingActive=!1;const n=window.batchImagesToProcess;window.batchImagesToProcess=null,Cn();const s=document.getElementById("preset-selector").querySelector(".preset-selector-header h3");s.textContent="Select Preset",await xl(e,n);return}const t=document.getElementById("viewer-prompt");t.value=e.message,Cn()}function Bl(){if(te<0||te>=k.length){alert("No image selected");return}let t=document.getElementById("viewer-prompt").value.trim(),n="Custom Prompt";if(!t){const s=ko(),i=u[s];t=i.message,n=i.name,alert(`Using random preset: ${n}`)}const o=k[te];typeof PluginMessageHandler<"u"?(PluginMessageHandler.postMessage(JSON.stringify({message:Yn(t,n),pluginId:"com.r1.pixelart",imageBase64:o.imageBase64})),alert("Magic transform submitted! You can submit again with a different prompt.")):alert("Magic transform sent: "+t.substring(0,50)+"...")}function Pn(){lt=!lt;const e=document.getElementById("batch-mode-toggle"),t=document.getElementById("batch-controls"),n=document.getElementById("batch-action-bar");lt?(e.textContent="Done",e.classList.add("active"),t.style.display="flex",n.style.display="flex",U.clear(),Un(),ce()):(e.textContent="Select",e.classList.remove("active"),t.style.display="none",n.style.display="none",U.clear(),ce())}function Un(){const e=document.getElementById("batch-selected-count"),t=document.getElementById("batch-apply-preset"),n=document.getElementById("batch-delete");e.textContent=`${U.size} selected`,t.disabled=U.size===0,n&&(n.disabled=U.size===0)}function Sl(){const e=Mo();U.clear(),e.forEach(t=>U.add(t.id)),Un(),ce()}function Tl(){U.clear(),Un(),ce()}function xi(e){U.has(e)?U.delete(e):U.add(e),Un()}async function wl(){if(U.size===0)return;const e=document.getElementById("preset-selector"),t=e.querySelector(".preset-selector-header h3");t.textContent=`Select Preset (${U.size} images)`;const n=Array.from(U);window.batchProcessingActive=!0,window.batchImagesToProcess=n,an(),e.style.display="flex",Fe=!0,ie=0,Et()}async function xl(e,t){const n=t||Array.from(U),o=n.length,s=document.createElement("div");s.className="batch-progress-overlay",s.innerHTML=`
    <div class="batch-progress-text">Processing <span id="batch-current">0</span> / ${o}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(s);let i=0;for(const l of n){const r=k.find(a=>a.id===l);if(r)try{const a=Yn(e.message,e.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:a,pluginId:"com.r1.pixelart",imageBase64:r.imageBase64})),i++,document.getElementById("batch-current").textContent=i,document.getElementById("batch-progress-fill").style.width=`${i/o*100}%`,await new Promise(c=>setTimeout(c,3e3))}catch(a){console.error(`Failed to process image ${l}:`,a)}}document.body.removeChild(s),lt=!1,U.clear(),Pn(),alert(`Batch processing complete! ${i} of ${o} images submitted.`)}async function Cl(){if(U.size===0)return;const e=U.size;if(!await confirm(`Are you sure you want to delete ${e} selected image${e>1?"s":""}? This cannot be undone.`))return;const n=Array.from(U),o=document.createElement("div");o.className="batch-progress-overlay",o.innerHTML=`
    <div class="batch-progress-text">Deleting <span id="batch-current">0</span> / ${e}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(o);let s=0;for(const i of n)try{await Ki(i),s++,document.getElementById("batch-current").textContent=s,document.getElementById("batch-progress-fill").style.width=`${s/e*100}%`}catch(l){console.error(`Failed to delete image ${i}:`,l)}document.body.removeChild(o),lt=!1,U.clear(),await _n(),Pn(),alert(`${s} of ${e} image${s>1?"s":""} deleted successfully.`)}function Pl(e){Tn=e,_e=[],vt=!0;const t=document.getElementById("preset-selector"),n=t.querySelector(".preset-selector-header h3");n.innerHTML='Select Presets <span id="multi-preset-count" style="font-size: 12px; color: #666;">(0 selected)</span>';let o=document.getElementById("multi-preset-controls");if(!o){o=document.createElement("div"),o.id="multi-preset-controls",o.style.cssText="padding: 0 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; gap: 8px; justify-content: space-between; align-items: stretch;",o.innerHTML=`
      <button id="multi-preset-apply" class="batch-control-button" style="background: #4CAF50; color: white;">Apply Selected</button>
      <button id="multi-preset-cancel" class="batch-control-button">Cancel</button>
    `;const s=document.getElementById("preset-filter"),i=document.getElementById("preset-list");s.parentNode.insertBefore(o,s),s.parentNode.insertBefore(s,i)}o.style.display="flex",an(),nr(),t.style.display="flex",Fe=!0,ie=0,Et(),document.getElementById("multi-preset-apply").onclick=Ll,document.getElementById("multi-preset-cancel").onclick=or}function nr(){document.getElementById("preset-list").querySelectorAll(".preset-item").forEach(o=>{const s=o.querySelector(".preset-name").textContent;_e.some(l=>l.name===s)?(o.style.background="#e8f5e9",o.style.border="2px solid #4CAF50"):(o.style.background="",o.style.border="")});const n=document.getElementById("multi-preset-count");n&&(n.textContent=`(${_e.length} selected)`)}function or(){vt=!1,Tn=null,_e=[];const e=document.getElementById("multi-preset-controls");e&&(e.style.display="none");const t=document.querySelector(".preset-selector-header h3");t.textContent="Select Preset",Cn()}async function Ll(){if(_e.length===0){alert("Please select at least one preset");return}if(!Tn){alert("No image selected");return}const e=k.find(s=>s.id===Tn);if(!e){alert("Image not found");return}const t=[..._e];or();const n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`
    <div class="batch-progress-text">Applying preset <span id="batch-current">0</span> / ${t.length}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(n);let o=0;for(const s of t)try{const i=Yn(s.message,s.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:i,pluginId:"com.r1.pixelart",imageBase64:e.imageBase64})),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=`${o/t.length*100}%`,await new Promise(l=>setTimeout(l,3e3))}catch(i){console.error(`Failed to apply preset ${s.name}:`,i)}document.body.removeChild(n),alert(`${o} preset${o>1?"s":""} applied successfully!`)}function Ml(){const e=document.getElementById("viewer-image"),t=document.querySelector(".image-viewer-container");let n=0,o=0,s=0,i=0,l=!1;t.addEventListener("touchstart",r=>{r.touches.length===2?(r.preventDefault(),hn=!0,bi=Ci(r.touches[0],r.touches[1]),vi=xe):r.touches.length===1&&xe>1&&(l=!0,s=r.touches[0].clientX-n,i=r.touches[0].clientY-o)},{passive:!1}),t.addEventListener("touchmove",r=>{if(hn&&r.touches.length===2){r.preventDefault();const c=Ci(r.touches[0],r.touches[1])/bi;xe=Math.max(1,Math.min(vi*c,5)),e.style.transform=`scale(${xe}) translate(${n}px, ${o}px)`}else l&&r.touches.length===1&&xe>1&&(r.preventDefault(),n=r.touches[0].clientX-s,o=r.touches[0].clientY-i,e.style.transform=`scale(${xe}) translate(${n}px, ${o}px)`)},{passive:!1}),t.addEventListener("touchend",r=>{r.touches.length<2&&(hn=!1),r.touches.length===0&&(l=!1,xe===1&&(n=0,o=0,e.style.transform="scale(1) translate(0, 0)"))}),t.addEventListener("touchcancel",()=>{hn=!1,l=!1})}function Ci(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function Nt(){if(!F)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),le=Math.max(0,Math.min(le,t.length-1));const n=t[le];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=parseInt(n.dataset.index),s=u[o],i=document.getElementById("menu-category-hint");i&&s&&s.category&&!yo?(i.innerHTML="",i.style.display="block",s.category.forEach((l,r)=>{const a=document.createElement("span");if(a.textContent=l,a.style.cursor="pointer",a.style.padding="0 2px",Je===l&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),Je===l?Je="":Je=l,le=0,Pe()},i.appendChild(a),r<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function Ol(){if(!F||!Ue)return;const e=document.getElementById("menu-styles-list");!e||e.querySelectorAll(".style-item").length===0||(le=Math.max(0,le-1),Nt())}function Al(){if(!F||!Ue)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(le=Math.min(t.length-1,le+1),Nt())}function Dl(){if(!F||!Ue)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||le>=t.length)return;const n=t[le];if(n&&n.querySelector(".style-name")){const i=Rt()[le];if(i){const l=u.findIndex(r=>r===i);l!==-1&&(E=l,z(),Ho())}}}async function kl(){await Ee.init(),await ae.init();const t=(await ae.loadImportedPresets()).length>0,o=(await Ee.getAllModifications()).length>0;t||o?u=await Ln():(u=[],setTimeout(async()=>{await confirm("Welcome! You should import presets to get started. Would you like to import now?")&&(document.getElementById("menu-button").click(),setTimeout(()=>{document.getElementById("settings-menu-button").click(),setTimeout(()=>{document.getElementById("import-presets-button").click()},100)},100))},500));const s=localStorage.getItem(Io);if(s)try{const g=JSON.parse(s).filter(f=>f.internal===!1);for(const f of g)await Ee.saveNewPreset(f),u.find(v=>v.name===f.name)||u.push(f);localStorage.removeItem(Io)}catch(c){console.error("Error loading styles:",c)}const i=localStorage.getItem(Wi);if(i)try{Qe=JSON.parse(i),Array.isArray(Qe)||(Qe=[])}catch(c){console.error("Error parsing favorite styles:",c),Qe=[]}Ul(),_l();const l=localStorage.getItem(Xi);if(l)try{S=JSON.parse(l),Array.isArray(S)||(S=[])}catch{console.error("Error parsing visible presets:",error),S=[]}const r=new Set(u.map(c=>c.name)),a=S.length;S=S.filter(c=>r.has(c)),a!==S.length&&he(),S.length===0&&u.length>0&&(S=u.map(c=>c.name),he()),We(),setTimeout(()=>{Nl()},1e3)}async function Nl(){try{const e=await fetch("./presets.json");if(!e.ok)return;const t=await e.json(),n=ae.getImportedPresets();if(n.length===0)return;let o=!1;const s=new Set(n.map(i=>i.name));for(const i of t){const l=n.find(r=>r.name===i.name);if(!l||l.message!==i.message){o=!0;break}}if(o){const i=document.getElementById("updates-status");i&&(i.textContent="üî¥ Updates available",i.style.color="#FF5722",i.style.fontWeight="bold"),window.hasPresetsUpdates=!0}}catch(e){console.log("Could not check for updates:",e)}}function sr(){const e=document.getElementById("master-prompt-indicator"),t=document.getElementById("start-screen");e&&(e.style.display=Te&&!t?"block":"none")}async function Ln(){const e=await Ee.getAllModifications(),t=new Set,n=new Map,o=[];for(const r of e)r.type==="deletion"?t.add(r.name):r.type==="modification"?n.set(r.name,r.data):r.type==="new"&&o.push(r.data);const s=await ae.loadImportedPresets();At=s.length>0;let i;if(At)i=s;else{if(ft.length===0){const r=await fetch("./presets.json");r.ok?(oo=await r.json(),ft=[...oo]):(oo=[],ft=[])}i=ft}return[...i.filter(r=>!t.has(r.name)).map(r=>n.has(r.name)?{...r,...n.get(r.name)}:{...r}),...o]}function he(){try{localStorage.setItem(Xi,JSON.stringify(S))}catch(e){console.error("Error saving visible presets:",e)}}function Rl(){return u.filter(e=>S.includes(e.name))}function ql(e){try{localStorage.setItem(Ni,e.toString())}catch(t){console.error("Error saving resolution:",t)}}function _l(){try{const e=localStorage.getItem(Ni);if(e!==null){const t=parseInt(e,10);t>=0&&t<on.length&&(Xe=t)}}catch(e){console.error("Error loading resolution:",e)}}function en(){const t=u.filter(s=>S.includes(s.name)).slice().sort((s,i)=>s.name.localeCompare(i.name)),n=t.filter(s=>Dt(s.name)),o=t.filter(s=>!Dt(s.name));return{favorites:n,regular:o}}function Rt(){const{favorites:e,regular:t}=en(),n=e.filter(s=>S.includes(s.name)),o=t.filter(s=>S.includes(s.name));return[...n,...o]}function ir(){const e=Rt(),t=u[E];return e.findIndex(n=>n===t)}function rr(e){const n=Rt()[e];return u.findIndex(o=>o===n)}function lr(){try{const e=u.filter(t=>t.internal===!1);localStorage.setItem(Io,JSON.stringify(e))}catch(e){console.error("Error saving styles:",e)}}function Hl(e){const t=Qe.indexOf(e);t>-1?Qe.splice(t,1):Qe.push(e),localStorage.setItem(Wi,JSON.stringify(Qe));const n=document.querySelector(".styles-menu-scroll-container"),o=n?n.scrollTop:0;Pe(),n&&(n.scrollTop=o)}function Ul(){const e=localStorage.getItem(Hi);if(e!==null)try{const t=parseInt(e,10);t>=0&&t<u.length&&(E=t)}catch(t){console.error("Error loading last used style:",t)}}function Dt(e){return Qe.includes(e)}function ko(){const e=Rt();if(e.length===0)return 0;const t=e.filter(o=>Dt(o.name));if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];return u.findIndex(s=>s===o)}const n=e[Math.floor(Math.random()*e.length)];return u.findIndex(o=>o===n)}function ar(){fe=!fe;const e=document.getElementById("motion-toggle");if(fe)e.classList.add("active"),e.title="Motion Detection: ON",B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ üëÅÔ∏è Motion Detection":`Motion Detection mode ON ‚Ä¢ ${u[E].name}`,ne("üëÅÔ∏è Motion Detection");else{e.classList.remove("active"),e.title="Motion Detection: OFF",qo(),Vt&&(clearInterval(Vt),Vt=null);const t=document.getElementById("timer-countdown");t&&(t.style.display="none",t.classList.remove("countdown-fade-in","countdown-fade-out"));const n=document.getElementById("camera-button");n&&_.length>1&&(n.style.display="flex"),u&&u[E]&&(B.textContent=O?"‚ö° NO MAGIC MODE":`Style: ${u[E].name}`,ne(u[E].name))}}function Fl(){for(let e in Qt)if(Qt[e].seconds===Ot)return parseInt(e);return 1}function $l(){document.getElementById("settings-submenu").style.display="none",document.getElementById("motion-submenu").style.display="flex",Rn=!0,X=!1}function Vl(){document.getElementById("motion-submenu").style.display="none",Rn=!1,$e()}function Gl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("visible-presets-submenu").style.display="flex",F=!1,Ze=!0,ln=!0,X=!1,ge=0,Zt="",document.getElementById("visible-presets-filter").value="",xt(),We()}function jl(){document.getElementById("visible-presets-submenu").style.display="none",Ze=!1,ln=!1,ge=0,Zt="",ut="";const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none"),$e()}function cr(){document.getElementById("settings-submenu").style.display="none",document.getElementById("preset-builder-submenu").style.display="flex",F=!1,X=!1,kt=!0,Fn()}function No(){document.getElementById("preset-builder-submenu").style.display="none",kt=!1,pe=-1;const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none"),$e()}function Fn(){pe=-1,document.getElementById("preset-builder-name").value="",document.getElementById("preset-builder-category").value="",document.getElementById("preset-builder-template").value="",document.getElementById("preset-builder-prompt").value="";const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none");const t=document.getElementById("preset-builder-clear");t&&(t.style.display="flex"),document.querySelectorAll(".chip-section-content").forEach(n=>{n.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(n=>{n.classList.remove("expanded")})}function Yl(e){const t=u[e];cr(),pe=e,setTimeout(()=>{const n=document.getElementById("preset-builder-name"),o=document.getElementById("preset-builder-category"),s=document.getElementById("preset-builder-prompt"),i=document.getElementById("preset-builder-template"),l=document.getElementById("preset-builder-delete"),r=document.getElementById("preset-builder-clear");n&&(n.value=t.name),o&&(o.value=t.category?t.category.join(", "):""),s&&(s.value=t.message),i&&(i.value=""),l&&(l.style.display="flex"),r&&(r.style.display="none")},100)}function zl(){const e=document.getElementById("preset-builder-template"),t=document.getElementById("preset-builder-prompt"),n=e.value;n&&Bi[n]!==void 0&&(t.value=Bi[n])}function Jl(){const e=new Set;return u.forEach(t=>{t.category&&Array.isArray(t.category)&&t.category.forEach(n=>{e.add(n.toUpperCase())})}),Array.from(e).sort()}async function Ql(){const e=document.getElementById("preset-builder-name").value.trim(),t=document.getElementById("preset-builder-category").value.trim(),n=document.getElementById("preset-builder-prompt").value.trim();if(!e){alert("Please enter a preset name");return}if(!n){alert("Please enter a prompt");return}const o=t?t.split(",").map(l=>l.trim().toUpperCase()).filter(l=>l.length>0):["CUSTOM"];let s=null;if(pe>=0){const l=u[pe].name;if(s=l,u[pe]={name:e.toUpperCase(),category:o,message:n,internal:!1},l!==e.toUpperCase()){const r=S.indexOf(l);r>-1&&(S[r]=e.toUpperCase())}}else{const l=u.findIndex(a=>a.name.toUpperCase()===e.toUpperCase());if(l!==-1){if(!await confirm(`A preset named "${e}" already exists. Do you want to overwrite it?`))return;s=u[l].name,u.splice(l,1)}const r={name:e.toUpperCase(),category:o,message:n,internal:!1};u.push(r),S.includes(r.name)||S.push(r.name)}he();const i=pe>=0?u[pe]:u[u.length-1];s&&s!==i.name&&await Ee.db.transaction(["presets"],"readwrite").objectStore("presets").delete(`new_${s}`),await Ee.saveNewPreset(i),alert(pe>=0?`Preset "${e}" updated!`:`Preset "${e}" saved successfully!`),Fn(),No(),F&&Pe()}async function Wl(){if(pe<0){alert("No preset selected for deletion");return}const e=u[pe];if(e.internal!==!1){alert("Cannot delete built-in presets");return}if(!await confirm(`Delete preset "${e.name}"? This cannot be undone.`))return;u.splice(pe,1);const t=S.indexOf(e.name);t>-1&&(S.splice(t,1),he());const n=pe===E;if(E>=u.length&&(E=u.length-1),n){const i=u.filter(l=>S.includes(l.name));i.length>0?E=u.findIndex(l=>l.name===i[0].name):u.length>0&&(E=0),z()}await Ee.db.transaction(["presets"],"readwrite").objectStore("presets").delete(`new_${e.name}`),lr(),We(),alert(`Preset "${e.name}" deleted successfully!`),Fn(),No(),F&&Pe()}function xt(){const e=document.getElementById("visible-presets-list"),t=document.querySelector("#visible-presets-submenu .submenu-list");t&&t.scrollTop,e.innerHTML="";const n=new Set(ae.getImportedPresets().map(a=>a.name)),i=u.filter(a=>{if(a.internal)return!1;const c=n.has(a.name),g=!ft.some(f=>f.name===a.name);return c||g}).filter(a=>{if(Zt){const c=Zt.toLowerCase(),g=a.category&&a.category.some(v=>v.toLowerCase().includes(c));if(!(a.name.toLowerCase().includes(c)||g))return!1}return ut?a.category&&a.category.includes(ut):!0}).sort((a,c)=>a.name.localeCompare(c.name)),l=document.createDocumentFragment();i.forEach(a=>{const c=document.createElement("div");c.className="style-item",c.dataset.presetName=a.name;const g=document.createElement("input");g.type="checkbox",g.className="master-prompt-checkbox",g.checked=S.includes(a.name),g.style.marginRight="3vw";const f=document.createElement("span");f.className="style-name",f.textContent=a.name,c.appendChild(g),c.appendChild(f),g.onclick=v=>{v.stopPropagation(),Pi(a.name,g.checked)},c.onclick=()=>{g.checked=!g.checked,Pi(a.name,g.checked)},l.appendChild(c)}),e.appendChild(l);const r=document.getElementById("visible-presets-count");if(r){const a=i.filter(c=>S.includes(c.name)).length;r.textContent=a}setTimeout(()=>{tn()},50)}function Pi(e,t){const n=S.indexOf(e);t&&n===-1?S.push(e):!t&&n>-1&&S.splice(n,1),he(),We();const o=u[E];if(o&&!t&&o.name===e){const r=u.filter(a=>S.includes(a.name));r.length>0&&(E=u.findIndex(a=>a.name===r[0].name),z())}const s=document.querySelector("#visible-presets-submenu .submenu-list"),i=s?s.scrollTop:0;xt(),s&&requestAnimationFrame(()=>{s.scrollTop=i});const l=document.getElementById("styles-count");if(l){const{favorites:r,regular:a}=en(),c=r.length+a.length;l.textContent=c}F&&Pe()}function We(){const e=document.getElementById("current-visible-presets-display");if(e){const t=u.filter(o=>!o.internal).length,n=S.length;e.textContent=n===t?"All Visible":`${n} of ${t}`}}function Xl(){if(!Ze||!ln)return;const e=document.getElementById("visible-presets-list");!e||e.querySelectorAll(".style-item").length===0||(ge=Math.max(0,ge-1),tn())}function Kl(){if(!Ze||!ln)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(ge=Math.min(t.length-1,ge+1),tn())}function tn(){if(!Ze)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),ge=Math.max(0,Math.min(ge,t.length-1));const n=t[ge];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.dataset.presetName,s=u.find(l=>l.name===o),i=document.getElementById("visible-presets-category-hint");i&&s&&s.category&&!po?(i.innerHTML="",i.style.display="block",s.category.forEach((l,r)=>{const a=document.createElement("span");if(a.textContent=l,a.style.cursor="pointer",a.style.padding="0 2px",ut===l&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),ut===l?ut="":ut=l,ge=0,xt()},i.appendChild(a),r<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function Zl(){if(!Ze||!ln)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||ge>=t.length)return;const n=t[ge];n&&n.click()}function dr(){const e=["Very Low","Low","Medium","High","Very High"],t=document.getElementById("current-motion-display");if(t){const n=Math.floor((50-Lt)/10)+1,o=Math.max(1,Math.min(5,n));t.textContent=`Sensitivity: ${e[o-1]}`}}function En(){const e={motionThreshold:Lt,motionPixelThreshold:Po,motionContinuousEnabled:ht,motionCooldown:Mt,motionStartDelay:Ot};try{localStorage.setItem(ji,JSON.stringify(e))}catch(t){console.error("Failed to save motion settings:",t)}}function ea(){try{const e=localStorage.getItem(ji);if(e){const t=JSON.parse(e);Lt=t.motionThreshold||30,Po=t.motionPixelThreshold||.1,ht=t.motionContinuousEnabled!==void 0?t.motionContinuousEnabled:!0,Mt=t.motionCooldown||2,Ot=t.motionStartDelay||3}{const t=document.getElementById("motion-sensitivity-slider");if(t){const l=Math.floor((50-Lt)/10)+1;t.value=Math.max(1,Math.min(5,l))}const n=document.getElementById("motion-continuous-enabled");n&&(n.checked=ht);const o=document.getElementById("motion-cooldown-slider");o&&(o.value=Mt);const s=document.getElementById("motion-start-delay-slider"),i=document.getElementById("motion-start-delay-value");if(s&&i){const l=Fl();s.value=l,i.textContent=Qt[l].label}dr()}}catch(e){console.error("Failed to load motion settings:",e)}}function ta(){O=!O;const e=document.getElementById("no-magic-status");e&&(e.textContent=O?"Enabled":"Disabled",e.style.color=O?"#4CAF50":"",e.style.fontWeight=O?"600":"");try{localStorage.setItem(Yi,JSON.stringify(O))}catch(t){console.error("Failed to save No Magic mode:",t)}mr(),O?showStatus("No Magic Mode ON - Camera only",2e3):showStatus("No Magic Mode OFF - AI prompts enabled",2e3)}function na(){try{const e=localStorage.getItem(Yi);if(e!==null){O=JSON.parse(e);const t=document.getElementById("no-magic-status");t&&(t.textContent=O?"Enabled":"Disabled",t.style.color=O?"#4CAF50":"",t.style.fontWeight=O?"600":""),mr()}}catch(e){console.error("Failed to load No Magic mode:",e)}}function mr(){window.cameraStarted&&(O?B&&(B.textContent="‚ö° NO MAGIC MODE"):z())}function oa(){const e=localStorage.getItem(Ri);e!==null&&(Ct=parseInt(e,10)),ur()}function sa(){localStorage.setItem(Ri,Ct.toString()),ur()}function ur(){const e=document.getElementById("current-import-resolution-display");if(e){const t=xo[Ct];e.textContent=t.name.split(" ")[0]}}function ia(){document.getElementById("settings-submenu").style.display="none",document.getElementById("tutorial-submenu").style.display="flex",F=!1,bt=!0,Ae=0,X=!1,gr()}function ra(){document.getElementById("tutorial-submenu").style.display="none",bt=!1,$e()}function la(e){const t=document.getElementById("tutorial-glossary"),n=document.getElementById("tutorial-content-area"),o=document.getElementById("section-"+e),s=document.getElementById("back-to-glossary");t&&n&&o&&(t.style.display="none",n.style.display="flex",s&&(s.style.display="block"),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"start"})},100))}function gr(){const e=document.getElementById("tutorial-glossary"),t=document.getElementById("tutorial-content-area"),n=document.getElementById("back-to-glossary");e&&t&&(t.style.display="none",e.style.display="block",n&&(n.style.display="none"),Ae=0,setTimeout(()=>{Ro()},50))}function aa(){if(!bt)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Ae=(Ae-1+o.length)%o.length,Ro();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.max(0,n.scrollTop-80))}function ca(){if(!bt)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;Ae=(Ae+1)%o.length,Ro();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+80))}function Ro(){const e=document.getElementById("tutorial-glossary");if(!e)return;const t=e.querySelectorAll(".glossary-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),Ae>=0&&Ae<t.length)){const n=t[Ae];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function da(){document.getElementById("settings-submenu").style.display="none";const e=document.getElementById("import-resolution-submenu"),t=document.getElementById("import-resolution-list");t.innerHTML="",xo.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Ct&&s.classList.add("selected"),s.textContent=n.name,s.onclick=()=>{Ct=o,sa(),fr()},t.appendChild(s)}),e.style.display="flex"}function fr(){document.getElementById("import-resolution-submenu").style.display="none",document.getElementById("settings-submenu").style.display="flex"}function bo(){!I||!b||(ze=null,pn=!1,bn=setInterval(()=>{if(!fe||pn||!ht&&Y.style.display==="block")return;ma()&&(console.log("Motion detected! Capturing..."),So(),pn=!0,setTimeout(()=>{if(pn=!1,ze=null,Y.style.display==="block"&&(Y.style.display="none",I.style.display="block"),!ht){qo(),fe=!1;const t=document.getElementById("motion-toggle");t.classList.remove("active"),t.title="Motion Detection: OFF",showStatus("Motion capture complete - Press eye button to reactivate",3e3),u&&u[E]&&ne(u[E].name)}},Mt*1e3))},500))}function qo(){bn&&(clearInterval(bn),bn=null),ze=null}function ma(){if(!I||!b)return!1;const e=b.getContext("2d"),t=320,n=240;b.width=t,b.height=n,e.drawImage(I,0,0,t,n);const o=e.getImageData(0,0,t,n);if(!ze)return ze=o,!1;let s=0;const i=t*n;for(let r=0;r<o.data.length;r+=4){const a=Math.abs(o.data[r]-ze.data[r]),c=Math.abs(o.data[r+1]-ze.data[r+1]),g=Math.abs(o.data[r+2]-ze.data[r+2]);(a+c+g)/3>Lt&&s++}return ze=o,s/i>Po}function yr(){Re=!Re;const e=document.getElementById("random-toggle");Re?(e.classList.add("random-active"),B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ üé≤ Random Mode":`Random mode ON ‚Ä¢ ${u[E].name}`,ne("üé≤ Random Mode")):(e.classList.remove("random-active"),z(),u&&u[E]&&ne(u[E].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"random_mode_toggled",enabled:Re,timestamp:Date.now()}))}function ua(){try{const e=localStorage.getItem(Qi);e&&(D=JSON.parse(e))}catch(e){console.error("Error loading queue:",e),D=[]}}function cn(){try{localStorage.setItem(Qi,JSON.stringify(D))}catch(e){console.error("Error saving queue:",e)}}function ao(){St&&(Se?(St.className="connection-status online",St.querySelector("#connection-text").textContent="Online"):(St.className="connection-status offline",St.querySelector("#connection-text").textContent="Offline")),qt()}function qt(){if(wt){const e=D.length;wt.querySelector("#queue-count").textContent=e,wt.style.display=e>0?"block":"none"}if(qe){const e=D.length;qe.querySelector("#sync-count").textContent=e,qe.style.display=e>0&&Se?"block":"none"}}function ga(){window.addEventListener("online",()=>{Se=!0,ao(),console.log("Connection restored"),D.length>0&&!yt&&setTimeout(()=>{B.textContent=`Connection restored! Syncing ${D.length} photos...`,nn()},1e3)}),window.addEventListener("offline",()=>{Se=!1,ao(),console.log("Connection lost"),yt&&(B.textContent="Connection lost during sync")}),ao()}async function fa(){try{return _=(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"),console.log("Available cameras:",_.length),_}catch(e){return console.error("Error enumerating cameras:",e),[]}}function $n(){const e=on[Xe];if(_.length===0)return{video:{facingMode:"environment",width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};const n={video:{deviceId:{exact:_[me].deviceId},width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};return pt()&&(n.video.advanced=[{zoom:1}]),n}async function ya(e){if(!(e===Xe||!N)){Xe=e,ql(e);try{B.textContent="Changing resolution...",N&&N.getTracks().forEach(n=>n.stop());const t=$n();N=await navigator.mediaDevices.getUserMedia(t),I.srcObject=N,Z=N.getVideoTracks()[0],await new Promise(n=>{I.onloadedmetadata=async()=>{try{await I.play(),Vn(),await _t(re),setTimeout(n,100)}catch(o){console.error("Video play error:",o),n()}}}),z(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"resolution_changed",resolution:on[Xe].name,timestamp:Date.now()}))}catch(t){console.error("Resolution change error:",t),B.textContent="Resolution change failed"}}}function vo(){if(_.length===0)return"Default Camera";const e=_[me];let t=e.label;return!t||t===""?e.deviceId?t=`Camera ${me+1}`:t="Unknown Camera":(t=t.replace(/\([^)]*\)/g,"").trim(),t.toLowerCase().includes("front")?t="Front Camera":t.toLowerCase().includes("back")||t.toLowerCase().includes("rear")?t="Back Camera":t.length>20&&(t=t.substring(0,17)+"...")),t}function pt(){if(_.length===0)return!1;const e=_[me];if(!e)return!1;const t=e.label.toLowerCase();return e.facingMode==="user"?!0:e.facingMode==="environment"?!1:t.includes("front")||t.includes("user")||t.includes("selfie")||t.includes("face")?!0:t.includes("back")||t.includes("rear")||t.includes("environment")?!1:_.length===2?me===1:me>0}function Vn(){try{pt()?(I.style.transform="translateZ(0)",I.style.webkitTransform="translateZ(0)"):(I.style.transform="scaleX(-1) translateZ(0)",I.style.webkitTransform="scaleX(-1) translateZ(0)")}catch(e){console.warn("Mirror transform skipped:",e)}}function pa(){if(!Z)return!1;const e=Z.getCapabilities();return e&&"zoom"in e}function pr(){if(!Z)return{min:1,max:5,step:.1};const e=Z.getCapabilities();return e&&e.zoom?{min:Math.min(e.zoom.min||1,1),max:Math.max(e.zoom.max||5,5),step:e.zoom.step||.1}:{min:1,max:5,step:.1}}async function _t(e){if(Z)try{if(pa()){const t=pr(),n=Math.max(t.min,Math.min(e,t.max)),o={advanced:[{zoom:n}]},s=Z.getCapabilities();s&&s.focusMode&&s.focusMode.includes("continuous")&&(o.advanced[0].focusMode="continuous"),await Z.applyConstraints(o),re=n,pt()?(I.style.transform="translateZ(0)",I.style.webkitTransform="translateZ(0)"):(I.style.transform="scaleX(-1) translateZ(0)",I.style.webkitTransform="scaleX(-1) translateZ(0)")}else{const t=Math.max(1,Math.min(e,5));re=t,pt()?(I.style.transform=`scale(${t})`,I.style.webkitTransform=`scale(${t})`):(I.style.transform=`scaleX(-1) scale(${t})`,I.style.webkitTransform=`scaleX(-1) scale(${t})`)}}catch{const n=Math.max(1,Math.min(e,5));re=n,pt()?(I.style.transform=`scale(${n})`,I.style.webkitTransform=`scale(${n})`):(I.style.transform=`scaleX(-1) scale(${n})`,I.style.webkitTransform=`scaleX(-1) scale(${n})`)}}async function ha(){if(Z)try{const e=Z.getCapabilities();e&&e.focusMode&&(e.focusMode.includes("single-shot")?(await Z.applyConstraints({advanced:[{focusMode:"single-shot",zoom:re}]}),console.log("Triggered single-shot focus"),setTimeout(async()=>{try{await Z.applyConstraints({advanced:[{focusMode:"continuous",zoom:re}]})}catch(t){console.log("Could not return to continuous focus:",t)}},500)):e.focusMode.includes("manual")&&(await Z.applyConstraints({advanced:[{focusMode:"manual",zoom:re}]}),console.log("Triggered manual focus")))}catch(e){console.log("Focus adjustment not supported or failed:",e)}}async function Ea(){if(so||_.length<=1){console.log("Cannot switch camera: loading or not enough cameras");return}so=!0;try{B.textContent="Switching camera...",N&&N.getTracks().forEach(t=>t.stop()),me=(me+1)%_.length,console.log(`Switching to camera ${me+1} of ${_.length}`);const e=$n();N=await navigator.mediaDevices.getUserMedia(e),I.srcObject=N,Z=N.getVideoTracks()[0],await new Promise(t=>{I.onloadedmetadata=async()=>{try{await I.play(),Vn(),await _t(re),setTimeout(t,100)}catch(n){console.error("Video play error:",n),t()}}}),z(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"camera_switched",cameraIndex:me,cameraLabel:vo(),timestamp:Date.now()}))}catch(e){console.error("Camera switch error:",e),B.textContent="Camera switch failed",me=(me-1+_.length)%_.length}finally{so=!1}}function Ia(){try{const e=localStorage.getItem(qi);if(e){const t=JSON.parse(e);W=t.count||5;const n=t.speed||2;sn=Pt[n].delay}}catch(e){console.error("Error loading burst settings:",e)}}function Li(e,t){try{localStorage.setItem(qi,JSON.stringify({count:e,speed:t}))}catch(n){console.error("Error saving burst settings:",n)}}function hr(){ve=!ve;const e=document.getElementById("burst-toggle");ve?(e.classList.add("burst-active"),B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${W} photos) ‚Ä¢ ${u[E].name}`,ne("üì∏ Burst Mode")):(e.classList.remove("burst-active"),z(),u&&u[E]&&ne(u[E].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_mode_toggled",enabled:ve,count:W,timestamp:Date.now()}))}function Er(){Be=!Be;const e=document.getElementById("timer-toggle");Be?(e.classList.add("timer-active"),B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ ‚è±Ô∏è Timer Mode":`Timer mode ON (${He}s delay) ‚Ä¢ ${u[E].name}`,ne("‚è±Ô∏è Timer Mode")):(e.classList.remove("timer-active"),Ke&&(clearInterval(Ke),Ke=null,document.getElementById("timer-countdown").style.display="none"),z(),u&&u[E]&&ne(u[E].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"timer_mode_toggled",enabled:Be,delay:He,timestamp:Date.now()}))}function Bo(e){let t=He;const n=document.getElementById("timer-countdown"),o=document.getElementById("timer-countdown-text");o.textContent=t,n.style.display="flex",n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),B.textContent=`Timer: ${t}s...`,Ke=setInterval(()=>{t--,t>0?(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{o.textContent=t,n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),B.textContent=`Timer: ${t}s...`},500)):(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{n.style.display="none",n.classList.remove("countdown-fade-out"),clearInterval(Ke),Ke=null,e(),It&&Be&&(setTimeout(()=>{if(Y.style.display==="block"){Y.style.display="none",I.style.display="block";const s=document.getElementById("camera-button");s&&_.length>1&&(s.style.display="flex")}},500),setTimeout(()=>{Be&&Bo(e)},Ie*1e3))},500))},1e3)}function Ir(){Ke&&(clearInterval(Ke),Ke=null,document.getElementById("timer-countdown").style.display="none",z())}function ba(){try{const e=localStorage.getItem(_i);if(e){const t=JSON.parse(e);He=t.delay||10,It=t.repeat||!1,Ie=t.repeatInterval||1}}catch(e){console.error("Error loading timer settings:",e)}}function co(){try{localStorage.setItem(_i,JSON.stringify({delay:He,repeat:It,repeatInterval:Ie}))}catch(e){console.error("Error saving timer settings:",e)}}function Yt(){const e=document.getElementById("current-timer-display");if(e){const t=It?`Repeat (${Fi[va()].label})`:"No Repeat";e.textContent=`${He}s, ${t}`}}function va(){for(const[e,t]of Object.entries(Fi))if(t.seconds===Ie)return parseInt(e);return 1}async function Mi(){if(!(!N||io||Y.style.display==="block")){io=!0,B.textContent=`Burst mode: Taking ${W} photos...`;for(let e=0;e<W;e++)B.textContent=`Burst ${e+1}/${W}...`,Ba(e+1),e<W-1&&await new Promise(t=>setTimeout(t,sn));io=!1,B.textContent=`Burst complete! ${W} photos saved.`,Se&&!yt?setTimeout(()=>{nn()},500):Se||(B.textContent=`Burst complete! ${W} photos queued (offline).`),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_complete",count:W,timestamp:Date.now()})),setTimeout(()=>{ve?B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${W} photos) ‚Ä¢ ${u[E].name}`:z()},2e3)}}function Ba(e){if(!N)return;Re&&(E=ko()),(b.width!==I.videoWidth||b.height!==I.videoHeight)&&(b.width=I.videoWidth,b.height=I.videoHeight);const t=b.getContext("2d",{willReadFrequently:!1,alpha:!1});t.clearRect(0,0,b.width,b.height);const n=b.width/re,o=b.height/re,s=(b.width-n)/2,i=(b.height-o)/2;if(pt())t.drawImage(I,s,i,n,o,0,0,b.width,b.height);else{t.save(),t.scale(-1,1),t.drawImage(I,s,i,n,o,-b.width,0,b.width,b.height),t.restore();const g=document.createElement("canvas");g.width=b.width,g.height=b.height;const f=g.getContext("2d");f.scale(-1,1),f.drawImage(b,-b.width,0),t.clearRect(0,0,b.width,b.height),t.drawImage(g,0,0)}const l=Xe>=2?.7:.8,r=b.toDataURL("image/jpeg",l),a=u[E];Zi(r);const c={id:Date.now().toString()+"-"+e,imageBase64:r,preset:a,timestamp:Date.now()};D.push(c),cn(),qt()}async function Sa(){try{I=document.getElementById("video"),b=document.getElementById("canvas"),Y=document.getElementById("captured-image"),B=document.getElementById("status"),Sn=document.getElementById("reset-button");const e=document.getElementById("start-screen");if(e){const r=e.querySelector(".start-text");r&&(r.textContent="Requesting camera access...");const a=document.getElementById("start-button");a&&(a.disabled=!0)}if(await fa(),_.length>1){const r=_.findIndex(a=>{const c=a.label.toLowerCase();return c.includes("back")||c.includes("rear")||c.includes("environment")});me=r!==-1?r:_.length-1}else me=0;const t=$n();N=await navigator.mediaDevices.getUserMedia(t),I.srcObject=N,Z=N.getVideoTracks()[0],console.log("Camera initialized:",vo()),ua(),ga(),await new Promise(r=>{I.onloadedmetadata=async()=>{try{await I.play(),Vn(),_t(1),setTimeout(r,100)}catch(a){console.error("Video play error:",a),r()}}}),document.getElementById("start-screen").remove(),document.getElementById("camera-container").style.display="flex",B.style.display="block";const n=document.getElementById("camera-button");_.length>1&&(n.style.display="flex");const o=document.getElementById("menu-button");o&&(o.style.display="flex");const s=document.getElementById("mode-carousel");s&&(s.style.display="block");const i=document.getElementById("gallery-button");i&&(i.style.display="flex"),z();const l=document.getElementById("connection-status");if(l&&Se&&(l.style.display="block",setTimeout(()=>{l.style.display="none"},3e3)),window.hasPresetsUpdates){const r=document.getElementById("updates-indicator");r&&(r.style.display="block",setTimeout(()=>{r.style.display="none"},3e3))}sr(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_ready",availableCameras:_.length,currentCamera:vo(),timestamp:Date.now()}))}catch(e){console.error("Camera access error:",e),B.textContent="Camera access denied";const t=document.getElementById("start-button");t&&(t.disabled=!1);const n=document.getElementById("start-screen");n&&(n.style.display="block"),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_error",error:e.message,timestamp:Date.now()}))}}function ct(){N&&I&&(N.getTracks().forEach(e=>{e.stop()}),I.style.display="none",I.srcObject=null)}async function br(){if(I)try{const e=$n();N=await navigator.mediaDevices.getUserMedia(e),I.srcObject=N,Z=N.getVideoTracks()[0],await new Promise(t=>{I.onloadedmetadata=async()=>{try{await I.play(),Vn(),await _t(re),setTimeout(t,100)}catch(n){console.error("Video resume error:",n),t()}}}),I.style.display="block"}catch(e){console.error("Failed to resume camera:",e),B.textContent="Camera resume failed"}}function So(){if(!N)return;Re&&(E=ko(),ne(u[E].name)),(b.width!==I.videoWidth||b.height!==I.videoHeight)&&(b.width=I.videoWidth,b.height=I.videoHeight);const e=b.getContext("2d",{willReadFrequently:!1,alpha:!1,desynchronized:!0});e.clearRect(0,0,b.width,b.height);const t=b.width/re,n=b.height/re,o=(b.width-t)/2,s=(b.height-n)/2;if(pt())e.drawImage(I,o,s,t,n,0,0,b.width,b.height);else{e.save(),e.scale(-1,1),e.drawImage(I,o,s,t,n,-b.width,0,b.width,b.height),e.restore();const f=document.createElement("canvas");f.width=b.width,f.height=b.height;const v=f.getContext("2d");v.scale(-1,1),v.drawImage(b,-b.width,0),e.clearRect(0,0,b.width,b.height),e.drawImage(f,0,0)}const i=Xe>=2?.7:.8,l=b.toDataURL("image/jpeg",i);Y.src=l,Y.style.display="block",Y.style.transform="none",I.style.display="none",Dn(),fe||Be&&It?Sn.style.display="none":Sn.style.display="block";const r=document.getElementById("camera-button");r&&(r.style.display="none");const a=document.getElementById("resolution-button");a&&(a.style.display="none"),Zi(l);const c=u[E],g={id:Date.now().toString(),imageBase64:l,preset:c,timestamp:Date.now()};if(D.push(g),cn(),qt(),Se){const f=O?"Photo saved!":"Photo saved! Uploading...";B.textContent=f,yt||nn()}else B.textContent=`Photo queued for sync (${D.length} in queue)`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"photo_captured",queued:!0,queueLength:D.length,timestamp:Date.now()}))}async function nn(){if(D.length===0||yt)return;if(!Se){B.textContent="Cannot sync - offline";return}yt=!0,qe.disabled=!0,qe.classList.add("syncing"),console.log(`Syncing ${D.length} queued photos...`);const e=D.length;let t=0;for(;D.length>0&&Se;){const n=D[0];try{if(B.textContent=`Syncing ${t+1}/${e}...`,typeof PluginMessageHandler<"u"&&!O&&PluginMessageHandler.postMessage(JSON.stringify({message:Yn(n.preset.message,n.preset.name),pluginId:"com.r1.pixelart",imageBase64:n.imageBase64})),await new Promise(o=>setTimeout(o,3e3)),Se)D.shift(),t++,cn(),qt();else{console.log("Lost connection during sync");break}await new Promise(o=>setTimeout(o,3e3))}catch(o){console.error("Sync error:",o),B.textContent="Sync error - will retry later";break}}if(yt=!1,qe.disabled=!1,qe.classList.remove("syncing"),D.length===0){const n=O?`All ${t} photos saved!`:`All ${t} photos synced successfully!`;B.textContent=n,setTimeout(()=>{z()},2e3)}else Se?B.textContent=`Synced ${t}. ${D.length} remaining.`:B.textContent=`Connection lost. ${D.length} photos queued.`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"sync_complete",synced:t,remaining:D.length,timestamp:Date.now()}))}function _o(){const e=document.getElementById("queue-manager"),t=document.getElementById("queue-list");t.innerHTML="",D.length===0?t.innerHTML=`
      <div class="queue-empty">
        <h4>No Photos in Queue</h4>
        <p>Take photos while offline and they'll appear here for syncing.</p>
      </div>
    `:D.forEach((n,o)=>{const s=document.createElement("div");s.className="queue-item",s.innerHTML=`
        <div class="queue-item-header">
          <span class="queue-item-style">${n.preset.name}</span>
          <span class="queue-item-time">${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <img src="${n.imageBase64}" class="queue-item-preview" alt="Queued photo">
        <div class="queue-item-actions">
          <button onclick="removeFromQueue(${o})" class="delete-button">Remove</button>
          <button onclick="previewQueueItem(${o})" class="secondary">Preview</button>
        </div>
      `,t.appendChild(s)}),e.style.display="flex"}function Ta(){document.getElementById("queue-manager").style.display="none"}async function wa(e){await confirm("Remove this photo from the sync queue?")&&(D.splice(e,1),cn(),qt(),_o())}function xa(e){const t=D[e];alert(`Style: ${t.preset.name}
Prompt: ${t.preset.message}
Saved: ${new Date(t.timestamp).toLocaleString()}`)}async function vr(){await confirm("Clear all photos from the queue? This cannot be undone.")&&(D=[],cn(),qt(),_o())}window.addEventListener("sideClick",()=>{if(console.log("Side button pressed"),X){const o=document.getElementById("settings-submenu").querySelectorAll(".menu-section-button");o.length>0&&Me<o.length&&o[Me].click();return}if(Ze){Zl();return}if(bt){const n=document.getElementById("tutorial-glossary");if(n&&n.style.display!=="none"){const o=n.querySelectorAll(".glossary-item");o.length>0&&Ae<o.length&&o[Ae].click()}return}if(rn){const o=document.getElementById("resolution-submenu").querySelectorAll(".resolution-item");o.length>0&&Oe<o.length&&o[Oe].click();return}if(Fe){bl();return}if(F&&Ue){Dl();return}const e=document.getElementById("start-screen"),t=document.getElementById("start-button");if(e&&e.style.display!=="none")console.log("Simulating tap on start button"),setTimeout(()=>{t.click()},100);else if(Y&&Y.style.display==="block")Gn();else{if(fe){if(Ot>0){let n=Ot;const o=document.getElementById("timer-countdown"),s=document.getElementById("timer-countdown-text");s.textContent=n,o.style.display="flex",o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),B.textContent=`Motion Detection starting in ${n}s...`,Vt=setInterval(()=>{n--,n>0?(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{s.textContent=n,o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),B.textContent=`Motion Detection starting in ${n}s...`},500)):(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{o.style.display="none",o.classList.remove("countdown-fade-out"),clearInterval(Vt),fe&&I&&I.readyState>=2&&(bo(),showStatus("Motion Detection active - Move in front of camera",3e3))},500))},1e3)}else bo(),showStatus("Motion Detection ON - Move in front of camera",3e3);return}Be?Bo(ve?()=>Mi():()=>So()):ve?Mi():So()}});window.addEventListener("scrollUp",()=>{var t,n,o,s;if(console.log("Scroll wheel: up"),document.getElementById("style-editor").style.display==="flex"){Ti();return}if(Fe){el();return}if(ae.isImportModalOpen){ae.scrollImportUp();return}if(bt){aa();return}if(kt){er();return}if(Ze){Xl();return}if(F&&Ue){Ol();return}if(Rn){ul();return}if(Xt){dl();return}if(Nn){al();return}if(kn){rl();return}if(rn){sl();return}if(X){nl();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){fl();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){pl();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){Ti();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){El();return}if(!N||Y.style.display==="block")return;const e=Date.now();e-xn<Ji||(xn=e,rt&&clearTimeout(rt),rt=setTimeout(()=>{let i=ir();const l=Rt();i=(i-1+l.length)%l.length,E=rr(i);const r=u[E];r&&ne(O?"‚ö° NO MAGIC MODE":r.name),z(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:u[E].name,timestamp:Date.now()})),rt=null},50))});window.addEventListener("scrollDown",()=>{var t,n,o,s;if(console.log("Scroll wheel: down"),document.getElementById("style-editor").style.display==="flex"){wi();return}if(Fe){tl();return}if(ae.isImportModalOpen){ae.scrollImportDown();return}if(bt){ca();return}if(kt){tr();return}if(Ze){Kl();return}if(F&&Ue){Al();return}if(Rn){gl();return}if(Xt){ml();return}if(Nn){cl();return}if(kn){ll();return}if(rn){il();return}if(X){ol();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){yl();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){hl();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){wi();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){Il();return}if(!N||Y.style.display==="block")return;const e=Date.now();e-xn<Ji||(xn=e,rt&&clearTimeout(rt),rt=setTimeout(()=>{let i=ir();const l=Rt();i=(i+1)%l.length,E=rr(i);const r=u[E];r&&ne(O?"‚ö° NO MAGIC MODE":r.name),z(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:u[E].name,timestamp:Date.now()})),rt=null},50))});function z(){E=Math.max(0,Math.min(E,u.length-1));const e=u[E];if(Z)try{const t={};Z.applyConstraints(t)}catch(t){console.error("Error applying preset constraints:",t)}B&&(B.textContent=O?"‚ö° NO MAGIC MODE":`Style: ${e.name}`),ne(e.name),localStorage.setItem(Hi,E.toString()),F&&Nt()}window.onPluginMessage=function(e){console.log("Received plugin message:",e),e&&e.status==="processing"?B.textContent="AI is processing your image...":e&&e.status==="complete"?B.textContent="AI transformation complete!":e&&e.error&&(B.textContent="Error: "+e.error)};typeof PluginMessageHandler<"u"?(console.log("Flutter channel is available"),PluginMessageHandler.postMessage(JSON.stringify({message:"AI Camera Styles initialized",pluginId:"com.r1.pixelart"}))):console.log("Running in development mode - Flutter channel not available");function Gn(){Y.style.display="none",fe&&ht||(qo(),fe&&bo()),Y.style.transform="none",I.style.display="block",Sn.style.display="none";const e=document.getElementById("camera-button");e&&_.length>1&&(e.style.display="flex");const t=document.getElementById("resolution-button");t&&(t.style.display="flex"),setTimeout(()=>{_t(re)},50),z(),Tr()}function Oi(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function Ca(){const e=document.getElementById("video");e.addEventListener("touchstart",n=>{n.touches.length===2&&(n.preventDefault(),Ft=!0,hi=Oi(n.touches[0],n.touches[1]),Ei=re)},{passive:!1});let t=null;e.addEventListener("touchmove",n=>{if(Ft&&n.touches.length===2){n.preventDefault();const s=Oi(n.touches[0],n.touches[1])/hi,i=Ei*s,l=pr(),r=Math.max(l.min,Math.min(i,l.max));t||(_t(r),t=setTimeout(()=>{t=null},50))}},{passive:!1}),e.addEventListener("touchend",n=>{n.touches.length<2&&(Ft&&ha(),Ft=!1,console.log("Pinch ended, current zoom:",re))}),e.addEventListener("touchcancel",()=>{Ft=!1})}function jn(){const e=document.getElementById("unified-menu");Y&&Y.style.display==="block"&&Gn(),Pe();const t=document.getElementById("styles-count");if(t){const{favorites:n,regular:o}=en(),s=n.length+o.length;t.textContent=s}Br(),Mn(),On(),Yt(),F=!0,Ue=!0,ct(),Ir(),e.style.display="flex"}async function Ho(){F=!1,Ue=!1,le=0,st="",Je="",document.getElementById("style-filter").value="";const e=document.getElementById("menu-category-hint");if(e&&(e.style.display="none"),document.getElementById("unified-menu").style.display="none",await br(),O)B&&(B.textContent="‚ö° NO MAGIC MODE"),ne("‚ö° NO MAGIC MODE");else if(Be||ve||fe||Re){let t="";Be?t="‚è±Ô∏è Timer Mode":ve?t="üì∏ Burst Mode":fe?t="üëÅÔ∏è Motion Detection":Re&&(t="üé≤ Random Mode"),B&&(B.textContent=`${t} ‚Ä¢ ${u[E]?u[E].name:""}`),ne(t)}else z()}function $e(){const e=document.getElementById("settings-submenu"),t=document.getElementById("unified-menu");Br(),Mn(),Yt(),On(),t.style.display="none",ct(),e.style.display="flex",F=!1,X=!0,Me=0,setTimeout(()=>{Ao()},50)}function Pa(){if(Wt){Wt=!1,document.getElementById("settings-submenu").style.display="none",X=!1,document.getElementById("unified-menu").style.display="none",F=!1,Ue=!1,ce().then(()=>{Oo(Lo)});return}document.getElementById("settings-submenu").style.display="none",X=!1,Me=0,jn()}function La(){const e=document.getElementById("timer-settings-submenu"),t=document.getElementById("settings-submenu"),n=document.getElementById("timer-delay-slider"),o=document.getElementById("timer-delay-value"),s=document.getElementById("timer-repeat-enabled");if(n&&o){const r=Ui.indexOf(He);n.value=r!==-1?r+1:3,o.textContent=He}s&&(s.checked=It);const i=document.getElementById("timer-repeat-interval-input"),l=document.getElementById("timer-repeat-interval-unit");i&&l&&(Ie>=3600&&Ie%3600===0?(i.value=Ie/3600,l.value="3600"):Ie>=60&&Ie%60===0?(i.value=Ie/60,l.value="60"):(i.value=Ie,l.value="1")),t.style.display="none",ct(),e.style.display="flex",Nn=!0,X=!1}function Ma(){document.getElementById("timer-settings-submenu").style.display="none",Nn=!1,$e()}function Oa(){const e=document.querySelector(".styles-menu-scroll-container");e&&(e.scrollTo({top:0,behavior:"smooth"}),le=0,Nt())}function Aa(){const e=document.querySelector(".styles-menu-scroll-container");if(e){e.scrollTo({top:e.scrollHeight,behavior:"smooth"});const t=document.getElementById("menu-styles-list");if(t){const n=t.querySelectorAll(".style-item");n.length>0&&(le=n.length-1,Nt())}}}function Br(){const e=document.getElementById("current-resolution-display");if(e){const t=on[Xe];e.textContent=`${t.width}x${t.height}`}}function Mn(){const e=document.getElementById("current-burst-display");if(e){let t="Medium";for(const[n,o]of Object.entries(Pt))if(o.delay===sn){t=o.label;break}e.textContent=`${W} photos, ${t}`}}function Da(){document.getElementById("settings-submenu").style.display="none",ct();const e=document.getElementById("resolution-submenu"),t=document.getElementById("resolution-list");t.innerHTML="",on.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Xe&&s.classList.add("active");const i=document.createElement("span");i.className="resolution-name",i.textContent=n.name,s.appendChild(i),s.onclick=()=>{ya(o),Sr()},t.appendChild(s)}),e.style.display="flex",rn=!0,X=!1,Oe=0,setTimeout(()=>{const n=e.querySelectorAll(".resolution-item");Do(n)},100)}async function Sr(){document.getElementById("resolution-submenu").style.display="none",rn=!1,Oe=0,$e()}function ka(){document.getElementById("settings-submenu").style.display="none",ct();const e=document.getElementById("burst-submenu"),t=document.getElementById("burst-count-slider"),n=document.getElementById("burst-speed-slider"),o=document.getElementById("burst-count-value"),s=document.getElementById("burst-speed-value");if(t&&o&&(t.value=W,o.textContent=W),n&&s){let i=2;for(const[l,r]of Object.entries(Pt))if(r.delay===sn){i=parseInt(l);break}n.value=i,s.textContent=Pt[i].label}e.style.display="flex",kn=!0,X=!1}async function Na(){document.getElementById("burst-submenu").style.display="none",kn=!1,$e()}function Ai(){document.getElementById("settings-submenu").style.display="none",ct();const e=document.getElementById("master-prompt-submenu"),t=document.getElementById("master-prompt-enabled"),n=document.getElementById("master-prompt-text"),o=document.getElementById("master-prompt-char-count");t&&(t.checked=Te),n&&(n.value=Le,n.disabled=!Te,o&&(o.textContent=Le.length)),e.style.display="flex",Xt=!0,X=!1}async function Ra(){if(Wt){Wt=!1,document.getElementById("master-prompt-submenu").style.display="none",Xt=!1,document.getElementById("settings-submenu").style.display="none",X=!1,document.getElementById("unified-menu").style.display="none",F=!1,Ue=!1,await ce(),Oo(Lo);return}document.getElementById("master-prompt-submenu").style.display="none",Xt=!1,$e()}function qa(){document.getElementById("settings-submenu").style.display="none",ct();const e=document.getElementById("aspect-ratio-submenu");e.style.display="flex",X=!1}async function _a(){document.getElementById("aspect-ratio-submenu").style.display="none",$e()}function Di(){const e=document.getElementById("current-aspect-ratio-display");e&&(e.textContent=ue==="none"?"None":ue)}function On(){const e=document.getElementById("current-master-prompt-display");if(e)if(Te&&Le.trim()){const t=Le.substring(0,20);e.textContent=`Enabled: ${t}${Le.length>20?"...":""}`}else Te?e.textContent="Enabled (empty)":e.textContent="Disabled"}function In(){try{localStorage.setItem($i,Le),localStorage.setItem(Vi,Te.toString()),localStorage.setItem(Gi,ue)}catch(e){console.error("Failed to save master prompt:",e)}}function Ha(){try{const e=localStorage.getItem($i),t=localStorage.getItem(Vi);e!==null&&(Le=e),t!==null&&(Te=t==="true"),sr();const n=localStorage.getItem(Gi);if(n){ue=n;const o=document.getElementById("aspect-ratio-1-1"),s=document.getElementById("aspect-ratio-16-9");o&&(o.checked=ue==="1:1"),s&&(s.checked=ue==="16:9");const i=document.getElementById("current-aspect-ratio-display");i&&(i.textContent=ue==="none"?"None":ue)}}catch(e){console.error("Failed to load master prompt:",e)}}function Ua(){try{const e=localStorage.getItem(Co);e&&(it=JSON.parse(e))}catch(e){console.error("Failed to load selection history:",e),it={}}}function Yn(e,t=""){let n=e;if(Te&&Le.trim()&&(n=`${e} ${Le}`),/RANDOM|SELECT|SELECTION|CHOOSE|modulo|LAST DIGIT|LAST TWO DIGITS|LAST THREE DIGITS/i.test(e)){const s=Date.now(),i=s%10,l=s%100,r=s%1e3;n=Fa(n,i,l,r,t)}return ue==="1:1"?n+=" Use a square aspect ratio.":ue==="16:9"&&(n+=" Use a square aspect ratio, but pad the image with black bars at top and bottom to simulate a 16:9 aspect ratio."),console.log("FINAL PROMPT:",n),n}function Fa(e,t,n,o,s){console.log("=== PROCESSING RANDOM SELECTIONS ===");const i=/‚Ä¢\s*If\s+(?:the\s+)?(?:LAST\s+DIGIT|RANDOM\s+SEED)(?:\s+of\s+the\s+RANDOM\s+SEED)?(?:\s+ends\s+in)?[^\n]*?(?:is\s+)?(?:an?\s+)?(EVEN|ODD)(?:\s+number)?[^\n]*?:\s*(?:SELECT\s+)?(.+?)(?=\n‚Ä¢|\n\n|$)/gi;e=e.replace(i,(c,g,f)=>{console.log("Found even/odd pattern for:",g);const v=t%2===0;if(g.toUpperCase()==="EVEN"&&v||g.toUpperCase()==="ODD"&&!v){const P=f.trim();return console.log("SELECTED (even/odd):",P),To(s,P),""}return""}),e=e.replace(/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option\s+[AB]:|\n[A-Z][A-Z\s]+(?:\([A-Z]+\))?:|\n\n|$)/gi,(c,g,f)=>"");const l=/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option|$)/gi;let r=null;e.replace(l,(c,g,f)=>(r||(r=f.trim()),c)),r&&(To(s,r),e=`SELECTED OPTION: ${r}
(Automatically selected using random seed)`);const a=/(?:select|choose|pick)?(?:\s+exactly\s+one)?[^\n]*?(?:use|using|with|via|by)\s+(?:the\s+)?(?:last\s+(digit|two\s+digits|three\s+digits)|random\s+seed)(?:\s+of\s+the\s+random\s+seed)?[^\n]*?\s+modulo\s+(\d+)[^\n]*?:\s*\n((?:\s*-\s*\d+:.*(?:\n|$))*)/gi;return e=e.replace(a,(c,g,f,v)=>{let w;return g?g.toLowerCase().includes("three")?w="THREE DIGITS":g.toLowerCase().includes("two")?w="TWO DIGITS":w="DIGIT":w="TWO DIGITS",console.log("Found modulo pattern:",w,"modulo",f),$a(w,f,v,t,n,o,s,c)}),e=e.replace(/‚Ä¢\s*If\s+none\s+is\s+specified[^\n]*\n/gi,""),e=e.replace(/‚Ä¢\s*If\s+no\s+\w+\s+is\s+specified[^\n]*\n/gi,""),e=e.replace(/‚Ä¢\s*Otherwise\s+SELECT[^\n]*\n/gi,""),e=e.replace(/^\s*[A-Z][A-Z\s]+(?:\([A-Z]+\))?:\s*$/gm,""),e=e.replace(/\n{3,}/g,`

`),console.log("=== FINISHED PROCESSING ==="),e}function $a(e,t,n,o,s,i,l,r){const a=[],c=/^\s*[-‚Äì]\s*(\d+):\s*(.+?)$/gm;let g;for(;(g=c.exec(n))!==null;){const T=parseInt(g[1]),C=g[2].trim();a.push({number:T,option:C}),console.log(`  Found option ${T}: ${C.substring(0,50)}`)}if(a.length===0)return console.log("  No options found, keeping original"),r;let f;e==="DIGIT"?f=o:e==="TWO DIGITS"?f=s:e==="THREE DIGITS"&&(f=i),console.log("  Selected value before modulo:",f);const v=parseInt(t),w=f%v;console.log("  Selection index after modulo:",w);const P=a.find(T=>T.number===w);return P?(console.log("  SELECTED:",P.option),To(l,P.option),`SELECTED OPTION: ${P.option}
(Automatically selected using random seed)`):(console.log("  No matching option found!"),r)}function To(e,t){if(!e||!t)return;const n=Va(e);n.unshift(t),n.length>Ii&&n.splice(Ii),it[e]=n,localStorage.setItem(Co,JSON.stringify(it))}function Va(e){if(!e)return[];if(!it[e]){const t=localStorage.getItem(Co);if(t)try{it=JSON.parse(t)}catch{it={}}}return it[e]||[]}function Pe(e=!1){const t=document.getElementById("menu-styles-list");t.innerHTML="",t.replaceWith(t.cloneNode(!1));const n=document.getElementById("menu-styles-list"),o=document.createDocumentFragment(),{favorites:s,regular:i}=en(),l=s.filter(c=>{if(st){const g=st.toLowerCase(),f=c.category&&c.category.some(w=>w.toLowerCase().includes(g));if(!(c.name.toLowerCase().includes(g)||c.message.toLowerCase().includes(g)||f))return!1}return Je?c.category&&c.category.includes(Je):!0}),r=i.filter(c=>{if(st){const g=st.toLowerCase(),f=c.category&&c.category.some(w=>w.toLowerCase().includes(g));if(!(c.name.toLowerCase().includes(g)||c.message.toLowerCase().includes(g)||f))return!1}return Je?c.category&&c.category.includes(Je):!0});if(l.length>0){const c=document.createElement("h3");c.className="menu-section-header",c.textContent="‚òÖ Favorites",o.appendChild(c),l.forEach(g=>{const f=ki(g);o.appendChild(f)})}if(r.length>0){const c=document.createElement("h3");c.className="menu-section-header",c.textContent=st?"Search Results":"All Styles",o.appendChild(c),r.forEach(g=>{const f=ki(g);o.appendChild(f)})}if(r.length===0&&l.length===0&&st){const c=document.createElement("div");c.className="menu-empty",c.textContent="No styles found",o.appendChild(c)}n.appendChild(o),n.addEventListener("click",Ga);const a=document.getElementById("styles-count");if(a){const{favorites:c,regular:g}=en(),f=c.length+g.length;a.textContent=f}e||(le=0,Nt())}function ki(e){const t=u.findIndex(r=>r===e),n=document.createElement("div");n.className="style-item",n.dataset.index=t,t===E&&n.classList.add("active");const o=document.createElement("button");o.className="style-favorite",o.textContent=Dt(e.name)?"‚≠ê":"‚òÜ",o.dataset.action="favorite",o.dataset.styleName=e.name;const s=document.createElement("span");s.className="style-name",s.textContent=e.name;const i=document.createElement("button");i.className="style-edit";const l=e.internal===!1;return i.textContent=l?"Builder":"Edit",i.dataset.action=l?"builder":"edit",i.dataset.index=t,n.appendChild(o),n.appendChild(s),n.appendChild(i),n}function Ga(e){const t=e.target;if(t.dataset.action==="favorite"){e.stopPropagation();const o=t.dataset.styleName;Hl(o);return}if(t.dataset.action==="edit"){e.stopPropagation();const o=parseInt(t.dataset.index);Ya(o);return}if(t.dataset.action==="builder"){e.stopPropagation();const o=parseInt(t.dataset.index);Yl(o);return}const n=t.closest(".style-item");if(n){const o=parseInt(n.dataset.index);isNaN(o)||(E=o,z(),Ho())}}function ja(e="Add New Style"){const t=document.getElementById("style-editor");document.getElementById("editor-title").textContent=e,t.style.display="flex",setTimeout(()=>{const n=document.querySelector(".style-editor-body");n&&n.focus()},100)}let An=!1;function Uo(){if(!An){An=!0;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="0.5vh",e.style.paddingBottom="0.5vw")}}function Fo(){setTimeout(()=>{const e=document.querySelectorAll(".style-input, .style-textarea");if(!Array.from(e).some(n=>n===document.activeElement)&&An){An=!1;const n=document.querySelector(".style-editor-body");n&&(n.style.gap="1vh",n.style.paddingBottom="1vw")}},100)}const mo=document.getElementById("style-name"),uo=document.getElementById("style-category"),go=document.getElementById("style-message");mo&&(mo.addEventListener("focus",Uo),mo.addEventListener("blur",Fo));uo&&(uo.addEventListener("focus",Uo),uo.addEventListener("blur",Fo));go&&(go.addEventListener("focus",Uo),go.addEventListener("blur",Fo));function $o(){document.getElementById("style-editor").style.display="none",document.getElementById("style-name").value="",document.getElementById("style-message").value="";const e=document.getElementById("style-category");e&&(e.value=""),document.getElementById("delete-style").style.display="none",ye=-1}function Ya(e){ye=e;const t=u[e];document.getElementById("style-name").value=t.name,document.getElementById("style-message").value=t.message;const n=document.getElementById("style-category");n&&(n.value=t.category?t.category.join(", "):""),document.getElementById("delete-style").style.display="block",ja("Edit Style")}async function za(){const e=document.getElementById("style-name").value.trim(),t=document.getElementById("style-message").value.trim(),n=document.getElementById("style-category").value.trim(),o=n?n.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):[];if(!e||!t){alert("Please fill in both name and AI prompt");return}if(ye>=0){const s=u[ye].name;u[ye]={name:e,category:o,message:t};const i=ft.some(r=>r.name===s),l=At&&ae.getImportedPresets().some(r=>r.name===s);if(i||l?await Ee.saveModification(s,{name:e,message:t,category:o}):await Ee.saveNewPreset({name:e,category:o,message:t}),s!==e){const r=S.indexOf(s);r>-1&&(S[r]=e,he())}}else{const s={name:e,category:o,message:t};await Ee.saveNewPreset(s),u.push(s),S.push(e),he()}alert(ye>=0?`Preset "${e}" updated!`:`Preset "${e}" saved!`),$o(),jn()}async function Ja(){if(ye>=0&&u.length>1&&await confirm("Delete this style?")){const e=u[ye].name,t=ft.some(a=>a.name===e);At&&ae.getImportedPresets().some(a=>a.name===e)?await ae.deletePreset(e):t?await Ee.saveDeletion(e):await Ee.removeModification(e),u.splice(ye,1);const o=S.indexOf(e);o>-1&&(S.splice(o,1),he());const s=ye===E;if(ye===E?E=Math.max(0,ye-1):ye<E&&(E=E-1),E=Math.max(0,Math.min(E,u.length-1)),lr(),s){const a=u.filter(c=>S.includes(c.name));a.length>0?E=u.findIndex(c=>c.name===a[0].name):u.length>0&&(E=0)}const i=u[E];if(i&&!S.includes(i.name)){const a=u.filter(c=>S.includes(c.name));a.length>0?E=u.findIndex(c=>c.name===a[0].name):u.length>0&&(E=0)}z(),We(),$o();const l=document.querySelector(".styles-menu-scroll-container"),r=l?l.scrollTop:0;jn(),l&&requestAnimationFrame(()=>{l.scrollTop=r}),alert(`Preset "${e}" deleted successfully!`)}}function Qa(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain(),s=e.createBiquadFilter();n.type="square",n.frequency.setValueAtTime(2400,t),n.frequency.exponentialRampToValueAtTime(1800,t+.012),s.type="highpass",s.frequency.setValueAtTime(1500,t),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.015),n.connect(s),s.connect(o),o.connect(e.destination),n.start(t),n.stop(t+.015);const i=e.createOscillator(),l=e.createGain(),r=e.createBiquadFilter();i.type="square",i.frequency.setValueAtTime(1200,t+.015),i.frequency.exponentialRampToValueAtTime(200,t+.023),r.type="bandpass",r.frequency.setValueAtTime(1500,t+.015),r.Q.setValueAtTime(2,t+.015),l.gain.setValueAtTime(.4,t+.015),l.gain.exponentialRampToValueAtTime(.001,t+.03),i.connect(r),r.connect(l),l.connect(e.destination),i.start(t+.015),i.stop(t+.03);const a=e.createOscillator(),c=e.createGain();a.type="triangle",a.frequency.setValueAtTime(400,t+.023),a.frequency.setValueAtTime(450,t+.027),a.frequency.setValueAtTime(380,t+.031),a.frequency.setValueAtTime(420,t+.035),c.gain.setValueAtTime(0,t+.023),c.gain.linearRampToValueAtTime(.15,t+.025),c.gain.exponentialRampToValueAtTime(.001,t+.04),a.connect(c),c.connect(e.destination),a.start(t+.023),a.stop(t+.04);const g=e.createOscillator(),f=e.createGain(),v=e.createBiquadFilter();g.type="square",g.frequency.setValueAtTime(800,t+.05),g.frequency.exponentialRampToValueAtTime(150,t+.06),v.type="bandpass",v.frequency.setValueAtTime(1e3,t+.05),v.Q.setValueAtTime(2,t+.05),f.gain.setValueAtTime(.5,t+.05),f.gain.exponentialRampToValueAtTime(.001,t+.07),g.connect(v),v.connect(f),f.connect(e.destination),g.start(t+.05),g.stop(t+.07);const w=e.createOscillator(),P=e.createGain(),T=e.createBiquadFilter();w.type="sine",w.frequency.setValueAtTime(180,t+.05),w.frequency.exponentialRampToValueAtTime(120,t+.095),T.type="lowpass",T.frequency.setValueAtTime(300,t+.05),P.gain.setValueAtTime(0,t+.05),P.gain.linearRampToValueAtTime(.2,t+.055),P.gain.exponentialRampToValueAtTime(.001,t+.105),w.connect(T),T.connect(P),P.connect(e.destination),w.start(t+.05),w.stop(t+.105);const C=e.sampleRate*.08,R=e.createBuffer(1,C,e.sampleRate),we=R.getChannelData(0);for(let dt=0;dt<C;dt++){const dn=Math.sin(dt/200)*.5+.5;we[dt]=(Math.random()*2-1)*dn}const oe=e.createBufferSource();oe.buffer=R;const j=e.createBiquadFilter();j.type="bandpass",j.frequency.setValueAtTime(3e3,t+.07),j.Q.setValueAtTime(1,t+.07);const K=e.createGain();K.gain.setValueAtTime(0,t+.07),K.gain.linearRampToValueAtTime(.12,t+.075),K.gain.linearRampToValueAtTime(.12,t+.125),K.gain.exponentialRampToValueAtTime(.001,t+.15),oe.connect(j),j.connect(K),K.connect(e.destination),oe.start(t+.07),oe.stop(t+.15);const de=e.createOscillator(),$=e.createGain();de.type="square",de.frequency.setValueAtTime(600,t+.145),de.frequency.exponentialRampToValueAtTime(100,t+.155),$.gain.setValueAtTime(.25,t+.145),$.gain.exponentialRampToValueAtTime(.001,t+.165),de.connect($),$.connect(e.destination),de.start(t+.145),de.stop(t+.165)}catch(e){console.log("Audio generation failed:",e)}}window.addEventListener("load",()=>{var li,ai,ci,di,mi,ui,gi,fi,yi,pi;kl(),Ha(),Ua(),Ca();const e=document.getElementById("start-button");e&&e.addEventListener("click",()=>{Qa();const d=document.querySelector(".camera-body");d&&(d.style.transition="all 0.1s",d.style.boxShadow="0 0 50px rgba(255, 255, 255, 1)",setTimeout(()=>{d.style.boxShadow=""},100));const m=document.querySelector(".lens-inner");m&&(m.style.transition="all 0.05s",m.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout(()=>{m.style.transform="translate(-50%, -50%) scale(1)"},50)),setTimeout(()=>{Sa()},300)});const t=document.getElementById("burst-toggle");t&&t.addEventListener("click",hr);const n=document.getElementById("timer-toggle");n&&n.addEventListener("click",Er);const o=document.getElementById("random-toggle");o&&o.addEventListener("click",yr);const s=document.getElementById("motion-toggle");s&&s.addEventListener("click",ar);const i=document.getElementById("menu-button");i&&i.addEventListener("click",jn);const l=document.getElementById("close-menu");l&&l.addEventListener("click",Ho);const r=document.getElementById("jump-to-top");r&&r.addEventListener("click",Oa);const a=document.getElementById("jump-to-bottom");a&&a.addEventListener("click",Aa);const c=document.getElementById("settings-menu-button");c&&c.addEventListener("click",$e);const g=document.getElementById("settings-back");g&&g.addEventListener("click",Pa);const f=document.getElementById("resolution-settings-button");f&&f.addEventListener("click",Da);const v=document.getElementById("resolution-back");v&&v.addEventListener("click",Sr);const w=document.getElementById("burst-settings-button");w&&w.addEventListener("click",ka);const P=document.getElementById("burst-back");P&&P.addEventListener("click",Na);const T=document.getElementById("timer-settings-button");T&&T.addEventListener("click",La);const C=document.getElementById("timer-settings-back");C&&C.addEventListener("click",Ma);const R=document.getElementById("master-prompt-settings-button");R&&R.addEventListener("click",Ai);const we=document.getElementById("master-prompt-back");we&&we.addEventListener("click",Ra);const oe=document.getElementById("aspect-ratio-settings-button");oe&&oe.addEventListener("click",qa);const j=document.getElementById("aspect-ratio-back");j&&j.addEventListener("click",_a);const K=document.getElementById("aspect-ratio-1-1"),de=document.getElementById("aspect-ratio-16-9");K&&K.addEventListener("change",d=>{d.target.checked?(ue="1:1",de&&(de.checked=!1)):ue="none",In(),Di()}),de&&de.addEventListener("change",d=>{d.target.checked?(ue="16:9",K&&(K.checked=!1)):ue="none",In(),Di()});const $=document.getElementById("motion-settings-button");$&&$.addEventListener("click",$l);const dt=document.getElementById("motion-back");dt&&dt.addEventListener("click",Vl);const dn=document.getElementById("visible-presets-settings-button");dn&&dn.addEventListener("click",Gl);const Vo=document.getElementById("visible-presets-back");Vo&&Vo.addEventListener("click",jl);const Go=document.getElementById("preset-builder-button");Go&&Go.addEventListener("click",cr);const jo=document.getElementById("preset-builder-back");jo&&jo.addEventListener("click",No);const Yo=document.getElementById("preset-builder-jump-up");Yo&&Yo.addEventListener("click",er);const zo=document.getElementById("preset-builder-jump-down");zo&&zo.addEventListener("click",tr);const Jo=document.getElementById("preset-builder-template");Jo&&Jo.addEventListener("change",zl);const Qo=document.getElementById("preset-builder-name");Qo&&Qo.addEventListener("keypress",d=>{var m;d.key==="Enter"&&(d.preventDefault(),(m=document.getElementById("preset-builder-category"))==null||m.focus())});const De=document.getElementById("preset-builder-category"),Ve=document.getElementById("category-autocomplete");if(De&&Ve){const d=()=>{const p=De.value,h=p.lastIndexOf(","),y=(h>=0?p.substring(h+1):p).trim().toUpperCase(),M=Jl(),x=y?M.filter(L=>L.includes(y)):M;x.length>0?(Ve.innerHTML=x.map(L=>`<div class="category-autocomplete-item" data-category="${L}">${L}</div>`).join(""),Ve.style.display="block"):Ve.style.display="none"},m=p=>{const h=De.value,y=h.lastIndexOf(",");y>=0?De.value=h.substring(0,y+1)+" "+p+", ":De.value=p+", ",Ve.style.display="none",De.focus()};De.addEventListener("input",d),De.addEventListener("focus",d),Ve.addEventListener("click",p=>{if(p.target.classList.contains("category-autocomplete-item")){const h=p.target.getAttribute("data-category");m(h)}}),document.addEventListener("click",p=>{!De.contains(p.target)&&!Ve.contains(p.target)&&(Ve.style.display="none")}),De.addEventListener("keypress",p=>{var h;p.key==="Enter"&&(p.preventDefault(),Ve.style.display="none",(h=document.getElementById("preset-builder-template"))==null||h.focus())})}const Wo=document.getElementById("preset-builder-save");Wo&&Wo.addEventListener("click",Ql);const Xo=document.getElementById("preset-builder-clear");Xo&&Xo.addEventListener("click",Fn);const Ko=document.getElementById("preset-builder-delete");Ko&&Ko.addEventListener("click",Wl),document.querySelectorAll(".chip-section-header").forEach(d=>{d.addEventListener("click",()=>{const m=d.getAttribute("data-section"),p=document.getElementById("section-"+m),h=p.style.display==="block";document.querySelectorAll(".chip-section-content").forEach(y=>{y.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(y=>{y.classList.remove("expanded")}),h||(p.style.display="block",d.classList.add("expanded"))})}),document.querySelectorAll(".preset-chip").forEach(d=>{d.addEventListener("click",m=>{const p=m.target.getAttribute("data-text"),h=document.getElementById("preset-builder-prompt"),y=h.value;y.trim()?h.value=y+" "+p:h.value=p,h.scrollTop=h.scrollHeight})});const Zo=document.getElementById("preset-builder-quality");Zo&&Zo.addEventListener("change",d=>{const m=d.target.value;if(m){const p=document.getElementById("preset-builder-prompt"),h=p.value;h.trim()?p.value=h+" "+m:p.value=m,d.target.value="",p.scrollTop=p.scrollHeight}});const mn=document.getElementById("visible-presets-filter");mn&&(mn.addEventListener("input",d=>{Zt=d.target.value,xt()}),mn.addEventListener("focus",()=>{po=!0;const d=document.getElementById("visible-presets-category-hint");d&&(d.style.display="none")}),mn.addEventListener("blur",()=>{po=!1}));const es=document.getElementById("visible-presets-select-all");es&&es.addEventListener("click",()=>{S=u.filter(m=>!m.internal).map(m=>m.name),he(),xt(),We(),F&&Pe()});const ts=document.getElementById("visible-presets-deselect-all");ts&&ts.addEventListener("click",()=>{S=[],he(),xt(),We(),F&&Pe()});const ns=document.getElementById("visible-presets-jump-up");ns&&ns.addEventListener("click",()=>{ge=0,tn()});const os=document.getElementById("visible-presets-jump-down");os&&os.addEventListener("click",()=>{const d=document.getElementById("visible-presets-list");if(d){const m=d.querySelectorAll(".style-item");m.length>0&&(ge=m.length-1,tn())}});let q=null,Ge=null,V=null,Ht=[],et=0,je=0,Ye=0,tt=!1;function wr(){const d=k[te];if(!d)return;document.getElementById("image-viewer").style.display="none",document.getElementById("image-editor-modal").style.display="flex",q=document.getElementById("editor-canvas"),Ge=q.getContext("2d",{willReadFrequently:!0});const m=new Image;m.onload=()=>{V=m,Ht=[],et=0,je=0,Ye=0,document.getElementById("brightness-slider").value=0,document.getElementById("contrast-slider").value=0,document.getElementById("brightness-value").textContent="0",document.getElementById("contrast-value").textContent="0",nt(),zn()},m.src=d.imageBase64}function nt(){!V||!q||(q.width=V.width,q.height=V.height,Ge.clearRect(0,0,q.width,q.height),Ge.drawImage(V,0,0),(je!==0||Ye!==0)&&xr())}function xr(){const d=Ge.getImageData(0,0,q.width,q.height),m=d.data,p=je,h=(Ye+100)/100;for(let y=0;y<m.length;y+=4)m[y]=((m[y]/255-.5)*h+.5)*255,m[y+1]=((m[y+1]/255-.5)*h+.5)*255,m[y+2]=((m[y+2]/255-.5)*h+.5)*255,m[y]+=p,m[y+1]+=p,m[y+2]+=p,m[y]=Math.max(0,Math.min(255,m[y])),m[y+1]=Math.max(0,Math.min(255,m[y+1])),m[y+2]=Math.max(0,Math.min(255,m[y+2]));Ge.putImageData(d,0,0)}function Cr(){un(),et=(et+90)%360;const d=document.createElement("canvas"),m=d.getContext("2d");et===90||et===270?(d.width=V.height,d.height=V.width):(d.width=V.width,d.height=V.height),m.translate(d.width/2,d.height/2),m.rotate(et*Math.PI/180),m.drawImage(V,-V.width/2,-V.height/2);const p=new Image;p.onload=()=>{V=p,nt()},p.src=d.toDataURL("image/jpeg",.95)}function Pr(){un();const d=Ge.getImageData(0,0,q.width,q.height),m=d.data,p=q.width,h=q.height,y=new Uint8ClampedArray(m),M=[0,-1,0,-1,5,-1,0,-1,0];for(let L=1;L<h-1;L++)for(let A=1;A<p-1;A++)for(let H=0;H<3;H++){let J=0;for(let G=-1;G<=1;G++)for(let Q=-1;Q<=1;Q++){const Ne=((L+G)*p+(A+Q))*4+H,mt=(G+1)*3+(Q+1);J+=m[Ne]*M[mt]}y[(L*p+A)*4+H]=Math.max(0,Math.min(255,J))}for(let L=0;L<m.length;L+=4)m[L]=y[L],m[L+1]=y[L+1],m[L+2]=y[L+2];Ge.putImageData(d,0,0);const x=new Image;x.onload=()=>{V=x,nt()},x.src=q.toDataURL("image/jpeg",.95)}function Lr(){un();const d=Ge.getImageData(0,0,q.width,q.height),m=d.data,p=1.15,h=1.2,y=5;for(let x=0;x<m.length;x+=4){let L=m[x],A=m[x+1],H=m[x+2];L=((L/255-.5)*p+.5)*255,A=((A/255-.5)*p+.5)*255,H=((H/255-.5)*p+.5)*255;const J=.2989*L+.587*A+.114*H;L=J+h*(L-J),A=J+h*(A-J),H=J+h*(H-J),L+=y,A+=y,H+=y,m[x]=Math.max(0,Math.min(255,L)),m[x+1]=Math.max(0,Math.min(255,A)),m[x+2]=Math.max(0,Math.min(255,H))}Ge.putImageData(d,0,0);const M=new Image;M.onload=()=>{V=M,nt()},M.src=q.toDataURL("image/jpeg",.95)}function Mr(){tt=!tt;const d=document.getElementById("crop-overlay"),m=document.getElementById("crop-button");if(tt){d.style.display="block",m.classList.add("active");const h=document.querySelector(".editor-image-container").getBoundingClientRect(),y=q.getBoundingClientRect(),M=document.querySelector(".crop-top-left"),x=document.querySelector(".crop-bottom-right");M.style.left=y.left-h.left+y.width*.1+"px",M.style.top=y.top-h.top+y.height*.1+"px",x.style.right=h.right-y.right+y.width*.1+"px",x.style.bottom=h.bottom-y.bottom+y.height*.1+"px"}else d.style.display="none",m.classList.remove("active")}function Or(){if(!tt)return;un(),document.querySelector(".editor-image-container").getBoundingClientRect();const m=q.getBoundingClientRect(),p=document.querySelector(".crop-top-left"),h=document.querySelector(".crop-bottom-right"),y=p.getBoundingClientRect(),M=h.getBoundingClientRect(),x=y.left-m.left,L=y.top-m.top,A=M.right-m.left,H=M.bottom-m.top,J=A-x,G=H-L;if(J<=0||G<=0){alert("Invalid crop area");return}const Q=V.width/m.width,Ne=V.height/m.height,mt=x*Q,Ut=L*Ne,eo=J*Q,to=G*Ne,yn=document.createElement("canvas");yn.width=eo,yn.height=to,yn.getContext("2d").drawImage(V,mt,Ut,eo,to,0,0,eo,to);const no=new Image;no.onload=()=>{V=no,tt=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active"),nt()},no.src=yn.toDataURL("image/jpeg",.95)}function un(){const d={image:V,rotation:et,brightness:je,contrast:Ye};Ht.push(d),zn()}function Ar(){if(Ht.length===0)return;const d=Ht.pop();V=d.image,et=d.rotation,je=d.brightness,Ye=d.contrast,document.getElementById("brightness-slider").value=je,document.getElementById("contrast-slider").value=Ye,document.getElementById("brightness-value").textContent=je,document.getElementById("contrast-value").textContent=Ye,nt(),zn()}function zn(){const d=document.getElementById("undo-edit-button");d.disabled=Ht.length===0}async function Dr(){const d=document.createElement("canvas");d.width=q.width,d.height=q.height,d.getContext("2d").drawImage(q,0,0);const p=d.toDataURL("image/jpeg",.9),h={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:p,timestamp:Date.now()};k.unshift(h),await Hn(h),te=0;const y=document.getElementById("viewer-image");y.src=p,y.style.transform="scale(1) translate(0, 0)",xe=1,ss(),await ce(),Jt("Edited image saved!","success",3e3)}function ss(){document.getElementById("image-editor-modal").style.display="none",document.getElementById("image-viewer").style.display="flex",tt=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active")}(li=document.getElementById("edit-viewer-image"))==null||li.addEventListener("click",wr),(ai=document.getElementById("close-image-editor"))==null||ai.addEventListener("click",ss),(ci=document.getElementById("rotate-button"))==null||ci.addEventListener("click",Cr),(di=document.getElementById("sharpen-button"))==null||di.addEventListener("click",Pr),(mi=document.getElementById("autocorrect-button"))==null||mi.addEventListener("click",Lr),(ui=document.getElementById("undo-edit-button"))==null||ui.addEventListener("click",Ar),(gi=document.getElementById("save-edit-button"))==null||gi.addEventListener("click",Dr),(fi=document.getElementById("crop-button"))==null||fi.addEventListener("click",()=>{tt?Or():Mr()}),(yi=document.getElementById("brightness-slider"))==null||yi.addEventListener("input",d=>{je=parseInt(d.target.value),document.getElementById("brightness-value").textContent=je,nt()}),(pi=document.getElementById("contrast-slider"))==null||pi.addEventListener("input",d=>{Ye=parseInt(d.target.value),document.getElementById("contrast-value").textContent=Ye,nt()});let ke=null;document.querySelectorAll(".crop-corner").forEach(d=>{d.addEventListener("touchstart",m=>{m.preventDefault(),ke=d})}),document.addEventListener("touchmove",d=>{if(!ke||!tt)return;d.preventDefault();const m=d.touches[0],h=document.querySelector(".editor-image-container").getBoundingClientRect(),y=q.getBoundingClientRect();let M=m.clientX-h.left,x=m.clientY-h.top;const L=y.left-h.left,A=y.top-h.top,H=y.right-h.left,J=y.bottom-h.top,G=ke.offsetWidth;if(ke.classList.contains("crop-top-left")){M=Math.max(L,Math.min(M,H-G)),x=Math.max(A,Math.min(x,J-G));const Ne=document.querySelector(".crop-bottom-right").getBoundingClientRect(),mt=Ne.right-h.left-G*2,Ut=Ne.bottom-h.top-G*2;M=Math.min(M,mt),x=Math.min(x,Ut),ke.style.left=M+"px",ke.style.top=x+"px"}else if(ke.classList.contains("crop-bottom-right")){M=Math.max(L+G,Math.min(M,H)),x=Math.max(A+G,Math.min(x,J));const Ne=document.querySelector(".crop-top-left").getBoundingClientRect(),mt=Ne.right-h.left+G,Ut=Ne.bottom-h.top+G;M=Math.max(M,mt),x=Math.max(x,Ut),ke.style.right=h.width-M+"px",ke.style.bottom=h.height-x+"px"}}),document.addEventListener("touchend",()=>{ke=null});const is=document.getElementById("motion-sensitivity-slider"),rs=document.getElementById("motion-sensitivity-value");if(is&&rs){const d=["Very Low","Low","Medium","High","Very High"];is.addEventListener("input",m=>{const p=parseInt(m.target.value);rs.textContent=d[p-1],Lt=50-p*10,En(),dr()})}const ls=document.getElementById("motion-continuous-enabled");ls&&ls.addEventListener("change",d=>{ht=d.target.checked,En()});const as=document.getElementById("motion-cooldown-slider"),cs=document.getElementById("motion-cooldown-value");as&&cs&&as.addEventListener("input",d=>{Mt=parseInt(d.target.value),cs.textContent=`${Mt}s`,En()});const ds=document.getElementById("motion-start-delay-slider"),ms=document.getElementById("motion-start-delay-value");ds&&ms&&ds.addEventListener("input",d=>{const m=parseInt(d.target.value);Ot=Qt[m].seconds,ms.textContent=Qt[m].label,En()});const us=document.getElementById("no-magic-toggle-button");us&&us.addEventListener("click",ta);const gs=document.getElementById("tutorial-button");gs&&gs.addEventListener("click",ia);const fs=document.getElementById("tutorial-back");fs&&fs.addEventListener("click",ra);const ys=document.getElementById("import-presets-button");ys&&ys.addEventListener("click",async()=>{try{const d=await ae.import();if(d.success){const m=new Set(u.map(y=>y.name));u=await Ln();const p=new Set(u.map(y=>y.name));S=S.filter(y=>p.has(y)),u.forEach(y=>{!m.has(y.name)&&!S.includes(y.name)&&S.push(y.name)}),he(),Pe(),We();const h=document.getElementById("styles-count");if(h){const y=u.filter(M=>S.includes(M.name)).length;h.textContent=y}alert(d.message)}else d.message!=="cancelled"&&d.message!=="No presets selected"&&alert("Import failed: "+d.message)}catch(d){alert("Import error: "+d.message)}}),document.querySelectorAll(".glossary-item").forEach(d=>{d.addEventListener("click",()=>{const m=d.getAttribute("data-section");la(m)})});const ps=document.getElementById("back-to-glossary");ps&&ps.addEventListener("click",gr);const hs=document.getElementById("master-prompt-enabled");hs&&hs.addEventListener("change",d=>{Te=d.target.checked;const m=document.getElementById("master-prompt-text");m&&(m.disabled=!Te),In();const p=document.getElementById("master-prompt-indicator");p&&(p.style.display=Te?"block":"none"),On()});const Es=document.getElementById("master-prompt-text");Es&&Es.addEventListener("input",d=>{Le=d.target.value;const m=document.getElementById("master-prompt-char-count");m&&(m.textContent=Le.length),In(),On()});const gn=document.getElementById("style-filter");let Jn=null;gn&&(gn.addEventListener("input",d=>{st=d.target.value,Jn&&clearTimeout(Jn),Jn=setTimeout(()=>{Pe()},150)}),gn.addEventListener("focus",()=>{yo=!0;const d=document.getElementById("menu-category-hint");d&&(d.style.display="none")}),gn.addEventListener("blur",()=>{yo=!1}));const Is=document.getElementById("burst-count-slider"),Qn=document.getElementById("burst-speed-slider");Is&&Is.addEventListener("input",d=>{W=parseInt(d.target.value),document.getElementById("burst-count-value").textContent=W;const m=parseInt(Qn.value);Li(W,m),Mn(),ve&&(B.textContent=O?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${W} photos) ‚Ä¢ ${u[E].name}`)}),Qn&&Qn.addEventListener("input",d=>{const m=parseInt(d.target.value);sn=Pt[m].delay,document.getElementById("burst-speed-value").textContent=Pt[m].label,Li(W,m),Mn()});const bs=document.getElementById("timer-delay-slider"),vs=document.getElementById("timer-delay-value");bs&&vs&&bs.addEventListener("input",d=>{const m=parseInt(d.target.value)-1;He=Ui[m],vs.textContent=He,co(),Yt()});const Bs=document.getElementById("timer-repeat-enabled");Bs&&Bs.addEventListener("change",d=>{It=d.target.checked,co(),Yt()});const Wn=document.getElementById("timer-repeat-interval-input"),Xn=document.getElementById("timer-repeat-interval-unit");if(Wn&&Xn){const d=()=>{const m=parseInt(Wn.value)||1,p=parseInt(Xn.value);Ie=m*p,co(),Yt()};Wn.addEventListener("input",d),Xn.addEventListener("change",d)}Ia(),ba(),ea(),na(),oa();const Ss=document.getElementById("reset-button");Ss&&Ss.addEventListener("click",Gn);const Ts=document.getElementById("camera-button");Ts&&Ts.addEventListener("click",Ea);const ws=document.getElementById("close-editor");ws&&ws.addEventListener("click",$o);const xs=document.getElementById("import-resolution-settings-button");xs&&xs.addEventListener("click",da);const Cs=document.getElementById("import-resolution-back");Cs&&Cs.addEventListener("click",fr);const Ps=document.getElementById("save-style");Ps&&Ps.addEventListener("click",za);const Ls=document.getElementById("delete-style");Ls&&Ls.addEventListener("click",Ja),St=document.getElementById("connection-status"),wt=document.getElementById("queue-status"),qe=document.getElementById("sync-button"),qe&&qe.addEventListener("click",nn),wt&&wt.addEventListener("click",_o);const Ms=document.getElementById("close-queue-manager");Ms&&Ms.addEventListener("click",Ta);const Os=document.getElementById("sync-all");Os&&Os.addEventListener("click",nn);const As=document.getElementById("clear-queue");As&&As.addEventListener("click",vr);const Ds=document.getElementById("gallery-button");Ds&&Ds.addEventListener("click",ce);const ks=document.getElementById("close-gallery");ks&&ks.addEventListener("click",Jr);const Ns=document.getElementById("gallery-import-button");Ns&&Ns.addEventListener("click",()=>{Za()});const Rs=document.getElementById("check-updates-button");Rs&&Rs.addEventListener("click",async()=>{try{const d=await fetch("./presets.json");if(!d.ok){alert("Could not load presets.json");return}const m=await d.json(),p=ae.getImportedPresets();if(p.length===0){alert('No presets imported yet. Use "Import Presets" first.');return}let h=0,y=0;const M=new Set(p.map(A=>A.name));if(m.forEach(A=>{if(M.has(A.name)){const H=p.find(J=>J.name===A.name);H&&H.message!==A.message&&h++}else y++}),h===0&&y===0){alert("‚úÖ All presets are up to date!");return}const x=[];if(h>0&&x.push(`${h} updated preset(s)`),y>0&&x.push(`${y} new preset(s)`),await confirm(`Found ${x.join(" and ")} available.

Would you like to import updates now?`)){const A=await ae.import();if(A.success){const H=new Set(u.map(Q=>Q.name));u=await Ln();const J=new Set(u.map(Q=>Q.name));S=S.filter(Q=>J.has(Q)),u.forEach(Q=>{!H.has(Q.name)&&!S.includes(Q.name)&&S.push(Q.name)}),he(),Pe(),We();const G=document.getElementById("updates-status");G&&(G.textContent="Check for Updates",G.style.color="",G.style.fontWeight=""),alert(A.message)}}}catch(d){alert("Error checking for updates: "+d.message)}});const qs=document.getElementById("close-qr-scanner");qs&&qs.addEventListener("click",()=>{zt()});const _s=document.getElementById("close-viewer");_s&&_s.addEventListener("click",Xr);const Hs=document.getElementById("delete-viewer-image");Hs&&Hs.addEventListener("click",Kr);const Us=document.getElementById("upload-viewer-image");Us&&Us.addEventListener("click",Wa);const Fs=document.getElementById("mp-viewer-button");Fs&&Fs.addEventListener("click",()=>{Lo=te,document.getElementById("image-viewer").style.display="none",document.getElementById("gallery-modal").style.display="none",Wt=!0,document.getElementById("unified-menu").style.display="flex",F=!0,document.getElementById("settings-submenu").style.display="flex",X=!0,Ai()});const $s=document.getElementById("qr-scan-button");$s&&$s.addEventListener("click",()=>{const d=document.getElementById("qr-scan-button"),m=document.getElementById("qr-scanner-video");d&&(d.disabled=!0),m&&m.paused&&m.play(),ee("Scanning...",""),Tr()});const Vs=document.getElementById("close-qr-modal");Vs&&Vs.addEventListener("click",Ka);const Gs=document.getElementById("gallery-start-date-btn"),Kn=document.getElementById("gallery-start-date");Gs&&Kn&&(Gs.addEventListener("click",()=>{Kn.showPicker()}),Kn.addEventListener("change",d=>{Gt=d.target.value||null,Si("start",Gt),lo()}));const js=document.getElementById("gallery-end-date-btn"),Zn=document.getElementById("gallery-end-date");js&&Zn&&(js.addEventListener("click",()=>{Zn.showPicker()}),Zn.addEventListener("change",d=>{jt=d.target.value||null,Si("end",jt),lo()}));const Ys=document.getElementById("gallery-sort-order");Ys&&Ys.addEventListener("change",d=>{Kt=d.target.value;try{localStorage.setItem(zi,Kt)}catch(m){console.error("Failed to save sort order:",m)}lo()});const zs=document.getElementById("prev-page");zs&&zs.addEventListener("click",Wr);const Js=document.getElementById("next-page");Js&&Js.addEventListener("click",Qr);const Qs=document.getElementById("load-preset-button");Qs&&Qs.addEventListener("click",Zr);const Ws=document.getElementById("multi-preset-button");Ws&&Ws.addEventListener("click",()=>{if(te>=0){const d=k[te].id;Pl(d)}});const Xs=document.getElementById("close-preset-selector");Xs&&Xs.addEventListener("click",Cn);const fn=document.getElementById("preset-filter");fn&&(fn.addEventListener("input",d=>{wn=d.target.value,an()}),fn.addEventListener("focus",()=>{ho=!0;const d=document.getElementById("preset-selector-category-hint");d&&(d.style.display="none");const m=document.getElementById("multi-preset-controls");m&&(m.style.display="none")}),fn.addEventListener("blur",()=>{if(ho=!1,vt){const d=document.getElementById("multi-preset-controls");d&&(d.style.display="flex")}}));const Ks=document.getElementById("preset-selector-jump-up");Ks&&Ks.addEventListener("click",()=>{ie=0,Et()});const Zs=document.getElementById("preset-selector-jump-down");Zs&&Zs.addEventListener("click",()=>{const d=document.getElementById("preset-list");if(d){const m=d.querySelectorAll(".preset-item");m.length>0&&(ie=m.length-1,Et())}});const ei=document.getElementById("magic-button");ei&&ei.addEventListener("click",Bl);const ti=document.getElementById("batch-mode-toggle");ti&&ti.addEventListener("click",Pn);const ni=document.getElementById("batch-select-all");ni&&ni.addEventListener("click",Sl);const oi=document.getElementById("batch-deselect-all");oi&&oi.addEventListener("click",Tl);const si=document.getElementById("batch-cancel");si&&si.addEventListener("click",Pn);const ii=document.getElementById("batch-apply-preset");ii&&ii.addEventListener("click",wl);const ri=document.getElementById("batch-delete");ri&&ri.addEventListener("click",Cl),qn().then(async()=>{localStorage.getItem("r1_gallery_index")?(console.log("Migrating old gallery data..."),await jr()):await _n()}).catch(d=>{console.error("Failed to initialize database:",d)}),Ml()});window.removeFromQueue=wa;window.previewQueueItem=xa;window.clearQueue=vr;async function Wa(){if(te<0)return;const e=document.getElementById("status"),t=document.getElementById("upload-viewer-image");try{t.disabled=!0,t.textContent="‚è≥",e&&(e.style.display="block",e.textContent="Getting server...");const n=await fetch("https://api.gofile.io/servers");if(!n.ok)throw new Error("Failed to get upload server");const o=await n.json();if(o.status!=="ok"||!o.data||!o.data.servers||o.data.servers.length===0)throw new Error("No upload servers available");const s=o.data.servers[0].name;e&&(e.textContent="Uploading image...");const l=k[te].imageBase64.split(",")[1],r=atob(l),a=new Array(r.length);for(let C=0;C<r.length;C++)a[C]=r.charCodeAt(C);const c=new Uint8Array(a),g=new Blob([c],{type:"image/png"}),f=new FormData;f.append("file",g,`magic-kamera-${Date.now()}.png`);const v=`https://${s}.gofile.io/uploadFile`,w=await fetch(v,{method:"POST",body:f});if(!w.ok)throw new Error("Upload failed - status: "+w.status);const P=await w.json();if(P.status!=="ok"||!P.data||!P.data.downloadPage)throw new Error("Upload failed: "+(P.status||"unknown error"));const T=P.data.downloadPage;e&&(e.textContent="Upload successful!",setTimeout(()=>{e.style.display="none"},2e3)),Xa(T.trim())}catch(n){console.error("Upload error:",n),e&&(e.textContent="Upload failed: "+n.message,setTimeout(()=>{e.style.display="none"},4e3))}finally{t.disabled=!1,t.textContent="üì§"}}function Xa(e){const t=document.getElementById("qr-modal"),n=document.getElementById("qr-code-container"),o=document.getElementById("qr-url-text");!t||!n||!o||(n.innerHTML="",new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),o.textContent=e,t.style.display="flex")}function Ka(){const e=document.getElementById("qr-modal");e&&(e.style.display="none")}function Za(){const e=document.getElementById("qr-scanner-modal"),t=document.getElementById("qr-scanner-video");if(!e||!t)return;e.style.display="flex",ec(),ee("Ready to scan","");const n=document.getElementById("qr-scan-button");n&&(n.disabled=!1)}function zt(){const e=document.getElementById("qr-scanner-modal");e&&(e.style.display="none"),Dn(),tc(),ee("Point camera at QR code...","")}async function ec(){const e=document.getElementById("qr-scanner-video");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=t,e.onloadedmetadata=()=>{e.pause(),ee("Ready to scan","")}}catch(t){console.error("Error starting QR scanner camera:",t),ee("Camera access denied","error")}}function tc(){const e=document.getElementById("qr-scanner-video");e&&e.srcObject&&(e.srcObject.getTracks().forEach(n=>n.stop()),e.srcObject=null)}function ee(e,t=""){const n=document.getElementById("qr-scanner-status");n&&(n.textContent=e,n.className="qr-scanner-status",t&&n.classList.add(t))}function Jt(e,t="info",n=3e3){const o=document.getElementById("gallery-status-message");o&&(o.textContent=e,o.className="gallery-status-message",t==="error"?o.classList.add("error"):t==="success"&&o.classList.add("success"),o.style.display="block",setTimeout(()=>{o.style.display="none"},n))}function Tr(){Eo||(Eo=!0,Bn=setInterval(nc,Gr))}function Dn(){Eo=!1,Bn&&(clearInterval(Bn),Bn=null)}function nc(){const e=document.getElementById("qr-scanner-video");if(!e||e.readyState!==e.HAVE_ENOUGH_DATA)return;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height),s=jsQR(o.data,o.width,o.height);s&&s.data?oc(s.data)?Tt!==s.data&&(Tt=s.data,ee("QR Code detected! Importing...","success"),Dn(),setTimeout(()=>{ic()},500)):(Dn(),zt(),Jt("Invalid QR code - must be a valid URL","error",4e3)):ee("Scanning...","")}function oc(e){try{const t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}async function sc(e,t=640,n=480,o=.85){return new Promise((s,i)=>{const l=new Image,r=URL.createObjectURL(e);l.onload=()=>{URL.revokeObjectURL(r);let a=l.width,c=l.height;if(a>t||c>n){const v=a/c;a>c?(a=t,c=a/v):(c=n,a=c*v)}const g=document.createElement("canvas");g.width=a,g.height=c,g.getContext("2d").drawImage(l,0,0,a,c),g.toBlob(v=>{v?s(v):i(new Error("Failed to compress image"))},"image/jpeg",o)},l.onerror=()=>{URL.revokeObjectURL(r),i(new Error("Failed to load image for resizing"))},l.src=r})}async function ic(){if(!Tt){zt(),Jt("No QR code detected","error",3e3);return}try{ee("Downloading image...","");const e=Tt.trim(),t=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/raw?url=",""];let n=null,o=null;for(let g=0;g<t.length;g++)try{const f=t[g]?t[g]+encodeURIComponent(e):e;ee(`Trying method ${g+1}/${t.length}...`,"");const v=new AbortController,w=setTimeout(()=>v.abort(),8e3);if(n=await fetch(f,{signal:v.signal}),clearTimeout(w),n.ok){ee("Download successful!","success");break}}catch(f){o=f;continue}if(!n||!n.ok)throw new Error("All download methods failed");ee("Reading image data...","");let s=await n.blob();const i=Math.round(s.size/1024);if(ee("Original size: "+i+"KB",""),s.type&&!s.type.startsWith("image/"))throw new Error("Not an image: "+s.type);ee("Optimizing image...","");const l=xo[Ct];s=await sc(s,l.width,l.height,.85);const r=Math.round(s.size/1024);ee("Compressed: "+i+"KB ‚Üí "+r+"KB",""),ee("Converting to base64...","");const a=await new Promise((g,f)=>{const v=setTimeout(()=>{f(new Error("Base64 conversion timeout"))},1e4),w=new FileReader;w.onloadend=()=>{clearTimeout(v),g(w.result)},w.onerror=()=>{clearTimeout(v),f(new Error("FileReader error"))},w.readAsDataURL(s)});ee("Saving to gallery...","");const c={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:a,timestamp:Date.now()};k.unshift(c),await Hn(c),ee("‚úÖ Import successful!","success"),Tt=null,zt(),await ce(),Jt("Image imported successfully!","success",3e3)}catch(e){Tt=null,zt(),Jt("Import failed: "+e.message,"error",4e3)}}document.getElementById("factory-reset-button").addEventListener("click",async()=>{await confirm(At?"This will delete ALL custom presets and undo ALL modifications, returning to your clean imported preset list. This cannot be undone. Continue?":"This will delete ALL custom presets and restore all presets to their original state. This cannot be undone. Continue?")&&(await Ee.clearAll(),u=await Ln(),u.length>0&&(S=u.map(n=>n.name),he()),renderMenuStyles(),alert(At?"All custom presets deleted and modifications cleared. Reset to imported presets!":"All custom presets deleted and modifications cleared!"))});document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".mode-carousel-track");e&&e.querySelectorAll(".mode-button").forEach(n=>{const o=n.getAttribute("data-mode");o==="random"?n.addEventListener("click",yr):o==="motion"?n.addEventListener("click",ar):o==="burst"?n.addEventListener("click",hr):o==="timer"&&n.addEventListener("click",Er)})});console.log("AI Camera Styles app initialized!");let wo=0;document.addEventListener("touchstart",e=>{wo=e.touches[0].clientX},{passive:!0});document.addEventListener("touchend",e=>{const t=e.changedTouches[0].clientX,n=wo-t,o=document.querySelector(".mode-carousel");if(!o)return;const s=30,i=window.innerWidth*.5;wo>i&&n>s&&o.classList.add("show"),n<-s&&o.classList.remove("show")},{passive:!0});
