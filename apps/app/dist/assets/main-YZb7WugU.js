(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const _l="CameraPresetsDB",Ul=1,se="presets";class Hl{constructor(){this.db=null}async init(){return new Promise((t,n)=>{const o=indexedDB.open(_l,Ul);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(se)||i.createObjectStore(se,{keyPath:"id"}).createIndex("type","type",{unique:!1})}})}async saveModification(t,n){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`modified_${t}`,type:"modification",name:t,data:n,timestamp:Date.now()})}async saveNewPreset(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`new_${t.name}`,type:"new",name:t.name,data:t,timestamp:Date.now()})}async saveDeletion(t){await this.db.transaction([se],"readwrite").objectStore(se).put({id:`deleted_${t}`,type:"deletion",name:t,timestamp:Date.now()})}async getAllModifications(){return new Promise((t,n)=>{const i=this.db.transaction([se],"readonly").objectStore(se).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async clearAll(){return new Promise((t,n)=>{const o=this.db.transaction([se],"readwrite"),i=o.objectStore(se).clear();i.onsuccess=()=>t(),i.onerror=()=>n(i.error),o.onerror=()=>n(o.error)})}async clearFactoryPresetModifications(){return new Promise((t,n)=>{const o=this.db.transaction([se],"readwrite"),s=o.objectStore(se),i=s.getAll();i.onsuccess=()=>{const r=i.result,l=[];for(const a of r)if(a.type==="modification"||a.type==="deletion"){const c=s.delete(a.id);l.push(new Promise((m,f)=>{c.onsuccess=()=>m(),c.onerror=()=>f(c.error)}))}Promise.all(l).then(()=>t()).catch(n)},i.onerror=()=>n(i.error),o.onerror=()=>n(o.error)})}async removeModification(t){const o=this.db.transaction([se],"readwrite").objectStore(se);await o.delete(`modified_${t}`),await o.delete(`deleted_${t}`)}}const Se=new Hl,Fl="ImportedPresetsDB",Vl=1,st="imported_presets";class Gl{constructor(){this.db=null,this.importedPresets=[],this.isImportModalOpen=!1,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates=new Map}async init(){return new Promise((t,n)=>{const o=indexedDB.open(Fl,Vl);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,t()},o.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(st)||i.createObjectStore(st,{keyPath:"id",autoIncrement:!0})}})}async loadImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([st],"readonly").objectStore(st).getAll();i.onsuccess=()=>{this.importedPresets=i.result.map(r=>r.preset),t(this.importedPresets)},i.onerror=()=>{console.error("Error loading imported presets:",i.error),t([])}})}async saveImportedPresets(t){return this.db||await this.init(),new Promise(async(n,o)=>{const i=this.db.transaction([st],"readwrite").objectStore(st),r=i.clear();r.onsuccess=()=>{const l=t.map(a=>new Promise((c,m)=>{const f=i.add({preset:a});f.onsuccess=()=>c(),f.onerror=()=>m(f.error)}));Promise.all(l).then(()=>{this.importedPresets=t,n()}).catch(o)},r.onerror=()=>o(r.error)})}async loadPresetsFromFile(){try{const t=await fetch("./presets.json");if(!t.ok)throw new Error("Failed to load presets.json");return(await t.json()).filter(s=>s.name&&s.message&&Array.isArray(s.category)).sort((s,i)=>s.name.localeCompare(i.name))}catch(t){throw console.error("Error loading presets.json:",t),new Error("Could not load presets.json file")}}getFilteredPresets(t){if(!this.importFilterText.trim())return t;const n=this.importFilterText.toLowerCase();return t.filter(o=>o.name.toLowerCase().includes(n))}async showPresetSelectionUI(t){return new Promise(n=>{this.isImportModalOpen=!0,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates.clear(),t.forEach(S=>{const C=this.importedPresets.some(R=>R.name===S.name);this.checkboxStates.set(S.name,C)});const o=document.createElement("div");o.className="styles-menu",o.style.display="flex",o.style.zIndex="10000",o.id="import-preset-modal";const s=document.createElement("div");s.className="styles-menu-content";const i=document.createElement("div");i.className="styles-menu-header",i.style.marginBottom="0",i.innerHTML=`
        <h2 style="font-size: 14px;">Import (<span id="import-preset-count">${t.length}</span>)</h2>
        <div class="menu-nav-buttons">
          <button id="import-jump-to-top" class="menu-jump-button" title="Jump to top">‚Üë</button>
          <button id="import-jump-to-bottom" class="menu-jump-button" title="Jump to bottom">‚Üì</button>
          <button id="close-import-modal" class="close-button">√ó</button>
        </div>
      `;const r=document.createElement("div");r.className="styles-menu-scroll-container",r.id="import-scroll-container",r.style.paddingTop="0",r.style.paddingBottom="22px";const l=document.createElement("div");l.className="menu-section",l.style.cssText="position: sticky; top: 0; background: #1a1a1a; z-index: 10; padding: 5px 0; margin: 0; border-bottom: 1px solid #333;",l.innerHTML=`
        <input type="text" id="import-preset-filter" class="style-filter" placeholder="Filter..." style="width: 100%; margin: 0; height: 24px; font-size: 12px;">
      `;const a=document.createElement("div");a.className="menu-section",a.id="import-presets-section",a.style.margin="0";const c=document.createElement("div");c.className="menu-list",c.id="import-presets-list";const m=()=>{const S=this.getFilteredPresets(t),C=document.getElementById("import-preset-count");C&&(C.textContent=S.length),c.innerHTML="",S.forEach((R,me)=>{const k=document.createElement("button");k.className="menu-item",k.dataset.presetIndex=me,k.dataset.presetName=R.name,k.style.cssText="display: flex; align-items: center; padding: 6px 15px; min-height: 30px; width: 100%; justify-content: flex-start; margin-bottom: 2px;";const D=document.createElement("input");D.type="checkbox",D.id=`import-preset-${me}`,D.checked=this.checkboxStates.get(R.name)||!1,D.style.cssText=`
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #4CAF50;
            flex-shrink: 0;
          `,D.onclick=j=>{j.stopPropagation(),this.checkboxStates.set(R.name,D.checked)};const q=document.createElement("span");q.className="menu-item-name",q.textContent=R.name,q.style.cssText="flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; color: #000; font-size: 12px; display: flex; align-items: center;";const ge=this.importedPresets.find(j=>j.name===R.name);if(ge){if(ge.message!==R.message){const j=document.createElement("span");j.className="preset-ticket preset-ticket-updated",j.textContent="UPDATED",q.appendChild(j)}}else{const j=document.createElement("span");j.className="preset-ticket preset-ticket-new",j.textContent="NEW",q.appendChild(j)}k.appendChild(D),k.appendChild(q),k.onclick=j=>{j.target!==D&&(D.checked=!D.checked,this.checkboxStates.set(R.name,D.checked))},c.appendChild(k)}),f()},f=()=>{const S=c.querySelectorAll(".menu-item");if(S.forEach(C=>C.classList.remove("menu-selected")),this.currentImportScrollIndex>=0&&this.currentImportScrollIndex<S.length){const C=S[this.currentImportScrollIndex];C.classList.add("menu-selected"),C.scrollIntoView({behavior:"smooth",block:"nearest"})}};a.appendChild(c);const y=document.createElement("div");y.style.cssText=`
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1a1a1a;
  z-index: 20;
  padding: 2px;
  border-top: 1px solid #333;
  display: flex;
  gap: 3px;
`,y.innerHTML=`
  <button id="select-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úì All
  </button>
  <button id="deselect-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    ‚úó None
  </button>
  <button id="confirm-import-presets" style="flex: 1; padding: 0; background: #4CAF50; color: white; border: none; border-radius: 2px; font-size: 10px; font-weight: bold; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Import
  </button>
  <button id="cancel-import-presets" style="flex: 1; padding: 0; background: #666; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">
    Cancel
  </button>
`,r.appendChild(l),r.appendChild(a),s.appendChild(i),s.appendChild(r),o.appendChild(s),o.appendChild(y),document.body.appendChild(o),m(),document.getElementById("import-preset-filter").addEventListener("input",S=>{this.importFilterText=S.target.value,this.currentImportScrollIndex=0,m()}),document.getElementById("select-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!0)}),m()},document.getElementById("deselect-all-presets").onclick=()=>{this.getFilteredPresets(t).forEach(C=>{this.checkboxStates.set(C.name,!1)}),m()};const B=()=>{this.isImportModalOpen=!1,document.body.removeChild(o)};document.getElementById("close-import-modal").onclick=()=>{B(),n(null)},document.getElementById("cancel-import-presets").onclick=()=>{B(),n(null)},document.getElementById("confirm-import-presets").onclick=()=>{const S=t.filter(C=>this.checkboxStates.get(C.name)===!0);B(),n(S)},document.getElementById("import-jump-to-top").onclick=()=>{r.scrollTop=0,this.currentImportScrollIndex=0,f()},document.getElementById("import-jump-to-bottom").onclick=()=>{r.scrollTop=r.scrollHeight;const S=c.querySelectorAll(".menu-item");this.currentImportScrollIndex=S.length-1,f()},this.scrollImportUp=()=>{c.querySelectorAll(".menu-item").length!==0&&(this.currentImportScrollIndex=Math.max(0,this.currentImportScrollIndex-1),f())},this.scrollImportDown=()=>{const S=c.querySelectorAll(".menu-item");S.length!==0&&(this.currentImportScrollIndex=Math.min(S.length-1,this.currentImportScrollIndex+1),f())},r.style.overflowY="auto"})}async import(){try{const t=await this.loadPresetsFromFile();if(t.length===0)return{success:!1,message:"No presets found in presets.json"};const n=await this.showPresetSelectionUI(t);if(n===null)return{success:!1,message:"cancelled"};if(n.length===0)return{success:!1,message:"No presets selected"};const o=new Map(this.importedPresets.map(a=>[a.name,a]));let s=0,i=0;n.forEach(a=>{o.has(a.name)?(o.set(a.name,a),s++):(o.set(a.name,a),i++)});const r=Array.from(o.values());await this.saveImportedPresets(r);let l="";return s>0&&i>0?l=`Updated ${s}, imported ${i} new. Total: ${r.length}`:s>0?l=`Updated ${s} preset(s). Total: ${r.length}`:l=`Imported ${i} new preset(s). Total: ${r.length}`,{success:!0,message:l,updated:s,new:i,total:r.length}}catch(t){return{success:!1,message:t.message}}}async deletePreset(t){const n=this.importedPresets.findIndex(o=>o.name===t);return n>=0?(this.importedPresets.splice(n,1),await this.saveImportedPresets(this.importedPresets),!0):!1}async clearImportedPresets(){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction([st],"readwrite").objectStore(st).clear();i.onsuccess=()=>{this.importedPresets=[],t()},i.onerror=()=>n(i.error)})}getImportedPresets(){return this.importedPresets}}const de=new Gl;let so=[],T,w,J,v,Tn,_=null,ee=null;function jl(e,t="info"){return new Promise(n=>{const o=document.getElementById("custom-alert-modal"),s=document.getElementById("custom-alert-message"),i=document.getElementById("custom-alert-buttons");s.textContent=e,i.innerHTML='<button class="custom-alert-btn custom-alert-btn-primary" id="custom-alert-ok">OK</button>',o.style.display="flex";const r=document.getElementById("custom-alert-ok"),l=()=>{o.style.display="none",r.removeEventListener("click",l),n()};r.addEventListener("click",l)})}function Yl(e,t={}){return new Promise(n=>{const o=document.getElementById("custom-alert-modal"),s=document.getElementById("custom-alert-message"),i=document.getElementById("custom-alert-buttons");s.textContent=e;const r=t.yesText||"Yes",l=t.noText||"No",a=t.danger?"custom-alert-btn-danger":"custom-alert-btn-primary";i.innerHTML=`
      <button class="custom-alert-btn custom-alert-btn-secondary" id="custom-confirm-no">${l}</button>
      <button class="custom-alert-btn ${a}" id="custom-confirm-yes">${r}</button>
    `,o.style.display="flex";const c=document.getElementById("custom-confirm-yes"),m=document.getElementById("custom-confirm-no"),f=()=>{o.style.display="none",c.removeEventListener("click",f),m.removeEventListener("click",y),n(!0)},y=()=>{o.style.display="none",c.removeEventListener("click",f),m.removeEventListener("click",y),n(!1)};c.addEventListener("click",f),m.addEventListener("click",y)})}window.alert=jl;window.confirm=Yl;const ln=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"SXGA+ (1400x1050)",width:1400,height:1050},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080},{name:"HD (3264x2448)",width:3264,height:2448}];let Ke=0;const $i="r1_camera_resolution",Co=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080}];let Lt=0;const _i="r1_import_resolution";let fe=0,H=[],io=!1,le=1,Gt=!1,bi=0,vi=1,ye=!1,K=5,rn=500,lo=!1;const Ot={1:{delay:800,label:"Slow"},2:{delay:500,label:"Medium"},3:{delay:300,label:"Fast"}},Ui="r1_camera_burst_settings",Hi="r1_camera_timer_settings",Fi="r1_camera_last_preset";let he=!1,Ze=null,Ue=10,Bt=!1,Vi=[3,5,10],Te=1;const Gi={1:{seconds:1,label:"1s"},2:{seconds:3,label:"3s"},3:{seconds:5,label:"5s"},4:{seconds:10,label:"10s"},5:{seconds:30,label:"30s"},6:{seconds:60,label:"1m"},7:{seconds:300,label:"5m"},8:{seconds:600,label:"10m"},9:{seconds:1800,label:"30m"},10:{seconds:3600,label:"1h"}};let Le="",xe=!1;const ji="r1_camera_master_prompt",Yi="r1_camera_master_prompt_enabled",zi="r1_camera_aspect_ratio";let pe="none";const Po="r1_camera_selection_history";let lt={};const Bi=5;let qe=!1,re=!1,vn=null,Je=null,At=30,Mo=.1,It=!0,Dt=2,hn=!1,kt=3;const Ji="r1_camera_motion_settings";let Yt=null;const Kt={1:{seconds:3,label:"3s"},2:{seconds:10,label:"10s"},3:{seconds:30,label:"30s"},4:{seconds:60,label:"1m"},5:{seconds:300,label:"5m"},6:{seconds:600,label:"10m"},7:{seconds:900,label:"15m"},8:{seconds:1800,label:"30m"}};let L=!1;const Qi="r1_camera_no_magic_mode";let ae=!1;const Wi="r1_camera_manual_options";let Zt=!1,Lo=-1,wt,ro,jt=null,ce=0,G=!1,He=!1,Fe=!1,ie=0,Oe=0,Ae=0,Z=!1,an=!1,Nn=!1,Rn=!1,en=!1,qn=!1,St=!1,$t=!1,be=-1,De=0;const zl="R1CameraGallery",Jl=1,dt="images";let Pe=null,$=[];const Xi="r1_gallery_sort_order";let ne=-1,Ce=1,En=!1,Si=0,Ti=1,we=1;const Bn=16;let zt=null,Jt=null,tn="newest",at=!1,V=new Set,Tt=!1,_e=[],wn=null,it="",xn="",po=0,ft="",Qe="",pt="",yo=!1,ho=!1,Eo=!1,Sn=null,Ct=null,Io=!1;const Ql=500,wi={transform:"Take a picture and transform the image into [DESCRIBE TRANSFORMATION]. [ADD SPECIFIC DETAILS ABOUT STYLE, APPEARANCE, COLORS, ETC.]",transform_subject:"Take a picture and transform the subject into [WHAT THE SUBJECT BECOMES]. Preserve the subject's recognizable facial structure and identity. [ADD DETAILS ABOUT NEW APPEARANCE, ENVIRONMENT, LIGHTING].",convert:"Take a picture and convert the scene into [DESCRIBE NEW FORMAT/MEDIUM]. [ADD DETAILS ABOUT MATERIALS, TEXTURES, SCALE].",style:"Take a picture in the style of [ARTISTIC STYLE/ARTIST]. [ADD DETAILS ABOUT TECHNIQUE, COLORS, COMPOSITION].",place:"Take a picture and place the subject in [DESCRIBE SCENE/LOCATION]. [ADD DETAILS ABOUT LIGHTING, ATMOSPHERE, INTEGRATION].",recreate:"Take a picture and recreate [FAMOUS WORK/SCENE]. Replace [DESCRIBE WHAT TO REPLACE]. Preserve the iconic [DESCRIBE KEY ELEMENTS TO KEEP].",render:"Take a picture and render it as [FORMAT/MEDIUM]. [ADD DETAILS ABOUT APPEARANCE, TEXTURE, TECHNICAL SPECIFICS].",make:"Take a picture and make the subject into [CHARACTER/CREATURE]. [ADD DETAILS ABOUT APPEARANCE, TRAITS, SETTING]. Make it photorealistic.",analyze:"Analyze the image and [DESCRIBE WHAT TO ANALYZE/EXTRACT]. [ADD DETAILS ABOUT OUTPUT FORMAT] and email it to me.",random_even_odd:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If the RANDOM SEED ends in an EVEN number (0,2,4,6,8): SELECT Option A
- If the RANDOM SEED ends in an ODD number (1,3,5,7,9): SELECT Option B

If Option A:
[DESCRIBE WHAT HAPPENS IN OPTION A - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]

If Option B:
[DESCRIBE WHAT HAPPENS IN OPTION B - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO BOTH OPTIONS - LIGHTING, QUALITY, PRESERVATION, ETC.]`,random_last_digit:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST DIGIT modulo [NUMBER 2-10]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  - 5: [OPTION 6 DESCRIPTION]
  - 6: [OPTION 7 DESCRIPTION]
  - 7: [OPTION 8 DESCRIPTION]
  - 8: [OPTION 9 DESCRIPTION]
  - 9: [OPTION 10 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS - STYLE, QUALITY, TECHNICAL DETAILS, ETC.]

IMPORTANT:
- Replace [NUMBER 2-10] with the actual number of options you have (between 2 and 10)
- Remove any unused option lines (e.g., if you only have 5 options, remove lines 5-9)
- Each option should be a distinct visual variation or transformation
- For exactly 10 options, use LAST DIGIT modulo 10 (covers digits 0-9)`,random_last_two:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST TWO DIGITS modulo [NUMBER 11-99]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  - 5: [OPTION 6 DESCRIPTION]
  - 6: [OPTION 7 DESCRIPTION]
  - 7: [OPTION 8 DESCRIPTION]
  - 8: [OPTION 9 DESCRIPTION]
  - 9: [OPTION 10 DESCRIPTION]
  - 10: [OPTION 11 DESCRIPTION]
  - 11: [OPTION 12 DESCRIPTION]
  - 12: [OPTION 13 DESCRIPTION]
  - 13: [OPTION 14 DESCRIPTION]
  - 14: [OPTION 15 DESCRIPTION]
  - 15: [OPTION 16 DESCRIPTION]
  - 16: [OPTION 17 DESCRIPTION]
  - 17: [OPTION 18 DESCRIPTION]
  - 18: [OPTION 19 DESCRIPTION]
  - 19: [OPTION 20 DESCRIPTION]
  - 20: [OPTION 21 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]

IMPORTANT:
- Replace [NUMBER 11-99] with the actual number of options (between 11 and 99)
- Add or remove option lines to match your number of options
- Use LAST TWO DIGITS only when you have MORE than 10 options
- Ensure the colon (:) comes immediately after the modulo number
- Use exactly 2 spaces before each dash (-)
- Keep all options in one continuous list with no blank lines`,random_last_three:`Take a picture and transform [DESCRIBE BASE TRANSFORMATION].

SELECTION (CRITICAL):
- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT
- If none is specified, SELECT EXACTLY ONE using LAST THREE DIGITS modulo [NUMBER 100+]:
  - 0: [OPTION 1 DESCRIPTION]
  - 1: [OPTION 2 DESCRIPTION]
  - 2: [OPTION 3 DESCRIPTION]
  - 3: [OPTION 4 DESCRIPTION]
  - 4: [OPTION 5 DESCRIPTION]
  (continue numbering for all your options)
  - 98: [OPTION 99 DESCRIPTION]
  - 99: [OPTION 100 DESCRIPTION]
  - 100: [OPTION 101 DESCRIPTION]

[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]

IMPORTANT:
- Replace [NUMBER 100+] with the actual number of options (101 or more)
- Add option lines for every option you want to include
- Use LAST THREE DIGITS only when you have 101 or more options
- Ensure the colon (:) comes immediately after the modulo number
- Use exactly 2 spaces before each dash (-)
- Keep all options in one continuous list with no blank lines
- This format is ideal for large preset collections like 120 Star Trek species or 150 character types`,custom:""};let g=[],yt=[],Nt=!1,I=0,Ie=-1,ve=navigator.onLine,O=[],ct=!1,rt=null,Cn=0;const Ki=500,Zi="r1_camera_queue";let xt,Pt,$e;const bo="r1_camera_styles";let We=[];const el="r1_camera_favorites",tl="r1_camera_visible_presets";let x=[],et=!1,Ee=0,nn="",cn=!0;function oe(e){jt&&(clearTimeout(jt),jt=null),wt||(wt=document.getElementById("style-reveal"),ro=document.getElementById("style-reveal-text")),!(!wt||!ro)&&(ro.textContent=L?"‚ö° NO MAGIC MODE":e,wt.style.display="block",jt=setTimeout(()=>{wt&&(wt.style.display="none"),jt=null},1200))}function $n(){return new Promise((e,t)=>{const n=indexedDB.open(zl,Jl);n.onerror=()=>{console.error("Failed to open IndexedDB:",n.error),t(n.error)},n.onsuccess=()=>{Pe=n.result,console.log("IndexedDB opened successfully"),e(Pe)},n.onupgradeneeded=o=>{Pe=o.target.result,Pe.objectStoreNames.contains(dt)||(Pe.createObjectStore(dt,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Object store created"))}})}async function Wl(){try{const e=localStorage.getItem("r1_gallery_index");if(!e){console.log("No old gallery data to migrate");return}const t=JSON.parse(e);let n=0;for(const o of t){const s="r1_gallery_"+o,i=localStorage.getItem(s);if(i){const r=JSON.parse(i);for(const l of r)await Un(l),n++;localStorage.removeItem(s)}}localStorage.removeItem("r1_gallery_index"),console.log(`Migration complete: ${n} images migrated to IndexedDB`),await _n()}catch(e){console.error("Migration failed:",e)}}async function _n(){try{Pe||await $n(),$=[];const n=Pe.transaction([dt],"readonly").objectStore(dt).getAll();return new Promise((o,s)=>{n.onsuccess=()=>{$=n.result||[];const i=localStorage.getItem(Xi);i&&(tn=i),$.sort((r,l)=>l.timestamp-r.timestamp),console.log(`Gallery loaded: ${$.length} images`),o()},n.onerror=()=>{console.error("Failed to load gallery:",n.error),$=[],s(n.error)}})}catch(e){console.error("Error loading gallery:",e),$=[]}}async function Un(e){try{Pe||await $n();const o=Pe.transaction([dt],"readwrite").objectStore(dt).add(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image saved to IndexedDB"),s()},o.onerror=()=>{console.error("Failed to save image:",o.error),i(o.error)}})}catch(t){console.error("Error saving image:",t)}}async function nl(e){try{Pe||await $n();const o=Pe.transaction([dt],"readwrite").objectStore(dt).delete(e);return new Promise((s,i)=>{o.onsuccess=()=>{console.log("Image deleted from IndexedDB"),s()},o.onerror=()=>{console.error("Failed to delete image:",o.error),i(o.error)}})}catch(t){console.error("Error deleting image:",t)}}async function ol(e){const t={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:e,timestamp:Date.now()};$.unshift(t),await Un(t),console.log(`Image added. Total: ${$.length}`)}function Xl(e){return!zt&&!Jt?e:e.filter(t=>{const n=new Date(t.timestamp);n.setHours(0,0,0,0);const o=n.getTime();let s=!0,i=!0;if(zt){const r=new Date(zt).getTime();s=o>=r}if(Jt){const r=new Date(Jt).getTime();i=o<=r}return s&&i})}function Kl(e){const t=[...e];return tn==="newest"?t.sort((n,o)=>o.timestamp-n.timestamp):t.sort((n,o)=>n.timestamp-o.timestamp),t}function Oo(){let e=Xl($);return Kl(e)}async function ue(){ut(),Sl(),J&&J.style.display==="block"&&jn(),await _n();const e=document.getElementById("gallery-modal"),t=document.getElementById("gallery-grid"),n=document.getElementById("gallery-pagination"),o=document.getElementById("page-info"),s=document.getElementById("prev-page"),i=document.getElementById("next-page"),r=document.getElementById("gallery-count");r&&(r.textContent=$.length);const l=document.getElementById("gallery-sort-order");l&&(l.value=tn);const a=Oo();if(a.length===0)t.innerHTML='<div class="gallery-empty">No photos match the selected filter.</div>',n.style.display="none";else{const c=Math.ceil(a.length/Bn);we=Math.min(we,c);const m=(we-1)*Bn,f=Math.min(m+Bn,a.length),y=a.slice(m,f),b=document.createDocumentFragment();y.forEach(B=>{const S=document.createElement("div");if(S.className="gallery-item",at&&V.has(B.id)&&S.classList.add("selected"),at){const R=document.createElement("input");R.type="checkbox",R.className="gallery-item-checkbox",R.checked=V.has(B.id),R.addEventListener("click",me=>{me.stopPropagation(),Mi(B.id)}),S.appendChild(R)}const C=document.createElement("img");C.src=B.imageBase64,C.alt="Gallery image",C.loading="lazy",S.appendChild(C),S.onclick=()=>{if(at)Mi(B.id),ue();else{const R=$.findIndex(me=>me.id===B.id);Ao(R)}},b.appendChild(S)}),t.innerHTML="",t.appendChild(b),c>1?(n.style.display="flex",o.textContent=`Page ${we} of ${c}`,s.disabled=we===1,i.disabled=we===c):n.style.display="none"}e.style.display="flex"}async function Zl(){if(document.getElementById("gallery-modal").style.display="none",we=1,await Tl(),v&&(v.style.display="block"),L)v&&(v.textContent="‚ö° NO MAGIC MODE"),oe("‚ö° NO MAGIC MODE");else if(he||ye||re||qe||Tt){let e="";he?e="‚è±Ô∏è Timer Mode":ye?e="üì∏ Burst Mode":re?e="üëÅÔ∏è Motion Detection":qe&&(e="üé≤ Random Mode"),v&&(v.textContent=`${e} ‚Ä¢ ${g[I]?g[I].name:""}`),oe(e)}else Q()}function er(){const e=Oo(),t=Math.ceil(e.length/Bn);we<t&&(we++,ue())}function tr(){we>1&&(we--,ue())}function ao(){we=1,ue()}function xi(e,t){const n=e==="start"?"gallery-start-date-btn":"gallery-end-date-btn",o=document.getElementById(n);if(!o)return;const s=o.querySelector(".date-button-text");if(s)if(t){const r=new Date(t+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.textContent=r,o.classList.add("has-date")}else s.textContent=e==="start"?"Start":"End",o.classList.remove("has-date")}function Ao(e){if(e<0||e>=$.length)return;ne=e;const t=$[e],n=document.getElementById("image-viewer"),o=document.getElementById("viewer-image"),s=document.getElementById("viewer-prompt");o.src=t.imageBase64,o.style.transform="scale(1) translate(0, 0)",Ce=1,s.value="";const i=document.getElementById("mp-viewer-button");i&&(xe?i.classList.add("enabled"):i.classList.remove("enabled")),n.style.display="flex",document.getElementById("gallery-modal").style.display="none"}function nr(){document.getElementById("image-viewer").style.display="none",ne=-1,Ce=1;const e=document.getElementById("gallery-modal");e.style.display="flex",ue()}async function or(){if(!(ne<0||ne>=$.length)&&await confirm("Delete this image from gallery?")){const e=$[ne];await nl(e.id),$.splice(ne,1),document.getElementById("image-viewer").style.display="none",ne=-1,Ce=1,ue()}}function sr(){const e=document.getElementById("preset-selector");Tt=!1,_e=[];const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none");const n=e.querySelector(".preset-selector-header h3");n&&(n.innerHTML='Select Preset (<span id="preset-count">0</span>)'),dn();const o=document.getElementById("preset-count");o&&(o.textContent=g.length),e.style.display="flex",Fe=!0,ie=0,bt(),setTimeout(()=>{const s=document.getElementById("preset-list");s&&po>0&&(s.scrollTop=po)},50)}function Pn(){const e=document.getElementById("preset-list");e&&(po=e.scrollTop),document.getElementById("preset-selector").style.display="none",xn="",pt="",document.getElementById("preset-filter").value="",Fe=!1,ie=0;const t=document.getElementById("preset-selector-category-hint");t&&(t.style.display="none"),Tt=!1}function ir(){if(!Fe)return;const e=document.getElementById("preset-list");!e||e.querySelectorAll(".preset-item").length===0||(ie=Math.max(0,ie-1),bt())}function lr(){if(!Fe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");t.length!==0&&(ie=Math.min(t.length-1,ie+1),bt())}function bt(){const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("preset-selected")}),ie>=0&&ie<t.length)){const n=t[ie];n.classList.add("preset-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.querySelector(".preset-name").textContent,s=g.find(r=>r.name===o),i=document.getElementById("preset-selector-category-hint");i&&s&&s.category&&!Eo?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const a=document.createElement("span");if(a.textContent=r,a.style.cursor="pointer",a.style.padding="0 2px",pt===r&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),pt===r?pt="":pt=r,ie=0,dn()},i.appendChild(a),l<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function rr(){if(!Z)return;const e=document.getElementById("settings-submenu");!e||e.querySelectorAll(".menu-section-button").length===0||(Oe=Math.max(0,Oe-1),Do())}function ar(){if(!Z)return;const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");t.length!==0&&(Oe=Math.min(t.length-1,Oe+1),Do())}function Do(){const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),Oe>=0&&Oe<t.length)){const n=t[Oe];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function cr(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Ae=(Ae-1+t.length)%t.length,ko(t))}function dr(){const e=document.getElementById("resolution-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelectorAll(".resolution-item");t.length!==0&&(Ae=(Ae+1)%t.length,ko(t))}function ko(e){if(e.forEach(t=>t.classList.remove("menu-selected")),Ae>=0&&Ae<e.length){const t=e[Ae];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}}function ur(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function mr(){const e=document.getElementById("burst-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function gr(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function fr(){const e=document.getElementById("timer-settings-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function pr(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function yr(){const e=document.getElementById("master-prompt-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function hr(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Er(){const e=document.getElementById("motion-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function sl(){if(!$t)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function il(){if(!$t)return;const e=document.getElementById("preset-builder-submenu");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Ir(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function br(){const e=document.getElementById("gallery-modal");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function vr(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Br(){const e=document.getElementById("image-viewer");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function Ci(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.max(0,t.scrollTop-100):n&&(n.scrollTop=Math.max(0,n.scrollTop-200))}function Pi(){const e=document.getElementById("style-editor");if(!e||e.style.display!=="flex")return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+100):n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+200))}function Sr(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function Tr(){const e=document.getElementById("queue-manager");if(!e||e.style.display!=="flex")return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function wr(){if(!Fe)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(t.length===0||ie>=t.length)return;const n=t[ie];n&&n.click()}function dn(){const e=document.getElementById("preset-list");e.innerHTML="";const n=Hr().filter(l=>{if(xn){const a=xn.toLowerCase(),c=l.category&&l.category.some(f=>f.toLowerCase().includes(a));if(!(l.name.toLowerCase().includes(a)||l.message.toLowerCase().includes(a)||c))return!1}return pt?l.category&&l.category.includes(pt):!0}).sort((l,a)=>l.name.localeCompare(a.name)),o=n.filter(l=>Rt(l.name)),s=n.filter(l=>!Rt(l.name)),i=[...o,...s];if(i.length===0){e.innerHTML='<div class="preset-empty">No presets found</div>';return}i.forEach(l=>{const a=document.createElement("div");a.className="preset-item";const c=document.createElement("div");c.className="preset-name",c.textContent=l.name;const m=document.createElement("div");m.className="preset-description preset-description-hidden",m.textContent=l.message,a.appendChild(c),a.appendChild(m),a.onclick=()=>{m.classList.contains("preset-description-hidden")?m.classList.remove("preset-description-hidden"):xr(l)},e.appendChild(a)});const r=document.getElementById("preset-count");r&&(r.textContent=i.length)}async function xr(e){if(Tt){const n=_e.findIndex(o=>o.name===e.name);n>-1?_e.splice(n,1):_e.push(e),ll();return}if(window.batchProcessingActive){window.batchProcessingActive=!1;const n=window.batchImagesToProcess;window.batchImagesToProcess=null,Pn();const s=document.getElementById("preset-selector").querySelector(".preset-selector-header h3");s.textContent="Select Preset",await Or(e,n);return}const t=document.getElementById("viewer-prompt");t.value=e.message,Pn()}async function Cr(){if(ne<0||ne>=$.length){alert("No image selected");return}let t=document.getElementById("viewer-prompt").value.trim(),n="Custom Prompt",o=null,s=null;if(t&&(o=g.find(r=>r.message===t),o&&(n=o.name)),!t){const r=No(),l=g[r];o=l,t=l.message,n=l.name,alert(`Using random preset: ${n}`)}if(ae&&!L&&o){const r=Pl(o.message);if(r.length>0){const l=await pl(o,r);if(l===null)return;s=l}}const i=$[ne];typeof PluginMessageHandler<"u"?(PluginMessageHandler.postMessage(JSON.stringify({message:zn(t,n,s),pluginId:"com.r1.pixelart",imageBase64:i.imageBase64})),alert("Magic transform submitted! You can submit again with a different prompt.")):alert("Magic transform sent: "+t.substring(0,50)+"...")}function Mn(){at=!at;const e=document.getElementById("batch-mode-toggle"),t=document.getElementById("batch-controls"),n=document.getElementById("batch-action-bar");at?(e.textContent="Done",e.classList.add("active"),t.style.display="flex",n.style.display="flex",V.clear(),Hn(),ue()):(e.textContent="Select",e.classList.remove("active"),t.style.display="none",n.style.display="none",V.clear(),ue())}function Hn(){const e=document.getElementById("batch-selected-count"),t=document.getElementById("batch-apply-preset"),n=document.getElementById("batch-delete");e.textContent=`${V.size} selected`,t.disabled=V.size===0,n&&(n.disabled=V.size===0)}function Pr(){const e=Oo();V.clear(),e.forEach(t=>V.add(t.id)),Hn(),ue()}function Mr(){V.clear(),Hn(),ue()}function Mi(e){V.has(e)?V.delete(e):V.add(e),Hn()}async function Lr(){if(V.size===0)return;const e=document.getElementById("preset-selector"),t=e.querySelector(".preset-selector-header h3");t.textContent=`Select Preset (${V.size} images)`;const n=Array.from(V);window.batchProcessingActive=!0,window.batchImagesToProcess=n,dn(),e.style.display="flex",Fe=!0,ie=0,bt()}async function Or(e,t){const n=t||Array.from(V),o=n.length,s=document.createElement("div");s.className="batch-progress-overlay",s.innerHTML=`
    <div class="batch-progress-text">Processing <span id="batch-current">0</span> / ${o}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(s);let i=0;for(const r of n){const l=$.find(a=>a.id===r);if(l)try{const a=zn(e.message,e.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:a,pluginId:"com.r1.pixelart",imageBase64:l.imageBase64})),i++,document.getElementById("batch-current").textContent=i,document.getElementById("batch-progress-fill").style.width=`${i/o*100}%`,await new Promise(c=>setTimeout(c,3e3))}catch(a){console.error(`Failed to process image ${r}:`,a)}}document.body.removeChild(s),at=!1,V.clear(),Mn(),alert(`Batch processing complete! ${i} of ${o} images submitted.`)}async function Ar(){if(V.size===0)return;const e=V.size;if(!await confirm(`Are you sure you want to delete ${e} selected image${e>1?"s":""}? This cannot be undone.`))return;const n=Array.from(V),o=document.createElement("div");o.className="batch-progress-overlay",o.innerHTML=`
    <div class="batch-progress-text">Deleting <span id="batch-current">0</span> / ${e}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(o);let s=0;for(const i of n)try{await nl(i),s++,document.getElementById("batch-current").textContent=s,document.getElementById("batch-progress-fill").style.width=`${s/e*100}%`}catch(r){console.error(`Failed to delete image ${i}:`,r)}document.body.removeChild(o),at=!1,V.clear(),await _n(),Mn(),alert(`${s} of ${e} image${s>1?"s":""} deleted successfully.`)}function Dr(e){wn=e,_e=[],Tt=!0;const t=document.getElementById("preset-selector"),n=t.querySelector(".preset-selector-header h3");n.innerHTML='Select Presets <span id="multi-preset-count" style="font-size: 12px; color: #666;">(0 selected)</span>';let o=document.getElementById("multi-preset-controls");if(!o){o=document.createElement("div"),o.id="multi-preset-controls",o.style.cssText="padding: 0 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; gap: 8px; justify-content: space-between; align-items: stretch;",o.innerHTML=`
      <button id="multi-preset-apply" class="batch-control-button" style="background: #4CAF50; color: white;">Apply Selected</button>
      <button id="multi-preset-cancel" class="batch-control-button">Cancel</button>
    `;const s=document.getElementById("preset-filter"),i=document.getElementById("preset-list");s.parentNode.insertBefore(o,s),s.parentNode.insertBefore(s,i)}o.style.display="flex",dn(),ll(),t.style.display="flex",Fe=!0,ie=0,bt(),document.getElementById("multi-preset-apply").onclick=kr,document.getElementById("multi-preset-cancel").onclick=rl}function ll(){document.getElementById("preset-list").querySelectorAll(".preset-item").forEach(o=>{const s=o.querySelector(".preset-name").textContent;_e.some(r=>r.name===s)?(o.style.background="#e8f5e9",o.style.border="2px solid #4CAF50"):(o.style.background="",o.style.border="")});const n=document.getElementById("multi-preset-count");n&&(n.textContent=`(${_e.length} selected)`)}function rl(){Tt=!1,wn=null,_e=[];const e=document.getElementById("multi-preset-controls");e&&(e.style.display="none");const t=document.querySelector(".preset-selector-header h3");t.textContent="Select Preset",Pn()}async function kr(){if(_e.length===0){alert("Please select at least one preset");return}if(!wn){alert("No image selected");return}const e=$.find(s=>s.id===wn);if(!e){alert("Image not found");return}const t=[..._e];rl();const n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`
    <div class="batch-progress-text">Applying preset <span id="batch-current">0</span> / ${t.length}</div>
    <div class="batch-progress-bar">
      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>
    </div>
  `,document.body.appendChild(n);let o=0;for(const s of t)try{const i=zn(s.message,s.name);typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({message:i,pluginId:"com.r1.pixelart",imageBase64:e.imageBase64})),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=`${o/t.length*100}%`,await new Promise(r=>setTimeout(r,3e3))}catch(i){console.error(`Failed to apply preset ${s.name}:`,i)}document.body.removeChild(n),alert(`${o} preset${o>1?"s":""} applied successfully!`)}function Nr(){const e=document.getElementById("viewer-image"),t=document.querySelector(".image-viewer-container");let n=0,o=0,s=0,i=0,r=!1;t.addEventListener("touchstart",l=>{l.touches.length===2?(l.preventDefault(),En=!0,Si=Li(l.touches[0],l.touches[1]),Ti=Ce):l.touches.length===1&&Ce>1&&(r=!0,s=l.touches[0].clientX-n,i=l.touches[0].clientY-o)},{passive:!1}),t.addEventListener("touchmove",l=>{if(En&&l.touches.length===2){l.preventDefault();const c=Li(l.touches[0],l.touches[1])/Si;Ce=Math.max(1,Math.min(Ti*c,5)),e.style.transform=`scale(${Ce}) translate(${n}px, ${o}px)`}else r&&l.touches.length===1&&Ce>1&&(l.preventDefault(),n=l.touches[0].clientX-s,o=l.touches[0].clientY-i,e.style.transform=`scale(${Ce}) translate(${n}px, ${o}px)`)},{passive:!1}),t.addEventListener("touchend",l=>{l.touches.length<2&&(En=!1),l.touches.length===0&&(r=!1,Ce===1&&(n=0,o=0,e.style.transform="scale(1) translate(0, 0)"))}),t.addEventListener("touchcancel",()=>{En=!1,r=!1})}function Li(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function _t(){if(!G)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),ce=Math.max(0,Math.min(ce,t.length-1));const n=t[ce];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=parseInt(n.dataset.index),s=g[o],i=document.getElementById("menu-category-hint");i&&s&&s.category&&!yo?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const a=document.createElement("span");if(a.textContent=r,a.style.cursor="pointer",a.style.padding="0 2px",Qe===r&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),Qe===r?Qe="":Qe=r,ce=0,Me()},i.appendChild(a),l<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function Rr(){if(!G||!He)return;const e=document.getElementById("menu-styles-list");!e||e.querySelectorAll(".style-item").length===0||(ce=Math.max(0,ce-1),_t())}function qr(){if(!G||!He)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(ce=Math.min(t.length-1,ce+1),_t())}function $r(){if(!G||!He)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||ce>=t.length)return;const n=t[ce];if(n&&n.querySelector(".style-name")){const i=Ut()[ce];if(i){const r=g.findIndex(l=>l===i);r!==-1&&(I=r,Q(),Ho())}}}async function _r(){await Se.init(),await de.init();const t=(await de.loadImportedPresets()).length>0,o=(await Se.getAllModifications()).length>0;t||o?g=await Ln():(g=[],setTimeout(async()=>{await confirm("Welcome! You should import presets to get started. Would you like to import now?")&&(document.getElementById("menu-button").click(),setTimeout(()=>{document.getElementById("settings-menu-button").click(),setTimeout(()=>{document.getElementById("import-presets-button").click()},100)},100))},500));const s=localStorage.getItem(bo);if(s)try{const m=JSON.parse(s).filter(f=>f.internal===!1);for(const f of m)await Se.saveNewPreset(f),g.find(y=>y.name===f.name)||g.push(f);localStorage.removeItem(bo)}catch(c){console.error("Error loading styles:",c)}const i=localStorage.getItem(el);if(i)try{We=JSON.parse(i),Array.isArray(We)||(We=[])}catch(c){console.error("Error parsing favorite styles:",c),We=[]}jr(),Vr();const r=localStorage.getItem(tl);if(r)try{x=JSON.parse(r),Array.isArray(x)||(x=[])}catch{console.error("Error parsing visible presets:",error),x=[]}const l=new Set(g.map(c=>c.name)),a=x.length;x=x.filter(c=>l.has(c)),a!==x.length&&Be(),x.length===0&&g.length>0&&(x=g.map(c=>c.name),Be()),Xe(),setTimeout(()=>{Ur()},1e3)}async function Ur(){try{const e=await fetch("./presets.json");if(!e.ok)return;const t=await e.json(),n=de.getImportedPresets();if(n.length===0)return;let o=!1;const s=new Set(n.map(i=>i.name));for(const i of t){const r=n.find(l=>l.name===i.name);if(!r||r.message!==i.message){o=!0;break}}if(o){const i=document.getElementById("updates-status");i&&(i.textContent="üî¥ Updates available",i.style.color="#FF5722",i.style.fontWeight="bold"),window.hasPresetsUpdates=!0}}catch(e){console.log("Could not check for updates:",e)}}function al(){const e=document.getElementById("master-prompt-indicator"),t=document.getElementById("start-screen");e&&(e.style.display=xe&&!t?"block":"none")}async function Ln(){const e=await Se.getAllModifications(),t=new Set,n=new Map,o=[];for(const l of e)l.type==="deletion"?t.add(l.name):l.type==="modification"?n.set(l.name,l.data):l.type==="new"&&o.push(l.data);const s=await de.loadImportedPresets();Nt=s.length>0;let i;if(Nt)i=s;else{if(yt.length===0){const l=await fetch("./presets.json");l.ok?(so=await l.json(),yt=[...so]):(so=[],yt=[])}i=yt}return[...i.filter(l=>!t.has(l.name)).map(l=>n.has(l.name)?{...l,...n.get(l.name)}:{...l}),...o]}function Be(){try{localStorage.setItem(tl,JSON.stringify(x))}catch(e){console.error("Error saving visible presets:",e)}}function Hr(){return g.filter(e=>x.includes(e.name))}function Fr(e){try{localStorage.setItem($i,e.toString())}catch(t){console.error("Error saving resolution:",t)}}function Vr(){try{const e=localStorage.getItem($i);if(e!==null){const t=parseInt(e,10);t>=0&&t<ln.length&&(Ke=t)}}catch(e){console.error("Error loading resolution:",e)}}function on(){const t=g.filter(s=>x.includes(s.name)).slice().sort((s,i)=>s.name.localeCompare(i.name)),n=t.filter(s=>Rt(s.name)),o=t.filter(s=>!Rt(s.name));return{favorites:n,regular:o}}function Ut(){const{favorites:e,regular:t}=on(),n=e.filter(s=>x.includes(s.name)),o=t.filter(s=>x.includes(s.name));return[...n,...o]}function cl(){const e=Ut(),t=g[I];return e.findIndex(n=>n===t)}function dl(e){const n=Ut()[e];return g.findIndex(o=>o===n)}function ul(){try{const e=g.filter(t=>t.internal===!1);localStorage.setItem(bo,JSON.stringify(e))}catch(e){console.error("Error saving styles:",e)}}function Gr(e){const t=We.indexOf(e);t>-1?We.splice(t,1):We.push(e),localStorage.setItem(el,JSON.stringify(We));const n=document.querySelector(".styles-menu-scroll-container"),o=n?n.scrollTop:0;Me(),n&&(n.scrollTop=o)}function jr(){const e=localStorage.getItem(Fi);if(e!==null)try{const t=parseInt(e,10);t>=0&&t<g.length&&(I=t)}catch(t){console.error("Error loading last used style:",t)}}function Rt(e){return We.includes(e)}function No(){const e=Ut();if(e.length===0)return 0;const t=e.filter(o=>Rt(o.name));if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];return g.findIndex(s=>s===o)}const n=e[Math.floor(Math.random()*e.length)];return g.findIndex(o=>o===n)}function ml(){re=!re;const e=document.getElementById("motion-toggle");if(re)e.classList.add("active"),e.title="Motion Detection: ON",v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ üëÅÔ∏è Motion Detection":`Motion Detection mode ON ‚Ä¢ ${g[I].name}`,oe("üëÅÔ∏è Motion Detection");else{e.classList.remove("active"),e.title="Motion Detection: OFF",_o(),Yt&&(clearInterval(Yt),Yt=null);const t=document.getElementById("timer-countdown");t&&(t.style.display="none",t.classList.remove("countdown-fade-in","countdown-fade-out"));const n=document.getElementById("camera-button");n&&H.length>1&&(n.style.display="flex"),g&&g[I]&&(v.textContent=L?"‚ö° NO MAGIC MODE":`Style: ${g[I].name}`,oe(g[I].name))}}function Yr(){for(let e in Kt)if(Kt[e].seconds===kt)return parseInt(e);return 1}function zr(){document.getElementById("settings-submenu").style.display="none",document.getElementById("motion-submenu").style.display="flex",qn=!0,Z=!1}function Jr(){document.getElementById("motion-submenu").style.display="none",qn=!1,Ve()}function Qr(){document.getElementById("settings-submenu").style.display="none",document.getElementById("visible-presets-submenu").style.display="flex",G=!1,et=!0,cn=!0,Z=!1,Ee=0,nn="",document.getElementById("visible-presets-filter").value="",Mt(),Xe()}function Wr(){document.getElementById("visible-presets-submenu").style.display="none",et=!1,cn=!1,Ee=0,nn="",ft="";const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none"),Ve()}function gl(){document.getElementById("settings-submenu").style.display="none",document.getElementById("preset-builder-submenu").style.display="flex",G=!1,Z=!1,$t=!0,Fn()}function Ro(){document.getElementById("preset-builder-submenu").style.display="none",$t=!1,be=-1;const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none"),Ve()}function Fn(){be=-1,document.getElementById("preset-builder-name").value="",document.getElementById("preset-builder-category").value="",document.getElementById("preset-builder-template").value="",document.getElementById("preset-builder-prompt").value="";const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none");const t=document.getElementById("preset-builder-clear");t&&(t.style.display="flex"),document.querySelectorAll(".chip-section-content").forEach(n=>{n.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(n=>{n.classList.remove("expanded")})}function Xr(e){const t=g[e];gl(),be=e,setTimeout(()=>{const n=document.getElementById("preset-builder-name"),o=document.getElementById("preset-builder-category"),s=document.getElementById("preset-builder-prompt"),i=document.getElementById("preset-builder-template"),r=document.getElementById("preset-builder-delete"),l=document.getElementById("preset-builder-clear");n&&(n.value=t.name),o&&(o.value=t.category?t.category.join(", "):""),s&&(s.value=t.message),i&&(i.value=""),r&&(r.style.display="flex"),l&&(l.style.display="none")},100)}function Kr(){const e=document.getElementById("preset-builder-template"),t=document.getElementById("preset-builder-prompt"),n=e.value;n&&wi[n]!==void 0&&(t.value=wi[n])}function Zr(){const e=new Set;return g.forEach(t=>{t.category&&Array.isArray(t.category)&&t.category.forEach(n=>{e.add(n.toUpperCase())})}),Array.from(e).sort()}async function ea(){const e=document.getElementById("preset-builder-name").value.trim(),t=document.getElementById("preset-builder-category").value.trim(),n=document.getElementById("preset-builder-prompt").value.trim();if(!e){alert("Please enter a preset name");return}if(!n){alert("Please enter a prompt");return}const o=t?t.split(",").map(r=>r.trim().toUpperCase()).filter(r=>r.length>0):["CUSTOM"];let s=null;if(be>=0){const r=g[be].name;if(s=r,g[be]={name:e.toUpperCase(),category:o,message:n,internal:!1},r!==e.toUpperCase()){const l=x.indexOf(r);l>-1&&(x[l]=e.toUpperCase())}}else{const r=g.findIndex(a=>a.name.toUpperCase()===e.toUpperCase());if(r!==-1){if(!await confirm(`A preset named "${e}" already exists. Do you want to overwrite it?`))return;s=g[r].name,g.splice(r,1)}const l={name:e.toUpperCase(),category:o,message:n,internal:!1};g.push(l),x.includes(l.name)||x.push(l.name)}Be();const i=be>=0?g[be]:g[g.length-1];s&&s!==i.name&&await Se.db.transaction(["presets"],"readwrite").objectStore("presets").delete(`new_${s}`),await Se.saveNewPreset(i),alert(be>=0?`Preset "${e}" updated!`:`Preset "${e}" saved successfully!`),Fn(),Ro(),G&&Me()}async function ta(){if(be<0){alert("No preset selected for deletion");return}const e=g[be];if(e.internal!==!1){alert("Cannot delete built-in presets");return}if(!await confirm(`Delete preset "${e.name}"? This cannot be undone.`))return;g.splice(be,1);const t=x.indexOf(e.name);t>-1&&(x.splice(t,1),Be());const n=be===I;if(I>=g.length&&(I=g.length-1),n){const i=g.filter(r=>x.includes(r.name));i.length>0?I=g.findIndex(r=>r.name===i[0].name):g.length>0&&(I=0),Q()}await Se.db.transaction(["presets"],"readwrite").objectStore("presets").delete(`new_${e.name}`),ul(),Xe(),alert(`Preset "${e.name}" deleted successfully!`),Fn(),Ro(),G&&Me()}function Mt(){const e=document.getElementById("visible-presets-list"),t=document.querySelector("#visible-presets-submenu .submenu-list");t&&t.scrollTop,e.innerHTML="";const n=new Set(de.getImportedPresets().map(a=>a.name)),i=g.filter(a=>{if(a.internal)return!1;const c=n.has(a.name),m=!yt.some(f=>f.name===a.name);return c||m}).filter(a=>{if(nn){const c=nn.toLowerCase(),m=a.category&&a.category.some(y=>y.toLowerCase().includes(c));if(!(a.name.toLowerCase().includes(c)||m))return!1}return ft?a.category&&a.category.includes(ft):!0}).sort((a,c)=>a.name.localeCompare(c.name)),r=document.createDocumentFragment();i.forEach(a=>{const c=document.createElement("div");c.className="style-item",c.dataset.presetName=a.name;const m=document.createElement("input");m.type="checkbox",m.className="master-prompt-checkbox",m.checked=x.includes(a.name),m.style.marginRight="3vw";const f=document.createElement("span");f.className="style-name",f.textContent=a.name,c.appendChild(m),c.appendChild(f),m.onclick=y=>{y.stopPropagation(),Oi(a.name,m.checked)},c.onclick=()=>{m.checked=!m.checked,Oi(a.name,m.checked)},r.appendChild(c)}),e.appendChild(r);const l=document.getElementById("visible-presets-count");if(l){const a=i.filter(c=>x.includes(c.name)).length;l.textContent=a}setTimeout(()=>{sn()},50)}function Oi(e,t){const n=x.indexOf(e);t&&n===-1?x.push(e):!t&&n>-1&&x.splice(n,1),Be(),Xe();const o=g[I];if(o&&!t&&o.name===e){const l=g.filter(a=>x.includes(a.name));l.length>0&&(I=g.findIndex(a=>a.name===l[0].name),Q())}const s=document.querySelector("#visible-presets-submenu .submenu-list"),i=s?s.scrollTop:0;Mt(),s&&requestAnimationFrame(()=>{s.scrollTop=i});const r=document.getElementById("styles-count");if(r){const{favorites:l,regular:a}=on(),c=l.length+a.length;r.textContent=c}G&&Me()}function Xe(){const e=document.getElementById("current-visible-presets-display");if(e){const t=g.filter(o=>!o.internal).length,n=x.length;e.textContent=n===t?"All Visible":`${n} of ${t}`}}function na(){if(!et||!cn)return;const e=document.getElementById("visible-presets-list");!e||e.querySelectorAll(".style-item").length===0||(Ee=Math.max(0,Ee-1),sn())}function oa(){if(!et||!cn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");t.length!==0&&(Ee=Math.min(t.length-1,Ee+1),sn())}function sn(){if(!et)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0)return;t.forEach(o=>{o.classList.remove("menu-selected")}),Ee=Math.max(0,Math.min(Ee,t.length-1));const n=t[Ee];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const o=n.dataset.presetName,s=g.find(r=>r.name===o),i=document.getElementById("visible-presets-category-hint");i&&s&&s.category&&!ho?(i.innerHTML="",i.style.display="block",s.category.forEach((r,l)=>{const a=document.createElement("span");if(a.textContent=r,a.style.cursor="pointer",a.style.padding="0 2px",ft===r&&(a.style.textDecoration="underline",a.style.fontWeight="bold"),a.onclick=c=>{c.stopPropagation(),ft===r?ft="":ft=r,Ee=0,Mt()},i.appendChild(a),l<s.category.length-1){const c=document.createElement("span");c.textContent=", ",i.appendChild(c)}})):i&&(i.style.display="none")}}function sa(){if(!et||!cn)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(t.length===0||Ee>=t.length)return;const n=t[Ee];n&&n.click()}function fl(){const e=["Very Low","Low","Medium","High","Very High"],t=document.getElementById("current-motion-display");if(t){const n=Math.floor((50-At)/10)+1,o=Math.max(1,Math.min(5,n));t.textContent=`Sensitivity: ${e[o-1]}`}}function In(){const e={motionThreshold:At,motionPixelThreshold:Mo,motionContinuousEnabled:It,motionCooldown:Dt,motionStartDelay:kt};try{localStorage.setItem(Ji,JSON.stringify(e))}catch(t){console.error("Failed to save motion settings:",t)}}function ia(){try{const e=localStorage.getItem(Ji);if(e){const t=JSON.parse(e);At=t.motionThreshold||30,Mo=t.motionPixelThreshold||.1,It=t.motionContinuousEnabled!==void 0?t.motionContinuousEnabled:!0,Dt=t.motionCooldown||2,kt=t.motionStartDelay||3}{const t=document.getElementById("motion-sensitivity-slider");if(t){const r=Math.floor((50-At)/10)+1;t.value=Math.max(1,Math.min(5,r))}const n=document.getElementById("motion-continuous-enabled");n&&(n.checked=It);const o=document.getElementById("motion-cooldown-slider");o&&(o.value=Dt);const s=document.getElementById("motion-start-delay-slider"),i=document.getElementById("motion-start-delay-value");if(s&&i){const r=Yr();s.value=r,i.textContent=Kt[r].label}fl()}}catch(e){console.error("Failed to load motion settings:",e)}}function la(){L=!L;const e=document.getElementById("no-magic-status");e&&(e.textContent=L?"Enabled":"Disabled",e.style.color=L?"#4CAF50":"",e.style.fontWeight=L?"600":"");try{localStorage.setItem(Qi,JSON.stringify(L))}catch(t){console.error("Failed to save No Magic mode:",t)}qo(),L?showStatus("No Magic Mode ON - Camera only",2e3):showStatus("No Magic Mode OFF - AI prompts enabled",2e3)}function ra(){try{const e=localStorage.getItem(Qi);if(e!==null){L=JSON.parse(e);const t=document.getElementById("no-magic-status");t&&(t.textContent=L?"Enabled":"Disabled",t.style.color=L?"#4CAF50":"",t.style.fontWeight=L?"600":""),qo()}}catch(e){console.error("Failed to load No Magic mode:",e)}}function aa(){ae=!ae;const e=document.getElementById("manual-options-status");e&&(e.textContent=ae?"Enabled":"Disabled",e.style.color=ae?"#4CAF50":"",e.style.fontWeight=ae?"600":"");try{localStorage.setItem(Wi,JSON.stringify(ae))}catch(t){console.error("Failed to save Manual Select mode:",t)}if(qo(),ae){const t=Ja();t.allowed?showStatus("Manual Select ON - Only works with Random mode",2500):showStatus(`‚ö†Ô∏è ${t.reason}`,3e3)}else showStatus("Manual Select OFF - Random selection active",2e3)}function ca(){try{const e=localStorage.getItem(Wi);if(e!==null){ae=JSON.parse(e);const t=document.getElementById("manual-options-status");t&&(t.textContent=ae?"Enabled":"Disabled",t.style.color=ae?"#4CAF50":"",t.style.fontWeight=ae?"600":"")}}catch(e){console.error("Failed to load Manual Select mode:",e)}}async function pl(e,t){return t.length>0&&!t[0].hasOwnProperty("title")&&(t=[{title:"SELECT",options:t}]),new Promise(n=>{const o=document.getElementById("manual-options-modal"),s=document.getElementById("manual-options-list"),i=document.getElementById("manual-options-preset-name");if(!o||!s||!i){console.error("Manual select modal elements not found"),n(null);return}i.textContent=e.name,s.innerHTML="",t.forEach((y,b)=>{const B=document.createElement("div");B.style.padding="10px 12px 4px",B.style.fontWeight="700",B.style.fontSize="11px",B.style.letterSpacing="0.05em",B.style.color="#aaa",B.style.textTransform="uppercase",B.style.borderTop=b>0?"1px solid #333":"none",B.style.marginTop=b>0?"8px":"0",B.textContent=y.title,s.appendChild(B),y.options.forEach((C,R)=>{const me=`s${b}_o${R}`,k=document.createElement("div");k.className="style-item",k.style.padding="10px 12px",k.style.cursor="pointer",k.style.display="flex",k.style.alignItems="center";const D=document.createElement("input");D.type="radio",D.name=`manual-option-section-${b}`,D.id=`manual-option-${me}`,D.value=C.value,D.style.marginRight="10px";const q=document.createElement("label");q.htmlFor=`manual-option-${me}`,q.textContent=C.label,q.style.cursor="pointer",q.style.flex="1",q.style.fontSize="12px",k.appendChild(D),k.appendChild(q),k.onclick=()=>{D.checked=!0},s.appendChild(k)});const S=s.querySelector(`input[name="manual-option-section-${b}"]`);S&&(S.checked=!0)}),o.style.display="flex";const r=document.getElementById("close-manual-options"),l=document.getElementById("cancel-manual-options"),a=document.getElementById("confirm-manual-options"),c=()=>{o.style.display="none",r&&(r.onclick=null),l&&(l.onclick=null),a&&(a.onclick=null)},m=()=>{c(),n(null)},f=()=>{const y=[];t.forEach((b,B)=>{const S=s.querySelector(`input[name="manual-option-section-${B}"]:checked`);y.push(S?parseInt(S.value):0)}),c(),n(t.length===1?y[0]:y)};r&&(r.onclick=m),l&&(l.onclick=m),a&&(a.onclick=f)})}function qo(){window.cameraStarted&&(L?v&&(v.textContent="‚ö° NO MAGIC MODE"):ae?v&&(v.textContent="üéØ MANUALLY SELECT"):Q())}function da(){const e=localStorage.getItem(_i);e!==null&&(Lt=parseInt(e,10)),yl()}function ua(){localStorage.setItem(_i,Lt.toString()),yl()}function yl(){const e=document.getElementById("current-import-resolution-display");if(e){const t=Co[Lt];e.textContent=t.name.split(" ")[0]}}function ma(){document.getElementById("settings-submenu").style.display="none",document.getElementById("tutorial-submenu").style.display="flex",G=!1,St=!0,De=0,Z=!1,hl()}function ga(){document.getElementById("tutorial-submenu").style.display="none",St=!1,Ve()}function fa(e){const t=document.getElementById("tutorial-glossary"),n=document.getElementById("tutorial-content-area"),o=document.getElementById("section-"+e),s=document.getElementById("back-to-glossary");t&&n&&o&&(t.style.display="none",n.style.display="flex",s&&(s.style.display="block"),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"start"})},100))}function hl(){const e=document.getElementById("tutorial-glossary"),t=document.getElementById("tutorial-content-area"),n=document.getElementById("back-to-glossary");e&&t&&(t.style.display="none",e.style.display="block",n&&(n.style.display="none"),De=0,setTimeout(()=>{$o()},50))}function pa(){if(!St)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;De=(De-1+o.length)%o.length,$o();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.max(0,n.scrollTop-80))}function ya(){if(!St)return;const e=document.getElementById("tutorial-glossary");if(e&&e.style.display!=="none"){const o=e.querySelectorAll(".glossary-item");if(o.length===0)return;De=(De+1)%o.length,$o();return}const t=document.getElementById("tutorial-content-area");if(!t||t.style.display!=="flex")return;const n=t.querySelector(".submenu-list.tutorial-content");n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+80))}function $o(){const e=document.getElementById("tutorial-glossary");if(!e)return;const t=e.querySelectorAll(".glossary-item");if(t.length!==0&&(t.forEach(n=>{n.classList.remove("menu-selected")}),De>=0&&De<t.length)){const n=t[De];n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"})}}function ha(){document.getElementById("settings-submenu").style.display="none";const e=document.getElementById("import-resolution-submenu"),t=document.getElementById("import-resolution-list");t.innerHTML="",Co.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Lt&&s.classList.add("selected"),s.textContent=n.name,s.onclick=()=>{Lt=o,ua(),El()},t.appendChild(s)}),e.style.display="flex"}function El(){document.getElementById("import-resolution-submenu").style.display="none",document.getElementById("settings-submenu").style.display="flex"}function vo(){!T||!w||(Je=null,hn=!1,vn=setInterval(()=>{if(!re||hn||!It&&J.style.display==="block")return;Ea()&&(console.log("Motion detected! Capturing..."),To(),hn=!0,setTimeout(()=>{if(hn=!1,Je=null,J.style.display==="block"&&(J.style.display="none",T.style.display="block"),!It){_o(),re=!1;const t=document.getElementById("motion-toggle");t.classList.remove("active"),t.title="Motion Detection: OFF",showStatus("Motion capture complete - Press eye button to reactivate",3e3),g&&g[I]&&oe(g[I].name)}},Dt*1e3))},500))}function _o(){vn&&(clearInterval(vn),vn=null),Je=null}function Ea(){if(!T||!w)return!1;const e=w.getContext("2d"),t=320,n=240;w.width=t,w.height=n,e.drawImage(T,0,0,t,n);const o=e.getImageData(0,0,t,n);if(!Je)return Je=o,!1;let s=0;const i=t*n;for(let l=0;l<o.data.length;l+=4){const a=Math.abs(o.data[l]-Je.data[l]),c=Math.abs(o.data[l+1]-Je.data[l+1]),m=Math.abs(o.data[l+2]-Je.data[l+2]);(a+c+m)/3>At&&s++}return Je=o,s/i>Mo}function Il(){qe=!qe;const e=document.getElementById("random-toggle");qe?(e.classList.add("random-active"),v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ üé≤ Random Mode":`Random mode ON ‚Ä¢ ${g[I].name}`,oe("üé≤ Random Mode")):(e.classList.remove("random-active"),Q(),g&&g[I]&&oe(g[I].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"random_mode_toggled",enabled:qe,timestamp:Date.now()}))}function Ia(){try{const e=localStorage.getItem(Zi);e&&(O=JSON.parse(e))}catch(e){console.error("Error loading queue:",e),O=[]}}function ht(){try{localStorage.setItem(Zi,JSON.stringify(O))}catch(e){console.error("Error saving queue:",e)}}function co(){xt&&(ve?(xt.className="connection-status online",xt.querySelector("#connection-text").textContent="Online"):(xt.className="connection-status offline",xt.querySelector("#connection-text").textContent="Offline")),vt()}function vt(){if(Pt){const e=O.length;Pt.querySelector("#queue-count").textContent=e,Pt.style.display=e>0?"block":"none"}if($e){const e=O.length;$e.querySelector("#sync-count").textContent=e,$e.style.display=e>0&&ve?"block":"none"}}function ba(){window.addEventListener("online",()=>{ve=!0,co(),console.log("Connection restored"),O.length>0&&!ct&&setTimeout(()=>{v.textContent=`Connection restored! Syncing ${O.length} photos...`,qt()},1e3)}),window.addEventListener("offline",()=>{ve=!1,co(),console.log("Connection lost"),ct&&(v.textContent="Connection lost during sync")}),co()}async function va(){try{return H=(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"),console.log("Available cameras:",H.length),H}catch(e){return console.error("Error enumerating cameras:",e),[]}}function Vn(){const e=ln[Ke];if(H.length===0)return{video:{facingMode:"environment",width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};const n={video:{deviceId:{exact:H[fe].deviceId},width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};return Et()&&(n.video.advanced=[{zoom:1}]),n}async function Ba(e){if(!(e===Ke||!_)){Ke=e,Fr(e);try{v.textContent="Changing resolution...",_&&_.getTracks().forEach(n=>n.stop());const t=Vn();_=await navigator.mediaDevices.getUserMedia(t),T.srcObject=_,ee=_.getVideoTracks()[0],await new Promise(n=>{T.onloadedmetadata=async()=>{try{await T.play(),Gn(),await Ht(le),setTimeout(n,100)}catch(o){console.error("Video play error:",o),n()}}}),Q(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"resolution_changed",resolution:ln[Ke].name,timestamp:Date.now()}))}catch(t){console.error("Resolution change error:",t),v.textContent="Resolution change failed"}}}function Bo(){if(H.length===0)return"Default Camera";const e=H[fe];let t=e.label;return!t||t===""?e.deviceId?t=`Camera ${fe+1}`:t="Unknown Camera":(t=t.replace(/\([^)]*\)/g,"").trim(),t.toLowerCase().includes("front")?t="Front Camera":t.toLowerCase().includes("back")||t.toLowerCase().includes("rear")?t="Back Camera":t.length>20&&(t=t.substring(0,17)+"...")),t}function Et(){if(H.length===0)return!1;const e=H[fe];if(!e)return!1;const t=e.label.toLowerCase();return e.facingMode==="user"?!0:e.facingMode==="environment"?!1:t.includes("front")||t.includes("user")||t.includes("selfie")||t.includes("face")?!0:t.includes("back")||t.includes("rear")||t.includes("environment")?!1:H.length===2?fe===1:fe>0}function Gn(){try{Et()?(T.style.transform="translateZ(0)",T.style.webkitTransform="translateZ(0)"):(T.style.transform="scaleX(-1) translateZ(0)",T.style.webkitTransform="scaleX(-1) translateZ(0)")}catch(e){console.warn("Mirror transform skipped:",e)}}function Sa(){if(!ee)return!1;const e=ee.getCapabilities();return e&&"zoom"in e}function bl(){if(!ee)return{min:1,max:5,step:.1};const e=ee.getCapabilities();return e&&e.zoom?{min:Math.min(e.zoom.min||1,1),max:Math.max(e.zoom.max||5,5),step:e.zoom.step||.1}:{min:1,max:5,step:.1}}async function Ht(e){if(ee)try{if(Sa()){const t=bl(),n=Math.max(t.min,Math.min(e,t.max)),o={advanced:[{zoom:n}]},s=ee.getCapabilities();s&&s.focusMode&&s.focusMode.includes("continuous")&&(o.advanced[0].focusMode="continuous"),await ee.applyConstraints(o),le=n,Et()?(T.style.transform="translateZ(0)",T.style.webkitTransform="translateZ(0)"):(T.style.transform="scaleX(-1) translateZ(0)",T.style.webkitTransform="scaleX(-1) translateZ(0)")}else{const t=Math.max(1,Math.min(e,5));le=t,Et()?(T.style.transform=`scale(${t})`,T.style.webkitTransform=`scale(${t})`):(T.style.transform=`scaleX(-1) scale(${t})`,T.style.webkitTransform=`scaleX(-1) scale(${t})`)}}catch{const n=Math.max(1,Math.min(e,5));le=n,Et()?(T.style.transform=`scale(${n})`,T.style.webkitTransform=`scale(${n})`):(T.style.transform=`scaleX(-1) scale(${n})`,T.style.webkitTransform=`scaleX(-1) scale(${n})`)}}async function Ta(){if(ee)try{const e=ee.getCapabilities();e&&e.focusMode&&(e.focusMode.includes("single-shot")?(await ee.applyConstraints({advanced:[{focusMode:"single-shot",zoom:le}]}),console.log("Triggered single-shot focus"),setTimeout(async()=>{try{await ee.applyConstraints({advanced:[{focusMode:"continuous",zoom:le}]})}catch(t){console.log("Could not return to continuous focus:",t)}},500)):e.focusMode.includes("manual")&&(await ee.applyConstraints({advanced:[{focusMode:"manual",zoom:le}]}),console.log("Triggered manual focus")))}catch(e){console.log("Focus adjustment not supported or failed:",e)}}async function wa(){if(io||H.length<=1){console.log("Cannot switch camera: loading or not enough cameras");return}io=!0;try{v.textContent="Switching camera...",_&&_.getTracks().forEach(t=>t.stop()),fe=(fe+1)%H.length,console.log(`Switching to camera ${fe+1} of ${H.length}`);const e=Vn();_=await navigator.mediaDevices.getUserMedia(e),T.srcObject=_,ee=_.getVideoTracks()[0],await new Promise(t=>{T.onloadedmetadata=async()=>{try{await T.play(),Gn(),await Ht(le),setTimeout(t,100)}catch(n){console.error("Video play error:",n),t()}}}),Q(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"camera_switched",cameraIndex:fe,cameraLabel:Bo(),timestamp:Date.now()}))}catch(e){console.error("Camera switch error:",e),v.textContent="Camera switch failed",fe=(fe-1+H.length)%H.length}finally{io=!1}}function xa(){try{const e=localStorage.getItem(Ui);if(e){const t=JSON.parse(e);K=t.count||5;const n=t.speed||2;rn=Ot[n].delay}}catch(e){console.error("Error loading burst settings:",e)}}function Ai(e,t){try{localStorage.setItem(Ui,JSON.stringify({count:e,speed:t}))}catch(n){console.error("Error saving burst settings:",n)}}function vl(){ye=!ye;const e=document.getElementById("burst-toggle");ye?(e.classList.add("burst-active"),v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${K} photos) ‚Ä¢ ${g[I].name}`,oe("üì∏ Burst Mode")):(e.classList.remove("burst-active"),Q(),g&&g[I]&&oe(g[I].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_mode_toggled",enabled:ye,count:K,timestamp:Date.now()}))}function Bl(){he=!he;const e=document.getElementById("timer-toggle");he?(e.classList.add("timer-active"),v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ ‚è±Ô∏è Timer Mode":`Timer mode ON (${Ue}s delay) ‚Ä¢ ${g[I].name}`,oe("‚è±Ô∏è Timer Mode")):(e.classList.remove("timer-active"),Ze&&(clearInterval(Ze),Ze=null,document.getElementById("timer-countdown").style.display="none"),Q(),g&&g[I]&&oe(g[I].name)),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"timer_mode_toggled",enabled:he,delay:Ue,timestamp:Date.now()}))}function So(e){let t=Ue;const n=document.getElementById("timer-countdown"),o=document.getElementById("timer-countdown-text");o.textContent=t,n.style.display="flex",n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),v.textContent=`Timer: ${t}s...`,Ze=setInterval(()=>{t--,t>0?(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{o.textContent=t,n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),v.textContent=`Timer: ${t}s...`},500)):(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{n.style.display="none",n.classList.remove("countdown-fade-out"),clearInterval(Ze),Ze=null,e(),Bt&&he&&(setTimeout(()=>{if(J.style.display==="block"){J.style.display="none",T.style.display="block";const s=document.getElementById("camera-button");s&&H.length>1&&(s.style.display="flex")}},500),setTimeout(()=>{he&&So(e)},Te*1e3))},500))},1e3)}function Sl(){Ze&&(clearInterval(Ze),Ze=null,document.getElementById("timer-countdown").style.display="none",Q())}function Ca(){try{const e=localStorage.getItem(Hi);if(e){const t=JSON.parse(e);Ue=t.delay||10,Bt=t.repeat||!1,Te=t.repeatInterval||1}}catch(e){console.error("Error loading timer settings:",e)}}function uo(){try{localStorage.setItem(Hi,JSON.stringify({delay:Ue,repeat:Bt,repeatInterval:Te}))}catch(e){console.error("Error saving timer settings:",e)}}function Qt(){const e=document.getElementById("current-timer-display");if(e){const t=Bt?`Repeat (${Gi[Pa()].label})`:"No Repeat";e.textContent=`${Ue}s, ${t}`}}function Pa(){for(const[e,t]of Object.entries(Gi))if(t.seconds===Te)return parseInt(e);return 1}async function Di(){if(!(!_||lo||J.style.display==="block")){lo=!0,v.textContent=`Burst mode: Taking ${K} photos...`;for(let e=0;e<K;e++)v.textContent=`Burst ${e+1}/${K}...`,Ma(e+1),e<K-1&&await new Promise(t=>setTimeout(t,rn));lo=!1,v.textContent=`Burst complete! ${K} photos saved.`,ve&&!ct?setTimeout(()=>{qt()},500):ve||(v.textContent=`Burst complete! ${K} photos queued (offline).`),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_complete",count:K,timestamp:Date.now()})),setTimeout(()=>{ye?v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${K} photos) ‚Ä¢ ${g[I].name}`:Q()},2e3)}}function Ma(e){if(!_)return;qe&&(I=No()),(w.width!==T.videoWidth||w.height!==T.videoHeight)&&(w.width=T.videoWidth,w.height=T.videoHeight);const t=w.getContext("2d",{willReadFrequently:!1,alpha:!1});t.clearRect(0,0,w.width,w.height);const n=w.width/le,o=w.height/le,s=(w.width-n)/2,i=(w.height-o)/2;if(Et())t.drawImage(T,s,i,n,o,0,0,w.width,w.height);else{t.save(),t.scale(-1,1),t.drawImage(T,s,i,n,o,-w.width,0,w.width,w.height),t.restore();const m=document.createElement("canvas");m.width=w.width,m.height=w.height;const f=m.getContext("2d");f.scale(-1,1),f.drawImage(w,-w.width,0),t.clearRect(0,0,w.width,w.height),t.drawImage(m,0,0)}const r=Ke>=2?.7:.8,l=w.toDataURL("image/jpeg",r),a=g[I];ol(l);const c={id:Date.now().toString()+"-"+e,imageBase64:l,preset:a,timestamp:Date.now()};O.push(c),ht(),vt()}async function La(){try{T=document.getElementById("video"),w=document.getElementById("canvas"),J=document.getElementById("captured-image"),v=document.getElementById("status"),Tn=document.getElementById("reset-button");const e=document.getElementById("start-screen");if(e){const l=e.querySelector(".start-text");l&&(l.textContent="Requesting camera access...");const a=document.getElementById("start-button");a&&(a.disabled=!0)}if(await va(),H.length>1){const l=H.findIndex(a=>{const c=a.label.toLowerCase();return c.includes("back")||c.includes("rear")||c.includes("environment")});fe=l!==-1?l:H.length-1}else fe=0;const t=Vn();_=await navigator.mediaDevices.getUserMedia(t),T.srcObject=_,ee=_.getVideoTracks()[0],console.log("Camera initialized:",Bo()),Ia(),ba(),await new Promise(l=>{T.onloadedmetadata=async()=>{try{await T.play(),Gn(),Ht(1),setTimeout(l,100)}catch(a){console.error("Video play error:",a),l()}}}),document.getElementById("start-screen").remove(),document.getElementById("camera-container").style.display="flex",v.style.display="block";const n=document.getElementById("camera-button");H.length>1&&(n.style.display="flex");const o=document.getElementById("menu-button");o&&(o.style.display="flex");const s=document.getElementById("mode-carousel");s&&(s.style.display="block");const i=document.getElementById("gallery-button");i&&(i.style.display="flex"),Q();const r=document.getElementById("connection-status");if(r&&ve&&(r.style.display="block",setTimeout(()=>{r.style.display="none"},3e3)),window.hasPresetsUpdates){const l=document.getElementById("updates-indicator");l&&(l.style.display="block",setTimeout(()=>{l.style.display="none"},3e3))}al(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_ready",availableCameras:H.length,currentCamera:Bo(),timestamp:Date.now()}))}catch(e){console.error("Camera access error:",e),v.textContent="Camera access denied";const t=document.getElementById("start-button");t&&(t.disabled=!1);const n=document.getElementById("start-screen");n&&(n.style.display="block"),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_error",error:e.message,timestamp:Date.now()}))}}function ut(){_&&T&&(_.getTracks().forEach(e=>{e.stop()}),T.style.display="none",T.srcObject=null)}async function Tl(){if(T)try{const e=Vn();_=await navigator.mediaDevices.getUserMedia(e),T.srcObject=_,ee=_.getVideoTracks()[0],await new Promise(t=>{T.onloadedmetadata=async()=>{try{await T.play(),Gn(),await Ht(le),setTimeout(t,100)}catch(n){console.error("Video resume error:",n),t()}}}),T.style.display="block"}catch(e){console.error("Failed to resume camera:",e),v.textContent="Camera resume failed"}}function To(){if(!_)return;qe&&(I=No(),oe(g[I].name)),(w.width!==T.videoWidth||w.height!==T.videoHeight)&&(w.width=T.videoWidth,w.height=T.videoHeight);const e=w.getContext("2d",{willReadFrequently:!1,alpha:!1,desynchronized:!0});e.clearRect(0,0,w.width,w.height);const t=w.width/le,n=w.height/le,o=(w.width-t)/2,s=(w.height-n)/2;if(Et())e.drawImage(T,o,s,t,n,0,0,w.width,w.height);else{e.save(),e.scale(-1,1),e.drawImage(T,o,s,t,n,-w.width,0,w.width,w.height),e.restore();const y=document.createElement("canvas");y.width=w.width,y.height=w.height;const b=y.getContext("2d");b.scale(-1,1),b.drawImage(w,-w.width,0),e.clearRect(0,0,w.width,w.height),e.drawImage(y,0,0)}const i=Ke>=2?.7:.8,r=w.toDataURL("image/jpeg",i);J.src=r,J.style.display="block",J.style.transform="none",T.style.display="none",kn(),re||he&&Bt?Tn.style.display="none":Tn.style.display="block";const l=document.getElementById("camera-button");l&&(l.style.display="none");const a=document.getElementById("resolution-button");a&&(a.style.display="none"),ol(r);const c=g[I],m={id:Date.now().toString(),imageBase64:r,preset:c,timestamp:Date.now()};if(O.push(m),ht(),vt(),ae&&!L&&!(he||re||ye)){const y=Pl(c.message);if(y.length>0){pl(c,y).then(b=>{if(b!==null){const B=O.findIndex(S=>S.id===m.id);B!==-1&&(O[B].manualSelection=b,ht()),ve&&!L?(v.textContent="Photo saved! Uploading...",ct||qt()):v.textContent=`Photo queued (${O.length} in queue)`}else{const B=O.findIndex(S=>S.id===m.id);B!==-1&&(O.splice(B,1),ht(),vt()),v.textContent="Photo not sent - cancelled"}});return}}if(ve){const y=L?"Photo saved!":"Photo saved! Uploading...";v.textContent=y,ct||qt()}else v.textContent=`Photo queued for sync (${O.length} in queue)`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"photo_captured",queued:!0,queueLength:O.length,timestamp:Date.now()}))}async function qt(){if(O.length===0||ct)return;if(!ve){v.textContent="Cannot sync - offline";return}ct=!0,$e.disabled=!0,$e.classList.add("syncing"),console.log(`Syncing ${O.length} queued photos...`);const e=O.length;let t=0;for(;O.length>0&&ve;){const n=O[0];try{if(v.textContent=`Syncing ${t+1}/${e}...`,typeof PluginMessageHandler<"u"&&!L&&PluginMessageHandler.postMessage(JSON.stringify({message:zn(n.preset.message,n.preset.name,n.manualSelection||null),pluginId:"com.r1.pixelart",imageBase64:n.imageBase64})),await new Promise(o=>setTimeout(o,3e3)),ve)O.shift(),t++,ht(),vt();else{console.log("Lost connection during sync");break}await new Promise(o=>setTimeout(o,3e3))}catch(o){console.error("Sync error:",o),v.textContent="Sync error - will retry later";break}}if(ct=!1,$e.disabled=!1,$e.classList.remove("syncing"),O.length===0){const n=L?`All ${t} photos saved!`:`All ${t} photos synced successfully!`;v.textContent=n,setTimeout(()=>{Q()},2e3)}else ve?v.textContent=`Synced ${t}. ${O.length} remaining.`:v.textContent=`Connection lost. ${O.length} photos queued.`;typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"sync_complete",synced:t,remaining:O.length,timestamp:Date.now()}))}function Uo(){const e=document.getElementById("queue-manager"),t=document.getElementById("queue-list");t.innerHTML="",O.length===0?t.innerHTML=`
      <div class="queue-empty">
        <h4>No Photos in Queue</h4>
        <p>Take photos while offline and they'll appear here for syncing.</p>
      </div>
    `:O.forEach((n,o)=>{const s=document.createElement("div");s.className="queue-item",s.innerHTML=`
        <div class="queue-item-header">
          <span class="queue-item-style">${n.preset.name}</span>
          <span class="queue-item-time">${new Date(n.timestamp).toLocaleString()}</span>
        </div>
        <img src="${n.imageBase64}" class="queue-item-preview" alt="Queued photo">
        <div class="queue-item-actions">
          <button onclick="removeFromQueue(${o})" class="delete-button">Remove</button>
          <button onclick="previewQueueItem(${o})" class="secondary">Preview</button>
        </div>
      `,t.appendChild(s)}),e.style.display="flex"}function Oa(){document.getElementById("queue-manager").style.display="none"}async function Aa(e){await confirm("Remove this photo from the sync queue?")&&(O.splice(e,1),ht(),vt(),Uo())}function Da(e){const t=O[e];alert(`Style: ${t.preset.name}
Prompt: ${t.preset.message}
Saved: ${new Date(t.timestamp).toLocaleString()}`)}async function wl(){await confirm("Clear all photos from the queue? This cannot be undone.")&&(O=[],ht(),vt(),Uo())}window.addEventListener("sideClick",()=>{if(console.log("Side button pressed"),Z){const o=document.getElementById("settings-submenu").querySelectorAll(".menu-section-button");o.length>0&&Oe<o.length&&o[Oe].click();return}if(et){sa();return}if(St){const n=document.getElementById("tutorial-glossary");if(n&&n.style.display!=="none"){const o=n.querySelectorAll(".glossary-item");o.length>0&&De<o.length&&o[De].click()}return}if(an){const o=document.getElementById("resolution-submenu").querySelectorAll(".resolution-item");o.length>0&&Ae<o.length&&o[Ae].click();return}if(Fe){wr();return}if(G&&He){$r();return}const e=document.getElementById("start-screen"),t=document.getElementById("start-button");if(e&&e.style.display!=="none")console.log("Simulating tap on start button"),setTimeout(()=>{t.click()},100);else if(J&&J.style.display==="block")jn();else{if(re){if(kt>0){let n=kt;const o=document.getElementById("timer-countdown"),s=document.getElementById("timer-countdown-text");s.textContent=n,o.style.display="flex",o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),v.textContent=`Motion Detection starting in ${n}s...`,Yt=setInterval(()=>{n--,n>0?(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{s.textContent=n,o.classList.remove("countdown-fade-out"),o.classList.add("countdown-fade-in"),v.textContent=`Motion Detection starting in ${n}s...`},500)):(o.classList.remove("countdown-fade-in"),o.classList.add("countdown-fade-out"),setTimeout(()=>{o.style.display="none",o.classList.remove("countdown-fade-out"),clearInterval(Yt),re&&T&&T.readyState>=2&&(vo(),showStatus("Motion Detection active - Move in front of camera",3e3))},500))},1e3)}else vo(),showStatus("Motion Detection ON - Move in front of camera",3e3);return}he?So(ye?()=>Di():()=>To()):ye?Di():To()}});window.addEventListener("scrollUp",()=>{var t,n,o,s;if(console.log("Scroll wheel: up"),document.getElementById("style-editor").style.display==="flex"){Ci();return}if(Fe){ir();return}if(de.isImportModalOpen){de.scrollImportUp();return}if(St){pa();return}if($t){sl();return}if(et){na();return}if(G&&He){Rr();return}if(qn){hr();return}if(en){pr();return}if(Rn){gr();return}if(Nn){ur();return}if(an){cr();return}if(Z){rr();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){Ir();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){vr();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){Ci();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){Sr();return}if(!_||J.style.display==="block")return;const e=Date.now();e-Cn<Ki||(Cn=e,rt&&clearTimeout(rt),rt=setTimeout(()=>{let i=cl();const r=Ut();i=(i-1+r.length)%r.length,I=dl(i);const l=g[I];l&&oe(L?"‚ö° NO MAGIC MODE":l.name),Q(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:g[I].name,timestamp:Date.now()})),rt=null},50))});window.addEventListener("scrollDown",()=>{var t,n,o,s;if(console.log("Scroll wheel: down"),document.getElementById("style-editor").style.display==="flex"){Pi();return}if(Fe){lr();return}if(de.isImportModalOpen){de.scrollImportDown();return}if(St){ya();return}if($t){il();return}if(et){oa();return}if(G&&He){qr();return}if(qn){Er();return}if(en){yr();return}if(Rn){fr();return}if(Nn){mr();return}if(an){dr();return}if(Z){ar();return}if(((t=document.getElementById("gallery-modal"))==null?void 0:t.style.display)==="flex"){br();return}if(((n=document.getElementById("image-viewer"))==null?void 0:n.style.display)==="flex"){Br();return}if(((o=document.getElementById("style-editor"))==null?void 0:o.style.display)==="flex"){Pi();return}if(((s=document.getElementById("queue-manager"))==null?void 0:s.style.display)==="flex"){Tr();return}if(!_||J.style.display==="block")return;const e=Date.now();e-Cn<Ki||(Cn=e,rt&&clearTimeout(rt),rt=setTimeout(()=>{let i=cl();const r=Ut();i=(i+1)%r.length,I=dl(i);const l=g[I];l&&oe(L?"‚ö° NO MAGIC MODE":l.name),Q(),typeof PluginMessageHandler<"u"&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:g[I].name,timestamp:Date.now()})),rt=null},50))});function Q(){I=Math.max(0,Math.min(I,g.length-1));const e=g[I];if(ee)try{const t={};ee.applyConstraints(t)}catch(t){console.error("Error applying preset constraints:",t)}v&&(L?v.textContent="‚ö° NO MAGIC MODE":ae?v.textContent=`üéØ MANUALLY SELECT | Style: ${e.name}`:v.textContent=`Style: ${e.name}`),oe(e.name),localStorage.setItem(Fi,I.toString()),G&&_t()}window.onPluginMessage=function(e){console.log("Received plugin message:",e),e&&e.status==="processing"?v.textContent="AI is processing your image...":e&&e.status==="complete"?v.textContent="AI transformation complete!":e&&e.error&&(v.textContent="Error: "+e.error)};typeof PluginMessageHandler<"u"?(console.log("Flutter channel is available"),PluginMessageHandler.postMessage(JSON.stringify({message:"AI Camera Styles initialized",pluginId:"com.r1.pixelart"}))):console.log("Running in development mode - Flutter channel not available");function jn(){J.style.display="none",re&&It||(_o(),re&&vo()),J.style.transform="none",T.style.display="block",Tn.style.display="none";const e=document.getElementById("camera-button");e&&H.length>1&&(e.style.display="flex");const t=document.getElementById("resolution-button");t&&(t.style.display="flex"),setTimeout(()=>{Ht(le)},50),Q(),Ml()}function ki(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function ka(){const e=document.getElementById("video");e.addEventListener("touchstart",n=>{n.touches.length===2&&(n.preventDefault(),Gt=!0,bi=ki(n.touches[0],n.touches[1]),vi=le)},{passive:!1});let t=null;e.addEventListener("touchmove",n=>{if(Gt&&n.touches.length===2){n.preventDefault();const s=ki(n.touches[0],n.touches[1])/bi,i=vi*s,r=bl(),l=Math.max(r.min,Math.min(i,r.max));t||(Ht(l),t=setTimeout(()=>{t=null},50))}},{passive:!1}),e.addEventListener("touchend",n=>{n.touches.length<2&&(Gt&&Ta(),Gt=!1,console.log("Pinch ended, current zoom:",le))}),e.addEventListener("touchcancel",()=>{Gt=!1})}function Yn(){const e=document.getElementById("unified-menu");J&&J.style.display==="block"&&jn(),Me();const t=document.getElementById("styles-count");if(t){const{favorites:n,regular:o}=on(),s=n.length+o.length;t.textContent=s}xl(),On(),An(),Qt(),G=!0,He=!0,ut(),Sl(),e.style.display="flex"}async function Ho(){G=!1,He=!1,ce=0,it="",Qe="",document.getElementById("style-filter").value="";const e=document.getElementById("menu-category-hint");if(e&&(e.style.display="none"),document.getElementById("unified-menu").style.display="none",await Tl(),L)v&&(v.textContent="‚ö° NO MAGIC MODE"),oe("‚ö° NO MAGIC MODE");else if(he||ye||re||qe){let t="";he?t="‚è±Ô∏è Timer Mode":ye?t="üì∏ Burst Mode":re?t="üëÅÔ∏è Motion Detection":qe&&(t="üé≤ Random Mode"),v&&(v.textContent=`${t} ‚Ä¢ ${g[I]?g[I].name:""}`),oe(t)}else Q()}function Ve(){const e=document.getElementById("settings-submenu"),t=document.getElementById("unified-menu");xl(),On(),Qt(),An(),t.style.display="none",ut(),e.style.display="flex",G=!1,Z=!0,Oe=0,setTimeout(()=>{Do()},50)}function Na(){if(Zt){Zt=!1,document.getElementById("settings-submenu").style.display="none",Z=!1,document.getElementById("unified-menu").style.display="none",G=!1,He=!1,ue().then(()=>{Ao(Lo)});return}document.getElementById("settings-submenu").style.display="none",Z=!1,Oe=0,Yn()}function Ra(){const e=document.getElementById("timer-settings-submenu"),t=document.getElementById("settings-submenu"),n=document.getElementById("timer-delay-slider"),o=document.getElementById("timer-delay-value"),s=document.getElementById("timer-repeat-enabled");if(n&&o){const l=Vi.indexOf(Ue);n.value=l!==-1?l+1:3,o.textContent=Ue}s&&(s.checked=Bt);const i=document.getElementById("timer-repeat-interval-input"),r=document.getElementById("timer-repeat-interval-unit");i&&r&&(Te>=3600&&Te%3600===0?(i.value=Te/3600,r.value="3600"):Te>=60&&Te%60===0?(i.value=Te/60,r.value="60"):(i.value=Te,r.value="1")),t.style.display="none",ut(),e.style.display="flex",Rn=!0,Z=!1}function qa(){document.getElementById("timer-settings-submenu").style.display="none",Rn=!1,Ve()}function $a(){const e=document.querySelector(".styles-menu-scroll-container");e&&(e.scrollTo({top:0,behavior:"smooth"}),ce=0,_t())}function _a(){const e=document.querySelector(".styles-menu-scroll-container");if(e){e.scrollTo({top:e.scrollHeight,behavior:"smooth"});const t=document.getElementById("menu-styles-list");if(t){const n=t.querySelectorAll(".style-item");n.length>0&&(ce=n.length-1,_t())}}}function xl(){const e=document.getElementById("current-resolution-display");if(e){const t=ln[Ke];e.textContent=`${t.width}x${t.height}`}}function On(){const e=document.getElementById("current-burst-display");if(e){let t="Medium";for(const[n,o]of Object.entries(Ot))if(o.delay===rn){t=o.label;break}e.textContent=`${K} photos, ${t}`}}function Ua(){document.getElementById("settings-submenu").style.display="none",ut();const e=document.getElementById("resolution-submenu"),t=document.getElementById("resolution-list");t.innerHTML="",ln.forEach((n,o)=>{const s=document.createElement("div");s.className="resolution-item",o===Ke&&s.classList.add("active");const i=document.createElement("span");i.className="resolution-name",i.textContent=n.name,s.appendChild(i),s.onclick=()=>{Ba(o),Cl()},t.appendChild(s)}),e.style.display="flex",an=!0,Z=!1,Ae=0,setTimeout(()=>{const n=e.querySelectorAll(".resolution-item");ko(n)},100)}async function Cl(){document.getElementById("resolution-submenu").style.display="none",an=!1,Ae=0,Ve()}function Ha(){document.getElementById("settings-submenu").style.display="none",ut();const e=document.getElementById("burst-submenu"),t=document.getElementById("burst-count-slider"),n=document.getElementById("burst-speed-slider"),o=document.getElementById("burst-count-value"),s=document.getElementById("burst-speed-value");if(t&&o&&(t.value=K,o.textContent=K),n&&s){let i=2;for(const[r,l]of Object.entries(Ot))if(l.delay===rn){i=parseInt(r);break}n.value=i,s.textContent=Ot[i].label}e.style.display="flex",Nn=!0,Z=!1}async function Fa(){document.getElementById("burst-submenu").style.display="none",Nn=!1,Ve()}function Ni(){document.getElementById("settings-submenu").style.display="none",ut();const e=document.getElementById("master-prompt-submenu"),t=document.getElementById("master-prompt-enabled"),n=document.getElementById("master-prompt-text"),o=document.getElementById("master-prompt-char-count");t&&(t.checked=xe),n&&(n.value=Le,n.disabled=!xe,o&&(o.textContent=Le.length)),e.style.display="flex",en=!0,Z=!1}async function Va(){if(Zt){Zt=!1,document.getElementById("master-prompt-submenu").style.display="none",en=!1,document.getElementById("settings-submenu").style.display="none",Z=!1,document.getElementById("unified-menu").style.display="none",G=!1,He=!1,await ue(),Ao(Lo);return}document.getElementById("master-prompt-submenu").style.display="none",en=!1,Ve()}function Ga(){document.getElementById("settings-submenu").style.display="none",ut();const e=document.getElementById("aspect-ratio-submenu");e.style.display="flex",Z=!1}async function ja(){document.getElementById("aspect-ratio-submenu").style.display="none",Ve()}function Ri(){const e=document.getElementById("current-aspect-ratio-display");e&&(e.textContent=pe==="none"?"None":pe)}function An(){const e=document.getElementById("current-master-prompt-display");if(e)if(xe&&Le.trim()){const t=Le.substring(0,20);e.textContent=`Enabled: ${t}${Le.length>20?"...":""}`}else xe?e.textContent="Enabled (empty)":e.textContent="Disabled"}function bn(){try{localStorage.setItem(ji,Le),localStorage.setItem(Yi,xe.toString()),localStorage.setItem(zi,pe)}catch(e){console.error("Failed to save master prompt:",e)}}function Ya(){try{const e=localStorage.getItem(ji),t=localStorage.getItem(Yi);e!==null&&(Le=e),t!==null&&(xe=t==="true"),al();const n=localStorage.getItem(zi);if(n){pe=n;const o=document.getElementById("aspect-ratio-1-1"),s=document.getElementById("aspect-ratio-16-9");o&&(o.checked=pe==="1:1"),s&&(s.checked=pe==="16:9");const i=document.getElementById("current-aspect-ratio-display");i&&(i.textContent=pe==="none"?"None":pe)}}catch(e){console.error("Failed to load master prompt:",e)}}function za(){try{const e=localStorage.getItem(Po);e&&(lt=JSON.parse(e))}catch(e){console.error("Failed to load selection history:",e),lt={}}}function Ja(){return L?{allowed:!1,reason:"Manual Select disabled: No Magic Mode is active"}:he?{allowed:!1,reason:"Manual Select disabled: Timer Mode is active"}:re?{allowed:!1,reason:"Manual Select disabled: Motion Detection is active"}:ye?{allowed:!1,reason:"Manual Select disabled: Burst Mode is active"}:{allowed:!0}}function Pl(e){const t=[],n=e.split(`
`),o=[];for(let s=0;s<n.length;s++){const i=n[s].match(/modulo\s+(\d+)/i);i&&o.push({lineIndex:s,count:parseInt(i[1])})}if(o.length===0){const s=/If\s+(?:the\s+)?(?:LAST\s+DIGIT|RANDOM\s+SEED)[^\n]*?(?:is\s+)?(?:an?\s+)?(EVEN|ODD)[^\n]*?:\s*(?:SELECT\s+)?(.+?)(?=\n|$)/gi;let i=null,r=null,l;for(;(l=s.exec(e))!==null;){const a=l[1].toUpperCase(),c=l[2].trim();a==="EVEN"?i=c:a==="ODD"&&(r=c)}return i&&r&&t.push({title:"SELECT",options:[{value:0,label:`0 (EVEN): ${i.substring(0,70)}${i.length>70?"...":""}`},{value:1,label:`1 (ODD): ${r.substring(0,70)}${r.length>70?"...":""}`}]}),t}for(const{lineIndex:s,count:i}of o){let r="";for(let m=s-1;m>=Math.max(0,s-15);m--){const f=n[m].trim();if(/^[A-Z][A-Z\s]+(?:\([A-Z\s]+\))?:?\s*$/.test(f)&&f.length>2){r=f.replace(/\s*\([^)]*\)\s*:?\s*$/,"").replace(/:$/,"").trim();break}}r||(r=`SELECTION ${t.length+1}`);const l=[];let a=0,c=!1;for(let m=s;m<n.length&&a<i;m++){const f=n[m].trim();if(f.match(/^[-‚Äì]\s*0\s*:/)&&(c=!0),c){const y=f.match(/^[-‚Äì]\s*(\d+)\s*:\s*(.+)/);if(y){const b=y[2].trim(),B=b.substring(0,80);l.push({value:a,label:`${a}: ${B}${b.length>80?"...":""}`}),a++}}}l.length>0&&t.push({title:r,options:l})}return t}function Qa(e,t){console.log("Injecting manual selection:",t);const n=Array.isArray(t);let o=0;const s=/[^\n]*modulo\s+\d+[^\n]*:\s*\n((?:\s*[-‚Äì]\s*\d+:.*(?:\n|$))*)/gi;e=e.replace(s,(a,c)=>{const m=n?t[o]??0:t;o++;const f=c.split(`
`);for(const y of f){const b=y.match(/^\s*[-‚Äì]\s*(\d+)\s*:\s*(.+)/);if(b){const B=parseInt(b[1]),S=b[2].trim();if(B===m)return console.log("Selected option:",S),`SELECTED OPTION: ${S}
(Manually selected by user)`}}return a});const r=(n?t[0]:t)===0,l=/If\s+(?:the\s+)?(?:LAST\s+DIGIT|RANDOM\s+SEED)[^\n]*?(?:is\s+)?(?:an?\s+)?(EVEN|ODD)[^\n]*?:\s*(?:SELECT\s+)?(.+?)(?=\n|$)/gi;return e=e.replace(l,(a,c,m)=>c.toUpperCase()==="EVEN"&&r||c.toUpperCase()==="ODD"&&!r?`SELECTED OPTION: ${m.trim()}
(Manually selected by user)`:""),e}function zn(e,t="",n=null){let o=e;if(xe&&Le.trim()&&(o=`${e} ${Le}`),/RANDOM|SELECT|SELECTION|CHOOSE|modulo|LAST DIGIT|LAST TWO DIGITS|LAST THREE DIGITS/i.test(e)){const i=Date.now(),r=i%10,l=i%100,a=i%1e3;n!==null&&(console.log("Using manual selection:",n),o=Qa(o,n)),o=Wa(o,r,l,a,t)}return pe==="1:1"?o+=" Use a square aspect ratio.":pe==="16:9"&&(o+=" Use a square aspect ratio, but pad the image with black bars at top and bottom to simulate a 16:9 aspect ratio."),console.log("FINAL PROMPT:",o),o}function Wa(e,t,n,o,s){console.log("=== PROCESSING RANDOM SELECTIONS ===");const i=/‚Ä¢\s*If\s+(?:the\s+)?(?:LAST\s+DIGIT|RANDOM\s+SEED)(?:\s+of\s+the\s+RANDOM\s+SEED)?(?:\s+ends\s+in)?[^\n]*?(?:is\s+)?(?:an?\s+)?(EVEN|ODD)(?:\s+number)?[^\n]*?:\s*(?:SELECT\s+)?(.+?)(?=\n‚Ä¢|\n\n|$)/gi;e=e.replace(i,(c,m,f)=>{console.log("Found even/odd pattern for:",m);const y=t%2===0;if(m.toUpperCase()==="EVEN"&&y||m.toUpperCase()==="ODD"&&!y){const B=f.trim();return console.log("SELECTED (even/odd):",B),wo(s,B),""}return""}),e=e.replace(/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option\s+[AB]:|\n[A-Z][A-Z\s]+(?:\([A-Z]+\))?:|\n\n|$)/gi,(c,m,f)=>"");const r=/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option|$)/gi;let l=null;e.replace(r,(c,m,f)=>(l||(l=f.trim()),c)),l&&(wo(s,l),e=`SELECTED OPTION: ${l}
(Automatically selected using random seed)`);const a=/(?:select|choose|pick)?(?:\s+exactly\s+one)?[^\n]*?(?:use|using|with|via|by)\s+(?:the\s+)?(?:last\s+(digit|two\s+digits|three\s+digits)|random\s+seed)(?:\s+of\s+the\s+random\s+seed)?[^\n]*?\s+modulo\s+(\d+)[^\n]*?:\s*\n((?:\s*-\s*\d+:.*(?:\n|$))*)/gi;return e=e.replace(a,(c,m,f,y)=>{let b;return m?m.toLowerCase().includes("three")?b="THREE DIGITS":m.toLowerCase().includes("two")?b="TWO DIGITS":b="DIGIT":b="TWO DIGITS",console.log("Found modulo pattern:",b,"modulo",f),Xa(b,f,y,t,n,o,s,c)}),e=e.replace(/‚Ä¢\s*If\s+none\s+is\s+specified[^\n]*\n/gi,""),e=e.replace(/‚Ä¢\s*If\s+no\s+\w+\s+is\s+specified[^\n]*\n/gi,""),e=e.replace(/‚Ä¢\s*Otherwise\s+SELECT[^\n]*\n/gi,""),e=e.replace(/^\s*[A-Z][A-Z\s]+(?:\([A-Z]+\))?:\s*\n(?=\s*\n|SELECTED OPTION:|‚Ä¢\s*If\s+external)/gm,""),e=e.replace(/\n{3,}/g,`

`),console.log("=== FINISHED PROCESSING ==="),e}function Xa(e,t,n,o,s,i,r,l){const a=[],c=/^\s*[-‚Äì]\s*(\d+):\s*(.+?)$/gm;let m;for(;(m=c.exec(n))!==null;){const S=parseInt(m[1]),C=m[2].trim();a.push({number:S,option:C}),console.log(`  Found option ${S}: ${C.substring(0,50)}`)}if(a.length===0)return console.log("  No options found, keeping original"),l;let f;e==="DIGIT"?f=o:e==="TWO DIGITS"?f=s:e==="THREE DIGITS"&&(f=i),console.log("  Selected value before modulo:",f);const y=parseInt(t),b=f%y;console.log("  Selection index after modulo:",b);const B=a.find(S=>S.number===b);return B?(console.log("  SELECTED:",B.option),wo(r,B.option),`SELECTED OPTION: ${B.option}
(Automatically selected using random seed)`):(console.log("  No matching option found!"),l)}function wo(e,t){if(!e||!t)return;const n=Ka(e);n.unshift(t),n.length>Bi&&n.splice(Bi),lt[e]=n,localStorage.setItem(Po,JSON.stringify(lt))}function Ka(e){if(!e)return[];if(!lt[e]){const t=localStorage.getItem(Po);if(t)try{lt=JSON.parse(t)}catch{lt={}}}return lt[e]||[]}function Me(e=!1){const t=document.getElementById("menu-styles-list");t.innerHTML="",t.replaceWith(t.cloneNode(!1));const n=document.getElementById("menu-styles-list"),o=document.createDocumentFragment(),{favorites:s,regular:i}=on(),r=s.filter(c=>{if(it){const m=it.toLowerCase(),f=c.category&&c.category.some(b=>b.toLowerCase().includes(m));if(!(c.name.toLowerCase().includes(m)||c.message.toLowerCase().includes(m)||f))return!1}return Qe?c.category&&c.category.includes(Qe):!0}),l=i.filter(c=>{if(it){const m=it.toLowerCase(),f=c.category&&c.category.some(b=>b.toLowerCase().includes(m));if(!(c.name.toLowerCase().includes(m)||c.message.toLowerCase().includes(m)||f))return!1}return Qe?c.category&&c.category.includes(Qe):!0});if(r.length>0){const c=document.createElement("h3");c.className="menu-section-header",c.textContent="‚òÖ Favorites",o.appendChild(c),r.forEach(m=>{const f=qi(m);o.appendChild(f)})}if(l.length>0){const c=document.createElement("h3");c.className="menu-section-header",c.textContent=it?"Search Results":"All Styles",o.appendChild(c),l.forEach(m=>{const f=qi(m);o.appendChild(f)})}if(l.length===0&&r.length===0&&it){const c=document.createElement("div");c.className="menu-empty",c.textContent="No styles found",o.appendChild(c)}n.appendChild(o),n.addEventListener("click",Za);const a=document.getElementById("styles-count");if(a){const{favorites:c,regular:m}=on(),f=c.length+m.length;a.textContent=f}e||(ce=0,_t())}function qi(e){const t=g.findIndex(l=>l===e),n=document.createElement("div");n.className="style-item",n.dataset.index=t,t===I&&n.classList.add("active");const o=document.createElement("button");o.className="style-favorite",o.textContent=Rt(e.name)?"‚≠ê":"‚òÜ",o.dataset.action="favorite",o.dataset.styleName=e.name;const s=document.createElement("span");s.className="style-name",s.textContent=e.name;const i=document.createElement("button");i.className="style-edit";const r=e.internal===!1;return i.textContent=r?"Builder":"Edit",i.dataset.action=r?"builder":"edit",i.dataset.index=t,n.appendChild(o),n.appendChild(s),n.appendChild(i),n}function Za(e){const t=e.target;if(t.dataset.action==="favorite"){e.stopPropagation();const o=t.dataset.styleName;Gr(o);return}if(t.dataset.action==="edit"){e.stopPropagation();const o=parseInt(t.dataset.index);tc(o);return}if(t.dataset.action==="builder"){e.stopPropagation();const o=parseInt(t.dataset.index);Xr(o);return}const n=t.closest(".style-item");if(n){const o=parseInt(n.dataset.index);isNaN(o)||(I=o,Q(),Ho())}}function ec(e="Add New Style"){const t=document.getElementById("style-editor");document.getElementById("editor-title").textContent=e,t.style.display="flex",setTimeout(()=>{const n=document.querySelector(".style-editor-body");n&&n.focus()},100)}let Dn=!1;function Fo(){if(!Dn){Dn=!0;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="0.5vh",e.style.paddingBottom="0.5vw")}}function Vo(){setTimeout(()=>{const e=document.querySelectorAll(".style-input, .style-textarea");if(!Array.from(e).some(n=>n===document.activeElement)&&Dn){Dn=!1;const n=document.querySelector(".style-editor-body");n&&(n.style.gap="1vh",n.style.paddingBottom="1vw")}},100)}const mo=document.getElementById("style-name"),go=document.getElementById("style-category"),fo=document.getElementById("style-message");mo&&(mo.addEventListener("focus",Fo),mo.addEventListener("blur",Vo));go&&(go.addEventListener("focus",Fo),go.addEventListener("blur",Vo));fo&&(fo.addEventListener("focus",Fo),fo.addEventListener("blur",Vo));function Go(){document.getElementById("style-editor").style.display="none",document.getElementById("style-name").value="",document.getElementById("style-message").value="";const e=document.getElementById("style-category");e&&(e.value=""),document.getElementById("delete-style").style.display="none",Ie=-1}function tc(e){Ie=e;const t=g[e];document.getElementById("style-name").value=t.name,document.getElementById("style-message").value=t.message;const n=document.getElementById("style-category");n&&(n.value=t.category?t.category.join(", "):""),document.getElementById("delete-style").style.display="block",ec("Edit Style")}async function nc(){const e=document.getElementById("style-name").value.trim(),t=document.getElementById("style-message").value.trim(),n=document.getElementById("style-category").value.trim(),o=n?n.split(",").map(s=>s.trim().toUpperCase()).filter(s=>s.length>0):[];if(!e||!t){alert("Please fill in both name and AI prompt");return}if(Ie>=0){const s=g[Ie].name;g[Ie]={name:e,category:o,message:t};const i=yt.some(l=>l.name===s),r=Nt&&de.getImportedPresets().some(l=>l.name===s);if(i||r?await Se.saveModification(s,{name:e,message:t,category:o}):await Se.saveNewPreset({name:e,category:o,message:t}),s!==e){const l=x.indexOf(s);l>-1&&(x[l]=e,Be())}}else{const s={name:e,category:o,message:t};await Se.saveNewPreset(s),g.push(s),x.push(e),Be()}alert(Ie>=0?`Preset "${e}" updated!`:`Preset "${e}" saved!`),Go(),Yn()}async function oc(){if(Ie>=0&&g.length>1&&await confirm("Delete this style?")){const e=g[Ie].name,t=yt.some(a=>a.name===e);Nt&&de.getImportedPresets().some(a=>a.name===e)?await de.deletePreset(e):t?await Se.saveDeletion(e):await Se.removeModification(e),g.splice(Ie,1);const o=x.indexOf(e);o>-1&&(x.splice(o,1),Be());const s=Ie===I;if(Ie===I?I=Math.max(0,Ie-1):Ie<I&&(I=I-1),I=Math.max(0,Math.min(I,g.length-1)),ul(),s){const a=g.filter(c=>x.includes(c.name));a.length>0?I=g.findIndex(c=>c.name===a[0].name):g.length>0&&(I=0)}const i=g[I];if(i&&!x.includes(i.name)){const a=g.filter(c=>x.includes(c.name));a.length>0?I=g.findIndex(c=>c.name===a[0].name):g.length>0&&(I=0)}Q(),Xe(),Go();const r=document.querySelector(".styles-menu-scroll-container"),l=r?r.scrollTop:0;Yn(),r&&requestAnimationFrame(()=>{r.scrollTop=l}),alert(`Preset "${e}" deleted successfully!`)}}function sc(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain(),s=e.createBiquadFilter();n.type="square",n.frequency.setValueAtTime(2400,t),n.frequency.exponentialRampToValueAtTime(1800,t+.012),s.type="highpass",s.frequency.setValueAtTime(1500,t),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.015),n.connect(s),s.connect(o),o.connect(e.destination),n.start(t),n.stop(t+.015);const i=e.createOscillator(),r=e.createGain(),l=e.createBiquadFilter();i.type="square",i.frequency.setValueAtTime(1200,t+.015),i.frequency.exponentialRampToValueAtTime(200,t+.023),l.type="bandpass",l.frequency.setValueAtTime(1500,t+.015),l.Q.setValueAtTime(2,t+.015),r.gain.setValueAtTime(.4,t+.015),r.gain.exponentialRampToValueAtTime(.001,t+.03),i.connect(l),l.connect(r),r.connect(e.destination),i.start(t+.015),i.stop(t+.03);const a=e.createOscillator(),c=e.createGain();a.type="triangle",a.frequency.setValueAtTime(400,t+.023),a.frequency.setValueAtTime(450,t+.027),a.frequency.setValueAtTime(380,t+.031),a.frequency.setValueAtTime(420,t+.035),c.gain.setValueAtTime(0,t+.023),c.gain.linearRampToValueAtTime(.15,t+.025),c.gain.exponentialRampToValueAtTime(.001,t+.04),a.connect(c),c.connect(e.destination),a.start(t+.023),a.stop(t+.04);const m=e.createOscillator(),f=e.createGain(),y=e.createBiquadFilter();m.type="square",m.frequency.setValueAtTime(800,t+.05),m.frequency.exponentialRampToValueAtTime(150,t+.06),y.type="bandpass",y.frequency.setValueAtTime(1e3,t+.05),y.Q.setValueAtTime(2,t+.05),f.gain.setValueAtTime(.5,t+.05),f.gain.exponentialRampToValueAtTime(.001,t+.07),m.connect(y),y.connect(f),f.connect(e.destination),m.start(t+.05),m.stop(t+.07);const b=e.createOscillator(),B=e.createGain(),S=e.createBiquadFilter();b.type="sine",b.frequency.setValueAtTime(180,t+.05),b.frequency.exponentialRampToValueAtTime(120,t+.095),S.type="lowpass",S.frequency.setValueAtTime(300,t+.05),B.gain.setValueAtTime(0,t+.05),B.gain.linearRampToValueAtTime(.2,t+.055),B.gain.exponentialRampToValueAtTime(.001,t+.105),b.connect(S),S.connect(B),B.connect(e.destination),b.start(t+.05),b.stop(t+.105);const C=e.sampleRate*.08,R=e.createBuffer(1,C,e.sampleRate),me=R.getChannelData(0);for(let mt=0;mt<C;mt++){const un=Math.sin(mt/200)*.5+.5;me[mt]=(Math.random()*2-1)*un}const k=e.createBufferSource();k.buffer=R;const D=e.createBiquadFilter();D.type="bandpass",D.frequency.setValueAtTime(3e3,t+.07),D.Q.setValueAtTime(1,t+.07);const q=e.createGain();q.gain.setValueAtTime(0,t+.07),q.gain.linearRampToValueAtTime(.12,t+.075),q.gain.linearRampToValueAtTime(.12,t+.125),q.gain.exponentialRampToValueAtTime(.001,t+.15),k.connect(D),D.connect(q),q.connect(e.destination),k.start(t+.07),k.stop(t+.15);const ge=e.createOscillator(),j=e.createGain();ge.type="square",ge.frequency.setValueAtTime(600,t+.145),ge.frequency.exponentialRampToValueAtTime(100,t+.155),j.gain.setValueAtTime(.25,t+.145),j.gain.exponentialRampToValueAtTime(.001,t+.165),ge.connect(j),j.connect(e.destination),ge.start(t+.145),ge.stop(t+.165)}catch(e){console.log("Audio generation failed:",e)}}window.addEventListener("load",()=>{var di,ui,mi,gi,fi,pi,yi,hi,Ei,Ii;_r(),Ya(),za(),ka();const e=document.getElementById("start-button");e&&e.addEventListener("click",()=>{sc();const d=document.querySelector(".camera-body");d&&(d.style.transition="all 0.1s",d.style.boxShadow="0 0 50px rgba(255, 255, 255, 1)",setTimeout(()=>{d.style.boxShadow=""},100));const u=document.querySelector(".lens-inner");u&&(u.style.transition="all 0.05s",u.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout(()=>{u.style.transform="translate(-50%, -50%) scale(1)"},50)),setTimeout(()=>{La()},300)});const t=document.getElementById("burst-toggle");t&&t.addEventListener("click",vl);const n=document.getElementById("timer-toggle");n&&n.addEventListener("click",Bl);const o=document.getElementById("random-toggle");o&&o.addEventListener("click",Il);const s=document.getElementById("motion-toggle");s&&s.addEventListener("click",ml);const i=document.getElementById("menu-button");i&&i.addEventListener("click",Yn);const r=document.getElementById("close-menu");r&&r.addEventListener("click",Ho);const l=document.getElementById("jump-to-top");l&&l.addEventListener("click",$a);const a=document.getElementById("jump-to-bottom");a&&a.addEventListener("click",_a);const c=document.getElementById("settings-menu-button");c&&c.addEventListener("click",Ve);const m=document.getElementById("settings-back");m&&m.addEventListener("click",Na);const f=document.getElementById("resolution-settings-button");f&&f.addEventListener("click",Ua);const y=document.getElementById("resolution-back");y&&y.addEventListener("click",Cl);const b=document.getElementById("burst-settings-button");b&&b.addEventListener("click",Ha);const B=document.getElementById("burst-back");B&&B.addEventListener("click",Fa);const S=document.getElementById("timer-settings-button");S&&S.addEventListener("click",Ra);const C=document.getElementById("timer-settings-back");C&&C.addEventListener("click",qa);const R=document.getElementById("master-prompt-settings-button");R&&R.addEventListener("click",Ni);const me=document.getElementById("master-prompt-back");me&&me.addEventListener("click",Va);const k=document.getElementById("aspect-ratio-settings-button");k&&k.addEventListener("click",Ga);const D=document.getElementById("aspect-ratio-back");D&&D.addEventListener("click",ja);const q=document.getElementById("aspect-ratio-1-1"),ge=document.getElementById("aspect-ratio-16-9");q&&q.addEventListener("change",d=>{d.target.checked?(pe="1:1",ge&&(ge.checked=!1)):pe="none",bn(),Ri()}),ge&&ge.addEventListener("change",d=>{d.target.checked?(pe="16:9",q&&(q.checked=!1)):pe="none",bn(),Ri()});const j=document.getElementById("motion-settings-button");j&&j.addEventListener("click",zr);const mt=document.getElementById("motion-back");mt&&mt.addEventListener("click",Jr);const un=document.getElementById("visible-presets-settings-button");un&&un.addEventListener("click",Qr);const jo=document.getElementById("visible-presets-back");jo&&jo.addEventListener("click",Wr);const Yo=document.getElementById("preset-builder-button");Yo&&Yo.addEventListener("click",gl);const zo=document.getElementById("preset-builder-back");zo&&zo.addEventListener("click",Ro);const Jo=document.getElementById("preset-builder-jump-up");Jo&&Jo.addEventListener("click",sl);const Qo=document.getElementById("preset-builder-jump-down");Qo&&Qo.addEventListener("click",il);const Wo=document.getElementById("preset-builder-template");Wo&&Wo.addEventListener("change",Kr);const Xo=document.getElementById("preset-builder-name");Xo&&Xo.addEventListener("keypress",d=>{var u;d.key==="Enter"&&(d.preventDefault(),(u=document.getElementById("preset-builder-category"))==null||u.focus())});const ke=document.getElementById("preset-builder-category"),Ge=document.getElementById("category-autocomplete");if(ke&&Ge){const d=()=>{const h=ke.value,E=h.lastIndexOf(","),p=(E>=0?h.substring(E+1):h).trim().toUpperCase(),A=Zr(),P=p?A.filter(M=>M.includes(p)):A;P.length>0?(Ge.innerHTML=P.map(M=>`<div class="category-autocomplete-item" data-category="${M}">${M}</div>`).join(""),Ge.style.display="block"):Ge.style.display="none"},u=h=>{const E=ke.value,p=E.lastIndexOf(",");p>=0?ke.value=E.substring(0,p+1)+" "+h+", ":ke.value=h+", ",Ge.style.display="none",ke.focus()};ke.addEventListener("input",d),ke.addEventListener("focus",d),Ge.addEventListener("click",h=>{if(h.target.classList.contains("category-autocomplete-item")){const E=h.target.getAttribute("data-category");u(E)}}),document.addEventListener("click",h=>{!ke.contains(h.target)&&!Ge.contains(h.target)&&(Ge.style.display="none")}),ke.addEventListener("keypress",h=>{var E;h.key==="Enter"&&(h.preventDefault(),Ge.style.display="none",(E=document.getElementById("preset-builder-template"))==null||E.focus())})}const Ko=document.getElementById("preset-builder-save");Ko&&Ko.addEventListener("click",ea);const Zo=document.getElementById("preset-builder-clear");Zo&&Zo.addEventListener("click",Fn);const es=document.getElementById("preset-builder-delete");es&&es.addEventListener("click",ta),document.querySelectorAll(".chip-section-header").forEach(d=>{d.addEventListener("click",()=>{const u=d.getAttribute("data-section"),h=document.getElementById("section-"+u),E=h.style.display==="block";document.querySelectorAll(".chip-section-content").forEach(p=>{p.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(p=>{p.classList.remove("expanded")}),E||(h.style.display="block",d.classList.add("expanded"))})}),document.querySelectorAll(".preset-chip").forEach(d=>{d.addEventListener("click",u=>{const h=u.target.getAttribute("data-text"),E=document.getElementById("preset-builder-prompt"),p=E.value;p.trim()?E.value=p+" "+h:E.value=h,E.scrollTop=E.scrollHeight})});const ts=document.getElementById("preset-builder-quality");ts&&ts.addEventListener("change",d=>{const u=d.target.value;if(u){const h=document.getElementById("preset-builder-prompt"),E=h.value;E.trim()?h.value=E+" "+u:h.value=u,d.target.value="",h.scrollTop=h.scrollHeight}});const mn=document.getElementById("visible-presets-filter");mn&&(mn.addEventListener("input",d=>{nn=d.target.value,Mt()}),mn.addEventListener("focus",()=>{ho=!0;const d=document.getElementById("visible-presets-category-hint");d&&(d.style.display="none")}),mn.addEventListener("blur",()=>{ho=!1}));const ns=document.getElementById("visible-presets-select-all");ns&&ns.addEventListener("click",()=>{x=g.filter(u=>!u.internal).map(u=>u.name),Be(),Mt(),Xe(),G&&Me()});const os=document.getElementById("visible-presets-deselect-all");os&&os.addEventListener("click",()=>{x=[],Be(),Mt(),Xe(),G&&Me()});const ss=document.getElementById("visible-presets-jump-up");ss&&ss.addEventListener("click",()=>{Ee=0,sn()});const is=document.getElementById("visible-presets-jump-down");is&&is.addEventListener("click",()=>{const d=document.getElementById("visible-presets-list");if(d){const u=d.querySelectorAll(".style-item");u.length>0&&(Ee=u.length-1,sn())}});let U=null,je=null,Y=null,Ft=[],tt=0,Ye=0,ze=0,nt=!1;function Ll(){const d=$[ne];if(!d)return;document.getElementById("image-viewer").style.display="none",document.getElementById("image-editor-modal").style.display="flex",U=document.getElementById("editor-canvas"),je=U.getContext("2d",{willReadFrequently:!0});const u=new Image;u.onload=()=>{Y=u,Ft=[],tt=0,Ye=0,ze=0,document.getElementById("brightness-slider").value=0,document.getElementById("contrast-slider").value=0,document.getElementById("brightness-value").textContent="0",document.getElementById("contrast-value").textContent="0",ot(),Jn()},u.src=d.imageBase64}function ot(){!Y||!U||(U.width=Y.width,U.height=Y.height,je.clearRect(0,0,U.width,U.height),je.drawImage(Y,0,0),(Ye!==0||ze!==0)&&Ol())}function Ol(){const d=je.getImageData(0,0,U.width,U.height),u=d.data,h=Ye,E=(ze+100)/100;for(let p=0;p<u.length;p+=4)u[p]=((u[p]/255-.5)*E+.5)*255,u[p+1]=((u[p+1]/255-.5)*E+.5)*255,u[p+2]=((u[p+2]/255-.5)*E+.5)*255,u[p]+=h,u[p+1]+=h,u[p+2]+=h,u[p]=Math.max(0,Math.min(255,u[p])),u[p+1]=Math.max(0,Math.min(255,u[p+1])),u[p+2]=Math.max(0,Math.min(255,u[p+2]));je.putImageData(d,0,0)}function Al(){gn(),tt=(tt+90)%360;const d=document.createElement("canvas"),u=d.getContext("2d");tt===90||tt===270?(d.width=Y.height,d.height=Y.width):(d.width=Y.width,d.height=Y.height),u.translate(d.width/2,d.height/2),u.rotate(tt*Math.PI/180),u.drawImage(Y,-Y.width/2,-Y.height/2);const h=new Image;h.onload=()=>{Y=h,ot()},h.src=d.toDataURL("image/jpeg",.95)}function Dl(){gn();const d=je.getImageData(0,0,U.width,U.height),u=d.data,h=U.width,E=U.height,p=new Uint8ClampedArray(u),A=[0,-1,0,-1,5,-1,0,-1,0];for(let M=1;M<E-1;M++)for(let N=1;N<h-1;N++)for(let F=0;F<3;F++){let W=0;for(let z=-1;z<=1;z++)for(let X=-1;X<=1;X++){const Re=((M+z)*h+(N+X))*4+F,gt=(z+1)*3+(X+1);W+=u[Re]*A[gt]}p[(M*h+N)*4+F]=Math.max(0,Math.min(255,W))}for(let M=0;M<u.length;M+=4)u[M]=p[M],u[M+1]=p[M+1],u[M+2]=p[M+2];je.putImageData(d,0,0);const P=new Image;P.onload=()=>{Y=P,ot()},P.src=U.toDataURL("image/jpeg",.95)}function kl(){gn();const d=je.getImageData(0,0,U.width,U.height),u=d.data,h=1.15,E=1.2,p=5;for(let P=0;P<u.length;P+=4){let M=u[P],N=u[P+1],F=u[P+2];M=((M/255-.5)*h+.5)*255,N=((N/255-.5)*h+.5)*255,F=((F/255-.5)*h+.5)*255;const W=.2989*M+.587*N+.114*F;M=W+E*(M-W),N=W+E*(N-W),F=W+E*(F-W),M+=p,N+=p,F+=p,u[P]=Math.max(0,Math.min(255,M)),u[P+1]=Math.max(0,Math.min(255,N)),u[P+2]=Math.max(0,Math.min(255,F))}je.putImageData(d,0,0);const A=new Image;A.onload=()=>{Y=A,ot()},A.src=U.toDataURL("image/jpeg",.95)}function Nl(){nt=!nt;const d=document.getElementById("crop-overlay"),u=document.getElementById("crop-button");if(nt){d.style.display="block",u.classList.add("active");const E=document.querySelector(".editor-image-container").getBoundingClientRect(),p=U.getBoundingClientRect(),A=document.querySelector(".crop-top-left"),P=document.querySelector(".crop-bottom-right");A.style.left=p.left-E.left+p.width*.1+"px",A.style.top=p.top-E.top+p.height*.1+"px",P.style.right=E.right-p.right+p.width*.1+"px",P.style.bottom=E.bottom-p.bottom+p.height*.1+"px"}else d.style.display="none",u.classList.remove("active")}function Rl(){if(!nt)return;gn(),document.querySelector(".editor-image-container").getBoundingClientRect();const u=U.getBoundingClientRect(),h=document.querySelector(".crop-top-left"),E=document.querySelector(".crop-bottom-right"),p=h.getBoundingClientRect(),A=E.getBoundingClientRect(),P=p.left-u.left,M=p.top-u.top,N=A.right-u.left,F=A.bottom-u.top,W=N-P,z=F-M;if(W<=0||z<=0){alert("Invalid crop area");return}const X=Y.width/u.width,Re=Y.height/u.height,gt=P*X,Vt=M*Re,to=W*X,no=z*Re,yn=document.createElement("canvas");yn.width=to,yn.height=no,yn.getContext("2d").drawImage(Y,gt,Vt,to,no,0,0,to,no);const oo=new Image;oo.onload=()=>{Y=oo,nt=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active"),ot()},oo.src=yn.toDataURL("image/jpeg",.95)}function gn(){const d={image:Y,rotation:tt,brightness:Ye,contrast:ze};Ft.push(d),Jn()}function ql(){if(Ft.length===0)return;const d=Ft.pop();Y=d.image,tt=d.rotation,Ye=d.brightness,ze=d.contrast,document.getElementById("brightness-slider").value=Ye,document.getElementById("contrast-slider").value=ze,document.getElementById("brightness-value").textContent=Ye,document.getElementById("contrast-value").textContent=ze,ot(),Jn()}function Jn(){const d=document.getElementById("undo-edit-button");d.disabled=Ft.length===0}async function $l(){const d=document.createElement("canvas");d.width=U.width,d.height=U.height,d.getContext("2d").drawImage(U,0,0);const h=d.toDataURL("image/jpeg",.9),E={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:h,timestamp:Date.now()};$.unshift(E),await Un(E),ne=0;const p=document.getElementById("viewer-image");p.src=h,p.style.transform="scale(1) translate(0, 0)",Ce=1,ls(),await ue(),Xt("Edited image saved!","success",3e3)}function ls(){document.getElementById("image-editor-modal").style.display="none",document.getElementById("image-viewer").style.display="flex",nt=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active")}(di=document.getElementById("edit-viewer-image"))==null||di.addEventListener("click",Ll),(ui=document.getElementById("close-image-editor"))==null||ui.addEventListener("click",ls),(mi=document.getElementById("rotate-button"))==null||mi.addEventListener("click",Al),(gi=document.getElementById("sharpen-button"))==null||gi.addEventListener("click",Dl),(fi=document.getElementById("autocorrect-button"))==null||fi.addEventListener("click",kl),(pi=document.getElementById("undo-edit-button"))==null||pi.addEventListener("click",ql),(yi=document.getElementById("save-edit-button"))==null||yi.addEventListener("click",$l),(hi=document.getElementById("crop-button"))==null||hi.addEventListener("click",()=>{nt?Rl():Nl()}),(Ei=document.getElementById("brightness-slider"))==null||Ei.addEventListener("input",d=>{Ye=parseInt(d.target.value),document.getElementById("brightness-value").textContent=Ye,ot()}),(Ii=document.getElementById("contrast-slider"))==null||Ii.addEventListener("input",d=>{ze=parseInt(d.target.value),document.getElementById("contrast-value").textContent=ze,ot()});let Ne=null;document.querySelectorAll(".crop-corner").forEach(d=>{d.addEventListener("touchstart",u=>{u.preventDefault(),Ne=d})}),document.addEventListener("touchmove",d=>{if(!Ne||!nt)return;d.preventDefault();const u=d.touches[0],E=document.querySelector(".editor-image-container").getBoundingClientRect(),p=U.getBoundingClientRect();let A=u.clientX-E.left,P=u.clientY-E.top;const M=p.left-E.left,N=p.top-E.top,F=p.right-E.left,W=p.bottom-E.top,z=Ne.offsetWidth;if(Ne.classList.contains("crop-top-left")){A=Math.max(M,Math.min(A,F-z)),P=Math.max(N,Math.min(P,W-z));const Re=document.querySelector(".crop-bottom-right").getBoundingClientRect(),gt=Re.right-E.left-z*2,Vt=Re.bottom-E.top-z*2;A=Math.min(A,gt),P=Math.min(P,Vt),Ne.style.left=A+"px",Ne.style.top=P+"px"}else if(Ne.classList.contains("crop-bottom-right")){A=Math.max(M+z,Math.min(A,F)),P=Math.max(N+z,Math.min(P,W));const Re=document.querySelector(".crop-top-left").getBoundingClientRect(),gt=Re.right-E.left+z,Vt=Re.bottom-E.top+z;A=Math.max(A,gt),P=Math.max(P,Vt),Ne.style.right=E.width-A+"px",Ne.style.bottom=E.height-P+"px"}}),document.addEventListener("touchend",()=>{Ne=null});const rs=document.getElementById("motion-sensitivity-slider"),as=document.getElementById("motion-sensitivity-value");if(rs&&as){const d=["Very Low","Low","Medium","High","Very High"];rs.addEventListener("input",u=>{const h=parseInt(u.target.value);as.textContent=d[h-1],At=50-h*10,In(),fl()})}const cs=document.getElementById("motion-continuous-enabled");cs&&cs.addEventListener("change",d=>{It=d.target.checked,In()});const ds=document.getElementById("motion-cooldown-slider"),us=document.getElementById("motion-cooldown-value");ds&&us&&ds.addEventListener("input",d=>{Dt=parseInt(d.target.value),us.textContent=`${Dt}s`,In()});const ms=document.getElementById("motion-start-delay-slider"),gs=document.getElementById("motion-start-delay-value");ms&&gs&&ms.addEventListener("input",d=>{const u=parseInt(d.target.value);kt=Kt[u].seconds,gs.textContent=Kt[u].label,In()});const fs=document.getElementById("no-magic-toggle-button");fs&&fs.addEventListener("click",la);const ps=document.getElementById("manual-options-toggle-button");ps&&ps.addEventListener("click",aa);const ys=document.getElementById("tutorial-button");ys&&ys.addEventListener("click",ma);const hs=document.getElementById("tutorial-back");hs&&hs.addEventListener("click",ga);const Es=document.getElementById("import-presets-button");Es&&Es.addEventListener("click",async()=>{try{const d=await de.import();if(d.success){const u=new Set(g.map(p=>p.name));g=await Ln();const h=new Set(g.map(p=>p.name));x=x.filter(p=>h.has(p)),g.forEach(p=>{!u.has(p.name)&&!x.includes(p.name)&&x.push(p.name)}),Be(),Me(),Xe();const E=document.getElementById("styles-count");if(E){const p=g.filter(A=>x.includes(A.name)).length;E.textContent=p}alert(d.message)}else d.message!=="cancelled"&&d.message!=="No presets selected"&&alert("Import failed: "+d.message)}catch(d){alert("Import error: "+d.message)}}),document.querySelectorAll(".glossary-item").forEach(d=>{d.addEventListener("click",()=>{const u=d.getAttribute("data-section");fa(u)})});const Is=document.getElementById("back-to-glossary");Is&&Is.addEventListener("click",hl);const bs=document.getElementById("master-prompt-enabled");bs&&bs.addEventListener("change",d=>{xe=d.target.checked;const u=document.getElementById("master-prompt-text");u&&(u.disabled=!xe),bn();const h=document.getElementById("master-prompt-indicator");h&&(h.style.display=xe?"block":"none"),An()});const vs=document.getElementById("master-prompt-text");vs&&vs.addEventListener("input",d=>{Le=d.target.value;const u=document.getElementById("master-prompt-char-count");u&&(u.textContent=Le.length),bn(),An()});const fn=document.getElementById("style-filter");let Qn=null;fn&&(fn.addEventListener("input",d=>{it=d.target.value,Qn&&clearTimeout(Qn),Qn=setTimeout(()=>{Me()},150)}),fn.addEventListener("focus",()=>{yo=!0;const d=document.getElementById("menu-category-hint");d&&(d.style.display="none")}),fn.addEventListener("blur",()=>{yo=!1}));const Bs=document.getElementById("burst-count-slider"),Wn=document.getElementById("burst-speed-slider");Bs&&Bs.addEventListener("input",d=>{K=parseInt(d.target.value),document.getElementById("burst-count-value").textContent=K;const u=parseInt(Wn.value);Ai(K,u),On(),ye&&(v.textContent=L?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${K} photos) ‚Ä¢ ${g[I].name}`)}),Wn&&Wn.addEventListener("input",d=>{const u=parseInt(d.target.value);rn=Ot[u].delay,document.getElementById("burst-speed-value").textContent=Ot[u].label,Ai(K,u),On()});const Ss=document.getElementById("timer-delay-slider"),Ts=document.getElementById("timer-delay-value");Ss&&Ts&&Ss.addEventListener("input",d=>{const u=parseInt(d.target.value)-1;Ue=Vi[u],Ts.textContent=Ue,uo(),Qt()});const ws=document.getElementById("timer-repeat-enabled");ws&&ws.addEventListener("change",d=>{Bt=d.target.checked,uo(),Qt()});const Xn=document.getElementById("timer-repeat-interval-input"),Kn=document.getElementById("timer-repeat-interval-unit");if(Xn&&Kn){const d=()=>{const u=parseInt(Xn.value)||1,h=parseInt(Kn.value);Te=u*h,uo(),Qt()};Xn.addEventListener("input",d),Kn.addEventListener("change",d)}xa(),Ca(),ia(),ra(),ca(),da();const xs=document.getElementById("reset-button");xs&&xs.addEventListener("click",jn);const Cs=document.getElementById("camera-button");Cs&&Cs.addEventListener("click",wa);const Ps=document.getElementById("close-editor");Ps&&Ps.addEventListener("click",Go);const Ms=document.getElementById("import-resolution-settings-button");Ms&&Ms.addEventListener("click",ha);const Ls=document.getElementById("import-resolution-back");Ls&&Ls.addEventListener("click",El);const Os=document.getElementById("save-style");Os&&Os.addEventListener("click",nc);const As=document.getElementById("delete-style");As&&As.addEventListener("click",oc),xt=document.getElementById("connection-status"),Pt=document.getElementById("queue-status"),$e=document.getElementById("sync-button"),$e&&$e.addEventListener("click",qt),Pt&&Pt.addEventListener("click",Uo);const Ds=document.getElementById("close-queue-manager");Ds&&Ds.addEventListener("click",Oa);const ks=document.getElementById("sync-all");ks&&ks.addEventListener("click",qt);const Ns=document.getElementById("clear-queue");Ns&&Ns.addEventListener("click",wl);const Rs=document.getElementById("gallery-button");Rs&&Rs.addEventListener("click",ue);const qs=document.getElementById("close-gallery");qs&&qs.addEventListener("click",Zl);const $s=document.getElementById("gallery-import-button");$s&&$s.addEventListener("click",()=>{ac()});const _s=document.getElementById("check-updates-button");_s&&_s.addEventListener("click",async()=>{try{const d=await fetch("./presets.json");if(!d.ok){alert("Could not load presets.json");return}const u=await d.json(),h=de.getImportedPresets();if(h.length===0){alert('No presets imported yet. Use "Import Presets" first.');return}let E=0,p=0;const A=new Set(h.map(N=>N.name));if(u.forEach(N=>{if(A.has(N.name)){const F=h.find(W=>W.name===N.name);F&&F.message!==N.message&&E++}else p++}),E===0&&p===0){alert("‚úÖ All presets are up to date!");return}const P=[];if(E>0&&P.push(`${E} updated preset(s)`),p>0&&P.push(`${p} new preset(s)`),await confirm(`Found ${P.join(" and ")} available.

Would you like to import updates now?`)){const N=await de.import();if(N.success){const F=new Set(g.map(X=>X.name));g=await Ln();const W=new Set(g.map(X=>X.name));x=x.filter(X=>W.has(X)),g.forEach(X=>{!F.has(X.name)&&!x.includes(X.name)&&x.push(X.name)}),Be(),Me(),Xe();const z=document.getElementById("updates-status");z&&(z.textContent="Check for Updates",z.style.color="",z.style.fontWeight=""),alert(N.message)}}}catch(d){alert("Error checking for updates: "+d.message)}});const Us=document.getElementById("close-qr-scanner");Us&&Us.addEventListener("click",()=>{Wt()});const Hs=document.getElementById("close-viewer");Hs&&Hs.addEventListener("click",nr);const Fs=document.getElementById("delete-viewer-image");Fs&&Fs.addEventListener("click",or);const Vs=document.getElementById("upload-viewer-image");Vs&&Vs.addEventListener("click",ic);const Gs=document.getElementById("mp-viewer-button");Gs&&Gs.addEventListener("click",()=>{Lo=ne,document.getElementById("image-viewer").style.display="none",document.getElementById("gallery-modal").style.display="none",Zt=!0,document.getElementById("unified-menu").style.display="flex",G=!0,document.getElementById("settings-submenu").style.display="flex",Z=!0,Ni()});const js=document.getElementById("qr-scan-button");js&&js.addEventListener("click",()=>{const d=document.getElementById("qr-scan-button"),u=document.getElementById("qr-scanner-video");d&&(d.disabled=!0),u&&u.paused&&u.play(),te("Scanning...",""),Ml()});const Ys=document.getElementById("close-qr-modal");Ys&&Ys.addEventListener("click",rc);const zs=document.getElementById("gallery-start-date-btn"),Zn=document.getElementById("gallery-start-date");zs&&Zn&&(zs.addEventListener("click",()=>{Zn.showPicker()}),Zn.addEventListener("change",d=>{zt=d.target.value||null,xi("start",zt),ao()}));const Js=document.getElementById("gallery-end-date-btn"),eo=document.getElementById("gallery-end-date");Js&&eo&&(Js.addEventListener("click",()=>{eo.showPicker()}),eo.addEventListener("change",d=>{Jt=d.target.value||null,xi("end",Jt),ao()}));const Qs=document.getElementById("gallery-sort-order");Qs&&Qs.addEventListener("change",d=>{tn=d.target.value;try{localStorage.setItem(Xi,tn)}catch(u){console.error("Failed to save sort order:",u)}ao()});const Ws=document.getElementById("prev-page");Ws&&Ws.addEventListener("click",tr);const Xs=document.getElementById("next-page");Xs&&Xs.addEventListener("click",er);const Ks=document.getElementById("load-preset-button");Ks&&Ks.addEventListener("click",sr);const Zs=document.getElementById("multi-preset-button");Zs&&Zs.addEventListener("click",()=>{if(ne>=0){const d=$[ne].id;Dr(d)}});const ei=document.getElementById("close-preset-selector");ei&&ei.addEventListener("click",Pn);const pn=document.getElementById("preset-filter");pn&&(pn.addEventListener("input",d=>{xn=d.target.value,dn()}),pn.addEventListener("focus",()=>{Eo=!0;const d=document.getElementById("preset-selector-category-hint");d&&(d.style.display="none");const u=document.getElementById("multi-preset-controls");u&&(u.style.display="none")}),pn.addEventListener("blur",()=>{if(Eo=!1,Tt){const d=document.getElementById("multi-preset-controls");d&&(d.style.display="flex")}}));const ti=document.getElementById("preset-selector-jump-up");ti&&ti.addEventListener("click",()=>{ie=0,bt()});const ni=document.getElementById("preset-selector-jump-down");ni&&ni.addEventListener("click",()=>{const d=document.getElementById("preset-list");if(d){const u=d.querySelectorAll(".preset-item");u.length>0&&(ie=u.length-1,bt())}});const oi=document.getElementById("magic-button");oi&&oi.addEventListener("click",Cr);const si=document.getElementById("batch-mode-toggle");si&&si.addEventListener("click",Mn);const ii=document.getElementById("batch-select-all");ii&&ii.addEventListener("click",Pr);const li=document.getElementById("batch-deselect-all");li&&li.addEventListener("click",Mr);const ri=document.getElementById("batch-cancel");ri&&ri.addEventListener("click",Mn);const ai=document.getElementById("batch-apply-preset");ai&&ai.addEventListener("click",Lr);const ci=document.getElementById("batch-delete");ci&&ci.addEventListener("click",Ar),$n().then(async()=>{localStorage.getItem("r1_gallery_index")?(console.log("Migrating old gallery data..."),await Wl()):await _n()}).catch(d=>{console.error("Failed to initialize database:",d)}),Nr()});window.removeFromQueue=Aa;window.previewQueueItem=Da;window.clearQueue=wl;async function ic(){if(ne<0)return;const e=document.getElementById("status"),t=document.getElementById("upload-viewer-image");try{t.disabled=!0,t.textContent="‚è≥",e&&(e.style.display="block",e.textContent="Getting server...");const n=await fetch("https://api.gofile.io/servers");if(!n.ok)throw new Error("Failed to get upload server");const o=await n.json();if(o.status!=="ok"||!o.data||!o.data.servers||o.data.servers.length===0)throw new Error("No upload servers available");const s=o.data.servers[0].name;e&&(e.textContent="Uploading image...");const r=$[ne].imageBase64.split(",")[1],l=atob(r),a=new Array(l.length);for(let C=0;C<l.length;C++)a[C]=l.charCodeAt(C);const c=new Uint8Array(a),m=new Blob([c],{type:"image/png"}),f=new FormData;f.append("file",m,`magic-kamera-${Date.now()}.png`);const y=`https://${s}.gofile.io/uploadFile`,b=await fetch(y,{method:"POST",body:f});if(!b.ok)throw new Error("Upload failed - status: "+b.status);const B=await b.json();if(B.status!=="ok"||!B.data||!B.data.downloadPage)throw new Error("Upload failed: "+(B.status||"unknown error"));const S=B.data.downloadPage;e&&(e.textContent="Upload successful!",setTimeout(()=>{e.style.display="none"},2e3)),lc(S.trim())}catch(n){console.error("Upload error:",n),e&&(e.textContent="Upload failed: "+n.message,setTimeout(()=>{e.style.display="none"},4e3))}finally{t.disabled=!1,t.textContent="üì§"}}function lc(e){const t=document.getElementById("qr-modal"),n=document.getElementById("qr-code-container"),o=document.getElementById("qr-url-text");!t||!n||!o||(n.innerHTML="",new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),o.textContent=e,t.style.display="flex")}function rc(){const e=document.getElementById("qr-modal");e&&(e.style.display="none")}function ac(){const e=document.getElementById("qr-scanner-modal"),t=document.getElementById("qr-scanner-video");if(!e||!t)return;e.style.display="flex",cc(),te("Ready to scan","");const n=document.getElementById("qr-scan-button");n&&(n.disabled=!1)}function Wt(){const e=document.getElementById("qr-scanner-modal");e&&(e.style.display="none"),kn(),dc(),te("Point camera at QR code...","")}async function cc(){const e=document.getElementById("qr-scanner-video");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=t,e.onloadedmetadata=()=>{e.pause(),te("Ready to scan","")}}catch(t){console.error("Error starting QR scanner camera:",t),te("Camera access denied","error")}}function dc(){const e=document.getElementById("qr-scanner-video");e&&e.srcObject&&(e.srcObject.getTracks().forEach(n=>n.stop()),e.srcObject=null)}function te(e,t=""){const n=document.getElementById("qr-scanner-status");n&&(n.textContent=e,n.className="qr-scanner-status",t&&n.classList.add(t))}function Xt(e,t="info",n=3e3){const o=document.getElementById("gallery-status-message");o&&(o.textContent=e,o.className="gallery-status-message",t==="error"?o.classList.add("error"):t==="success"&&o.classList.add("success"),o.style.display="block",setTimeout(()=>{o.style.display="none"},n))}function Ml(){Io||(Io=!0,Sn=setInterval(uc,Ql))}function kn(){Io=!1,Sn&&(clearInterval(Sn),Sn=null)}function uc(){const e=document.getElementById("qr-scanner-video");if(!e||e.readyState!==e.HAVE_ENOUGH_DATA)return;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height),s=jsQR(o.data,o.width,o.height);s&&s.data?mc(s.data)?Ct!==s.data&&(Ct=s.data,te("QR Code detected! Importing...","success"),kn(),setTimeout(()=>{fc()},500)):(kn(),Wt(),Xt("Invalid QR code - must be a valid URL","error",4e3)):te("Scanning...","")}function mc(e){try{const t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}async function gc(e,t=640,n=480,o=.85){return new Promise((s,i)=>{const r=new Image,l=URL.createObjectURL(e);r.onload=()=>{URL.revokeObjectURL(l);let a=r.width,c=r.height;if(a>t||c>n){const y=a/c;a>c?(a=t,c=a/y):(c=n,a=c*y)}const m=document.createElement("canvas");m.width=a,m.height=c,m.getContext("2d").drawImage(r,0,0,a,c),m.toBlob(y=>{y?s(y):i(new Error("Failed to compress image"))},"image/jpeg",o)},r.onerror=()=>{URL.revokeObjectURL(l),i(new Error("Failed to load image for resizing"))},r.src=l})}async function fc(){if(!Ct){Wt(),Xt("No QR code detected","error",3e3);return}try{te("Downloading image...","");const e=Ct.trim(),t=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/raw?url=",""];let n=null,o=null;for(let m=0;m<t.length;m++)try{const f=t[m]?t[m]+encodeURIComponent(e):e;te(`Trying method ${m+1}/${t.length}...`,"");const y=new AbortController,b=setTimeout(()=>y.abort(),8e3);if(n=await fetch(f,{signal:y.signal}),clearTimeout(b),n.ok){te("Download successful!","success");break}}catch(f){o=f;continue}if(!n||!n.ok)throw new Error("All download methods failed");te("Reading image data...","");let s=await n.blob();const i=Math.round(s.size/1024);if(te("Original size: "+i+"KB",""),s.type&&!s.type.startsWith("image/"))throw new Error("Not an image: "+s.type);te("Optimizing image...","");const r=Co[Lt];s=await gc(s,r.width,r.height,.85);const l=Math.round(s.size/1024);te("Compressed: "+i+"KB ‚Üí "+l+"KB",""),te("Converting to base64...","");const a=await new Promise((m,f)=>{const y=setTimeout(()=>{f(new Error("Base64 conversion timeout"))},1e4),b=new FileReader;b.onloadend=()=>{clearTimeout(y),m(b.result)},b.onerror=()=>{clearTimeout(y),f(new Error("FileReader error"))},b.readAsDataURL(s)});te("Saving to gallery...","");const c={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:a,timestamp:Date.now()};$.unshift(c),await Un(c),te("‚úÖ Import successful!","success"),Ct=null,Wt(),await ue(),Xt("Image imported successfully!","success",3e3)}catch(e){Ct=null,Wt(),Xt("Import failed: "+e.message,"error",4e3)}}document.getElementById("factory-reset-button").addEventListener("click",async()=>{await confirm(Nt?"This will delete ALL custom presets and undo ALL modifications, returning to your clean imported preset list. This cannot be undone. Continue?":"This will delete ALL custom presets and restore all presets to their original state. This cannot be undone. Continue?")&&(await Se.clearAll(),g=await Ln(),g.length>0&&(x=g.map(n=>n.name),Be()),renderMenuStyles(),alert(Nt?"All custom presets deleted and modifications cleared. Reset to imported presets!":"All custom presets deleted and modifications cleared!"))});document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".mode-carousel-track");e&&e.querySelectorAll(".mode-button").forEach(n=>{const o=n.getAttribute("data-mode");o==="random"?n.addEventListener("click",Il):o==="motion"?n.addEventListener("click",ml):o==="burst"?n.addEventListener("click",vl):o==="timer"&&n.addEventListener("click",Bl)})});console.log("AI Camera Styles app initialized!");let xo=0;document.addEventListener("touchstart",e=>{xo=e.touches[0].clientX},{passive:!0});document.addEventListener("touchend",e=>{const t=e.changedTouches[0].clientX,n=xo-t,o=document.querySelector(".mode-carousel");if(!o)return;const s=30,i=window.innerWidth*.5;xo>i&&n>s&&o.classList.add("show"),n<-s&&o.classList.remove("show")},{passive:!0});
